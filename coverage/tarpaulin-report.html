<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>html, body {
  margin: 0;
  padding: 0;
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: #ddd;
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: #ccf;
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: #fcc;
}
.files-list__file_medium {
  background: #ffc;
}
.files-list__file_high {
  background: #cfc;
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: white;
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: #338;
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
    content: counter(line);
    margin-right: 10px;
}
.code-line {
  margin: 0;
  padding: 0.3em;
  height: 1em;
  counter-increment: line;
}
.code-line_covered {
  background: #cfc;
}
.code-line_uncovered {
  background: #fcc;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","Users","rafael","dev","kagi","node","src","bin","value_type_test.rs"],"content":"use kagi_node::services::ValueType;\nuse kagi_node::{vjson, vmap};\n\nfn main() {\n    println!(\"Testing ValueType implementation\");\n\n    // Test vjson! macro\n    let value = vjson!({\n        \"name\": \"John\",\n        \"age\": 30,\n        \"is_active\": true,\n        \"address\": {\n            \"street\": \"123 Main St\",\n            \"city\": \"Anytown\"\n        },\n        \"skills\": [\"Rust\", \"JavaScript\", \"Python\"]\n    });\n\n    println!(\"vjson! result: {:?}\", value);\n\n    // Test vmap! macro\n    let value = vmap! {\n        \"name\" =\u003e \"John\",\n        \"age\" =\u003e 30,\n        \"is_active\" =\u003e true,\n        \"address\" =\u003e vmap! {\n            \"street\" =\u003e \"123 Main St\",\n            \"city\" =\u003e \"Anytown\"\n        }\n    };\n\n    println!(\"vmap! result: {:?}\", value);\n\n    // Test conversion between ValueType and JSON\n    let json = value.to_json();\n    println!(\"Converted to JSON: {}\", json);\n\n    // Test accessing values\n    if let ValueType::Map(map) = \u0026value {\n        if let Some(ValueType::String(name)) = map.get(\"name\") {\n            println!(\"Name: {}\", name);\n        }\n\n        if let Some(ValueType::Number(age)) = map.get(\"age\") {\n            println!(\"Age: {}\", age);\n        }\n\n        if let Some(ValueType::Bool(is_active)) = map.get(\"is_active\") {\n            println!(\"Is active: {}\", is_active);\n        }\n\n        if let Some(ValueType::Map(address)) = map.get(\"address\") {\n            if let Some(ValueType::String(street)) = address.get(\"street\") {\n                println!(\"Street: {}\", street);\n            }\n\n            if let Some(ValueType::String(city)) = address.get(\"city\") {\n                println!(\"City: {}\", city);\n            }\n        }\n    }\n\n    println!(\"All tests passed!\");\n}\n","traces":[{"line":4,"address":[],"length":0,"stats":{"Line":0}},{"line":5,"address":[],"length":0,"stats":{"Line":0}},{"line":8,"address":[],"length":0,"stats":{"Line":0}},{"line":9,"address":[],"length":0,"stats":{"Line":0}},{"line":10,"address":[],"length":0,"stats":{"Line":0}},{"line":11,"address":[],"length":0,"stats":{"Line":0}},{"line":12,"address":[],"length":0,"stats":{"Line":0}},{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":32},{"path":["/","Users","rafael","dev","kagi","node","src","cli.rs"],"content":"use crate::db::{Database, SqliteDatabase};\nuse crate::key_management::{KeyManager, KeyType};\nuse crate::p2p::build_swarm;\nuse crate::web::{start_web_server, WebServerMode};\n\nuse anyhow::{anyhow, Result};\nuse clap::{Parser, Subcommand};\nuse dirs::home_dir;\nuse libp2p::futures::StreamExt;\nuse log::{error, info, warn};\nuse open;\nuse std::fs;\nuse std::path::PathBuf;\nuse std::sync::Arc;\nuse tokio::sync::oneshot;\n\n#[derive(Parser)]\n#[command(author, version, about, long_about = None)]\npub struct Args {\n    /// Optional configuration directory\n    #[arg(short, long)]\n    config_dir: Option\u003cString\u003e,\n\n    /// Subcommand to execute\n    #[command(subcommand)]\n    command: Option\u003cCommands\u003e,\n}\n\n#[derive(Subcommand)]\npub enum Commands {\n    /// Generate a new keypair\n    Keygen {\n        /// Optional output file path\n        #[arg(short, long)]\n        output: Option\u003cString\u003e,\n    },\n}\n\npub async fn run() -\u003e Result\u003c()\u003e {\n    info!(\"Starting Kagi Node...\");\n\n    // Parse command line arguments\n    let args = Args::parse();\n\n    // Get the configuration directory\n    let config_dir = match args.config_dir {\n        Some(dir) =\u003e PathBuf::from(dir),\n        None =\u003e {\n            let home = home_dir().ok_or_else(|| anyhow!(\"Could not determine home directory\"))?;\n            home.join(\".node_config\")\n        }\n    };\n\n    info!(\"Config directory: {}\", config_dir.display());\n\n    // Create the configuration directory if it doesn't exist\n    if !config_dir.exists() {\n        info!(\"Creating config directory: {}\", config_dir.display());\n        fs::create_dir_all(\u0026config_dir)?;\n    } else {\n        info!(\"Config directory already exists: {}\", config_dir.display());\n    }\n\n    // Create subdirectories\n    let db_dir = config_dir.join(\"db\");\n    if !db_dir.exists() {\n        info!(\"Creating db directory: {}\", db_dir.display());\n        fs::create_dir_all(\u0026db_dir)?;\n    } else {\n        info!(\"Directory already exists: {}\", db_dir.display());\n    }\n\n    let logs_dir = config_dir.join(\"logs\");\n    if !logs_dir.exists() {\n        info!(\"Creating logs directory: {}\", logs_dir.display());\n        fs::create_dir_all(\u0026logs_dir)?;\n    } else {\n        info!(\"Directory already exists: {}\", logs_dir.display());\n    }\n\n    // Note: The webui directory is no longer needed as we're using UI files directly from the node directory\n    // The paths are now handled in the web.rs file\n\n    info!(\"Using configuration directory: {}\", config_dir.display());\n\n    // Handle subcommands\n    match args.command {\n        Some(Commands::Keygen { output }) =\u003e {\n            keygen(output).await?;\n            return Ok(());\n        }\n        None =\u003e {\n            // Start the node\n            info!(\"Starting node...\");\n            start_node(config_dir).await?;\n        }\n    }\n\n    Ok(())\n}\n\nasync fn start_node(config_dir: PathBuf) -\u003e Result\u003c()\u003e {\n    info!(\"Initializing key manager...\");\n    let _key_manager = KeyManager::new(config_dir.to_str().unwrap_or_default())?;\n\n    // Initialize the database\n    let db_path = config_dir.join(\"db/node.db\");\n    info!(\"Database path: {}\", db_path.display());\n\n    let db_dir = config_dir.join(\"db\");\n    info!(\"Database directory: {}\", db_dir.display());\n\n    if !db_dir.exists() {\n        info!(\"Creating database directory: {}\", db_dir.display());\n        fs::create_dir_all(\u0026db_dir)?;\n    } else {\n        info!(\"Database directory already exists: {}\", db_dir.display());\n    }\n\n    info!(\"Initializing database...\");\n    let db = Arc::new(SqliteDatabase::new(db_path.to_str().unwrap()).await?);\n\n    // Check if configuration exists\n    info!(\"Checking if configuration exists...\");\n    let config_result = db.load_node_config(config_dir.clone()).await;\n\n    match config_result {\n        Ok(config) =\u003e {\n            // Configuration exists, start the node\n            info!(\"Configuration found, starting node: {}\", config.node_name);\n\n            // Start the node with the configuration\n            info!(\"Building swarm...\");\n            let local_key = config.private_key;\n            let mut swarm = build_swarm(db.clone(), \u0026local_key).await?;\n\n            // Start the web server in normal mode\n            info!(\"Starting web server in normal mode...\");\n            tokio::spawn(start_web_server(\n                db.clone(),\n                None,\n                config_dir.clone(),\n                WebServerMode::NodeUI,\n            ));\n\n            // Process swarm events\n            info!(\"Processing swarm events...\");\n            while let Some(event) = swarm.next().await {\n                info!(\"Swarm event: {:?}\", event);\n            }\n\n            Ok(())\n        }\n        Err(_) =\u003e {\n            // No configuration exists, start the setup process\n            info!(\"No config found, initiating setup workflow\");\n\n            // Run the initial node setup\n            initial_node_setup(config_dir.clone()).await?;\n\n            // After setup is complete, check for configuration again\n            info!(\"Setup complete, checking for new configuration...\");\n\n            // Try to load the configuration again\n            let config_result = db.load_node_config(config_dir.clone()).await;\n\n            match config_result {\n                Ok(config) =\u003e {\n                    // Configuration now exists, start the node\n                    info!(\n                        \"Configuration found after setup, starting node: {}\",\n                        config.node_name\n                    );\n\n                    // Start the node with the configuration\n                    info!(\"Building swarm...\");\n                    let local_key = config.private_key;\n                    let mut swarm = build_swarm(db.clone(), \u0026local_key).await?;\n\n                    // Start the web server in normal mode\n                    info!(\"Starting web server in normal mode...\");\n                    tokio::spawn(start_web_server(\n                        db.clone(),\n                        None,\n                        config_dir.clone(),\n                        WebServerMode::NodeUI,\n                    ));\n\n                    // Process swarm events\n                    info!(\"Processing swarm events...\");\n                    while let Some(event) = swarm.next().await {\n                        info!(\"Swarm event: {:?}\", event);\n                    }\n\n                    Ok(())\n                }\n                Err(e) =\u003e {\n                    error!(\"Setup completed but no configuration found: {:?}\", e);\n                    Err(anyhow!(\"Setup completed but no configuration found: {}\", e))\n                }\n            }\n        }\n    }\n}\n\nasync fn initial_node_setup(config_dir: PathBuf) -\u003e Result\u003c()\u003e {\n    info!(\"Starting initial node setup...\");\n\n    // Create a oneshot channel for signaling when setup is complete\n    info!(\"Creating oneshot channel...\");\n    let (setup_tx, setup_rx) = oneshot::channel::\u003c()\u003e();\n\n    // Initialize the database\n    let db_path = config_dir.join(\"db/node.db\");\n    info!(\"Database path: {}\", db_path.display());\n\n    let db_dir = config_dir.join(\"db\");\n    info!(\"Database directory: {}\", db_dir.display());\n\n    if !db_dir.exists() {\n        info!(\"Creating database directory: {}\", db_dir.display());\n        std::fs::create_dir_all(\u0026db_dir)?;\n    } else {\n        info!(\"Database directory already exists: {}\", db_dir.display());\n    }\n\n    info!(\"Initializing database...\");\n    let db = Arc::new(SqliteDatabase::new(db_path.to_str().unwrap()).await?);\n\n    // Start the web server in setup mode\n    info!(\"Starting web server in setup mode...\");\n    let web_server_handle = tokio::spawn(start_web_server(\n        db.clone(),\n        Some(setup_tx),\n        config_dir.clone(),\n        WebServerMode::SetupUI,\n    ));\n\n    // Give the web server a moment to start\n    info!(\"Waiting for web server to start...\");\n    tokio::time::sleep(tokio::time::Duration::from_secs(2)).await;\n\n    // Inform the user to visit the setup page\n    info!(\"No previous configuration found. Please visit http://localhost:3000 to complete setup.\");\n    info!(\"If port 3000 is not available, the server may be running on a different port. Check the logs for details.\");\n\n    // Open the browser\n    info!(\"Opening browser...\");\n    if let Err(e) = open::that(\"http://localhost:3000\") {\n        warn!(\"Failed to open browser: {}\", e);\n        info!(\"Please open http://localhost:3000 in your browser to complete setup.\");\n        info!(\"If port 3000 is not available, try ports 3001-3009.\");\n    }\n\n    // Wait for setup to complete\n    info!(\"Waiting for setup to complete...\");\n    match tokio::time::timeout(std::time::Duration::from_secs(300), setup_rx).await {\n        Ok(result) =\u003e {\n            match result {\n                Ok(()) =\u003e {\n                    info!(\"Setup completed successfully!\");\n                    // Abort the web server task since setup is complete\n                    web_server_handle.abort();\n                    Ok(())\n                }\n                Err(e) =\u003e {\n                    error!(\"Setup channel error: {:?}\", e);\n                    // Check if configuration exists despite the channel error\n                    match db.load_node_config(config_dir.clone()).await {\n                        Ok(_) =\u003e {\n                            info!(\"Configuration found despite channel error, continuing...\");\n                            web_server_handle.abort();\n                            Ok(())\n                        }\n                        Err(_) =\u003e {\n                            error!(\"No configuration found after setup attempt\");\n                            web_server_handle.abort();\n                            Err(anyhow!(\n                                \"Setup failed: channel error and no configuration found\"\n                            ))\n                        }\n                    }\n                }\n            }\n        }\n        Err(_) =\u003e {\n            error!(\"Setup timed out after 5 minutes\");\n            web_server_handle.abort();\n            Err(anyhow!(\"Setup timed out after 5 minutes\"))\n        }\n    }\n}\n\nasync fn keygen(output: Option\u003cString\u003e) -\u003e Result\u003c()\u003e {\n    info!(\"Generating keypair...\");\n\n    // Generate a keypair\n    let keypair = KeyManager::generate_keypair()?;\n\n    // Convert the keypair to bytes\n    let keypair_bytes = keypair.to_bytes();\n\n    // Output the keypair\n    match output {\n        Some(path) =\u003e {\n            // Write the keypair to a file\n            info!(\"Writing keypair to file: {}\", path);\n            fs::write(path, keypair_bytes)?;\n        }\n        None =\u003e {\n            // Print the keypair to stdout\n            info!(\"Keypair: {:?}\", keypair_bytes);\n        }\n    }\n\n    Ok(())\n}\n\nasync fn status(config_dir: PathBuf) -\u003e Result\u003c()\u003e {\n    // Initialize key manager to check for existing keys\n    let key_manager = KeyManager::new(config_dir.to_str().unwrap_or_default())?;\n\n    println!(\"Node Status:\");\n    println!(\"Config directory: {}\", config_dir.display());\n\n    // Check if the node has a key\n    if let Some(node_key) = key_manager.get_key(KeyType::Node) {\n        println!(\"Node public key: {:?}\", node_key.public_key_bytes());\n    } else {\n        println!(\"No node key found\");\n    }\n\n    // Check if the node database exists\n    let db_path = config_dir.join(\"db/node.db\");\n    if db_path.exists() {\n        println!(\"Database: Exists at {}\", db_path.display());\n\n        // Try to load the node config from the database\n        let db = Arc::new(SqliteDatabase::new(db_path.to_str().unwrap()).await?);\n        match db.load_node_config(config_dir.clone()).await {\n            Ok(config) =\u003e {\n                println!(\"Node name: {}\", config.node_name);\n                println!(\"Web UI port: {}\", config.web_ui_port);\n            }\n            Err(_) =\u003e {\n                println!(\"No node configuration found in database\");\n            }\n        }\n    } else {\n        println!(\"Database: Not found\");\n    }\n\n    Ok(())\n}\n\nasync fn run_node(\n    config_dir: PathBuf,\n    db: Arc\u003cSqliteDatabase\u003e,\n    setup_tx: Option\u003coneshot::Sender\u003c()\u003e\u003e,\n) -\u003e Result\u003c()\u003e {\n    let key_manager = KeyManager::new(\n        config_dir\n            .to_str()\n            .ok_or_else(|| anyhow!(\"Invalid config directory path\"))?,\n    )?;\n\n    // ... existing code ...\n\n    Ok(())\n}\n\nasync fn get(config_dir: PathBuf, db: Arc\u003cSqliteDatabase\u003e, key: String) -\u003e Result\u003c()\u003e {\n    let key_manager = KeyManager::new(\n        config_dir\n            .to_str()\n            .ok_or_else(|| anyhow!(\"Invalid config directory path\"))?,\n    )?;\n\n    // ... existing code ...\n\n    Ok(())\n}\n\nasync fn put(\n    config_dir: PathBuf,\n    db: Arc\u003cSqliteDatabase\u003e,\n    key: String,\n    value: String,\n) -\u003e Result\u003c()\u003e {\n    let key_manager = KeyManager::new(\n        config_dir\n            .to_str()\n            .ok_or_else(|| anyhow!(\"Invalid config directory path\"))?,\n    )?;\n\n    // ... existing code ...\n\n    Ok(())\n}\n","traces":[{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":178},{"path":["/","Users","rafael","dev","kagi","node","src","config.rs"],"content":"use anyhow::{anyhow, Result};\nuse ed25519_dalek::{Keypair, PublicKey, SecretKey};\nuse rand::Rng;\nuse serde::{Deserialize, Deserializer, Serialize, Serializer};\nuse std::path::PathBuf;\n\n// Define a custom struct for serializing and deserializing the keypair\n#[derive(Debug, Serialize, Deserialize)]\npub struct NodeConfig {\n    pub node_name: String,\n    #[serde(\n        serialize_with = \"serialize_keypair\",\n        deserialize_with = \"deserialize_keypair\"\n    )]\n    pub private_key: Keypair,\n    #[serde(skip)]\n    pub config_dir: PathBuf,\n    pub web_ui_port: u16,\n}\n\n// Serialize the keypair to bytes\nfn serialize_keypair\u003cS\u003e(key: \u0026Keypair, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\nwhere\n    S: Serializer,\n{\n    let bytes = key.to_bytes();\n    serializer.serialize_bytes(\u0026bytes)\n}\n\n// Deserialize bytes to a keypair\nfn deserialize_keypair\u003c'de, D\u003e(deserializer: D) -\u003e Result\u003cKeypair, D::Error\u003e\nwhere\n    D: Deserializer\u003c'de\u003e,\n{\n    use serde::de::Error;\n    let bytes = Vec::\u003cu8\u003e::deserialize(deserializer)?;\n    Keypair::from_bytes(\u0026bytes).map_err(|e| Error::custom(format!(\"Invalid keypair: {}\", e)))\n}\n\nimpl NodeConfig {\n    pub fn new(\n        node_name: String,\n        private_key: Vec\u003cu8\u003e,\n        config_dir: PathBuf,\n        web_ui_port: u16,\n    ) -\u003e Result\u003cSelf\u003e {\n        let private_key = Keypair::from_bytes(\u0026private_key)?;\n        Ok(Self {\n            node_name,\n            private_key,\n            config_dir,\n            web_ui_port,\n        })\n    }\n\n    pub fn public_key_bytes(\u0026self) -\u003e Vec\u003cu8\u003e {\n        self.private_key.public.to_bytes().to_vec()\n    }\n\n    pub fn private_key_bytes(\u0026self) -\u003e Vec\u003cu8\u003e {\n        self.private_key.to_bytes().to_vec()\n    }\n\n    // Generate a new keypair\n    pub fn generate_keypair() -\u003e Result\u003cKeypair\u003e {\n        // For now, use a non-cryptographic RNG during testing\n        // In production, we should use a proper cryptographic RNG\n        let mut seed = [0u8; 32];\n        rand::thread_rng().fill(\u0026mut seed);\n\n        let secret = SecretKey::from_bytes(\u0026seed)\n            .map_err(|e| anyhow!(\"Failed to create secret key: {}\", e))?;\n        let public = PublicKey::from(\u0026secret);\n\n        Ok(Keypair { secret, public })\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::key_management::KeyManager;\n    use serde_json;\n\n    #[test]\n    fn test_node_config_serialization() -\u003e Result\u003c()\u003e {\n        // Generate a test keypair\n        let keypair = KeyManager::generate_keypair()?;\n        let config_dir = PathBuf::from(\"/tmp/test_config\");\n\n        // Create a NodeConfig\n        let config = NodeConfig {\n            node_name: \"test_node\".to_string(),\n            private_key: keypair,\n            config_dir: config_dir.clone(),\n            web_ui_port: 8383,\n        };\n\n        // Serialize to JSON\n        let json = serde_json::to_string(\u0026config)?;\n\n        // Deserialize from JSON\n        let deserialized_config: NodeConfig = serde_json::from_str(\u0026json)?;\n\n        // Check that the values match\n        assert_eq!(config.node_name, deserialized_config.node_name);\n        assert_eq!(config.web_ui_port, deserialized_config.web_ui_port);\n\n        // Since PathBuf is skipped during serialization, config_dir should be empty\n        assert_ne!(config.config_dir, deserialized_config.config_dir);\n\n        // Check that public key bytes match (this indicates the keypair was serialized correctly)\n        assert_eq!(\n            config.public_key_bytes(),\n            deserialized_config.public_key_bytes()\n        );\n\n        Ok(())\n    }\n\n    #[test]\n    fn test_node_config_methods() -\u003e Result\u003c()\u003e {\n        // Generate a test keypair\n        let keypair = KeyManager::generate_keypair()?;\n        let keypair_bytes = keypair.to_bytes();\n        let config_dir = PathBuf::from(\"/tmp/test_config\");\n\n        // Create a NodeConfig using the new method\n        let config = NodeConfig::new(\n            \"test_node\".to_string(),\n            keypair_bytes.to_vec(),\n            config_dir.clone(),\n            8383,\n        )?;\n\n        // Check that the values match\n        assert_eq!(config.node_name, \"test_node\");\n        assert_eq!(config.web_ui_port, 8383);\n        assert_eq!(config.config_dir, config_dir);\n\n        // Check public_key_bytes\n        let public_key_bytes = config.public_key_bytes();\n        assert_eq!(public_key_bytes.len(), 32);\n\n        // Check private_key_bytes\n        let private_key_bytes = config.private_key_bytes();\n        assert_eq!(private_key_bytes.len(), 64);\n\n        Ok(())\n    }\n}\n","traces":[{"line":22,"address":[],"length":0,"stats":{"Line":1}},{"line":26,"address":[],"length":0,"stats":{"Line":1}},{"line":27,"address":[],"length":0,"stats":{"Line":1}},{"line":31,"address":[],"length":0,"stats":{"Line":1}},{"line":36,"address":[],"length":0,"stats":{"Line":2}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":6}},{"line":47,"address":[],"length":0,"stats":{"Line":12}},{"line":56,"address":[],"length":0,"stats":{"Line":3}},{"line":57,"address":[],"length":0,"stats":{"Line":3}},{"line":60,"address":[],"length":0,"stats":{"Line":5}},{"line":61,"address":[],"length":0,"stats":{"Line":5}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}}],"covered":11,"coverable":19},{"path":["/","Users","rafael","dev","kagi","node","src","db.rs"],"content":"use crate::config::NodeConfig;\nuse anyhow::Result;\nuse async_trait::async_trait;\nuse rusqlite::{params, Connection};\nuse std::path::{Path, PathBuf};\nuse std::sync::Arc;\nuse tokio::sync::Mutex;\n\n#[async_trait]\npub trait Database {\n    async fn load_node_config(\u0026self, config_dir: PathBuf) -\u003e Result\u003cNodeConfig\u003e;\n    async fn save_node_config(\u0026self, config: \u0026NodeConfig) -\u003e Result\u003c()\u003e;\n}\n\npub struct SqliteDatabase {\n    connection: Arc\u003cMutex\u003cConnection\u003e\u003e,\n}\n\nimpl SqliteDatabase {\n    pub async fn new(db_path: \u0026str) -\u003e Result\u003cSelf\u003e {\n        let conn = Connection::open(db_path)?;\n\n        // Create tables if they don't exist\n        conn.execute(\n            \"CREATE TABLE IF NOT EXISTS node_config (\n                id INTEGER PRIMARY KEY,\n                node_name TEXT NOT NULL,\n                private_key BLOB NOT NULL,\n                web_ui_port INTEGER NOT NULL\n            )\",\n            [],\n        )?;\n\n        Ok(Self {\n            connection: Arc::new(Mutex::new(conn)),\n        })\n    }\n\n    /// Get a connection to the database\n    pub async fn get_connection(\u0026self) -\u003e Result\u003ctokio::sync::MutexGuard\u003c'_, Connection\u003e\u003e {\n        Ok(self.connection.lock().await)\n    }\n\n    pub async fn init_db(db_path: \u0026Path) -\u003e Result\u003c()\u003e {\n        let conn = Connection::open(db_path)?;\n\n        // Create tables if they don't exist\n        conn.execute(\n            \"CREATE TABLE IF NOT EXISTS node_config (\n                id INTEGER PRIMARY KEY,\n                node_name TEXT NOT NULL,\n                private_key BLOB NOT NULL,\n                web_ui_port INTEGER NOT NULL\n            )\",\n            [],\n        )?;\n\n        Ok(())\n    }\n}\n\n#[async_trait]\nimpl Database for SqliteDatabase {\n    async fn load_node_config(\u0026self, config_dir: PathBuf) -\u003e Result\u003cNodeConfig\u003e {\n        let conn = self.connection.lock().await;\n\n        let mut stmt =\n            conn.prepare(\"SELECT node_name, private_key, web_ui_port FROM node_config LIMIT 1\")?;\n        let mut rows = stmt.query([])?;\n\n        if let Some(row) = rows.next()? {\n            let node_name: String = row.get(0)?;\n            let private_key: Vec\u003cu8\u003e = row.get(1)?;\n            let web_ui_port: u16 = row.get(2)?;\n\n            let config = NodeConfig::new(node_name, private_key, config_dir, web_ui_port)?;\n            Ok(config)\n        } else {\n            Err(anyhow::anyhow!(\"No node configuration found in database\"))\n        }\n    }\n\n    async fn save_node_config(\u0026self, config: \u0026NodeConfig) -\u003e Result\u003c()\u003e {\n        let conn = self.connection.lock().await;\n\n        conn.execute(\"DELETE FROM node_config\", [])?;\n\n        conn.execute(\n            \"INSERT INTO node_config (node_name, private_key, web_ui_port) VALUES (?, ?, ?)\",\n            params![\n                config.node_name,\n                config.private_key_bytes(),\n                config.web_ui_port\n            ],\n        )?;\n\n        Ok(())\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::key_management::KeyManager;\n    use tempfile::tempdir;\n\n    #[tokio::test]\n    async fn test_sqlite_database_init() {\n        // Create a temporary directory for testing\n        let temp_dir = tempdir().unwrap();\n        let db_path = temp_dir.path().join(\"test_init.db\");\n\n        // Initialize the database\n        let result = SqliteDatabase::init_db(\u0026db_path).await;\n        assert!(result.is_ok(), \"Database initialization failed\");\n\n        // Check that the file was created\n        assert!(db_path.exists(), \"Database file was not created\");\n    }\n\n    #[tokio::test]\n    async fn test_node_config_save_and_load() {\n        // Create a temporary directory for testing\n        let temp_dir = tempdir().unwrap();\n        let db_path = temp_dir.path().join(\"test_config.db\");\n        let config_dir = temp_dir.path().to_path_buf();\n\n        // Create a new database\n        let db = SqliteDatabase::new(db_path.to_str().unwrap())\n            .await\n            .unwrap();\n\n        // Generate a keypair for testing\n        let keypair = KeyManager::generate_keypair().unwrap();\n        let keypair_bytes = keypair.to_bytes().to_vec();\n\n        // Create a node config\n        let node_name = \"test-node\";\n        let web_ui_port = 3000;\n        let config = NodeConfig::new(\n            node_name.to_string(),\n            keypair_bytes.clone(),\n            config_dir.clone(),\n            web_ui_port,\n        )\n        .unwrap();\n\n        // Save the config to the database\n        let save_result = db.save_node_config(\u0026config).await;\n        assert!(save_result.is_ok(), \"Failed to save node config\");\n\n        // Load the config from the database\n        let loaded_config = db.load_node_config(config_dir).await;\n        assert!(loaded_config.is_ok(), \"Failed to load node config\");\n\n        let loaded_config = loaded_config.unwrap();\n\n        // Verify the loaded config matches the original\n        assert_eq!(\n            loaded_config.node_name, node_name,\n            \"Node name doesn't match\"\n        );\n        assert_eq!(\n            loaded_config.web_ui_port, web_ui_port,\n            \"Web UI port doesn't match\"\n        );\n        assert_eq!(\n            loaded_config.private_key_bytes(),\n            keypair_bytes,\n            \"Private key doesn't match\"\n        );\n    }\n\n    #[tokio::test]\n    async fn test_node_config_update() {\n        // Create a temporary directory for testing\n        let temp_dir = tempdir().unwrap();\n        let db_path = temp_dir.path().join(\"test_update.db\");\n        let config_dir = temp_dir.path().to_path_buf();\n\n        // Create a new database\n        let db = SqliteDatabase::new(db_path.to_str().unwrap())\n            .await\n            .unwrap();\n\n        // Generate a keypair for testing\n        let keypair = KeyManager::generate_keypair().unwrap();\n        let keypair_bytes = keypair.to_bytes().to_vec();\n\n        // Create initial node config\n        let initial_node_name = \"initial-node\";\n        let initial_web_ui_port = 3000;\n        let initial_config = NodeConfig::new(\n            initial_node_name.to_string(),\n            keypair_bytes.clone(),\n            config_dir.clone(),\n            initial_web_ui_port,\n        )\n        .unwrap();\n\n        // Save the initial config\n        db.save_node_config(\u0026initial_config).await.unwrap();\n\n        // Create updated node config\n        let updated_node_name = \"updated-node\";\n        let updated_web_ui_port = 4000;\n        let updated_config = NodeConfig::new(\n            updated_node_name.to_string(),\n            keypair_bytes.clone(),\n            config_dir.clone(),\n            updated_web_ui_port,\n        )\n        .unwrap();\n\n        // Save the updated config\n        db.save_node_config(\u0026updated_config).await.unwrap();\n\n        // Load the config\n        let loaded_config = db.load_node_config(config_dir).await.unwrap();\n\n        // Verify the loaded config matches the updated config\n        assert_eq!(\n            loaded_config.node_name, updated_node_name,\n            \"Updated node name doesn't match\"\n        );\n        assert_eq!(\n            loaded_config.web_ui_port, updated_web_ui_port,\n            \"Updated web UI port doesn't match\"\n        );\n    }\n}\n","traces":[{"line":20,"address":[],"length":0,"stats":{"Line":58}},{"line":21,"address":[],"length":0,"stats":{"Line":36}},{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":18}},{"line":35,"address":[],"length":0,"stats":{"Line":18}},{"line":40,"address":[],"length":0,"stats":{"Line":152}},{"line":41,"address":[],"length":0,"stats":{"Line":76}},{"line":44,"address":[],"length":0,"stats":{"Line":2}},{"line":45,"address":[],"length":0,"stats":{"Line":2}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":1}},{"line":64,"address":[],"length":0,"stats":{"Line":2}},{"line":65,"address":[],"length":0,"stats":{"Line":4}},{"line":67,"address":[],"length":0,"stats":{"Line":2}},{"line":68,"address":[],"length":0,"stats":{"Line":2}},{"line":69,"address":[],"length":0,"stats":{"Line":2}},{"line":71,"address":[],"length":0,"stats":{"Line":2}},{"line":72,"address":[],"length":0,"stats":{"Line":4}},{"line":73,"address":[],"length":0,"stats":{"Line":2}},{"line":74,"address":[],"length":0,"stats":{"Line":2}},{"line":76,"address":[],"length":0,"stats":{"Line":2}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":3}},{"line":84,"address":[],"length":0,"stats":{"Line":6}},{"line":86,"address":[],"length":0,"stats":{"Line":3}},{"line":88,"address":[],"length":0,"stats":{"Line":3}},{"line":90,"address":[],"length":0,"stats":{"Line":3}},{"line":91,"address":[],"length":0,"stats":{"Line":3}},{"line":92,"address":[],"length":0,"stats":{"Line":3}},{"line":93,"address":[],"length":0,"stats":{"Line":3}},{"line":97,"address":[],"length":0,"stats":{"Line":3}}],"covered":28,"coverable":31},{"path":["/","Users","rafael","dev","kagi","node","src","ipc.rs"],"content":"// IPC (Inter-Process Communication) Module\n//\n// This module provides a cross-platform IPC mechanism for communication between\n// processes and the Kagi node. On Unix-like systems (macOS/Linux), it uses Unix domain\n// sockets. On Windows, it's designed to support Named Pipes (though currently\n// this is a placeholder implementation).\n//\n// The API supports publish/subscribe and request/response patterns.\n\nuse crate::db::SqliteDatabase;\nuse crate::services::registry::ServiceRegistry;\nuse crate::services::ValueType;\nuse anyhow::{anyhow, Result};\nuse async_trait::async_trait;\nuse log::{debug, error, info};\nuse serde::{Deserialize, Serialize};\nuse serde_json::{json, Value};\nuse std::path::PathBuf;\nuse std::sync::Arc;\nuse std::time::Duration;\nuse tokio::io::{AsyncReadExt, AsyncWriteExt};\nuse tokio::net::{UnixListener, UnixStream};\nuse tokio::sync::oneshot;\nuse tokio::task::JoinHandle;\nuse uuid::Uuid;\n\nuse crate::services::{RequestContext, ServiceRequest, ServiceResponse};\n\n// IPC message types\n\n/// IPC Request Type\n#[derive(Debug, Clone, Copy, Serialize, Deserialize)]\npub enum IpcRequestType {\n    /// Publish a message to a topic\n    Publish,\n    /// Subscribe to a topic\n    Subscribe,\n    /// Request data from a topic\n    Request,\n    /// Unsubscribe from a topic\n    Unsubscribe,\n    /// Ping request\n    Ping,\n    /// Echo request\n    Echo,\n}\n\n/// IPC Request\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct IpcRequest {\n    /// Request ID\n    #[serde(rename = \"id\")]\n    pub request_id: Option\u003cString\u003e,\n    /// Request type\n    pub request_type: IpcRequestType,\n    /// Topic to act on\n    pub topic: Option\u003cString\u003e,\n    /// Operation to perform (for service requests)\n    pub operation: Option\u003cString\u003e,\n    /// Data payload\n    pub data: Option\u003cValue\u003e,\n}\n\n#[derive(Debug, Serialize, Deserialize, Clone, PartialEq)]\npub enum IpcResponseStatus {\n    Success,\n    Error,\n}\n\n/// IPC Response\n#[derive(Debug, Serialize, Deserialize, Clone)]\npub struct IpcResponse {\n    pub request_id: String,\n    pub status: IpcResponseStatus,\n    pub message: Option\u003cString\u003e,\n    pub topic: Option\u003cString\u003e,\n    pub data: Option\u003cValue\u003e,\n    pub operation: Option\u003cString\u003e,\n}\n\n/// IPC Server for handling IPC requests\npub struct IpcServer {\n    /// Path to the socket file\n    socket_path: PathBuf,\n    /// Database connection\n    db: Arc\u003cSqliteDatabase\u003e,\n    /// Network ID\n    network_id: String,\n    /// Service registry\n    service_registry: Option\u003cArc\u003cServiceRegistry\u003e\u003e,\n    /// Task handle for the server\n    task_handle: Option\u003cJoinHandle\u003cResult\u003c()\u003e\u003e\u003e,\n}\n\nimpl IpcServer {\n    /// Create a new IPC server\n    pub fn new(socket_path: PathBuf, db: Arc\u003cSqliteDatabase\u003e, network_id: \u0026str) -\u003e Self {\n        IpcServer {\n            socket_path,\n            db,\n            network_id: network_id.to_string(),\n            service_registry: None,\n            task_handle: None,\n        }\n    }\n\n    /// Set the service registry\n    pub fn set_service_registry(\u0026mut self, service_registry: Arc\u003cServiceRegistry\u003e) {\n        self.service_registry = Some(service_registry);\n    }\n\n    /// Start the IPC server\n    pub async fn start(\u0026mut self) -\u003e Result\u003c()\u003e {\n        // Remove the socket file if it exists\n        if self.socket_path.exists() {\n            std::fs::remove_file(\u0026self.socket_path)?;\n        }\n\n        // Create the socket directory if it doesn't exist\n        if let Some(parent) = self.socket_path.parent() {\n            if !parent.exists() {\n                std::fs::create_dir_all(parent)?;\n            }\n        }\n\n        // Create the Unix socket listener\n        let listener = UnixListener::bind(\u0026self.socket_path)?;\n        info!(\"IPC server started on {:?}\", self.socket_path);\n\n        // Clone the service registry and database for the task\n        let service_registry = self.service_registry.clone();\n        let db = self.db.clone();\n        let network_id = self.network_id.clone();\n\n        // Spawn a task to handle incoming connections\n        let socket_path = self.socket_path.clone();\n        let task_handle = tokio::spawn(async move {\n            loop {\n                match listener.accept().await {\n                    Ok((stream, _)) =\u003e {\n                        // Clone the service registry and database for the connection\n                        let service_registry_clone = service_registry.clone();\n                        let db_clone = db.clone();\n                        let network_id_clone = network_id.clone();\n\n                        // Spawn a task to handle the connection\n                        tokio::spawn(async move {\n                            if let Err(e) = handle_connection(\n                                stream,\n                                service_registry_clone,\n                                db_clone,\n                                \u0026network_id_clone,\n                            )\n                            .await\n                            {\n                                error!(\"Error handling IPC connection: {}\", e);\n                            }\n                        });\n                    }\n                    Err(e) =\u003e {\n                        error!(\"Error accepting IPC connection: {}\", e);\n                    }\n                }\n            }\n        });\n\n        // Store the task handle\n        self.task_handle = Some(task_handle);\n\n        Ok(())\n    }\n\n    /// Stop the IPC server\n    pub async fn stop(\u0026mut self) -\u003e Result\u003c()\u003e {\n        // Cancel the task if it's running\n        if let Some(handle) = self.task_handle.take() {\n            handle.abort();\n        }\n\n        // Remove the socket file\n        if self.socket_path.exists() {\n            std::fs::remove_file(\u0026self.socket_path)?;\n        }\n\n        Ok(())\n    }\n\n    /// Create a service request from an IPC request\n    fn create_service_request(\u0026self, ipc_request: \u0026IpcRequest) -\u003e Result\u003cServiceRequest\u003e {\n        // Extract the service path and operation\n        let service_path = ipc_request\n            .topic\n            .as_ref()\n            .ok_or_else(|| anyhow!(\"No topic specified\"))?;\n        let operation = ipc_request\n            .operation\n            .as_ref()\n            .unwrap_or(\u0026\"\".to_string())\n            .to_string();\n\n        // Extract parameters\n        let parameters = match \u0026ipc_request.data {\n            Some(data) =\u003e ValueType::from_json(data.clone()),\n            None =\u003e ValueType::Null,\n        };\n\n        // Create a request context\n        let request_context = Arc::new(RequestContext::default());\n\n        // Create a new service request\n        Ok(ServiceRequest {\n            path: service_path.clone(),\n            operation,\n            params: parameters,\n            request_id: ipc_request.request_id.clone(),\n            request_context,\n        })\n    }\n\n    /// Create an IPC response from a service response\n    fn create_ipc_response(\n        \u0026self,\n        request_id: String,\n        topic: String,\n        service_response: ServiceResponse,\n    ) -\u003e IpcResponse {\n        // Create a new IPC response based on the service response\n        IpcResponse {\n            status: service_response.status.into(),\n            request_id,\n            topic: Some(topic),\n            message: Some(service_response.message),\n            data: service_response.data.map(|d| d.to_json()),\n            operation: None,\n        }\n    }\n}\n\n/// Handle an IPC connection\nasync fn handle_connection(\n    mut stream: UnixStream,\n    service_registry: Option\u003cArc\u003cServiceRegistry\u003e\u003e,\n    db: Arc\u003cSqliteDatabase\u003e,\n    network_id: \u0026str,\n) -\u003e Result\u003c()\u003e {\n    // Set a timeout for reading from the stream\n    stream.readable().await?;\n\n    // Read the request\n    let mut buffer = Vec::new();\n    stream.read_to_end(\u0026mut buffer).await?;\n\n    // Parse the request\n    let request: IpcRequest = serde_json::from_slice(\u0026buffer)?;\n\n    // Process the request\n    let response = process_request(request, service_registry, db, network_id).await?;\n\n    // Serialize the response\n    let response_json = serde_json::to_string(\u0026response)?;\n\n    // Write the response\n    stream.write_all(response_json.as_bytes()).await?;\n\n    Ok(())\n}\n\n/// Process an IPC request\nasync fn process_request(\n    request: IpcRequest,\n    service_registry: Option\u003cArc\u003cServiceRegistry\u003e\u003e,\n    db: Arc\u003cSqliteDatabase\u003e,\n    network_id: \u0026str,\n) -\u003e Result\u003cIpcResponse\u003e {\n    // Extract the request type\n    let request_type = request.request_type.clone();\n\n    // Process the request based on the type\n    match request_type {\n        IpcRequestType::Ping =\u003e {\n            // Simple ping request\n            Ok(IpcResponse::ping_success(\n                request\n                    .request_id\n                    .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                \"Pong\".to_string(),\n            ))\n        }\n        IpcRequestType::Echo =\u003e {\n            // Echo request\n            let data = request.data.unwrap_or(Value::Null);\n            Ok(IpcResponse::echo_success(\n                request\n                    .request_id\n                    .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                data,\n            ))\n        }\n        IpcRequestType::Request =\u003e {\n            // Request to a service\n            if let Some(ref topic) = request.topic {\n                if let Some(service_registry) = service_registry {\n                    // Create a service request\n                    let service_request = create_service_request(\u0026request)?;\n\n                    // Process the request through the service registry\n                    match service_registry.process_request(service_request).await {\n                        Ok(service_response) =\u003e {\n                            // Convert the service response to an IPC response\n                            create_ipc_response(\n                                request\n                                    .request_id\n                                    .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                                topic.clone(),\n                                service_response,\n                            )\n                        }\n                        Err(e) =\u003e {\n                            // Return an error response\n                            Ok(IpcResponse::error(\n                                request\n                                    .request_id\n                                    .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                                format!(\"Error processing request: {}\", e),\n                            ))\n                        }\n                    }\n                } else {\n                    Ok(IpcResponse::error(\n                        request\n                            .request_id\n                            .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                        \"Service registry not set\".to_string(),\n                    ))\n                }\n            } else {\n                Ok(IpcResponse::error(\n                    request\n                        .request_id\n                        .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                    \"Missing topic\".to_string(),\n                ))\n            }\n        }\n        IpcRequestType::Publish =\u003e {\n            // Publish to a topic (not implemented yet)\n            Ok(IpcResponse::publish_success(\n                request\n                    .request_id\n                    .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                request.topic.unwrap_or_default(),\n                request.data,\n            ))\n        }\n        IpcRequestType::Subscribe =\u003e {\n            // Subscribe to a topic (not implemented yet)\n            Ok(IpcResponse::subscribe_success(\n                request\n                    .request_id\n                    .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                request.topic.unwrap_or_default(),\n            ))\n        }\n        IpcRequestType::Unsubscribe =\u003e {\n            // Unsubscribe from a topic (not implemented yet)\n            Ok(IpcResponse::unsubscribe_success(\n                request\n                    .request_id\n                    .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                request.topic.unwrap_or_default(),\n            ))\n        }\n    }\n}\n\n// Helper function to create a service request from an IPC request\nfn create_service_request(request: \u0026IpcRequest) -\u003e Result\u003cServiceRequest\u003e {\n    // Extract the service path and operation\n    let service_path = request\n        .topic\n        .as_ref()\n        .ok_or_else(|| anyhow!(\"No topic specified\"))?;\n    let operation = request\n        .operation\n        .as_ref()\n        .unwrap_or(\u0026\"\".to_string())\n        .to_string();\n\n    // Extract parameters\n    let parameters = match \u0026request.data {\n        Some(data) =\u003e ValueType::from_json(data.clone()),\n        None =\u003e ValueType::Null,\n    };\n\n    // Create a request context\n    let request_context = Arc::new(RequestContext::default());\n\n    // Create a new service request\n    Ok(ServiceRequest {\n        path: service_path.clone(),\n        operation,\n        params: parameters,\n        request_id: request.request_id.clone(),\n        request_context,\n    })\n}\n\n// Helper function to create an IPC response from a service response\nfn create_ipc_response(\n    request_id: String,\n    topic: String,\n    service_response: ServiceResponse,\n) -\u003e Result\u003cIpcResponse\u003e {\n    // Create a new IPC response based on the service response\n    Ok(IpcResponse {\n        status: service_response.status.into(),\n        request_id,\n        topic: Some(topic),\n        message: Some(service_response.message),\n        data: service_response.data.map(|d| d.to_json()),\n        operation: None,\n    })\n}\n\n// Helper methods for creating IPC responses\nimpl IpcResponse {\n    /// Create a success response\n    pub fn success(request_id: String, topic: Option\u003cString\u003e, message: String) -\u003e Self {\n        IpcResponse {\n            request_id,\n            status: IpcResponseStatus::Success,\n            topic,\n            message: Some(message),\n            data: None,\n            operation: None,\n        }\n    }\n\n    /// Create an error response\n    pub fn error(request_id: String, message: String) -\u003e Self {\n        IpcResponse {\n            request_id,\n            status: IpcResponseStatus::Error,\n            topic: None,\n            message: Some(message),\n            data: None,\n            operation: None,\n        }\n    }\n\n    /// Create a ping success response\n    pub fn ping_success(request_id: String, message: String) -\u003e Self {\n        IpcResponse {\n            request_id,\n            status: IpcResponseStatus::Success,\n            topic: None,\n            message: Some(message),\n            data: None,\n            operation: None,\n        }\n    }\n\n    /// Create an echo success response\n    pub fn echo_success(request_id: String, data: Value) -\u003e Self {\n        IpcResponse {\n            request_id,\n            status: IpcResponseStatus::Success,\n            topic: None,\n            message: Some(\"Echo\".to_string()),\n            data: Some(data),\n            operation: None,\n        }\n    }\n\n    /// Create a publish success response\n    pub fn publish_success(request_id: String, topic: String, data: Option\u003cValue\u003e) -\u003e Self {\n        IpcResponse {\n            request_id,\n            status: IpcResponseStatus::Success,\n            topic: Some(topic),\n            message: Some(\"Published successfully\".to_string()),\n            data,\n            operation: None,\n        }\n    }\n\n    /// Create a subscribe success response\n    pub fn subscribe_success(request_id: String, topic: String) -\u003e Self {\n        IpcResponse {\n            request_id,\n            status: IpcResponseStatus::Success,\n            topic: Some(topic),\n            message: Some(\"Subscribed successfully\".to_string()),\n            data: None,\n            operation: None,\n        }\n    }\n\n    /// Create an unsubscribe success response\n    pub fn unsubscribe_success(request_id: String, topic: String) -\u003e Self {\n        IpcResponse {\n            request_id,\n            status: IpcResponseStatus::Success,\n            topic: Some(topic),\n            message: Some(\"Unsubscribed successfully\".to_string()),\n            data: None,\n            operation: None,\n        }\n    }\n}\n\n// Client implementation for connecting to the IPC server\npub struct IpcClient {\n    socket_path: PathBuf,\n    connection: Option\u003cUnixStream\u003e,\n    needs_reconnect: bool,\n}\n\nimpl IpcClient {\n    pub fn new(socket_path: PathBuf) -\u003e Self {\n        IpcClient {\n            socket_path,\n            connection: None,\n            needs_reconnect: true,\n        }\n    }\n\n    /// Connect to the IPC server\n    pub async fn connect(\u0026mut self) -\u003e Result\u003c()\u003e {\n        // If we already have a connection, check if it's still valid\n        if let Some(stream) = \u0026mut self.connection {\n            // Try to check if the connection is still valid\n            match stream.writable().await {\n                Ok(_) =\u003e {\n                    // Connection is still valid\n                    self.needs_reconnect = false;\n                    return Ok(());\n                }\n                Err(_) =\u003e {\n                    // Connection is no longer valid, need to reconnect\n                    self.connection = None;\n                    self.needs_reconnect = true;\n                }\n            }\n        }\n\n        // Try to connect with a timeout\n        let timeout_duration = Duration::from_secs(5);\n        let connect_result = tokio::time::timeout(timeout_duration, async {\n            UnixStream::connect(\u0026self.socket_path).await\n        })\n        .await;\n\n        match connect_result {\n            Ok(Ok(stream)) =\u003e {\n                // Successfully connected\n                self.connection = Some(stream);\n                self.needs_reconnect = false;\n                Ok(())\n            }\n            Ok(Err(e)) =\u003e {\n                // Connection error\n                self.connection = None;\n                self.needs_reconnect = true;\n                Err(anyhow!(\"Failed to connect to IPC server: {}\", e))\n            }\n            Err(_) =\u003e {\n                // Timeout\n                self.connection = None;\n                self.needs_reconnect = true;\n                Err(anyhow!(\"Timeout connecting to IPC server\"))\n            }\n        }\n    }\n\n    /// Disconnect from the IPC server\n    pub async fn disconnect(\u0026mut self) -\u003e Result\u003c()\u003e {\n        self.connection = None;\n        self.needs_reconnect = true;\n        Ok(())\n    }\n\n    /// Publish a message to a topic\n    pub async fn publish(\u0026mut self, topic: \u0026str, data: Option\u003cValue\u003e) -\u003e Result\u003cIpcResponse\u003e {\n        let request = IpcRequest {\n            request_id: Some(Uuid::new_v4().to_string()),\n            request_type: IpcRequestType::Publish,\n            topic: Some(topic.to_string()),\n            operation: None,\n            data,\n        };\n\n        self.send_request(request).await\n    }\n\n    /// Subscribe to a topic\n    pub async fn subscribe(\u0026mut self, topic: \u0026str) -\u003e Result\u003cIpcResponse\u003e {\n        let request = IpcRequest {\n            request_id: Some(Uuid::new_v4().to_string()),\n            request_type: IpcRequestType::Subscribe,\n            topic: Some(topic.to_string()),\n            operation: None,\n            data: None,\n        };\n\n        self.send_request(request).await\n    }\n\n    /// Request data from a topic\n    pub async fn request(\n        \u0026mut self,\n        topic: \u0026str,\n        operation: \u0026str,\n        data: Option\u003cValue\u003e,\n    ) -\u003e Result\u003cIpcResponse\u003e {\n        let request = IpcRequest {\n            request_id: Some(Uuid::new_v4().to_string()),\n            request_type: IpcRequestType::Request,\n            topic: Some(topic.to_string()),\n            operation: Some(operation.to_string()),\n            data,\n        };\n\n        self.send_request(request).await\n    }\n\n    /// Unsubscribe from a topic\n    pub async fn unsubscribe(\u0026mut self, topic: \u0026str) -\u003e Result\u003cIpcResponse\u003e {\n        let request = IpcRequest {\n            request_id: Some(Uuid::new_v4().to_string()),\n            request_type: IpcRequestType::Unsubscribe,\n            topic: Some(topic.to_string()),\n            operation: None,\n            data: None,\n        };\n\n        self.send_request(request).await\n    }\n\n    /// Send a request to the IPC server\n    async fn send_request(\u0026mut self, request: IpcRequest) -\u003e Result\u003cIpcResponse\u003e {\n        // Ensure we're connected\n        if self.needs_reconnect || self.connection.is_none() {\n            self.connect().await?;\n        }\n\n        // Serialize the request\n        let request_json = serde_json::to_string(\u0026request)?;\n\n        // Get the connection\n        let stream = self\n            .connection\n            .as_mut()\n            .ok_or_else(|| anyhow!(\"Not connected to IPC server\"))?;\n\n        // Write the request\n        match stream.write_all(request_json.as_bytes()).await {\n            Ok(_) =\u003e {\n                // Successfully wrote the request\n            }\n            Err(e) =\u003e {\n                // Write error, try to reconnect\n                self.needs_reconnect = true;\n                self.connection = None;\n                return Err(anyhow!(\"Failed to write to IPC server: {}\", e));\n            }\n        }\n\n        // Shutdown the write side to signal end of request\n        if let Err(e) = stream.shutdown().await {\n            // Shutdown error, try to reconnect\n            self.needs_reconnect = true;\n            self.connection = None;\n            return Err(anyhow!(\"Failed to shutdown write to IPC server: {}\", e));\n        }\n\n        // Read the response\n        let mut buffer = Vec::new();\n        match stream.read_to_end(\u0026mut buffer).await {\n            Ok(_) =\u003e {\n                // Successfully read the response\n            }\n            Err(e) =\u003e {\n                // Read error, try to reconnect\n                self.needs_reconnect = true;\n                self.connection = None;\n                return Err(anyhow!(\"Failed to read from IPC server: {}\", e));\n            }\n        }\n\n        // Parse the response\n        let response: IpcResponse = serde_json::from_slice(\u0026buffer)?;\n\n        // Need to reconnect for the next request since we've read to end\n        self.needs_reconnect = true;\n        self.connection = None;\n\n        Ok(response)\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use tempfile::tempdir;\n    use tokio::time::Duration;\n\n    #[tokio::test]\n    async fn test_ipc_server_start_stop() {\n        // Create a temporary directory for the socket\n        let temp_dir = tempdir().unwrap();\n        let socket_path = temp_dir.path().join(\"test.sock\");\n\n        // Create a test database\n        let db_path = temp_dir.path().join(\"test.db\");\n        let db = Arc::new(\n            SqliteDatabase::new(db_path.to_str().unwrap())\n                .await\n                .unwrap(),\n        );\n\n        // Create and start the IPC server\n        let mut server = IpcServer::new(socket_path.clone(), db, \"test_network\");\n\n        #[cfg(not(target_os = \"windows\"))]\n        {\n            // Start the server\n            server.start().await.unwrap();\n\n            // Check that the socket file exists\n            assert!(socket_path.exists());\n\n            // Stop the server\n            server.stop().await.unwrap();\n\n            // Check that the socket file is gone\n            assert!(!socket_path.exists());\n        }\n    }\n\n    #[tokio::test]\n    #[cfg(not(target_os = \"windows\"))]\n    async fn test_ipc_client_server_communication() {\n        // Create a test socket path\n        let temp_dir = tempdir().unwrap();\n        let socket_path = temp_dir.path().join(\"test.sock\");\n\n        // Create a test database\n        let db_path = temp_dir.path().join(\"test.db\");\n        let db = Arc::new(\n            SqliteDatabase::new(db_path.to_str().unwrap())\n                .await\n                .unwrap(),\n        );\n\n        // Create and start the IPC server\n        let mut server = IpcServer::new(socket_path.clone(), db, \"test_network\");\n        server.start().await.unwrap();\n\n        // Give the server a moment to start\n        tokio::time::sleep(Duration::from_millis(100)).await;\n\n        // Create and connect the IPC client\n        let mut client = IpcClient::new(socket_path.clone());\n        client.connect().await.unwrap();\n\n        // Send a publish request\n        let topic = \"test/topic\";\n        let data = Some(Value::String(\"test data\".to_string()));\n        let response = client.publish(topic, data).await.unwrap();\n\n        // Check the response\n        assert!(response.status == IpcResponseStatus::Success);\n        assert_eq!(response.message, Some(\"Published successfully\".to_string()));\n\n        // Disconnect the client\n        client.disconnect().await.unwrap();\n\n        // Stop the server\n        server.stop().await.unwrap();\n    }\n\n    // Additional tests for message integrity, etc.\n}\n","traces":[{"line":97,"address":[],"length":0,"stats":{"Line":5}},{"line":101,"address":[],"length":0,"stats":{"Line":5}},{"line":108,"address":[],"length":0,"stats":{"Line":3}},{"line":109,"address":[],"length":0,"stats":{"Line":3}},{"line":113,"address":[],"length":0,"stats":{"Line":8}},{"line":115,"address":[],"length":0,"stats":{"Line":3}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":6}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":6}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":3}},{"line":132,"address":[],"length":0,"stats":{"Line":3}},{"line":133,"address":[],"length":0,"stats":{"Line":3}},{"line":136,"address":[],"length":0,"stats":{"Line":3}},{"line":137,"address":[],"length":0,"stats":{"Line":5}},{"line":139,"address":[],"length":0,"stats":{"Line":6}},{"line":140,"address":[],"length":0,"stats":{"Line":4}},{"line":142,"address":[],"length":0,"stats":{"Line":4}},{"line":143,"address":[],"length":0,"stats":{"Line":4}},{"line":144,"address":[],"length":0,"stats":{"Line":4}},{"line":147,"address":[],"length":0,"stats":{"Line":8}},{"line":148,"address":[],"length":0,"stats":{"Line":4}},{"line":149,"address":[],"length":0,"stats":{"Line":4}},{"line":150,"address":[],"length":0,"stats":{"Line":4}},{"line":151,"address":[],"length":0,"stats":{"Line":4}},{"line":152,"address":[],"length":0,"stats":{"Line":4}},{"line":154,"address":[],"length":0,"stats":{"Line":4}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":8}},{"line":176,"address":[],"length":0,"stats":{"Line":6}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":3}},{"line":182,"address":[],"length":0,"stats":{"Line":3}},{"line":185,"address":[],"length":0,"stats":{"Line":3}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":10}},{"line":247,"address":[],"length":0,"stats":{"Line":4}},{"line":250,"address":[],"length":0,"stats":{"Line":4}},{"line":251,"address":[],"length":0,"stats":{"Line":4}},{"line":254,"address":[],"length":0,"stats":{"Line":8}},{"line":257,"address":[],"length":0,"stats":{"Line":4}},{"line":260,"address":[],"length":0,"stats":{"Line":8}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":4}},{"line":269,"address":[],"length":0,"stats":{"Line":10}},{"line":276,"address":[],"length":0,"stats":{"Line":4}},{"line":279,"address":[],"length":0,"stats":{"Line":4}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":6}},{"line":302,"address":[],"length":0,"stats":{"Line":3}},{"line":304,"address":[],"length":0,"stats":{"Line":3}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":3}},{"line":311,"address":[],"length":0,"stats":{"Line":3}},{"line":312,"address":[],"length":0,"stats":{"Line":3}},{"line":313,"address":[],"length":0,"stats":{"Line":6}},{"line":314,"address":[],"length":0,"stats":{"Line":3}},{"line":315,"address":[],"length":0,"stats":{"Line":3}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":338,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":1}},{"line":348,"address":[],"length":0,"stats":{"Line":1}},{"line":349,"address":[],"length":0,"stats":{"Line":1}},{"line":350,"address":[],"length":0,"stats":{"Line":1}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":9}},{"line":379,"address":[],"length":0,"stats":{"Line":18}},{"line":380,"address":[],"length":0,"stats":{"Line":9}},{"line":382,"address":[],"length":0,"stats":{"Line":18}},{"line":391,"address":[],"length":0,"stats":{"Line":9}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":9}},{"line":415,"address":[],"length":0,"stats":{"Line":9}},{"line":416,"address":[],"length":0,"stats":{"Line":9}},{"line":417,"address":[],"length":0,"stats":{"Line":9}},{"line":418,"address":[],"length":0,"stats":{"Line":9}},{"line":419,"address":[],"length":0,"stats":{"Line":9}},{"line":420,"address":[],"length":0,"stats":{"Line":24}},{"line":421,"address":[],"length":0,"stats":{"Line":9}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":1}},{"line":480,"address":[],"length":0,"stats":{"Line":1}},{"line":481,"address":[],"length":0,"stats":{"Line":1}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":4}},{"line":529,"address":[],"length":0,"stats":{"Line":14}},{"line":531,"address":[],"length":0,"stats":{"Line":4}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":4}},{"line":549,"address":[],"length":0,"stats":{"Line":8}},{"line":550,"address":[],"length":0,"stats":{"Line":4}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":554,"address":[],"length":0,"stats":{"Line":4}},{"line":555,"address":[],"length":0,"stats":{"Line":4}},{"line":557,"address":[],"length":0,"stats":{"Line":4}},{"line":558,"address":[],"length":0,"stats":{"Line":4}},{"line":559,"address":[],"length":0,"stats":{"Line":4}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":563,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":571,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":6}},{"line":578,"address":[],"length":0,"stats":{"Line":2}},{"line":579,"address":[],"length":0,"stats":{"Line":2}},{"line":580,"address":[],"length":0,"stats":{"Line":2}},{"line":584,"address":[],"length":0,"stats":{"Line":2}},{"line":586,"address":[],"length":0,"stats":{"Line":1}},{"line":588,"address":[],"length":0,"stats":{"Line":1}},{"line":593,"address":[],"length":0,"stats":{"Line":1}},{"line":597,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":601,"address":[],"length":0,"stats":{"Line":0}},{"line":606,"address":[],"length":0,"stats":{"Line":0}},{"line":610,"address":[],"length":0,"stats":{"Line":9}},{"line":617,"address":[],"length":0,"stats":{"Line":3}},{"line":619,"address":[],"length":0,"stats":{"Line":3}},{"line":620,"address":[],"length":0,"stats":{"Line":3}},{"line":624,"address":[],"length":0,"stats":{"Line":3}},{"line":628,"address":[],"length":0,"stats":{"Line":0}},{"line":630,"address":[],"length":0,"stats":{"Line":0}},{"line":632,"address":[],"length":0,"stats":{"Line":0}},{"line":637,"address":[],"length":0,"stats":{"Line":0}},{"line":641,"address":[],"length":0,"stats":{"Line":14}},{"line":643,"address":[],"length":0,"stats":{"Line":6}},{"line":644,"address":[],"length":0,"stats":{"Line":2}},{"line":648,"address":[],"length":0,"stats":{"Line":8}},{"line":651,"address":[],"length":0,"stats":{"Line":4}},{"line":652,"address":[],"length":0,"stats":{"Line":0}},{"line":654,"address":[],"length":0,"stats":{"Line":0}},{"line":657,"address":[],"length":0,"stats":{"Line":0}},{"line":658,"address":[],"length":0,"stats":{"Line":4}},{"line":661,"address":[],"length":0,"stats":{"Line":0}},{"line":663,"address":[],"length":0,"stats":{"Line":0}},{"line":664,"address":[],"length":0,"stats":{"Line":0}},{"line":665,"address":[],"length":0,"stats":{"Line":0}},{"line":670,"address":[],"length":0,"stats":{"Line":4}},{"line":672,"address":[],"length":0,"stats":{"Line":0}},{"line":673,"address":[],"length":0,"stats":{"Line":0}},{"line":674,"address":[],"length":0,"stats":{"Line":0}},{"line":678,"address":[],"length":0,"stats":{"Line":4}},{"line":679,"address":[],"length":0,"stats":{"Line":4}},{"line":680,"address":[],"length":0,"stats":{"Line":4}},{"line":683,"address":[],"length":0,"stats":{"Line":0}},{"line":685,"address":[],"length":0,"stats":{"Line":0}},{"line":686,"address":[],"length":0,"stats":{"Line":0}},{"line":687,"address":[],"length":0,"stats":{"Line":0}},{"line":692,"address":[],"length":0,"stats":{"Line":8}},{"line":695,"address":[],"length":0,"stats":{"Line":4}},{"line":696,"address":[],"length":0,"stats":{"Line":4}},{"line":698,"address":[],"length":0,"stats":{"Line":4}}],"covered":108,"coverable":233},{"path":["/","Users","rafael","dev","kagi","node","src","ipc_new.rs"],"content":"use anyhow::{anyhow, Result};\nuse log::{error, info};\nuse serde::{Deserialize, Serialize};\nuse serde_json::{json, Value};\nuse std::path::{Path, PathBuf};\nuse std::sync::Arc;\nuse std::time::Duration;\nuse tokio::io::{AsyncReadExt, AsyncWriteExt};\nuse tokio::net::{UnixListener, UnixStream};\nuse tokio::sync::mpsc;\nuse tokio::task::JoinHandle;\nuse uuid::Uuid;\n\nuse crate::db::SqliteDatabase;\nuse crate::services::registry::ServiceRegistry;\nuse crate::services::{\n    AbstractService, NodeRequestHandler, RequestContext, ServiceRequest, ServiceResponse, ValueType,\n};\n\n/// IPC Request Type\n#[derive(Debug, Serialize, Deserialize, Clone, Copy, PartialEq)]\npub enum IpcRequestType {\n    Ping,\n    Echo,\n    Request,\n    Publish,\n    Subscribe,\n    Unsubscribe,\n}\n\n/// IPC Request\n#[derive(Debug, Serialize, Deserialize, Clone)]\npub struct IpcRequest {\n    /// Request ID\n    #[serde(rename = \"id\")]\n    pub request_id: Option\u003cString\u003e,\n    /// Request type\n    pub request_type: IpcRequestType,\n    /// Topic to act on\n    pub topic: Option\u003cString\u003e,\n    /// Operation to perform (for service requests)\n    pub operation: Option\u003cString\u003e,\n    /// Data payload\n    pub data: Option\u003cValue\u003e,\n}\n\n#[derive(Debug, Serialize, Deserialize, Clone, PartialEq)]\npub enum IpcResponseStatus {\n    Success,\n    Error,\n}\n\n/// IPC Response\n#[derive(Debug, Serialize, Deserialize, Clone)]\npub struct IpcResponse {\n    pub request_id: String,\n    pub status: IpcResponseStatus,\n    pub message: Option\u003cString\u003e,\n    pub topic: Option\u003cString\u003e,\n    pub data: Option\u003cValue\u003e,\n    pub operation: Option\u003cString\u003e,\n}\n\nimpl IpcResponse {\n    /// Create a success response for a ping request\n    pub fn ping_success(request_id: String, message: String) -\u003e Self {\n        IpcResponse {\n            request_id,\n            status: IpcResponseStatus::Success,\n            message: Some(message),\n            topic: None,\n            data: None,\n            operation: None,\n        }\n    }\n\n    /// Create a success response for an echo request\n    pub fn echo_success(request_id: String, data: Value) -\u003e Self {\n        IpcResponse {\n            request_id,\n            status: IpcResponseStatus::Success,\n            message: Some(\"Echo successful\".to_string()),\n            topic: None,\n            data: Some(data),\n            operation: None,\n        }\n    }\n\n    /// Create a success response for a service request\n    pub fn service_success(\n        request_id: String,\n        topic: Option\u003cString\u003e,\n        data: Value,\n        operation: Option\u003cString\u003e,\n    ) -\u003e Self {\n        IpcResponse {\n            request_id,\n            status: IpcResponseStatus::Success,\n            message: Some(\"Service request successful\".to_string()),\n            topic,\n            data: Some(data),\n            operation,\n        }\n    }\n\n    /// Create an error response\n    pub fn error(request_id: String, message: String) -\u003e Self {\n        IpcResponse {\n            request_id,\n            status: IpcResponseStatus::Error,\n            message: Some(message),\n            topic: None,\n            data: None,\n            operation: None,\n        }\n    }\n}\n\n/// IPC Server for handling IPC requests\npub struct IpcServer {\n    /// Path to the socket file\n    socket_path: PathBuf,\n    /// Database connection\n    db: Arc\u003cSqliteDatabase\u003e,\n    /// Network ID\n    network_id: String,\n    /// Service registry\n    service_registry: Option\u003cArc\u003cServiceRegistry\u003e\u003e,\n    /// Task handle for the server\n    task_handle: Option\u003cJoinHandle\u003cResult\u003c()\u003e\u003e\u003e,\n}\n\nimpl IpcServer {\n    /// Create a new IPC server\n    pub fn new(socket_path: PathBuf, db: Arc\u003cSqliteDatabase\u003e, network_id: \u0026str) -\u003e Self {\n        IpcServer {\n            socket_path,\n            db,\n            network_id: network_id.to_string(),\n            service_registry: None,\n            task_handle: None,\n        }\n    }\n\n    /// Set the service registry\n    pub fn set_service_registry(\u0026mut self, service_registry: Arc\u003cServiceRegistry\u003e) {\n        self.service_registry = Some(service_registry);\n    }\n\n    /// Start the IPC server\n    pub async fn start(\u0026mut self) -\u003e Result\u003c()\u003e {\n        // Check if the server is already running\n        if self.task_handle.is_some() {\n            return Ok(());\n        }\n\n        // Create the socket path if it doesn't exist\n        if let Some(parent) = self.socket_path.parent() {\n            if !parent.exists() {\n                std::fs::create_dir_all(parent)?;\n            }\n        }\n\n        // Remove the socket file if it already exists\n        if self.socket_path.exists() {\n            std::fs::remove_file(\u0026self.socket_path)?;\n        }\n\n        // Create the Unix socket listener\n        let listener = UnixListener::bind(\u0026self.socket_path)?;\n        info!(\"IPC server started on {:?}\", self.socket_path);\n\n        // Clone the necessary data for the server task\n        let socket_path = self.socket_path.clone();\n        let db = self.db.clone();\n        let network_id = self.network_id.clone();\n        let service_registry = self.service_registry.clone();\n\n        // Spawn the server task\n        let task_handle = tokio::spawn(async move {\n            loop {\n                match listener.accept().await {\n                    Ok((stream, _)) =\u003e {\n                        // Clone the necessary data for the connection task\n                        let db = db.clone();\n                        let network_id = network_id.clone();\n                        let service_registry = service_registry.clone();\n\n                        // Spawn a task to handle the connection\n                        tokio::spawn(async move {\n                            if let Err(e) =\n                                handle_connection(stream, service_registry, db, \u0026network_id).await\n                            {\n                                error!(\"Error handling IPC connection: {}\", e);\n                            }\n                        });\n                    }\n                    Err(e) =\u003e {\n                        error!(\"Error accepting IPC connection: {}\", e);\n                    }\n                }\n            }\n        });\n\n        self.task_handle = Some(task_handle);\n        Ok(())\n    }\n\n    /// Stop the IPC server\n    pub async fn stop(\u0026mut self) -\u003e Result\u003c()\u003e {\n        // Check if the server is running\n        if let Some(task_handle) = self.task_handle.take() {\n            // Abort the server task\n            task_handle.abort();\n        }\n\n        // Remove the socket file\n        if self.socket_path.exists() {\n            std::fs::remove_file(\u0026self.socket_path)?;\n        }\n\n        Ok(())\n    }\n}\n\n/// Handle an IPC connection\nasync fn handle_connection(\n    mut stream: UnixStream,\n    service_registry: Option\u003cArc\u003cServiceRegistry\u003e\u003e,\n    db: Arc\u003cSqliteDatabase\u003e,\n    network_id: \u0026str,\n) -\u003e Result\u003c()\u003e {\n    // Buffer for reading data\n    let mut buffer = [0u8; 65536];\n\n    // Read data from the stream\n    let n = stream.read(\u0026mut buffer).await?;\n    if n == 0 {\n        return Ok(());\n    }\n\n    // Parse the request\n    let request_str = std::str::from_utf8(\u0026buffer[..n])?;\n    let request: IpcRequest = serde_json::from_str(request_str)?;\n\n    // Process the request\n    let response = process_request(request, service_registry, db, network_id).await?;\n\n    // Serialize the response\n    let response_str = serde_json::to_string(\u0026response)?;\n\n    // Write the response to the stream\n    stream.write_all(response_str.as_bytes()).await?;\n\n    Ok(())\n}\n\n/// Process an IPC request\nasync fn process_request(\n    request: IpcRequest,\n    service_registry: Option\u003cArc\u003cServiceRegistry\u003e\u003e,\n    db: Arc\u003cSqliteDatabase\u003e,\n    network_id: \u0026str,\n) -\u003e Result\u003cIpcResponse\u003e {\n    // Extract the request type\n    let request_type = request.request_type.clone();\n\n    // Process the request based on the type\n    match request_type {\n        IpcRequestType::Ping =\u003e {\n            // Simple ping request\n            Ok(IpcResponse::ping_success(\n                request\n                    .request_id\n                    .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                \"Pong\".to_string(),\n            ))\n        }\n        IpcRequestType::Echo =\u003e {\n            // Echo request\n            let data = request.data.unwrap_or(Value::Null);\n            Ok(IpcResponse::echo_success(\n                request\n                    .request_id\n                    .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                data,\n            ))\n        }\n        IpcRequestType::Request =\u003e {\n            // Request to a service\n            if let Some(topic) = \u0026request.topic {\n                if let Some(service_registry) = service_registry {\n                    // Create a service request\n                    let service_request = create_service_request(\u0026request)?;\n\n                    // Process the request through the service registry\n                    match service_registry.process_request(service_request).await {\n                        Ok(service_response) =\u003e {\n                            // Convert the service response to an IPC response\n                            create_ipc_response(\n                                request\n                                    .request_id\n                                    .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                                topic.clone(),\n                                service_response,\n                                request.operation.clone(),\n                            )\n                        }\n                        Err(e) =\u003e {\n                            // Return an error response\n                            Ok(IpcResponse::error(\n                                request\n                                    .request_id\n                                    .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                                format!(\"Error processing service request: {}\", e),\n                            ))\n                        }\n                    }\n                } else {\n                    // No service registry available\n                    Ok(IpcResponse::error(\n                        request\n                            .request_id\n                            .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                        \"No service registry available\".to_string(),\n                    ))\n                }\n            } else {\n                // No topic provided\n                Ok(IpcResponse::error(\n                    request\n                        .request_id\n                        .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                    \"No topic provided\".to_string(),\n                ))\n            }\n        }\n        IpcRequestType::Publish =\u003e {\n            // Publish a message to a topic\n            if let Some(topic) = \u0026request.topic {\n                if let Some(service_registry) = service_registry {\n                    // Convert the data to ValueType\n                    let data = match \u0026request.data {\n                        Some(value) =\u003e ValueType::from_json(value.clone()),\n                        None =\u003e ValueType::Null,\n                    };\n\n                    // Publish the message\n                    match service_registry.publish(topic.clone(), data).await {\n                        Ok(_) =\u003e {\n                            // Return a success response\n                            Ok(IpcResponse::service_success(\n                                request\n                                    .request_id\n                                    .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                                Some(topic.clone()),\n                                json!({\"published\": true}),\n                                None,\n                            ))\n                        }\n                        Err(e) =\u003e {\n                            // Return an error response\n                            Ok(IpcResponse::error(\n                                request\n                                    .request_id\n                                    .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                                format!(\"Error publishing message: {}\", e),\n                            ))\n                        }\n                    }\n                } else {\n                    // No service registry available\n                    Ok(IpcResponse::error(\n                        request\n                            .request_id\n                            .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                        \"No service registry available\".to_string(),\n                    ))\n                }\n            } else {\n                // No topic provided\n                Ok(IpcResponse::error(\n                    request\n                        .request_id\n                        .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                    \"No topic provided\".to_string(),\n                ))\n            }\n        }\n        IpcRequestType::Subscribe =\u003e {\n            // Subscribe to a topic\n            if let Some(topic) = \u0026request.topic {\n                if let Some(service_registry) = service_registry {\n                    // Create a subscription\n                    // TODO: Implement subscription handling\n                    Ok(IpcResponse::service_success(\n                        request\n                            .request_id\n                            .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                        Some(topic.clone()),\n                        json!({\"subscribed\": true}),\n                        None,\n                    ))\n                } else {\n                    // No service registry available\n                    Ok(IpcResponse::error(\n                        request\n                            .request_id\n                            .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                        \"No service registry available\".to_string(),\n                    ))\n                }\n            } else {\n                // No topic provided\n                Ok(IpcResponse::error(\n                    request\n                        .request_id\n                        .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                    \"No topic provided\".to_string(),\n                ))\n            }\n        }\n        IpcRequestType::Unsubscribe =\u003e {\n            // Unsubscribe from a topic\n            if let Some(topic) = \u0026request.topic {\n                if let Some(service_registry) = service_registry {\n                    // Remove the subscription\n                    // TODO: Implement unsubscription handling\n                    Ok(IpcResponse::service_success(\n                        request\n                            .request_id\n                            .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                        Some(topic.clone()),\n                        json!({\"unsubscribed\": true}),\n                        None,\n                    ))\n                } else {\n                    // No service registry available\n                    Ok(IpcResponse::error(\n                        request\n                            .request_id\n                            .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                        \"No service registry available\".to_string(),\n                    ))\n                }\n            } else {\n                // No topic provided\n                Ok(IpcResponse::error(\n                    request\n                        .request_id\n                        .unwrap_or_else(|| Uuid::new_v4().to_string()),\n                    \"No topic provided\".to_string(),\n                ))\n            }\n        }\n    }\n}\n\n/// Helper function to create a service request from an IPC request\nfn create_service_request(request: \u0026IpcRequest) -\u003e Result\u003cServiceRequest\u003e {\n    // Extract the service path and operation\n    let topic = request\n        .topic\n        .as_ref()\n        .ok_or_else(|| anyhow!(\"No topic provided\"))?;\n    let operation = request\n        .operation\n        .as_ref()\n        .ok_or_else(|| anyhow!(\"No operation provided\"))?;\n\n    // Extract parameters\n    let parameters = request.data.clone().unwrap_or(Value::Null);\n\n    // Create a dummy request context\n    let request_context = Arc::new(RequestContext::default());\n\n    // Create a new service request\n    Ok(ServiceRequest {\n        request_id: request.request_id.clone(),\n        path: topic.clone(),\n        operation: operation.clone(),\n        params: ValueType::from_json(parameters),\n        request_context,\n    })\n}\n\n/// Helper function to create an IPC response from a service response\nfn create_ipc_response(\n    request_id: String,\n    topic: String,\n    service_response: ServiceResponse,\n    operation: Option\u003cString\u003e,\n) -\u003e Result\u003cIpcResponse\u003e {\n    // Create IPC response based on the service response status\n    let status: IpcResponseStatus = service_response.status.into();\n\n    Ok(IpcResponse {\n        status,\n        request_id,\n        message: Some(service_response.message),\n        topic: Some(topic),\n        data: service_response.data.map(|d| d.to_json()),\n        operation,\n    })\n}\n\n/// IPC Client for communicating with the IPC server\npub struct IpcClient {\n    /// Path to the socket file\n    socket_path: PathBuf,\n    /// Connection to the server\n    connection: Option\u003cUnixStream\u003e,\n    /// Flag indicating if we need to reconnect\n    needs_reconnect: bool,\n}\n\nimpl IpcClient {\n    /// Create a new IPC client\n    pub fn new\u003cP: AsRef\u003cPath\u003e\u003e(socket_path: P) -\u003e Self {\n        IpcClient {\n            socket_path: socket_path.as_ref().to_path_buf(),\n            connection: None,\n            needs_reconnect: true,\n        }\n    }\n\n    /// Connect to the IPC server\n    pub async fn connect(\u0026mut self) -\u003e Result\u003c()\u003e {\n        // If we already have a connection, check if it's still valid\n        if let Some(stream) = \u0026mut self.connection {\n            // Try to check if the connection is still valid\n            match stream.writable().await {\n                Ok(_) =\u003e {\n                    // Connection is still valid\n                    self.needs_reconnect = false;\n                    return Ok(());\n                }\n                Err(_) =\u003e {\n                    // Connection is no longer valid, need to reconnect\n                    self.connection = None;\n                    self.needs_reconnect = true;\n                }\n            }\n        }\n\n        // Try to connect with a timeout\n        let timeout_duration = Duration::from_secs(5);\n        let connect_result = tokio::time::timeout(timeout_duration, async {\n            UnixStream::connect(\u0026self.socket_path).await\n        })\n        .await;\n\n        match connect_result {\n            Ok(Ok(stream)) =\u003e {\n                // Successfully connected\n                self.connection = Some(stream);\n                self.needs_reconnect = false;\n                Ok(())\n            }\n            Ok(Err(e)) =\u003e {\n                // Connection error\n                self.connection = None;\n                self.needs_reconnect = true;\n                Err(anyhow!(\"Failed to connect to IPC server: {}\", e))\n            }\n            Err(_) =\u003e {\n                // Timeout\n                self.connection = None;\n                self.needs_reconnect = true;\n                Err(anyhow!(\"Timeout connecting to IPC server\"))\n            }\n        }\n    }\n\n    /// Disconnect from the IPC server\n    pub async fn disconnect(\u0026mut self) -\u003e Result\u003c()\u003e {\n        self.connection = None;\n        self.needs_reconnect = true;\n        Ok(())\n    }\n\n    /// Send a request to the IPC server\n    async fn send_request(\u0026mut self, request: IpcRequest) -\u003e Result\u003cIpcResponse\u003e {\n        // Connect to the server if needed\n        if self.needs_reconnect {\n            self.connect().await?;\n        }\n\n        // Serialize the request\n        let request_str = serde_json::to_string(\u0026request)?;\n\n        // Get the connection\n        let stream = self\n            .connection\n            .as_mut()\n            .ok_or_else(|| anyhow!(\"Not connected to IPC server\"))?;\n\n        // Write the request to the stream\n        stream.write_all(request_str.as_bytes()).await?;\n\n        // Buffer for reading the response\n        let mut buffer = [0u8; 65536];\n\n        // Read the response from the stream\n        let n = stream.read(\u0026mut buffer).await?;\n        if n == 0 {\n            return Err(anyhow!(\"Connection closed by server\"));\n        }\n\n        // Parse the response\n        let response_str = std::str::from_utf8(\u0026buffer[..n])?;\n        let response: IpcResponse = serde_json::from_str(response_str)?;\n\n        Ok(response)\n    }\n\n    /// Ping the IPC server\n    pub async fn ping(\u0026mut self) -\u003e Result\u003cIpcResponse\u003e {\n        let request = IpcRequest {\n            request_id: Some(Uuid::new_v4().to_string()),\n            request_type: IpcRequestType::Ping,\n            topic: None,\n            operation: None,\n            data: None,\n        };\n\n        self.send_request(request).await\n    }\n\n    /// Echo a message\n    pub async fn echo(\u0026mut self, data: Value) -\u003e Result\u003cIpcResponse\u003e {\n        let request = IpcRequest {\n            request_id: Some(Uuid::new_v4().to_string()),\n            request_type: IpcRequestType::Echo,\n            topic: None,\n            operation: None,\n            data: Some(data),\n        };\n\n        self.send_request(request).await\n    }\n\n    /// Publish a message to a topic\n    pub async fn publish(\u0026mut self, topic: \u0026str, data: Option\u003cValue\u003e) -\u003e Result\u003cIpcResponse\u003e {\n        let request = IpcRequest {\n            request_id: Some(Uuid::new_v4().to_string()),\n            request_type: IpcRequestType::Publish,\n            topic: Some(topic.to_string()),\n            operation: None,\n            data,\n        };\n\n        self.send_request(request).await\n    }\n\n    /// Subscribe to a topic\n    pub async fn subscribe(\u0026mut self, topic: \u0026str) -\u003e Result\u003cIpcResponse\u003e {\n        let request = IpcRequest {\n            request_id: Some(Uuid::new_v4().to_string()),\n            request_type: IpcRequestType::Subscribe,\n            topic: Some(topic.to_string()),\n            operation: None,\n            data: None,\n        };\n\n        self.send_request(request).await\n    }\n\n    /// Unsubscribe from a topic\n    pub async fn unsubscribe(\u0026mut self, topic: \u0026str) -\u003e Result\u003cIpcResponse\u003e {\n        let request = IpcRequest {\n            request_id: Some(Uuid::new_v4().to_string()),\n            request_type: IpcRequestType::Unsubscribe,\n            topic: Some(topic.to_string()),\n            operation: None,\n            data: None,\n        };\n\n        self.send_request(request).await\n    }\n\n    /// Send a request to a service\n    pub async fn request(\n        \u0026mut self,\n        topic: \u0026str,\n        operation: \u0026str,\n        data: Option\u003cValue\u003e,\n    ) -\u003e Result\u003cIpcResponse\u003e {\n        let request = IpcRequest {\n            request_id: Some(Uuid::new_v4().to_string()),\n            request_type: IpcRequestType::Request,\n            topic: Some(topic.to_string()),\n            operation: Some(operation.to_string()),\n            data,\n        };\n\n        self.send_request(request).await\n    }\n}\n\nimpl From\u003ccrate::services::ResponseStatus\u003e for IpcResponseStatus {\n    fn from(status: crate::services::ResponseStatus) -\u003e Self {\n        match status {\n            crate::services::ResponseStatus::Success =\u003e IpcResponseStatus::Success,\n            crate::services::ResponseStatus::Error =\u003e IpcResponseStatus::Error,\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use std::path::PathBuf;\n    use tokio::test;\n\n    use super::*;\n}\n","traces":[{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":498,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":551,"address":[],"length":0,"stats":{"Line":0}},{"line":553,"address":[],"length":0,"stats":{"Line":0}},{"line":554,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":563,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":576,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":579,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":585,"address":[],"length":0,"stats":{"Line":0}},{"line":586,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":605,"address":[],"length":0,"stats":{"Line":0}},{"line":606,"address":[],"length":0,"stats":{"Line":0}},{"line":607,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":612,"address":[],"length":0,"stats":{"Line":0}},{"line":614,"address":[],"length":0,"stats":{"Line":0}},{"line":618,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":627,"address":[],"length":0,"stats":{"Line":0}},{"line":631,"address":[],"length":0,"stats":{"Line":0}},{"line":633,"address":[],"length":0,"stats":{"Line":0}},{"line":637,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":644,"address":[],"length":0,"stats":{"Line":0}},{"line":646,"address":[],"length":0,"stats":{"Line":0}},{"line":648,"address":[],"length":0,"stats":{"Line":0}},{"line":653,"address":[],"length":0,"stats":{"Line":0}},{"line":657,"address":[],"length":0,"stats":{"Line":0}},{"line":659,"address":[],"length":0,"stats":{"Line":0}},{"line":661,"address":[],"length":0,"stats":{"Line":0}},{"line":666,"address":[],"length":0,"stats":{"Line":0}},{"line":670,"address":[],"length":0,"stats":{"Line":0}},{"line":672,"address":[],"length":0,"stats":{"Line":0}},{"line":674,"address":[],"length":0,"stats":{"Line":0}},{"line":679,"address":[],"length":0,"stats":{"Line":0}},{"line":683,"address":[],"length":0,"stats":{"Line":0}},{"line":690,"address":[],"length":0,"stats":{"Line":0}},{"line":692,"address":[],"length":0,"stats":{"Line":0}},{"line":693,"address":[],"length":0,"stats":{"Line":0}},{"line":697,"address":[],"length":0,"stats":{"Line":0}},{"line":702,"address":[],"length":0,"stats":{"Line":0}},{"line":703,"address":[],"length":0,"stats":{"Line":0}},{"line":704,"address":[],"length":0,"stats":{"Line":0}},{"line":705,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":264},{"path":["/","Users","rafael","dev","kagi","node","src","key_management.rs"],"content":"use anyhow::{anyhow, Result};\nuse chacha20poly1305::{\n    aead::{Aead, KeyInit},\n    ChaCha20Poly1305, Nonce,\n};\nuse ed25519_dalek::{Keypair, Signature, Signer, Verifier};\nuse hkdf::Hkdf;\nuse rand::Rng;\nuse serde::{Deserialize, Serialize};\nuse sha2::Sha256;\nuse std::collections::HashMap;\nuse std::fs;\nuse std::path::Path;\nuse std::time::{Duration, Instant};\n\n/// The type of key used in the Kagi network\n#[derive(Debug, Copy, Clone, PartialEq, Eq, Hash, Serialize, Deserialize)]\npub enum KeyType {\n    /// Network identity key used for P2P connections\n    Network,\n    /// Node identity key used for signing data\n    Node,\n    /// User identity key for authentication\n    User,\n    /// Temporary key for ephemeral operations\n    Temporary,\n}\n\n/// A keypair with additional metadata for the Kagi network\n#[derive(Debug)]\npub struct KagiKeypair {\n    /// The underlying keypair\n    keypair: Keypair,\n    /// The type of key\n    key_type: KeyType,\n    /// When the key was created\n    created_at: Instant,\n    /// Optional expiration for temporary keys\n    expires_at: Option\u003cInstant\u003e,\n}\n\nimpl KagiKeypair {\n    /// Create a new keypair of the specified type\n    pub fn new(key_type: KeyType, expiration: Option\u003cDuration\u003e) -\u003e Result\u003cSelf\u003e {\n        // For now, use a non-cryptographic RNG during testing\n        // In production, we should use a proper cryptographic RNG\n        let mut seed = [0u8; 32];\n        rand::thread_rng().fill(\u0026mut seed);\n\n        let secret = ed25519_dalek::SecretKey::from_bytes(\u0026seed)\n            .map_err(|e| anyhow!(\"Failed to create secret key: {}\", e))?;\n        let public = ed25519_dalek::PublicKey::from(\u0026secret);\n\n        let keypair = Keypair { secret, public };\n\n        Ok(Self {\n            keypair,\n            key_type,\n            created_at: Instant::now(),\n            expires_at: expiration.map(|d| Instant::now() + d),\n        })\n    }\n\n    /// Create a keypair from existing key bytes\n    pub fn from_bytes(\n        key_type: KeyType,\n        bytes: \u0026[u8],\n        expiration: Option\u003cDuration\u003e,\n    ) -\u003e Result\u003cSelf\u003e {\n        if bytes.len() != 64 {\n            return Err(anyhow!(\"Invalid keypair length: {}\", bytes.len()));\n        }\n\n        let keypair =\n            Keypair::from_bytes(bytes).map_err(|e| anyhow!(\"Failed to create keypair: {}\", e))?;\n\n        Ok(Self {\n            keypair,\n            key_type,\n            created_at: Instant::now(),\n            expires_at: expiration.map(|d| Instant::now() + d),\n        })\n    }\n\n    /// Check if the key has expired\n    pub fn is_expired(\u0026self) -\u003e bool {\n        match self.expires_at {\n            Some(instant) =\u003e instant \u003c= Instant::now(),\n            None =\u003e false,\n        }\n    }\n\n    /// Get the key type\n    pub fn key_type(\u0026self) -\u003e KeyType {\n        self.key_type\n    }\n\n    /// Get the public key bytes\n    pub fn public_key_bytes(\u0026self) -\u003e \u0026[u8; 32] {\n        self.keypair.public.as_bytes()\n    }\n\n    /// Get the keypair bytes\n    pub fn keypair_bytes(\u0026self) -\u003e [u8; 64] {\n        self.keypair.to_bytes()\n    }\n\n    /// Sign a message using the private key\n    pub fn sign(\u0026self, message: \u0026[u8]) -\u003e Signature {\n        self.keypair.sign(message)\n    }\n\n    /// Verify a signature using the public key\n    pub fn verify(\u0026self, message: \u0026[u8], signature: \u0026Signature) -\u003e bool {\n        self.keypair.verify(message, signature).is_ok()\n    }\n\n    /// Encrypt data using ChaCha20Poly1305\n    pub fn encrypt(\u0026self, plaintext: \u0026[u8]) -\u003e Result\u003cVec\u003cu8\u003e\u003e {\n        // Derive an encryption key from our keypair\n        let salt = b\"kagi-encryption\";\n        let hkdf = Hkdf::\u003cSha256\u003e::new(Some(salt), self.keypair.secret.as_bytes());\n        let mut enc_key = [0u8; 32];\n        hkdf.expand(b\"chacha20poly1305-key\", \u0026mut enc_key)\n            .map_err(|_| anyhow!(\"Failed to derive encryption key\"))?;\n\n        // Create the ChaCha20Poly1305 cipher\n        let cipher = ChaCha20Poly1305::new_from_slice(\u0026enc_key)\n            .map_err(|_| anyhow!(\"Failed to create ChaCha20Poly1305 cipher\"))?;\n\n        // Generate a random nonce\n        let mut nonce_bytes = [0u8; 12];\n        rand::thread_rng().fill(\u0026mut nonce_bytes);\n        let nonce = Nonce::from_slice(\u0026nonce_bytes);\n\n        // Encrypt the plaintext\n        let ciphertext = cipher\n            .encrypt(nonce, plaintext)\n            .map_err(|_| anyhow!(\"Encryption failed\"))?;\n\n        // Combine nonce and ciphertext\n        let mut result = Vec::with_capacity(nonce_bytes.len() + ciphertext.len());\n        result.extend_from_slice(\u0026nonce_bytes);\n        result.extend_from_slice(\u0026ciphertext);\n\n        Ok(result)\n    }\n\n    /// Decrypt data using ChaCha20Poly1305\n    pub fn decrypt(\u0026self, ciphertext: \u0026[u8]) -\u003e Result\u003cVec\u003cu8\u003e\u003e {\n        if ciphertext.len() \u003c 12 {\n            return Err(anyhow!(\"Ciphertext too short\"));\n        }\n\n        // Extract nonce and ciphertext\n        let nonce = Nonce::from_slice(\u0026ciphertext[..12]);\n        let actual_ciphertext = \u0026ciphertext[12..];\n\n        // Derive the encryption key\n        let salt = b\"kagi-encryption\";\n        let hkdf = Hkdf::\u003cSha256\u003e::new(Some(salt), self.keypair.secret.as_bytes());\n        let mut enc_key = [0u8; 32];\n        hkdf.expand(b\"chacha20poly1305-key\", \u0026mut enc_key)\n            .map_err(|_| anyhow!(\"Failed to derive encryption key\"))?;\n\n        // Create the ChaCha20Poly1305 cipher\n        let cipher = ChaCha20Poly1305::new_from_slice(\u0026enc_key)\n            .map_err(|_| anyhow!(\"Failed to create ChaCha20Poly1305 cipher\"))?;\n\n        // Decrypt the ciphertext\n        let plaintext = cipher\n            .decrypt(nonce, actual_ciphertext)\n            .map_err(|_| anyhow!(\"Decryption failed\"))?;\n\n        Ok(plaintext)\n    }\n}\n\n/// The KeyManager manages the lifecycle of keys\npub struct KeyManager {\n    /// The keys managed by this instance\n    keys: HashMap\u003cKeyType, KagiKeypair\u003e,\n    /// The config directory where keys are stored\n    config_dir: String,\n}\n\nimpl KeyManager {\n    /// Create a new key manager\n    pub fn new(config_dir: \u0026str) -\u003e Result\u003cSelf\u003e {\n        // Ensure the config directory exists\n        let path = Path::new(config_dir);\n        if !path.exists() {\n            fs::create_dir_all(path)?;\n        }\n\n        Ok(Self {\n            keys: HashMap::new(),\n            config_dir: config_dir.to_string(),\n        })\n    }\n\n    /// Generate a new keypair\n    pub fn generate_keypair() -\u003e Result\u003cKeypair\u003e {\n        // For now, use a non-cryptographic RNG during testing\n        // In production, we should use a proper cryptographic RNG\n        let mut seed = [0u8; 32];\n        rand::thread_rng().fill(\u0026mut seed);\n\n        let secret = ed25519_dalek::SecretKey::from_bytes(\u0026seed)\n            .map_err(|e| anyhow!(\"Failed to create secret key: {}\", e))?;\n        let public = ed25519_dalek::PublicKey::from(\u0026secret);\n\n        Ok(Keypair { secret, public })\n    }\n\n    /// Load or create the node key\n    pub fn load_or_create_node_key(\u0026mut self) -\u003e Result\u003c\u0026KagiKeypair\u003e {\n        if self.keys.contains_key(\u0026KeyType::Node) {\n            return Ok(\u0026self.keys[\u0026KeyType::Node]);\n        }\n\n        let key_path = Path::new(\u0026self.config_dir).join(\"node_key\");\n\n        if key_path.exists() {\n            // Load existing key\n            let bytes = fs::read(\u0026key_path)?;\n            let keypair = KagiKeypair::from_bytes(KeyType::Node, \u0026bytes, None)?;\n            self.keys.insert(KeyType::Node, keypair);\n        } else {\n            // Create new key\n            let keypair = KagiKeypair::new(KeyType::Node, None)?;\n            fs::write(\u0026key_path, \u0026keypair.keypair_bytes())?;\n            self.keys.insert(KeyType::Node, keypair);\n        }\n\n        Ok(\u0026self.keys[\u0026KeyType::Node])\n    }\n\n    /// Load or create the network key\n    pub fn load_or_create_network_key(\u0026mut self) -\u003e Result\u003c\u0026KagiKeypair\u003e {\n        if self.keys.contains_key(\u0026KeyType::Network) {\n            return Ok(\u0026self.keys[\u0026KeyType::Network]);\n        }\n\n        let key_path = Path::new(\u0026self.config_dir).join(\"network_key\");\n\n        if key_path.exists() {\n            // Load existing key\n            let bytes = fs::read(\u0026key_path)?;\n            let keypair = KagiKeypair::from_bytes(KeyType::Network, \u0026bytes, None)?;\n            self.keys.insert(KeyType::Network, keypair);\n        } else {\n            // Create new key\n            let keypair = KagiKeypair::new(KeyType::Network, None)?;\n            fs::write(\u0026key_path, \u0026keypair.keypair_bytes())?;\n            self.keys.insert(KeyType::Network, keypair);\n        }\n\n        Ok(\u0026self.keys[\u0026KeyType::Network])\n    }\n\n    /// Add a temporary key with an expiration\n    pub fn add_temporary_key(\u0026mut self, duration: Duration) -\u003e Result\u003c\u0026KagiKeypair\u003e {\n        let keypair = KagiKeypair::new(KeyType::Temporary, Some(duration))?;\n        self.keys.insert(KeyType::Temporary, keypair);\n        Ok(\u0026self.keys[\u0026KeyType::Temporary])\n    }\n\n    /// Get a key by type\n    pub fn get_key(\u0026self, key_type: KeyType) -\u003e Option\u003c\u0026KagiKeypair\u003e {\n        self.keys.get(\u0026key_type)\n    }\n\n    /// Cleanup expired keys\n    pub fn cleanup_expired_keys(\u0026mut self) {\n        let expired_keys: Vec\u003cKeyType\u003e = self\n            .keys\n            .iter()\n            .filter(|(_, keypair)| keypair.is_expired())\n            .map(|(key_type, _)| *key_type)\n            .collect();\n\n        for key_type in expired_keys {\n            self.keys.remove(\u0026key_type);\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::thread::sleep;\n    use tempfile::tempdir;\n\n    #[test]\n    fn test_keypair_generation() {\n        // Test keypair generation and basic properties\n        let keypair = KagiKeypair::new(KeyType::Node, None).unwrap();\n\n        // Check key type\n        assert_eq!(keypair.key_type(), KeyType::Node);\n\n        // Check key lengths\n        assert_eq!(keypair.public_key_bytes().len(), 32);\n        assert_eq!(keypair.keypair_bytes().len(), 64);\n\n        // Check expiration\n        assert_eq!(keypair.is_expired(), false);\n    }\n\n    #[test]\n    fn test_signing_and_verification() {\n        // Generate a keypair\n        let keypair = KagiKeypair::new(KeyType::Node, None).unwrap();\n\n        // Sign a message\n        let message = b\"Hello, Kagi!\";\n        let signature = keypair.sign(message);\n\n        // Verify the signature\n        assert!(keypair.verify(message, \u0026signature));\n\n        // Verify that a modified message fails\n        let modified_message = b\"Hello, Kagi?\";\n        assert!(!keypair.verify(modified_message, \u0026signature));\n\n        // Verify that a modified signature fails\n        let mut signature_bytes = signature.to_bytes();\n        signature_bytes[0] = signature_bytes[0].wrapping_add(1);\n        let modified_signature = Signature::from_bytes(\u0026signature_bytes).unwrap();\n        assert!(!keypair.verify(message, \u0026modified_signature));\n    }\n\n    #[test]\n    fn test_encryption_and_decryption() {\n        // Generate a keypair\n        let keypair = KagiKeypair::new(KeyType::Node, None).unwrap();\n\n        // Encrypt a message\n        let plaintext = b\"Secret Kagi message\";\n        let ciphertext = keypair.encrypt(plaintext).unwrap();\n\n        // Decrypt the message\n        let decrypted = keypair.decrypt(\u0026ciphertext).unwrap();\n\n        // Check that the decrypted text matches the original\n        assert_eq!(decrypted, plaintext);\n\n        // Check that decryption fails with modified ciphertext\n        let mut modified_ciphertext = ciphertext.clone();\n        if modified_ciphertext.len() \u003e 20 {\n            modified_ciphertext[20] = modified_ciphertext[20].wrapping_add(1);\n            assert!(keypair.decrypt(\u0026modified_ciphertext).is_err());\n        }\n    }\n\n    #[test]\n    fn test_temporary_key_expiration() {\n        // Create a temporary key that expires in 10ms\n        let keypair =\n            KagiKeypair::new(KeyType::Temporary, Some(Duration::from_millis(10))).unwrap();\n\n        // Initially, the key should not be expired\n        assert_eq!(keypair.is_expired(), false);\n\n        // Wait for the key to expire\n        sleep(Duration::from_millis(20));\n\n        // Now the key should be expired\n        assert_eq!(keypair.is_expired(), true);\n    }\n\n    #[test]\n    fn test_key_manager() {\n        // Create a temporary directory for the test\n        let temp_dir = tempdir().unwrap();\n        let config_dir = temp_dir.path().to_str().unwrap();\n\n        // Create a new key manager\n        let mut key_manager = KeyManager::new(config_dir).unwrap();\n\n        // Load or create the node key\n        let node_key = key_manager.load_or_create_node_key().unwrap();\n        assert_eq!(node_key.key_type(), KeyType::Node);\n\n        // Check that the key file exists\n        let node_key_path = temp_dir.path().join(\"node_key\");\n        assert!(node_key_path.exists());\n\n        // Add a temporary key\n        let temp_key = key_manager\n            .add_temporary_key(Duration::from_millis(10))\n            .unwrap();\n        assert_eq!(temp_key.key_type(), KeyType::Temporary);\n\n        // Wait for the temporary key to expire\n        sleep(Duration::from_millis(20));\n\n        // Clean up expired keys\n        key_manager.cleanup_expired_keys();\n\n        // The temporary key should be gone\n        assert!(key_manager.get_key(KeyType::Temporary).is_none());\n\n        // The node key should still be there\n        assert!(key_manager.get_key(KeyType::Node).is_some());\n    }\n\n    #[test]\n    fn test_keypair_from_bytes() {\n        // Create a keypair\n        let original_keypair = KagiKeypair::new(KeyType::Node, None).unwrap();\n        let keypair_bytes = original_keypair.keypair_bytes();\n\n        // Create a new keypair from the bytes\n        let new_keypair = KagiKeypair::from_bytes(KeyType::Node, \u0026keypair_bytes, None).unwrap();\n\n        // The public keys should match\n        assert_eq!(\n            original_keypair.public_key_bytes(),\n            new_keypair.public_key_bytes()\n        );\n\n        // Check that signing with both keypairs produces verifiable signatures\n        let message = b\"Hello, Kagi!\";\n        let signature1 = original_keypair.sign(message);\n        let signature2 = new_keypair.sign(message);\n\n        assert!(original_keypair.verify(message, \u0026signature2));\n        assert!(new_keypair.verify(message, \u0026signature1));\n    }\n}\n","traces":[{"line":44,"address":[],"length":0,"stats":{"Line":7}},{"line":47,"address":[],"length":0,"stats":{"Line":7}},{"line":48,"address":[],"length":0,"stats":{"Line":7}},{"line":50,"address":[],"length":0,"stats":{"Line":14}},{"line":51,"address":[],"length":0,"stats":{"Line":14}},{"line":60,"address":[],"length":0,"stats":{"Line":2}},{"line":65,"address":[],"length":0,"stats":{"Line":1}},{"line":70,"address":[],"length":0,"stats":{"Line":1}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":1}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":5}},{"line":87,"address":[],"length":0,"stats":{"Line":5}},{"line":88,"address":[],"length":0,"stats":{"Line":3}},{"line":89,"address":[],"length":0,"stats":{"Line":2}},{"line":94,"address":[],"length":0,"stats":{"Line":3}},{"line":95,"address":[],"length":0,"stats":{"Line":3}},{"line":99,"address":[],"length":0,"stats":{"Line":3}},{"line":100,"address":[],"length":0,"stats":{"Line":3}},{"line":104,"address":[],"length":0,"stats":{"Line":3}},{"line":105,"address":[],"length":0,"stats":{"Line":3}},{"line":109,"address":[],"length":0,"stats":{"Line":3}},{"line":110,"address":[],"length":0,"stats":{"Line":3}},{"line":114,"address":[],"length":0,"stats":{"Line":5}},{"line":115,"address":[],"length":0,"stats":{"Line":5}},{"line":119,"address":[],"length":0,"stats":{"Line":1}},{"line":121,"address":[],"length":0,"stats":{"Line":1}},{"line":122,"address":[],"length":0,"stats":{"Line":1}},{"line":123,"address":[],"length":0,"stats":{"Line":1}},{"line":124,"address":[],"length":0,"stats":{"Line":1}},{"line":125,"address":[],"length":0,"stats":{"Line":2}},{"line":128,"address":[],"length":0,"stats":{"Line":2}},{"line":129,"address":[],"length":0,"stats":{"Line":1}},{"line":137,"address":[],"length":0,"stats":{"Line":1}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":2}},{"line":151,"address":[],"length":0,"stats":{"Line":2}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":2}},{"line":157,"address":[],"length":0,"stats":{"Line":2}},{"line":160,"address":[],"length":0,"stats":{"Line":2}},{"line":161,"address":[],"length":0,"stats":{"Line":2}},{"line":162,"address":[],"length":0,"stats":{"Line":2}},{"line":163,"address":[],"length":0,"stats":{"Line":2}},{"line":164,"address":[],"length":0,"stats":{"Line":2}},{"line":167,"address":[],"length":0,"stats":{"Line":4}},{"line":168,"address":[],"length":0,"stats":{"Line":2}},{"line":171,"address":[],"length":0,"stats":{"Line":1}},{"line":173,"address":[],"length":0,"stats":{"Line":2}},{"line":189,"address":[],"length":0,"stats":{"Line":1}},{"line":191,"address":[],"length":0,"stats":{"Line":1}},{"line":192,"address":[],"length":0,"stats":{"Line":1}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":1}},{"line":197,"address":[],"length":0,"stats":{"Line":1}},{"line":198,"address":[],"length":0,"stats":{"Line":1}},{"line":203,"address":[],"length":0,"stats":{"Line":5}},{"line":206,"address":[],"length":0,"stats":{"Line":5}},{"line":207,"address":[],"length":0,"stats":{"Line":5}},{"line":209,"address":[],"length":0,"stats":{"Line":10}},{"line":210,"address":[],"length":0,"stats":{"Line":10}},{"line":217,"address":[],"length":0,"stats":{"Line":1}},{"line":218,"address":[],"length":0,"stats":{"Line":1}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":1}},{"line":224,"address":[],"length":0,"stats":{"Line":1}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":2}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":1}},{"line":236,"address":[],"length":0,"stats":{"Line":1}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":1}},{"line":264,"address":[],"length":0,"stats":{"Line":2}},{"line":270,"address":[],"length":0,"stats":{"Line":2}},{"line":271,"address":[],"length":0,"stats":{"Line":2}},{"line":275,"address":[],"length":0,"stats":{"Line":1}},{"line":276,"address":[],"length":0,"stats":{"Line":1}},{"line":277,"address":[],"length":0,"stats":{"Line":1}},{"line":279,"address":[],"length":0,"stats":{"Line":4}},{"line":280,"address":[],"length":0,"stats":{"Line":3}},{"line":283,"address":[],"length":0,"stats":{"Line":4}},{"line":284,"address":[],"length":0,"stats":{"Line":1}}],"covered":74,"coverable":96},{"path":["/","Users","rafael","dev","kagi","node","src","lib.rs"],"content":"// Import modules\npub mod cli;\npub mod config;\npub mod db;\npub mod ipc;\npub mod ipc_new;\npub mod key_management;\npub mod node;\npub mod p2p;\npub mod services;\n#[cfg(test)]\npub mod tests;\npub mod util;\npub mod web;\n\n// Re-export types for easier access\npub use anyhow::Result;\nuse log::debug;\nuse std::path::PathBuf;\nuse std::sync::Arc;\npub use util::logging;\n\n/// Initialize a node with the given configuration directory\npub async fn init_node(config_dir: std::path::PathBuf) -\u003e Result\u003cnode::Node\u003e {\n    // Create a new node with the given configuration\n    let network_id = \"local\";\n    let node_path = config_dir.to_str().unwrap_or(\".\");\n    let node_config = node::NodeConfig::new(network_id, node_path);\n\n    // Create and initialize a new node\n    let mut node = node::Node::new(\u0026node_config).await?;\n    node.init().await?;\n\n    Ok(node)\n}\n\n/// Initialize the Kagi Node with services\npub async fn init_with_services(db_path: \u0026str, network_id: \u0026str) -\u003e Result\u003c()\u003e {\n    // Extract the node path from the database path\n    let db_path_buf = std::path::PathBuf::from(db_path);\n    let node_path = db_path_buf\n        .parent()\n        .unwrap_or(std::path::Path::new(\".\"))\n        .to_str()\n        .unwrap();\n\n    // Create NodeConfig\n    let node_config = node::NodeConfig::new(network_id, node_path);\n\n    // Create and initialize a new node\n    let mut node = node::Node::new(\u0026node_config).await?;\n    node.init().await?;\n\n    // Create the IPC server\n    let socket_path = std::path::PathBuf::from(\"/tmp/kagi.sock\");\n    let db = node.db().clone();\n    let mut ipc_server = ipc_new::IpcServer::new(socket_path, db, network_id);\n\n    // Set the service registry in the IPC server\n    ipc_server.set_service_registry(node.service_registry_arc());\n    ipc_server.start().await?;\n\n    // Run the main command-line interface\n    cli::run().await\n}\n\n/// Initialize the Kagi Node\npub async fn init() -\u003e Result\u003c()\u003e {\n    // This is a placeholder for future initialization code\n    Ok(())\n}\n\n/// Initialize the Kagi Node with services\npub async fn start_node(config: node::NodeConfig) -\u003e Result\u003cnode::Node\u003e {\n    // Create and initialize a new node\n    let mut node = node::Node::new(\u0026config).await?;\n    node.init().await?;\n\n    // Create the IPC server\n    let mut ipc_server = ipc_new::IpcServer::new(\n        PathBuf::from(\"/tmp/kagi.sock\"),\n        node.db().clone(),\n        node.network_id(),\n    );\n\n    // Set the service registry\n    ipc_server.set_service_registry(node.service_registry_arc());\n\n    // Start the IPC server\n    ipc_server.start().await?;\n\n    Ok(node)\n}\n","traces":[{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":31},{"path":["/","Users","rafael","dev","kagi","node","src","main.rs"],"content":"use anyhow::Result;\nuse clap::{arg, command, Parser};\nuse log::info;\n\nuse kagi_node;\n\n#[derive(Parser, Debug)]\n#[command(author, version, about, long_about = None)]\nstruct Args {\n    /// Path to the database file\n    #[arg(short, long, default_value = \"/tmp/kagi.db\")]\n    db_path: String,\n\n    /// Whether to run with local services\n    #[arg(long)]\n    services: bool,\n\n    /// Network ID for services\n    #[arg(long, default_value = \"network_default\")]\n    network_id: String,\n}\n\n#[tokio::main]\nasync fn main() -\u003e Result\u003c()\u003e {\n    // Initialize logging\n    env_logger::init();\n\n    info!(\"Starting Kagi Node...\");\n\n    // Parse command-line arguments\n    let args = Args::parse();\n\n    // Run the appropriate mode based on arguments\n    if args.services {\n        // Run with services\n        info!(\"Starting node with local services...\");\n        kagi_node::init_with_services(\u0026args.db_path, \u0026args.network_id).await?;\n\n        // Keep the main thread alive\n        tokio::signal::ctrl_c().await?;\n        info!(\"Shutting down...\");\n    } else {\n        // Run the CLI\n        kagi_node::cli::run().await?;\n    }\n\n    Ok(())\n}\n","traces":[{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":11},{"path":["/","Users","rafael","dev","kagi","node","src","node.rs"],"content":"use anyhow::{anyhow, Result};\nuse libp2p::PeerId;\nuse log::{info, warn};\nuse serde_json::{json, Value};\nuse std::collections::HashMap;\nuse std::fmt;\nuse std::fs;\nuse std::path::Path;\nuse std::sync::Arc;\nuse tokio::sync::RwLock;\nuse uuid;\n\nuse crate::db::SqliteDatabase;\nuse crate::key_management::KeyManager;\nuse crate::services::node_info::NodeInfoService;\nuse crate::services::registry::ServiceRegistry;\nuse crate::services::{\n    AbstractService, NodeRequestHandler, RequestContext, ServiceRequest, ServiceResponse, ValueType,\n};\nuse crate::util::logging::{\n    debug_log, debug_log_with_data, error_log, info_log, warn_log, Component,\n};\n\n/// Configuration for a Node\n/// Encapsulates all configuration options for a node in one place\n#[derive(Clone)]\npub struct NodeConfig {\n    /// Network ID for the node\n    network_id: String,\n    /// Path to the node's storage directory\n    node_path: String,\n    /// Path to the node's database file\n    db_path: String,\n}\n\nimpl NodeConfig {\n    /// Create a new NodeConfig with minimal parameters\n    pub fn new(network_id: \u0026str, node_path: \u0026str) -\u003e Self {\n        // Create the database path from the node path\n        let db_path = format!(\"{}/node.db\", node_path);\n\n        Self {\n            network_id: network_id.to_string(),\n            node_path: node_path.to_string(),\n            db_path,\n        }\n    }\n\n    /// Get the network ID\n    pub fn network_id(\u0026self) -\u003e \u0026str {\n        \u0026self.network_id\n    }\n\n    /// Get the node path\n    pub fn node_path(\u0026self) -\u003e \u0026str {\n        \u0026self.node_path\n    }\n\n    /// Get the database path\n    pub fn db_path(\u0026self) -\u003e \u0026str {\n        \u0026self.db_path\n    }\n}\n\n/// Node represents a Kagi node that can host services and communicate with other nodes\npub struct Node {\n    /// The service registry for service management\n    service_registry: Arc\u003cServiceRegistry\u003e,\n\n    /// The database connection\n    db: Arc\u003cSqliteDatabase\u003e,\n\n    /// The network ID\n    network_id: String,\n\n    /// The node path\n    node_path: String,\n\n    /// The database path\n    db_path: String,\n\n    /// The configuration\n    config: NodeConfig,\n}\n\n/// A dummy NodeRequestHandler used to create a RequestContext that won't be used for nested requests\npub struct DummyNodeRequestHandler {}\n\n#[async_trait::async_trait]\nimpl NodeRequestHandler for DummyNodeRequestHandler {\n    async fn request(\u0026self, _path: String, _params: ValueType) -\u003e Result\u003cServiceResponse\u003e {\n        // This should never be called in practice\n        Err(anyhow!(\n            \"DummyNodeRequestHandler should not be used for actual requests\"\n        ))\n    }\n\n    async fn publish(\u0026self, _topic: String, _data: ValueType) -\u003e Result\u003c()\u003e {\n        // This should never be called in practice\n        Err(anyhow!(\n            \"DummyNodeRequestHandler should not be used for actual requests\"\n        ))\n    }\n\n    async fn subscribe(\n        \u0026self,\n        _topic: String,\n        _callback: Box\u003cdyn Fn(ValueType) -\u003e Result\u003c()\u003e + Send + Sync\u003e,\n    ) -\u003e Result\u003c()\u003e {\n        // This should never be called in practice\n        Err(anyhow!(\n            \"DummyNodeRequestHandler should not be used for actual requests\"\n        ))\n    }\n}\n\n/// NodeRequestHandlerImpl - Implements NodeRequestHandler by wrapping a reference to the Node\n#[derive(Clone)]\npub struct NodeRequestHandlerImpl {\n    /// Reference to the service registry\n    service_registry: Arc\u003cServiceRegistry\u003e,\n}\n\nimpl NodeRequestHandlerImpl {\n    /// Create a new NodeRequestHandlerImpl\n    pub fn new(service_registry: Arc\u003cServiceRegistry\u003e) -\u003e Self {\n        NodeRequestHandlerImpl { service_registry }\n    }\n}\n\n#[async_trait::async_trait]\nimpl NodeRequestHandler for NodeRequestHandlerImpl {\n    async fn request(\u0026self, path: String, params: ValueType) -\u003e Result\u003cServiceResponse\u003e {\n        println!(\"NodeRequestHandlerImpl::request - Path: {}\", path);\n        println!(\"NodeRequestHandlerImpl::request - Params: {:?}\", params);\n\n        // Parse the path into service name and operation\n        // Format should be \"serviceName/operation\"\n        let parts: Vec\u003c\u0026str\u003e = path.split('/').collect();\n\n        if parts.is_empty() {\n            return Err(anyhow!(\n                \"Invalid path format. Expected 'serviceName/operation'\"\n            ));\n        }\n\n        let service_name = parts[0];\n        let operation = if parts.len() \u003e 1 { parts[1] } else { \"\" };\n\n        println!(\n            \"NodeRequestHandlerImpl::request - Service: {}, Operation: {}\",\n            service_name, operation\n        );\n\n        // Create path for service lookup - just use the service name\n        let service_path = service_name.to_string();\n\n        // Create a proper RequestContext that can handle nested requests\n        // Use self.clone() as the node_handler so nested requests go through this same handler\n        let request_context = Arc::new(RequestContext::new(\n            format!(\"{}/{}\", service_name, operation),\n            ValueType::Map(HashMap::new()),\n            Arc::new(self.clone()),\n        ));\n\n        // Create the service request with the new request_context\n        let request = ServiceRequest {\n            request_id: None,\n            path: service_path,\n            operation: operation.to_string(),\n            params,\n            request_context,\n        };\n\n        // Process the request through the service registry\n        let response = self.service_registry.process_request(request).await;\n\n        println!(\"NodeRequestHandlerImpl::request - Response: {:?}\", response);\n\n        response\n    }\n\n    async fn publish(\u0026self, topic: String, data: ValueType) -\u003e Result\u003c()\u003e {\n        // Forward to the registry's publish method\n        self.service_registry.publish(topic, data).await\n    }\n\n    async fn subscribe(\n        \u0026self,\n        topic: String,\n        callback: Box\u003cdyn Fn(ValueType) -\u003e Result\u003c()\u003e + Send + Sync\u003e,\n    ) -\u003e Result\u003c()\u003e {\n        // Create an anonymous service for this subscription\n        // Generate a unique name for the anonymous service\n        let service_name = format!(\"anonymous_listener_{}\", uuid::Uuid::new_v4());\n\n        // Register the subscription with the service name\n        self.service_registry\n            .subscribe(service_name, topic, callback)\n            .await\n    }\n}\n\n// Explicitly implement Send and Sync for NodeRequestHandlerImpl\n// This is needed because the trait object requires these bounds\nunsafe impl Send for NodeRequestHandlerImpl {}\nunsafe impl Sync for NodeRequestHandlerImpl {}\n\nimpl Node {\n    /// Create a new node with the given configuration\n    pub async fn new(config: \u0026NodeConfig) -\u003e Result\u003cSelf\u003e {\n        info_log(\n            Component::Node,\n            \u0026format!(\"Creating new Node with network_id: {}\", config.network_id),\n        );\n\n        // Create the database\n        let db_path = config.db_path();\n        let db = Arc::new(SqliteDatabase::new(\u0026db_path).await?);\n\n        // Create the service registry with the database\n        let service_registry = Arc::new(ServiceRegistry::new_with_db(\n            config.network_id(),\n            db.clone(),\n        ));\n\n        // Create the node\n        let mut node = Node {\n            service_registry,\n            db,\n            network_id: config.network_id().to_string(),\n            node_path: config.node_path().to_string(),\n            db_path: config.db_path().to_string(),\n            config: config.clone(),\n        };\n\n        // Create and set the NodeRequestHandlerImpl in the service registry\n        // This is needed for creating RequestContext objects\n        let node_request_handler =\n            Arc::new(NodeRequestHandlerImpl::new(node.service_registry.clone()));\n\n        // Get a mutable reference to update the service registry\n        if let Some(registry) = Arc::get_mut(\u0026mut node.service_registry) {\n            registry.set_node_handler(node_request_handler);\n        }\n\n        // Add log statement after creating the service registry\n        debug_log_with_data(\n            Component::Node,\n            \"Created ServiceRegistry with network_id\",\n            \u0026config.network_id,\n        );\n\n        Ok(node)\n    }\n\n    /// Create a new node using the legacy parameters (for backward compatibility)\n    /// This will be deprecated in the future\n    #[deprecated(since = \"0.1.0\", note = \"use new with NodeConfig instead\")]\n    pub async fn new_with_path(db_path: \u0026str, network_id: \u0026str) -\u003e Result\u003cSelf\u003e {\n        // Extract node_path from db_path by removing \"/node.db\"\n        let node_path = db_path.trim_end_matches(\"/node.db\");\n\n        // Create a NodeConfig\n        let config = NodeConfig {\n            network_id: network_id.to_string(),\n            node_path: node_path.to_string(),\n            db_path: db_path.to_string(),\n        };\n\n        // Use the new constructor\n        Self::new(\u0026config).await\n    }\n\n    /// Initialize the node\n    pub async fn init(\u0026mut self) -\u003e Result\u003c()\u003e {\n        info_log(Component::Node, \"Initializing Node\");\n\n        // Initialize built-in services\n        self.init_services().await?;\n\n        // Add more logging statements\n        debug_log(Component::Node, \"Node initialization complete\");\n        Ok(())\n    }\n\n    /// Initialize built-in services\n    async fn init_services(\u0026mut self) -\u003e Result\u003c()\u003e {\n        info_log(Component::Node, \"Initializing built-in services\");\n\n        // Import necessary services\n        use crate::services::node_info::NodeInfoService;\n        use crate::services::sqlite::SqliteService;\n\n        // Create and add the SQLite service\n        info_log(Component::Node, \"Creating and adding SQLite service\");\n        let sqlite_service = SqliteService::new(self.db.clone(), self.network_id());\n        self.add_service(sqlite_service).await?;\n\n        // Create and add the NodeInfo service\n        info_log(Component::Node, \"Creating and adding NodeInfo service\");\n        let node_info_service =\n            NodeInfoService::new(self.network_id(), Arc::new(self.config.clone()));\n        self.add_service(node_info_service).await?;\n\n        // List registered services for debugging\n        let services = self.service_registry.list_services().await;\n        debug_log_with_data(Component::Node, \"Registered services\", \u0026services);\n\n        info_log(Component::Node, \"Service initialization complete\");\n        Ok(())\n    }\n\n    /// Add a service to the node\n    /// This method automatically initializes and starts the service\n    pub async fn add_service\u003cS\u003e(\u0026mut self, mut service: S) -\u003e Result\u003c()\u003e\n    where\n        S: AbstractService + 'static,\n    {\n        // Create a node handler for request context\n        let node_handler = Arc::new(NodeRequestHandlerImpl::new(self.service_registry.clone()));\n\n        // Create a request context for initialization\n        let request_context = Arc::new(RequestContext::new(\n            service.name().to_string(),\n            ValueType::Map(HashMap::new()),\n            node_handler,\n        ));\n\n        // Initialize and start the service\n        info!(\"Initializing service: {}\", service.name());\n        service.init(\u0026request_context).await?;\n\n        info!(\"Starting service: {}\", service.name());\n        service.start().await?;\n\n        // Create an Arc around the initialized service\n        let service_arc = Arc::new(service);\n\n        // Register with the service registry\n        self.service_registry\n            .register_service(service_arc.clone())\n            .await?;\n\n        Ok(())\n    }\n\n    /// Add an Arc-wrapped service to the node\n    /// This method is useful when you need to keep a reference to the service\n    pub async fn add_service_arc\u003cS\u003e(\u0026self, service: Arc\u003cS\u003e) -\u003e Result\u003c()\u003e\n    where\n        S: AbstractService + 'static,\n    {\n        // Register with the service registry\n        self.service_registry\n            .register_service(service.clone())\n            .await?;\n\n        Ok(())\n    }\n\n    /// Call a service with the given path, operation, and parameters\n    /// This method is mainly for backward compatibility\n    pub async fn call\u003cP: Into\u003cString\u003e, O: Into\u003cString\u003e, V: Into\u003cValueType\u003e\u003e(\n        \u0026self,\n        path: P,\n        operation: O,\n        params: V,\n    ) -\u003e Result\u003cServiceResponse\u003e {\n        // Combine path and operation into the new format\n        let path_str = path.into();\n        let op_str = operation.into();\n        let full_path = format!(\"{}/{}\", path_str, op_str);\n\n        // Forward to the new request method\n        self.request(full_path, params).await\n    }\n\n    /// Request method for making service requests similar to the architecture notes\n    /// This is the main API method for interacting with services\n    pub async fn request\u003cP: Into\u003cString\u003e, V: Into\u003cValueType\u003e\u003e(\n        \u0026self,\n        path: P,\n        params: V,\n    ) -\u003e Result\u003cServiceResponse\u003e {\n        let path_str = path.into();\n        let params_value = params.into();\n\n        // Parse the path into service name and operation\n        // Format should be \"serviceName/operation\"\n        let parts: Vec\u003c\u0026str\u003e = path_str.split('/').collect();\n\n        if parts.is_empty() {\n            return Err(anyhow!(\n                \"Invalid path format. Expected 'serviceName/operation'\"\n            ));\n        }\n\n        let service_name = parts[0];\n        let operation = if parts.len() \u003e 1 { parts[1] } else { \"\" };\n\n        // Create path for service lookup - just use the service name\n        let service_path = service_name.to_string();\n\n        // Create a node handler reference for the request context\n        let node_handler = Arc::new(NodeRequestHandlerImpl::new(self.service_registry.clone()));\n\n        // Create a request context\n        let request_context = Arc::new(RequestContext::new(\n            format!(\"{}/{}\", service_name, operation),\n            ValueType::Map(HashMap::new()),\n            node_handler,\n        ));\n\n        // Create a service request with the request context\n        let request = ServiceRequest {\n            request_id: None,\n            path: service_path,\n            operation: operation.to_string(),\n            params: params_value,\n            request_context,\n        };\n\n        // Process the request through the service registry\n        self.service_registry.process_request(request).await\n    }\n\n    /// Publish an event to a topic\n    pub async fn publish\u003cT: Into\u003cString\u003e, V: Into\u003cValueType\u003e\u003e(\n        \u0026self,\n        topic: T,\n        data: V,\n    ) -\u003e Result\u003c()\u003e {\n        let topic_str = topic.into();\n        let data_value = data.into();\n\n        // Create a node handler reference\n        let node_handler = Arc::new(NodeRequestHandlerImpl::new(self.service_registry.clone()));\n\n        // Publish the event\n        node_handler.publish(topic_str, data_value).await\n    }\n\n    /// Subscribe to events on a topic\n    pub async fn subscribe\u003cT: Into\u003cString\u003e, F\u003e(\u0026self, topic: T, callback: F) -\u003e Result\u003c()\u003e\n    where\n        F: Fn(ValueType) -\u003e Result\u003c()\u003e + Send + Sync + 'static,\n    {\n        let topic_str = topic.into();\n        let callback_box = Box::new(callback);\n\n        // Create a node handler reference\n        let node_handler = Arc::new(NodeRequestHandlerImpl::new(self.service_registry.clone()));\n\n        // Subscribe to the topic\n        node_handler.subscribe(topic_str, callback_box).await\n    }\n\n    /// Get the service registry\n    pub fn service_registry(\u0026self) -\u003e Arc\u003cServiceRegistry\u003e {\n        warn_log(\n            Component::Node,\n            \"Warning: Using service_registry() which returns a new empty clone\",\n        );\n        Arc::new(ServiceRegistry::new(self.network_id()))\n    }\n\n    /// Get the service registry as an Arc\n    pub fn service_registry_arc(\u0026self) -\u003e Arc\u003cServiceRegistry\u003e {\n        debug_log(\n            Component::Node,\n            \"Using service_registry_arc() which returns the actual registry\",\n        );\n        self.service_registry.clone()\n    }\n\n    /// Get the database connection\n    pub fn db(\u0026self) -\u003e Arc\u003cSqliteDatabase\u003e {\n        self.db.clone()\n    }\n\n    /// Get the network ID\n    pub fn network_id(\u0026self) -\u003e \u0026str {\n        \u0026self.network_id\n    }\n\n    /// Get the node path\n    pub fn node_path(\u0026self) -\u003e \u0026str {\n        \u0026self.node_path\n    }\n\n    /// Get the database path\n    pub fn db_path(\u0026self) -\u003e \u0026str {\n        \u0026self.db_path\n    }\n}\n","traces":[{"line":38,"address":[],"length":0,"stats":{"Line":19}},{"line":40,"address":[],"length":0,"stats":{"Line":19}},{"line":43,"address":[],"length":0,"stats":{"Line":19}},{"line":44,"address":[],"length":0,"stats":{"Line":19}},{"line":50,"address":[],"length":0,"stats":{"Line":37}},{"line":51,"address":[],"length":0,"stats":{"Line":37}},{"line":55,"address":[],"length":0,"stats":{"Line":24}},{"line":56,"address":[],"length":0,"stats":{"Line":24}},{"line":60,"address":[],"length":0,"stats":{"Line":36}},{"line":61,"address":[],"length":0,"stats":{"Line":36}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":141}},{"line":133,"address":[],"length":0,"stats":{"Line":9}},{"line":134,"address":[],"length":0,"stats":{"Line":9}},{"line":135,"address":[],"length":0,"stats":{"Line":9}},{"line":139,"address":[],"length":0,"stats":{"Line":9}},{"line":141,"address":[],"length":0,"stats":{"Line":9}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":9}},{"line":148,"address":[],"length":0,"stats":{"Line":9}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":9}},{"line":178,"address":[],"length":0,"stats":{"Line":9}},{"line":180,"address":[],"length":0,"stats":{"Line":9}},{"line":183,"address":[],"length":0,"stats":{"Line":6}},{"line":185,"address":[],"length":0,"stats":{"Line":6}},{"line":195,"address":[],"length":0,"stats":{"Line":6}},{"line":198,"address":[],"length":0,"stats":{"Line":6}},{"line":199,"address":[],"length":0,"stats":{"Line":6}},{"line":200,"address":[],"length":0,"stats":{"Line":6}},{"line":211,"address":[],"length":0,"stats":{"Line":24}},{"line":213,"address":[],"length":0,"stats":{"Line":6}},{"line":214,"address":[],"length":0,"stats":{"Line":6}},{"line":218,"address":[],"length":0,"stats":{"Line":6}},{"line":219,"address":[],"length":0,"stats":{"Line":12}},{"line":222,"address":[],"length":0,"stats":{"Line":6}},{"line":223,"address":[],"length":0,"stats":{"Line":6}},{"line":224,"address":[],"length":0,"stats":{"Line":6}},{"line":231,"address":[],"length":0,"stats":{"Line":6}},{"line":232,"address":[],"length":0,"stats":{"Line":6}},{"line":233,"address":[],"length":0,"stats":{"Line":6}},{"line":234,"address":[],"length":0,"stats":{"Line":6}},{"line":239,"address":[],"length":0,"stats":{"Line":6}},{"line":240,"address":[],"length":0,"stats":{"Line":6}},{"line":243,"address":[],"length":0,"stats":{"Line":6}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":6}},{"line":251,"address":[],"length":0,"stats":{"Line":6}},{"line":254,"address":[],"length":0,"stats":{"Line":6}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":24}},{"line":277,"address":[],"length":0,"stats":{"Line":6}},{"line":280,"address":[],"length":0,"stats":{"Line":6}},{"line":283,"address":[],"length":0,"stats":{"Line":6}},{"line":284,"address":[],"length":0,"stats":{"Line":6}},{"line":288,"address":[],"length":0,"stats":{"Line":24}},{"line":289,"address":[],"length":0,"stats":{"Line":6}},{"line":296,"address":[],"length":0,"stats":{"Line":6}},{"line":297,"address":[],"length":0,"stats":{"Line":6}},{"line":298,"address":[],"length":0,"stats":{"Line":6}},{"line":301,"address":[],"length":0,"stats":{"Line":6}},{"line":302,"address":[],"length":0,"stats":{"Line":6}},{"line":303,"address":[],"length":0,"stats":{"Line":6}},{"line":304,"address":[],"length":0,"stats":{"Line":6}},{"line":307,"address":[],"length":0,"stats":{"Line":12}},{"line":308,"address":[],"length":0,"stats":{"Line":6}},{"line":310,"address":[],"length":0,"stats":{"Line":6}},{"line":311,"address":[],"length":0,"stats":{"Line":6}},{"line":316,"address":[],"length":0,"stats":{"Line":21}},{"line":321,"address":[],"length":0,"stats":{"Line":21}},{"line":324,"address":[],"length":0,"stats":{"Line":21}},{"line":325,"address":[],"length":0,"stats":{"Line":21}},{"line":326,"address":[],"length":0,"stats":{"Line":21}},{"line":327,"address":[],"length":0,"stats":{"Line":21}},{"line":331,"address":[],"length":0,"stats":{"Line":21}},{"line":332,"address":[],"length":0,"stats":{"Line":21}},{"line":334,"address":[],"length":0,"stats":{"Line":21}},{"line":335,"address":[],"length":0,"stats":{"Line":21}},{"line":338,"address":[],"length":0,"stats":{"Line":21}},{"line":341,"address":[],"length":0,"stats":{"Line":21}},{"line":342,"address":[],"length":0,"stats":{"Line":21}},{"line":343,"address":[],"length":0,"stats":{"Line":21}},{"line":345,"address":[],"length":0,"stats":{"Line":21}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":20}},{"line":386,"address":[],"length":0,"stats":{"Line":20}},{"line":387,"address":[],"length":0,"stats":{"Line":20}},{"line":391,"address":[],"length":0,"stats":{"Line":20}},{"line":393,"address":[],"length":0,"stats":{"Line":20}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":20}},{"line":400,"address":[],"length":0,"stats":{"Line":20}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":36}},{"line":484,"address":[],"length":0,"stats":{"Line":36}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}}],"covered":87,"coverable":155},{"path":["/","Users","rafael","dev","kagi","node","src","p2p.rs"],"content":"use crate::db::Database;\nuse crate::db::SqliteDatabase;\nuse crate::key_management::KeyManager;\nuse anyhow::Result;\nuse ed25519_dalek::Keypair;\nuse futures::StreamExt;\nuse libp2p::swarm::{NetworkBehaviour, SwarmBuilder, SwarmEvent};\nuse libp2p::{\n    core::{\n        transport::Transport,\n        upgrade::{self},\n        Multiaddr,\n    },\n    identify::{self},\n    identity,\n    kad::{\n        record::{store::MemoryStore, Record},\n        GetRecordOk, Kademlia, KademliaConfig, KademliaEvent, QueryResult,\n        RecordKey as KadRecordKey,\n    },\n    noise,\n    tcp::TokioTcpTransport,\n    yamux, PeerId, Swarm,\n};\nuse log::{error, info};\nuse std::sync::Arc;\nuse std::time::Duration;\n\n/// Our network behaviour combining Kademlia and Identify.\n#[derive(NetworkBehaviour)]\n#[behaviour(out_event = \"KagiNodeEvent\")]\npub struct KagiNodeBehaviour {\n    kademlia: Kademlia\u003cMemoryStore\u003e,\n    identify: identify::Behaviour,\n}\n\n/// Events that can be emitted by our behaviour.\n#[derive(Debug)]\npub enum KagiNodeEvent {\n    Kademlia(KademliaEvent),\n    Identify(identify::Event),\n}\n\n// Convert Kademlia events to our custom events\nimpl From\u003cKademliaEvent\u003e for KagiNodeEvent {\n    fn from(event: KademliaEvent) -\u003e Self {\n        KagiNodeEvent::Kademlia(event)\n    }\n}\n\n// Convert Identify events to our custom events\nimpl From\u003cidentify::Event\u003e for KagiNodeEvent {\n    fn from(event: identify::Event) -\u003e Self {\n        KagiNodeEvent::Identify(event)\n    }\n}\n\npub async fn build_swarm(\n    _db: Arc\u003cdyn Database + Send + Sync\u003e,\n    local_key: \u0026Keypair,\n) -\u003e Result\u003cSwarm\u003cKagiNodeBehaviour\u003e\u003e {\n    // Convert ed25519_dalek::Keypair to libp2p::identity::Keypair\n    // In libp2p 0.51, we need to extract the secret key bytes and create a new keypair\n    let secret_key_bytes = local_key.secret.as_bytes();\n    let mut key_buffer = [0u8; 32];\n    key_buffer.copy_from_slice(secret_key_bytes);\n\n    // Create a new libp2p keypair from the secret key\n    let id_keys =\n        identity::Keypair::ed25519_from_bytes(key_buffer).expect(\"Failed to convert keypair\");\n\n    let local_peer_id = PeerId::from(id_keys.public());\n\n    // Create a transport\n    let noise_keys = noise::Keypair::\u003cnoise::X25519Spec\u003e::new()\n        .into_authentic(\u0026id_keys)\n        .expect(\"Failed to create noise keys\");\n\n    // Use tokio TCP transport directly\n    let transport = TokioTcpTransport::new(Default::default())\n        .upgrade(upgrade::Version::V1)\n        .authenticate(noise::NoiseConfig::xx(noise_keys).into_authenticated())\n        .multiplex(yamux::YamuxConfig::default())\n        .timeout(Duration::from_secs(20))\n        .boxed();\n\n    // Create a Kademlia behavior\n    let store = MemoryStore::new(local_peer_id);\n    let kademlia_config = KademliaConfig::default();\n    let kademlia = Kademlia::with_config(local_peer_id, store, kademlia_config);\n\n    // Create an Identify behavior\n    let identify = identify::Behaviour::new(identify::Config::new(\n        \"kagi-node/1.0.0\".to_string(),\n        id_keys.public(),\n    ));\n\n    // Create our network behaviour\n    let behaviour = KagiNodeBehaviour { kademlia, identify };\n\n    // Create a new swarm\n    let swarm = SwarmBuilder::with_tokio_executor(transport, behaviour, local_peer_id).build();\n\n    Ok(swarm)\n}\n\n// Utility function to bootstrap the Kademlia DHT\npub async fn bootstrap_dht(\n    swarm: \u0026mut Swarm\u003cKagiNodeBehaviour\u003e,\n    bootstrap_peers: \u0026[(PeerId, String)],\n) -\u003e Result\u003c()\u003e {\n    // Add bootstrap peers to the DHT\n    for (peer_id, addr) in bootstrap_peers {\n        let multiaddr: Multiaddr = addr.parse()?;\n        swarm\n            .behaviour_mut()\n            .kademlia\n            .add_address(peer_id, multiaddr);\n        swarm.dial(peer_id.clone())?;\n    }\n\n    // Bootstrap the DHT\n    // Bootstrap returns a QueryId but we don't need to use it directly\n    let _ = swarm.behaviour_mut().kademlia.bootstrap();\n\n    Ok(())\n}\n\n// Function to publish data to the DHT\npub async fn publish_data(\n    swarm: \u0026mut Swarm\u003cKagiNodeBehaviour\u003e,\n    key: Vec\u003cu8\u003e,\n    value: Vec\u003cu8\u003e,\n) -\u003e Result\u003c()\u003e {\n    let record_key = KadRecordKey::new(\u0026key);\n    let record = Record {\n        key: record_key,\n        value,\n        publisher: None,\n        expires: None,\n    };\n\n    // put_record returns a QueryId but we don't need to use it directly\n    let _ = swarm\n        .behaviour_mut()\n        .kademlia\n        .put_record(record, libp2p::kad::Quorum::One);\n\n    Ok(())\n}\n\n// Function to get data from the DHT\npub async fn get_data(swarm: \u0026mut Swarm\u003cKagiNodeBehaviour\u003e, key: Vec\u003cu8\u003e) -\u003e Result\u003c()\u003e {\n    let record_key = KadRecordKey::new(\u0026key);\n    // get_record returns a QueryId but we don't need to use it directly\n    let _ = swarm.behaviour_mut().kademlia.get_record(record_key);\n\n    Ok(())\n}\n\n// Utility function to process swarm events\npub async fn process_swarm_events(swarm: \u0026mut Swarm\u003cKagiNodeBehaviour\u003e) -\u003e Result\u003c()\u003e {\n    while let Some(event) = swarm.next().await {\n        match event {\n            SwarmEvent::Behaviour(KagiNodeEvent::Kademlia(kad_event)) =\u003e match kad_event {\n                KademliaEvent::OutboundQueryProgressed { result, .. } =\u003e match result {\n                    QueryResult::GetRecord(result) =\u003e match result {\n                        Ok(GetRecordOk::FoundRecord(record)) =\u003e {\n                            info!(\n                                \"Got record with key: {:?}\",\n                                String::from_utf8_lossy(record.record.key.as_ref())\n                            );\n                            info!(\"Value: {:?}\", String::from_utf8_lossy(\u0026record.record.value));\n                            info!(\"Publisher: {:?}\", record.peer);\n                        }\n                        Ok(GetRecordOk::FinishedWithNoAdditionalRecord { .. }) =\u003e {\n                            info!(\"Could not find record with the given key\");\n                        }\n                        Err(e) =\u003e {\n                            error!(\"Failed to get record: {:?}\", e);\n                        }\n                    },\n                    _ =\u003e {}\n                },\n                _ =\u003e {}\n            },\n            SwarmEvent::Behaviour(KagiNodeEvent::Identify(identify_event)) =\u003e {\n                println!(\"Identify event: {:?}\", identify_event);\n            }\n            _ =\u003e {}\n        }\n    }\n\n    Ok(())\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use tempfile::tempdir;\n\n    #[tokio::test]\n    async fn test_build_swarm() -\u003e Result\u003c()\u003e {\n        // Create a test keypair\n        let keypair = KeyManager::generate_keypair()?;\n\n        // Create a temporary directory for the test database\n        let temp_dir = tempdir()?;\n        let db_path = temp_dir.path().join(\"test.db\");\n        let db = Arc::new(SqliteDatabase::new(db_path.to_str().unwrap()).await?);\n\n        // Build a swarm\n        let swarm = build_swarm(db, \u0026keypair).await?;\n\n        // Basic checks\n        assert!(swarm.local_peer_id().to_string().len() \u003e 0);\n\n        Ok(())\n    }\n}\n","traces":[{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":1}},{"line":64,"address":[],"length":0,"stats":{"Line":1}},{"line":65,"address":[],"length":0,"stats":{"Line":1}},{"line":66,"address":[],"length":0,"stats":{"Line":1}},{"line":69,"address":[],"length":0,"stats":{"Line":1}},{"line":70,"address":[],"length":0,"stats":{"Line":1}},{"line":72,"address":[],"length":0,"stats":{"Line":1}},{"line":75,"address":[],"length":0,"stats":{"Line":1}},{"line":76,"address":[],"length":0,"stats":{"Line":1}},{"line":80,"address":[],"length":0,"stats":{"Line":1}},{"line":81,"address":[],"length":0,"stats":{"Line":1}},{"line":82,"address":[],"length":0,"stats":{"Line":1}},{"line":83,"address":[],"length":0,"stats":{"Line":1}},{"line":84,"address":[],"length":0,"stats":{"Line":1}},{"line":88,"address":[],"length":0,"stats":{"Line":1}},{"line":89,"address":[],"length":0,"stats":{"Line":1}},{"line":90,"address":[],"length":0,"stats":{"Line":1}},{"line":93,"address":[],"length":0,"stats":{"Line":1}},{"line":94,"address":[],"length":0,"stats":{"Line":1}},{"line":95,"address":[],"length":0,"stats":{"Line":1}},{"line":99,"address":[],"length":0,"stats":{"Line":1}},{"line":102,"address":[],"length":0,"stats":{"Line":1}},{"line":104,"address":[],"length":0,"stats":{"Line":1}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}}],"covered":23,"coverable":69},{"path":["/","Users","rafael","dev","kagi","node","src","services","abstract_service.rs"],"content":"use anyhow::Result;\nuse async_trait::async_trait;\nuse serde::{Deserialize, Serialize};\n\nuse crate::services::{ServiceRequest, ServiceResponse};\n\n/// Represents the lifecycle state of a service\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]\npub enum ServiceState {\n    /// Service is created but not initialized\n    Created,\n    /// Service is initialized but not running\n    Initialized,\n    /// Service is running\n    Running,\n    /// Service is paused\n    Paused,\n    /// Service is stopped\n    Stopped,\n    /// Service has failed\n    Failed,\n}\n\n/// Metadata about a service\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ServiceMetadata {\n    /// The name of the service\n    pub name: String,\n    /// The path of the service\n    pub path: String,\n    /// Current state of the service\n    pub state: ServiceState,\n    /// Description of the service\n    pub description: String,\n    /// Available operations on the service\n    pub operations: Vec\u003cString\u003e,\n    /// Service version\n    pub version: String,\n}\n\n/// CRUD operation types\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub enum CrudOperationType {\n    /// Create a new document\n    Create,\n    /// Read documents\n    Read,\n    /// Update documents\n    Update,\n    /// Delete documents\n    Delete,\n}\n\n/// Abstract service trait - defines common behavior for all services\n#[async_trait]\npub trait AbstractService: Send + Sync {\n    /// Get the service name\n    fn name(\u0026self) -\u003e \u0026str;\n\n    /// Get the service path\n    fn path(\u0026self) -\u003e \u0026str;\n\n    /// Get the current state of the service\n    fn state(\u0026self) -\u003e ServiceState;\n\n    /// Initialize the service with a request context\n    async fn init(\u0026mut self, context: \u0026crate::services::RequestContext) -\u003e Result\u003c()\u003e;\n\n    /// Start the service\n    async fn start(\u0026mut self) -\u003e Result\u003c()\u003e;\n\n    /// Stop the service\n    async fn stop(\u0026mut self) -\u003e Result\u003c()\u003e;\n\n    /// Process a service request\n    async fn process_request(\u0026self, request: ServiceRequest) -\u003e Result\u003cServiceResponse\u003e;\n\n    /// Get a description of the service\n    fn description(\u0026self) -\u003e String;\n\n    /// Get metadata about the service\n    fn metadata(\u0026self) -\u003e ServiceMetadata {\n        ServiceMetadata {\n            name: self.name().to_string(),\n            path: self.path().to_string(),\n            state: self.state(),\n            description: self.description(),\n            operations: vec![],\n            version: \"1.0.0\".to_string(),\n        }\n    }\n}\n","traces":[{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":7},{"path":["/","Users","rafael","dev","kagi","node","src","services","mod.rs"],"content":"use anyhow::{anyhow, Result};\nuse base64;\nuse log::info;\nuse serde::{Deserialize, Serialize};\nuse serde_bytes;\nuse serde_json::{json, Value};\nuse std::any::Any;\nuse std::collections::HashMap;\nuse std::fmt;\nuse std::sync::Arc;\nuse tokio::sync::RwLock;\n\nuse crate::db::SqliteDatabase;\nuse crate::ipc::IpcResponseStatus;\nuse crate::node::NodeConfig;\n\n// Export the abstract service module\npub mod abstract_service;\n// Export the sqlite service module\npub mod sqlite;\n// Export the node info service module\npub mod node_info;\n// Export the registry service module\npub mod registry;\n// Export the utils module\npub mod utils;\n\n// Re-export service types\npub use abstract_service::AbstractService;\npub use node_info::NodeInfoService;\npub use registry::RegistryService;\npub use sqlite::SqliteService;\n\n/// Response status for service responses\n#[derive(Debug, Serialize, Deserialize, Clone, PartialEq)]\npub enum ResponseStatus {\n    /// Success\n    Success,\n    /// Error\n    Error,\n}\n\n// For backward compatibility\nimpl From\u003cResponseStatus\u003e for IpcResponseStatus {\n    fn from(status: ResponseStatus) -\u003e Self {\n        match status {\n            ResponseStatus::Success =\u003e IpcResponseStatus::Success,\n            ResponseStatus::Error =\u003e IpcResponseStatus::Error,\n        }\n    }\n}\n\n// For backward compatibility\nimpl From\u003cIpcResponseStatus\u003e for ResponseStatus {\n    fn from(status: IpcResponseStatus) -\u003e Self {\n        match status {\n            IpcResponseStatus::Success =\u003e ResponseStatus::Success,\n            IpcResponseStatus::Error =\u003e ResponseStatus::Error,\n        }\n    }\n}\n\n/// A generic value type that can represent different kinds of data\n/// This allows us to pass native data structures through the Node API\n/// and only serialize to JSON when needed at transport boundaries\n#[derive(Debug, Clone, Serialize, Deserialize)]\n#[serde(untagged)]\npub enum ValueType {\n    /// JSON value (for compatibility with external services)\n    Json(Value),\n    /// HashMap of string keys to ValueType values\n    Map(HashMap\u003cString, ValueType\u003e),\n    /// Vector of ValueType values\n    Array(Vec\u003cValueType\u003e),\n    /// String value\n    String(String),\n    /// Numeric value\n    Number(f64),\n    /// Boolean value\n    Bool(bool),\n    /// Null/None value\n    Null,\n    /// Binary data\n    #[serde(with = \"serde_bytes\")]\n    Bytes(Vec\u003cu8\u003e),\n    /// Raw struct data (serialized on demand)\n    #[serde(skip)]\n    Struct(Arc\u003cdyn SerializableStruct + Send + Sync + 'static\u003e),\n}\n\n/// Trait for types that can be stored in a ValueType::Struct\npub trait SerializableStruct: std::fmt::Debug {\n    /// Convert to a HashMap representation\n    fn to_map(\u0026self) -\u003e Result\u003cHashMap\u003cString, ValueType\u003e\u003e;\n\n    /// Convert to JSON Value\n    fn to_json_value(\u0026self) -\u003e Result\u003cValue\u003e;\n\n    /// Get the type name (for debugging)\n    fn type_name(\u0026self) -\u003e \u0026'static str;\n\n    /// Clone the struct (required since we can't directly clone a dyn trait)\n    fn clone_box(\u0026self) -\u003e Box\u003cdyn SerializableStruct + Send + Sync + 'static\u003e;\n}\n\n// We need to create our own Clone impl for Box\u003cdyn SerializableStruct\u003e\n// to avoid orphan rule violations\nimpl Clone for Box\u003cdyn SerializableStruct + Send + Sync + 'static\u003e {\n    fn clone(\u0026self) -\u003e Self {\n        self.clone_box()\n    }\n}\n\n// Define our own wrapper to avoid the orphan rule violation for Arc cloning\npub struct StructArc(pub Box\u003cdyn SerializableStruct + Send + Sync + 'static\u003e);\n\nimpl Clone for StructArc {\n    fn clone(\u0026self) -\u003e Self {\n        StructArc(self.0.clone())\n    }\n}\n\n/// Implementation for any type that implements Serialize and Debug\nimpl\u003cT\u003e SerializableStruct for T\nwhere\n    T: std::fmt::Debug + serde::Serialize + Clone + Send + Sync + 'static,\n{\n    fn to_map(\u0026self) -\u003e Result\u003cHashMap\u003cString, ValueType\u003e\u003e {\n        // Convert to JSON first\n        let json = serde_json::to_value(self)?;\n\n        // Then convert JSON to map\n        match json {\n            Value::Object(map) =\u003e {\n                let mut value_map = HashMap::new();\n                for (key, value) in map {\n                    value_map.insert(key, ValueType::from_json(value));\n                }\n                Ok(value_map)\n            }\n            _ =\u003e Err(anyhow!(\"Expected a JSON object, got: {:?}\", json)),\n        }\n    }\n\n    fn to_json_value(\u0026self) -\u003e Result\u003cValue\u003e {\n        serde_json::to_value(self).map_err(|e| anyhow!(\"Serialization error: {}\", e))\n    }\n\n    fn type_name(\u0026self) -\u003e \u0026'static str {\n        std::any::type_name::\u003cT\u003e()\n    }\n\n    fn clone_box(\u0026self) -\u003e Box\u003cdyn SerializableStruct + Send + Sync + 'static\u003e {\n        Box::new(self.clone())\n    }\n}\n\nimpl ValueType {\n    /// Create a ValueType from a JSON Value\n    pub fn from_json(value: Value) -\u003e Self {\n        ValueType::Json(value)\n    }\n\n    /// Convert this ValueType to a JSON Value\n    pub fn to_json(\u0026self) -\u003e Value {\n        match self {\n            ValueType::Json(value) =\u003e value.clone(),\n            ValueType::Map(map) =\u003e {\n                let mut json_map = serde_json::Map::new();\n                for (key, value) in map {\n                    json_map.insert(key.clone(), value.to_json());\n                }\n                Value::Object(json_map)\n            }\n            ValueType::Array(array) =\u003e {\n                let json_array = array.iter().map(|v| v.to_json()).collect();\n                Value::Array(json_array)\n            }\n            ValueType::String(s) =\u003e Value::String(s.clone()),\n            ValueType::Number(n) =\u003e {\n                if let Some(f) = serde_json::Number::from_f64(*n) {\n                    Value::Number(f)\n                } else {\n                    Value::Null\n                }\n            }\n            ValueType::Bool(b) =\u003e Value::Bool(*b),\n            ValueType::Null =\u003e Value::Null,\n            ValueType::Bytes(b) =\u003e {\n                // Base64 encode binary data for JSON representation\n                let base64 = base64::encode(b);\n                Value::String(base64)\n            }\n            ValueType::Struct(s) =\u003e {\n                // Serialize the struct to JSON on demand\n                match s.to_json_value() {\n                    Ok(v) =\u003e v,\n                    Err(_) =\u003e Value::Null,\n                }\n            }\n        }\n    }\n\n    /// Convert this ValueType to a HashMap if possible\n    pub fn to_map(\u0026self) -\u003e Result\u003cHashMap\u003cString, ValueType\u003e\u003e {\n        match self {\n            ValueType::Map(map) =\u003e Ok(map.clone()),\n            ValueType::Json(Value::Object(obj)) =\u003e {\n                let mut map = HashMap::new();\n                for (k, v) in obj {\n                    map.insert(k.clone(), ValueType::from_json(v.clone()));\n                }\n                Ok(map)\n            }\n            ValueType::Struct(s) =\u003e s.to_map(),\n            _ =\u003e Err(anyhow!(\"Cannot convert {:?} to HashMap\", self)),\n        }\n    }\n\n    /// Get a reference to a map if this ValueType is a Map\n    pub fn as_map(\u0026self) -\u003e Option\u003c\u0026HashMap\u003cString, ValueType\u003e\u003e {\n        match self {\n            ValueType::Map(map) =\u003e Some(map),\n            _ =\u003e None,\n        }\n    }\n\n    /// Get a reference to an array if this ValueType is an Array\n    pub fn as_array(\u0026self) -\u003e Option\u003c\u0026Vec\u003cValueType\u003e\u003e {\n        match self {\n            ValueType::Array(array) =\u003e Some(array),\n            _ =\u003e None,\n        }\n    }\n\n    /// Get a reference to a string if this ValueType is a String\n    pub fn as_str(\u0026self) -\u003e Option\u003c\u0026str\u003e {\n        match self {\n            ValueType::String(s) =\u003e Some(s),\n            _ =\u003e None,\n        }\n    }\n\n    /// Get an integer if this ValueType is an Integer\n    pub fn as_i64(\u0026self) -\u003e Option\u003ci64\u003e {\n        match self {\n            ValueType::Number(n) =\u003e Some(*n as i64),\n            _ =\u003e None,\n        }\n    }\n\n    /// Get a float if this ValueType is a Float\n    pub fn as_f64(\u0026self) -\u003e Option\u003cf64\u003e {\n        match self {\n            ValueType::Number(n) =\u003e Some(*n),\n            _ =\u003e None,\n        }\n    }\n\n    /// Get a boolean if this ValueType is a Boolean\n    pub fn as_bool(\u0026self) -\u003e Option\u003cbool\u003e {\n        match self {\n            ValueType::Bool(b) =\u003e Some(*b),\n            _ =\u003e None,\n        }\n    }\n\n    /// Get a reference to bytes if this ValueType is Bytes\n    pub fn as_bytes(\u0026self) -\u003e Option\u003c\u0026[u8]\u003e {\n        match self {\n            ValueType::Bytes(b) =\u003e Some(b),\n            _ =\u003e None,\n        }\n    }\n\n    /// Get a map value by key\n    pub fn get(\u0026self, key: \u0026str) -\u003e Option\u003cValueType\u003e {\n        match self {\n            ValueType::Map(map) =\u003e map.get(key).cloned(),\n            ValueType::Json(Value::Object(map)) =\u003e {\n                // Create a ValueType from the JSON value\n                map.get(key).map(|v| ValueType::from_json(v.clone()))\n            }\n            ValueType::Struct(s) =\u003e {\n                // Try to convert to map first\n                match s.to_map() {\n                    Ok(map) =\u003e map.get(key).cloned(),\n                    Err(_) =\u003e None,\n                }\n            }\n            _ =\u003e None,\n        }\n    }\n\n    /// Get a reference to a map value by key without cloning (unsafe, only use for readonly)\n    pub fn get_ref(\u0026self, key: \u0026str) -\u003e Option\u003c\u0026ValueType\u003e {\n        match self {\n            ValueType::Map(map) =\u003e map.get(key),\n            _ =\u003e None,\n        }\n    }\n}\n\n/// Convenient conversions from Rust types to ValueType\nimpl From\u003cString\u003e for ValueType {\n    fn from(s: String) -\u003e Self {\n        ValueType::String(s)\n    }\n}\n\nimpl From\u003c\u0026str\u003e for ValueType {\n    fn from(s: \u0026str) -\u003e Self {\n        ValueType::String(s.to_string())\n    }\n}\n\nimpl From\u003ci64\u003e for ValueType {\n    fn from(i: i64) -\u003e Self {\n        ValueType::Number(i as f64)\n    }\n}\n\nimpl From\u003ci32\u003e for ValueType {\n    fn from(i: i32) -\u003e Self {\n        ValueType::Number(i as f64)\n    }\n}\n\nimpl From\u003cf64\u003e for ValueType {\n    fn from(f: f64) -\u003e Self {\n        ValueType::Number(f)\n    }\n}\n\nimpl From\u003cbool\u003e for ValueType {\n    fn from(b: bool) -\u003e Self {\n        ValueType::Bool(b)\n    }\n}\n\nimpl From\u003cVec\u003cu8\u003e\u003e for ValueType {\n    fn from(b: Vec\u003cu8\u003e) -\u003e Self {\n        ValueType::Bytes(b)\n    }\n}\n\nimpl From\u003cHashMap\u003cString, ValueType\u003e\u003e for ValueType {\n    fn from(map: HashMap\u003cString, ValueType\u003e) -\u003e Self {\n        ValueType::Map(map)\n    }\n}\n\nimpl From\u003cVec\u003cValueType\u003e\u003e for ValueType {\n    fn from(array: Vec\u003cValueType\u003e) -\u003e Self {\n        ValueType::Array(array)\n    }\n}\n\n/// Implementation of From\u003cValue\u003e for ValueType\nimpl From\u003cValue\u003e for ValueType {\n    fn from(value: Value) -\u003e Self {\n        ValueType::Json(value)\n    }\n}\n\nimpl From\u003c()\u003e for ValueType {\n    fn from(_: ()) -\u003e Self {\n        ValueType::Null\n    }\n}\n\n/// Service request - represents a request to a service\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ServiceRequest {\n    /// The path of the service\n    pub path: String,\n    /// The operation to perform\n    pub operation: String,\n    /// The parameters for the operation\n    pub params: ValueType,\n    /// Request ID for tracing\n    pub request_id: Option\u003cString\u003e,\n    /// Request context object (not serialized)\n    #[serde(skip)]\n    pub request_context: Arc\u003cRequestContext\u003e,\n}\n\nimpl ServiceRequest {\n    /// Get the request ID\n    pub fn id(\u0026self) -\u003e Option\u003c\u0026String\u003e {\n        self.request_id.as_ref()\n    }\n\n    /// Set the request ID\n    pub fn set_id(\u0026mut self, id: Option\u003cString\u003e) {\n        self.request_id = id;\n    }\n\n    /// Create a new service request\n    pub fn new\u003cP: Into\u003cString\u003e, O: Into\u003cString\u003e, V: Into\u003cValueType\u003e\u003e(\n        path: P,\n        operation: O,\n        params: V,\n        node_handler: Arc\u003cdyn NodeRequestHandler + Send + Sync\u003e,\n    ) -\u003e Self {\n        let path_str = path.into();\n        let op_str = operation.into();\n        let params_value = params.into();\n\n        // Create a request context\n        let request_context = Arc::new(RequestContext::new(\n            format!(\"{}/{}\", path_str, op_str),\n            ValueType::Map(HashMap::new()),\n            node_handler,\n        ));\n\n        ServiceRequest {\n            path: path_str,\n            operation: op_str,\n            params: params_value,\n            request_id: None,\n            request_context,\n        }\n    }\n\n    /// Create a new service request with a request context\n    pub fn new_with_request_context\u003cP: Into\u003cString\u003e, O: Into\u003cString\u003e, V: Into\u003cValueType\u003e\u003e(\n        path: P,\n        operation: O,\n        params: V,\n        request_context: Arc\u003cRequestContext\u003e,\n    ) -\u003e Self {\n        ServiceRequest {\n            path: path.into(),\n            operation: operation.into(),\n            params: params.into(),\n            request_id: None,\n            request_context,\n        }\n    }\n\n    /// Get a parameter from the request\n    pub fn get_param(\u0026self, key: \u0026str) -\u003e Option\u003cValueType\u003e {\n        self.params.get(key)\n    }\n\n    /// Get a parameter reference from the request\n    pub fn get_param_ref(\u0026self, key: \u0026str) -\u003e Option\u003c\u0026ValueType\u003e {\n        self.params.get_ref(key)\n    }\n\n    /// Convert to JSON params\n    pub fn to_json_params(\u0026self) -\u003e Value {\n        json!({\n            \"path\": self.path,\n            \"operation\": self.operation,\n            \"params\": self.params.to_json(),\n            \"request_id\": self.request_id,\n        })\n    }\n\n    /// Create from JSON params\n    pub fn from_json_params(value: Value) -\u003e Self {\n        // This is a minimal implementation for now\n        ServiceRequest {\n            path: value\n                .get(\"path\")\n                .and_then(|v| v.as_str())\n                .unwrap_or(\"\")\n                .to_string(),\n            operation: value\n                .get(\"operation\")\n                .and_then(|v| v.as_str())\n                .unwrap_or(\"\")\n                .to_string(),\n            params: value\n                .get(\"params\")\n                .map(|v| ValueType::from_json(v.clone()))\n                .unwrap_or(ValueType::Null),\n            request_id: value\n                .get(\"request_id\")\n                .and_then(|v| v.as_str())\n                .map(|s| s.to_string()),\n            request_context: Arc::new(RequestContext::default()),\n        }\n    }\n}\n\n/// Service response - represents a response from a service\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ServiceResponse {\n    /// Status of the response (success or error)\n    #[serde(with = \"response_status_compat\")]\n    pub status: ResponseStatus,\n    /// A message describing the result\n    pub message: String,\n    /// The response data\n    pub data: Option\u003cValueType\u003e,\n}\n\n// This module enables backward compatibility with IpcResponseStatus\n// by allowing ServiceResponse to serialize/deserialize with both formats\nmod response_status_compat {\n    use super::{IpcResponseStatus, ResponseStatus};\n    use serde::{Deserialize, Deserializer, Serialize, Serializer};\n\n    pub fn serialize\u003cS\u003e(status: \u0026ResponseStatus, serializer: S) -\u003e Result\u003cS::Ok, S::Error\u003e\n    where\n        S: Serializer,\n    {\n        // Convert to IpcResponseStatus for serialization\n        let ipc_status: IpcResponseStatus = status.clone().into();\n        ipc_status.serialize(serializer)\n    }\n\n    pub fn deserialize\u003c'de, D\u003e(deserializer: D) -\u003e Result\u003cResponseStatus, D::Error\u003e\n    where\n        D: Deserializer\u003c'de\u003e,\n    {\n        // Deserialize as IpcResponseStatus then convert to ResponseStatus\n        let ipc_status = IpcResponseStatus::deserialize(deserializer)?;\n        Ok(ipc_status.into())\n    }\n}\n\n// Add helper methods to ServiceResponse\nimpl ServiceResponse {\n    /// Create a success response\n    pub fn success\u003cS: Into\u003cString\u003e, D: Into\u003cOption\u003cValueType\u003e\u003e\u003e(message: S, data: D) -\u003e Self {\n        ServiceResponse {\n            status: ResponseStatus::Success,\n            message: message.into(),\n            data: data.into(),\n        }\n    }\n\n    /// Create an error response\n    pub fn error\u003cS: Into\u003cString\u003e\u003e(message: S) -\u003e Self {\n        ServiceResponse {\n            status: ResponseStatus::Error,\n            message: message.into(),\n            data: None,\n        }\n    }\n\n    /// For compatibility with JSON serialization\n    pub fn to_json_data(\u0026self) -\u003e Option\u003cValue\u003e {\n        self.data.as_ref().map(|d| d.to_json())\n    }\n\n    /// For compatibility with JSON deserialization\n    pub fn from_json_data(status: IpcResponseStatus, message: String, data: Option\u003cValue\u003e) -\u003e Self {\n        let data = data.map(ValueType::from_json);\n        ServiceResponse {\n            status: status.into(),\n            message,\n            data,\n        }\n    }\n}\n\n/// Service Manager - manages services and routes requests\n/// This implementation is being refactored to use ServiceRegistry\n/// in the future and will eventually be deprecated\npub struct ServiceManager {\n    /// Map of service name to service implementation\n    services: Arc\u003cRwLock\u003cHashMap\u003cString, Arc\u003cdyn AbstractService\u003e\u003e\u003e\u003e,\n    /// The network ID\n    network_id: String,\n    /// Database connection\n    db: Arc\u003cSqliteDatabase\u003e,\n    /// Node configuration\n    config: Arc\u003cNodeConfig\u003e,\n    /// Node handler for making requests\n    node_handler: Option\u003cArc\u003cdyn NodeRequestHandler + Send + Sync\u003e\u003e,\n}\n\nimpl ServiceManager {\n    /// Create a new ServiceManager\n    pub fn new(db: Arc\u003cSqliteDatabase\u003e, config: Arc\u003cNodeConfig\u003e) -\u003e Self {\n        ServiceManager {\n            db,\n            network_id: config.network_id().to_string(),\n            services: Arc::new(RwLock::new(HashMap::new())),\n            config,\n            node_handler: None,\n        }\n    }\n\n    /// Create a new ServiceManager from a reference to NodeConfig\n    pub fn new_from_ref(db: Arc\u003cSqliteDatabase\u003e, config: \u0026NodeConfig) -\u003e Self {\n        // Create a new Arc\u003cNodeConfig\u003e from the reference by cloning\n        let config_clone = config.clone();\n        let config_arc = Arc::new(config_clone);\n\n        ServiceManager {\n            db,\n            network_id: config.network_id().to_string(),\n            services: Arc::new(RwLock::new(HashMap::new())),\n            config: config_arc,\n            node_handler: None,\n        }\n    }\n\n    /// Get the network ID\n    pub fn network_id(\u0026self) -\u003e \u0026str {\n        \u0026self.network_id\n    }\n\n    /// Get the node configuration\n    pub fn config(\u0026self) -\u003e Arc\u003cNodeConfig\u003e {\n        self.config.clone()\n    }\n\n    /// Get the database connection\n    pub fn get_db(\u0026self) -\u003e \u0026Arc\u003cSqliteDatabase\u003e {\n        \u0026self.db\n    }\n\n    /// Initialize services\n    pub async fn init_services(\u0026mut self) -\u003e Result\u003c()\u003e {\n        info!(\"Initializing services for network ID: {}\", self.network_id);\n\n        // Create a node handler for request context\n        let node_handler = if let Some(handler) = \u0026self.node_handler {\n            handler.clone()\n        } else {\n            Arc::new(crate::node::DummyNodeRequestHandler {})\n        };\n\n        // Create a request context for initialization\n        let request_context = Arc::new(RequestContext::new(\n            \"service_manager\".to_string(),\n            ValueType::Map(HashMap::new()),\n            node_handler,\n        ));\n\n        // Initialize the registry service\n        let mut registry_service =\n            registry::RegistryService::new(self.db.clone(), \u0026self.network_id);\n        registry_service.init(\u0026request_context).await?;\n        registry_service.start().await?;\n\n        // Add it to our services map\n        self.register_service(Arc::new(registry_service)).await?;\n\n        // Initialize the SQLite service\n        let mut sqlite_service = sqlite::SqliteService::new(self.db.clone(), \u0026self.network_id);\n        sqlite_service.init(\u0026request_context).await?;\n        sqlite_service.start().await?;\n\n        // Add it to our services map\n        self.register_service(Arc::new(sqlite_service)).await?;\n\n        // Initialize the node info service\n        let mut node_info_service =\n            node_info::NodeInfoService::new(\u0026self.network_id, self.config.clone());\n        node_info_service.init(\u0026request_context).await?;\n        node_info_service.start().await?;\n\n        // Add it to our services map\n        self.register_service(Arc::new(node_info_service)).await?;\n\n        // Load services from the registry database\n        let services = self.list_services().await;\n        log::info!(\"Services initialized: {}\", services.join(\", \"));\n\n        Ok(())\n    }\n\n    /// Register a service with the ServiceManager\n    /// Note: This is being refactored to use ServiceRegistry\n    pub async fn register_service(\u0026self, service: Arc\u003cdyn AbstractService\u003e) -\u003e Result\u003c()\u003e {\n        let mut services = self.services.write().await;\n        let service_name = service.name().to_string();\n\n        info!(\n            \"Registering service: {} at {}\",\n            service_name,\n            service.path()\n        );\n\n        if services.contains_key(\u0026service_name) {\n            return Err(anyhow!(\"Service '{}' is already registered\", service_name));\n        }\n\n        services.insert(service_name, service);\n\n        Ok(())\n    }\n\n    /// Get a service by name\n    pub async fn get_service(\u0026self, name: \u0026str) -\u003e Option\u003cArc\u003cdyn AbstractService\u003e\u003e {\n        let services = self.services.read().await;\n        services.get(name).cloned()\n    }\n\n    /// Get a service by path\n    pub async fn get_service_by_path(\u0026self, path: \u0026str) -\u003e Option\u003cArc\u003cdyn AbstractService\u003e\u003e {\n        let services = self.services.read().await;\n\n        // Check for direct matches first\n        for service in services.values() {\n            if service.path() == path {\n                return Some(service.clone());\n            }\n        }\n\n        // Check for matches with the network ID prefix\n        let full_path = if !path.starts_with(\u0026self.network_id) {\n            format!(\"{}/{}\", self.network_id, path)\n        } else {\n            path.to_string()\n        };\n\n        for service in services.values() {\n            if service.path() == full_path {\n                return Some(service.clone());\n            }\n            // Also check if the path is just the service name\n            if service.name() == path {\n                return Some(service.clone());\n            }\n        }\n\n        None\n    }\n\n    /// List all services\n    pub async fn list_services(\u0026self) -\u003e Vec\u003cString\u003e {\n        let services = self.services.read().await;\n        services.keys().cloned().collect()\n    }\n\n    /// Get all services\n    pub async fn get_all_services(\u0026self) -\u003e Vec\u003cArc\u003cdyn AbstractService\u003e\u003e {\n        let services = self.services.read().await;\n        services.values().cloned().collect()\n    }\n\n    /// Process a service request\n    pub async fn process_request(\u0026self, request: ServiceRequest) -\u003e Result\u003cServiceResponse\u003e {\n        // Extract the path from the request\n        let path = \u0026request.path;\n\n        // Get the service by path\n        let service = self\n            .get_service_by_path(path)\n            .await\n            .ok_or_else(|| anyhow!(\"No service found for path: {}\", path))?;\n\n        // Process the request with the service\n        service.process_request(request).await\n    }\n\n    /// Clone the ServiceManager\n    pub fn clone(\u0026self) -\u003e Self {\n        ServiceManager {\n            db: self.db.clone(),\n            network_id: self.network_id.clone(),\n            services: self.services.clone(),\n            config: self.config.clone(),\n            node_handler: self.node_handler.clone(),\n        }\n    }\n}\n\nimpl fmt::Display for ValueType {\n    fn fmt(\u0026self, f: \u0026mut fmt::Formatter\u003c'_\u003e) -\u003e fmt::Result {\n        match self {\n            ValueType::String(s) =\u003e write!(f, \"{}\", s),\n            ValueType::Number(n) =\u003e write!(f, \"{}\", n),\n            ValueType::Bool(b) =\u003e write!(f, \"{}\", b),\n            ValueType::Null =\u003e write!(f, \"null\"),\n            ValueType::Json(json) =\u003e write!(f, \"{}\", json),\n            ValueType::Map(_) =\u003e write!(f, \"{{...}}\"),\n            ValueType::Array(_) =\u003e write!(f, \"[...]\"),\n            ValueType::Bytes(_) =\u003e write!(f, \"\u003cbinary\u003e\"),\n            ValueType::Struct(_) =\u003e write!(f, \"\u003cstruct\u003e\"),\n        }\n    }\n}\n\n/// Wrapper type for external types to allow implementing traits for them\npub struct ValueWrapper\u003cT\u003e(pub T);\n\n/// Trait for types that can be converted to ValueType, defined in our crate\npub trait IntoValueType {\n    /// Convert to ValueType\n    fn into_value_type(self) -\u003e ValueType;\n}\n\n// Implement for primitive types to avoid orphan rule violations\nimpl IntoValueType for \u0026str {\n    fn into_value_type(self) -\u003e ValueType {\n        ValueType::String(self.to_string())\n    }\n}\n\nimpl IntoValueType for String {\n    fn into_value_type(self) -\u003e ValueType {\n        ValueType::String(self)\n    }\n}\n\nimpl IntoValueType for i64 {\n    fn into_value_type(self) -\u003e ValueType {\n        ValueType::Number(self as f64)\n    }\n}\n\nimpl IntoValueType for f64 {\n    fn into_value_type(self) -\u003e ValueType {\n        ValueType::Number(self)\n    }\n}\n\nimpl IntoValueType for bool {\n    fn into_value_type(self) -\u003e ValueType {\n        ValueType::Bool(self)\n    }\n}\n\n/// Convenience macro for creating a ValueType::Map from key-value pairs\n///\n/// # Examples\n///\n/// ```\n/// use kagi_node::vmap;\n/// let map = vmap! {\n///     \"name\" =\u003e \"John Doe\",\n///     \"age\" =\u003e 30,\n///     \"is_active\" =\u003e true,\n///     \"stats\" =\u003e vmap! {\n///         \"visits\" =\u003e 42,\n///         \"likes\" =\u003e 123\n///     }\n/// };\n/// ```\n#[macro_export]\nmacro_rules! vmap {\n    ($($key:expr =\u003e $value:expr),* $(,)?) =\u003e {{\n        let mut map = ::std::collections::HashMap::new();\n        $(\n            let key_str = $key.to_string();\n            let value = $crate::services::to_value_type($value);\n            map.insert(key_str, value);\n        )*\n        $crate::services::ValueType::Map(map)\n    }}\n}\n\n/// Helper function to convert a value to ValueType\n/// This is used by the vmap! macro\npub fn to_value_type\u003cT: Serialize\u003e(value: T) -\u003e ValueType {\n    // Special case for \u0026str or String\n    if let Ok(s) = serde_json::to_value(\u0026value) {\n        if s.is_string() {\n            if let Value::String(string_val) = s {\n                return ValueType::String(string_val);\n            }\n        }\n    }\n\n    // Use serde_json to convert the value to a JSON Value first\n    match serde_json::to_value(value) {\n        Ok(Value::String(s)) =\u003e ValueType::String(s),\n        Ok(Value::Number(n)) =\u003e {\n            if let Some(f) = n.as_f64() {\n                ValueType::Number(f)\n            } else {\n                ValueType::Number(n.as_i64().unwrap_or(0) as f64)\n            }\n        }\n        Ok(Value::Bool(b)) =\u003e ValueType::Bool(b),\n        Ok(Value::Array(arr)) =\u003e {\n            let values = arr.into_iter().map(|v| ValueType::Json(v)).collect();\n            ValueType::Array(values)\n        }\n        Ok(Value::Object(obj)) =\u003e {\n            let mut map = HashMap::new();\n            for (k, v) in obj {\n                // Recursively convert each value using its appropriate type\n                map.insert(\n                    k,\n                    match v {\n                        Value::String(s) =\u003e ValueType::String(s),\n                        Value::Number(n) =\u003e {\n                            if let Some(f) = n.as_f64() {\n                                ValueType::Number(f)\n                            } else {\n                                ValueType::Number(n.as_i64().unwrap_or(0) as f64)\n                            }\n                        }\n                        Value::Bool(b) =\u003e ValueType::Bool(b),\n                        Value::Array(arr) =\u003e {\n                            let values = arr\n                                .into_iter()\n                                .map(|item| match item {\n                                    Value::String(s) =\u003e ValueType::String(s),\n                                    Value::Number(n) =\u003e {\n                                        if let Some(f) = n.as_f64() {\n                                            ValueType::Number(f)\n                                        } else {\n                                            ValueType::Number(n.as_i64().unwrap_or(0) as f64)\n                                        }\n                                    }\n                                    Value::Bool(b) =\u003e ValueType::Bool(b),\n                                    _ =\u003e ValueType::Json(item), // Fall back to Json for other types\n                                })\n                                .collect();\n                            ValueType::Array(values)\n                        }\n                        Value::Object(nested_obj) =\u003e {\n                            let mut nested_map = HashMap::new();\n                            for (nested_k, nested_v) in nested_obj {\n                                nested_map.insert(\n                                    nested_k,\n                                    match nested_v {\n                                        Value::String(s) =\u003e ValueType::String(s),\n                                        Value::Number(n) =\u003e {\n                                            if let Some(f) = n.as_f64() {\n                                                ValueType::Number(f)\n                                            } else {\n                                                ValueType::Number(n.as_i64().unwrap_or(0) as f64)\n                                            }\n                                        }\n                                        Value::Bool(b) =\u003e ValueType::Bool(b),\n                                        _ =\u003e ValueType::Json(nested_v), // Fall back to Json for deep nesting\n                                    },\n                                );\n                            }\n                            ValueType::Map(nested_map)\n                        }\n                        Value::Null =\u003e ValueType::Null,\n                        _ =\u003e ValueType::Json(v), // Fall back to Json for other types\n                    },\n                );\n            }\n            ValueType::Map(map)\n        }\n        Ok(Value::Null) =\u003e ValueType::Null,\n        Err(_) =\u003e ValueType::Null,\n    }\n}\n\n/// Helper function to check if a value can be cast to a specific type\nfn option_as\u003cU: 'static\u003e(value: \u0026dyn Any) -\u003e Option\u003c\u0026U\u003e {\n    value.downcast_ref::\u003cU\u003e()\n}\n\n/// Utility macro for creating a ValueType from a json! macro\n#[macro_export]\nmacro_rules! vjson {\n    ($($json:tt)+) =\u003e {\n        $crate::services::ValueType::from(serde_json::json!($($json)+))\n    };\n}\n\n/// The RequestContext provides an API for services to interact with the node\n/// It allows services to make requests to other services, publish events, and subscribe to events\n/// without having direct access to the node instance.\n#[derive(Clone)]\npub struct RequestContext {\n    /// The service making the request (source)\n    source: String,\n    /// The parent service path (for tracing chains of requests)\n    parent_path: Option\u003cString\u003e,\n    /// Data context for the request (metrics, debugging info, etc.)\n    data: ValueType,\n    /// Node handler for making requests\n    node_handler: Arc\u003cdyn NodeRequestHandler + Send + Sync\u003e,\n}\n\n// Implement Default for RequestContext, which uses a DummyNodeRequestHandler\n// This is mainly needed for deserialization and should not be used in actual code\nimpl Default for RequestContext {\n    fn default() -\u003e Self {\n        RequestContext {\n            source: \"default\".to_string(),\n            parent_path: None,\n            data: ValueType::Map(HashMap::new()),\n            node_handler: Arc::new(crate::node::DummyNodeRequestHandler {}),\n        }\n    }\n}\n\n// Implement Debug manually since we can't derive it (node_handler doesn't implement Debug)\nimpl fmt::Debug for RequestContext {\n    fn fmt(\u0026self, f: \u0026mut fmt::Formatter\u003c'_\u003e) -\u003e fmt::Result {\n        f.debug_struct(\"RequestContext\")\n            .field(\"source\", \u0026self.source)\n            .field(\"parent_path\", \u0026self.parent_path)\n            .field(\"data\", \u0026self.data)\n            .field(\"node_handler\", \u0026\"\u003cnode handler\u003e\")\n            .finish()\n    }\n}\n\n/// Trait for node request handling\n/// This abstraction allows us to use different implementations for testing\n#[async_trait::async_trait]\npub trait NodeRequestHandler {\n    /// Make a request to a service\n    async fn request(\u0026self, path: String, params: ValueType) -\u003e Result\u003cServiceResponse\u003e;\n\n    /// Publish an event\n    async fn publish(\u0026self, topic: String, data: ValueType) -\u003e Result\u003c()\u003e;\n\n    /// Subscribe to events\n    async fn subscribe(\n        \u0026self,\n        topic: String,\n        callback: Box\u003cdyn Fn(ValueType) -\u003e Result\u003c()\u003e + Send + Sync\u003e,\n    ) -\u003e Result\u003c()\u003e;\n}\n\nimpl RequestContext {\n    /// Create a new RequestContext\n    pub fn new(\n        source: String,\n        data: ValueType,\n        node_handler: Arc\u003cdyn NodeRequestHandler + Send + Sync\u003e,\n    ) -\u003e Self {\n        RequestContext {\n            source,\n            parent_path: None,\n            data,\n            node_handler,\n        }\n    }\n\n    /// Create a RequestContext for a child request\n    pub fn new_child(\u0026self, source: String, data: ValueType) -\u003e Self {\n        RequestContext {\n            source,\n            parent_path: Some(self.current_path()),\n            data,\n            node_handler: self.node_handler.clone(),\n        }\n    }\n\n    /// Get the current path (for tracing)\n    pub fn current_path(\u0026self) -\u003e String {\n        self.source.clone()\n    }\n\n    /// Get the parent path (for tracing)\n    pub fn parent_path(\u0026self) -\u003e Option\u003cString\u003e {\n        self.parent_path.clone()\n    }\n\n    /// Get a context value\n    pub fn get(\u0026self, key: \u0026str) -\u003e Option\u003cValueType\u003e {\n        if let ValueType::Map(map) = \u0026self.data {\n            map.get(key).cloned()\n        } else {\n            None\n        }\n    }\n\n    /// Set a context value\n    pub fn set(\u0026mut self, key: \u0026str, value: ValueType) {\n        if let ValueType::Map(map) = \u0026mut self.data {\n            map.insert(key.to_string(), value);\n        } else {\n            let mut map = HashMap::new();\n            map.insert(key.to_string(), value);\n            self.data = ValueType::Map(map);\n        }\n    }\n\n    /// Make a request to another service\n    pub async fn request\u003cP: Into\u003cString\u003e, V: Into\u003cValueType\u003e\u003e(\n        \u0026self,\n        path: P,\n        params: V,\n    ) -\u003e Result\u003cServiceResponse\u003e {\n        let path_str = path.into();\n        let params_value = params.into();\n\n        println!(\n            \"RequestContext::request - Making request to path: {}\",\n            path_str\n        );\n        println!(\"RequestContext::request - With params: {:?}\", params_value);\n\n        // Make the request through the node handler\n        let response = self.node_handler.request(path_str, params_value).await;\n\n        println!(\"RequestContext::request - Response: {:?}\", response);\n\n        response\n    }\n\n    /// Publish an event\n    pub async fn publish\u003cT: Into\u003cString\u003e, V: Into\u003cValueType\u003e\u003e(\n        \u0026self,\n        topic: T,\n        data: V,\n    ) -\u003e Result\u003c()\u003e {\n        let topic_str = topic.into();\n        let data_value = data.into();\n\n        self.node_handler.publish(topic_str, data_value).await\n    }\n\n    /// Subscribe to events\n    pub async fn subscribe\u003cT: Into\u003cString\u003e, F\u003e(\u0026self, topic: T, callback: F) -\u003e Result\u003c()\u003e\n    where\n        F: Fn(ValueType) -\u003e Result\u003c()\u003e + Send + Sync + 'static,\n    {\n        let topic_str = topic.into();\n        let callback_box = Box::new(callback);\n\n        self.node_handler.subscribe(topic_str, callback_box).await\n    }\n\n    /// Convert to ValueType for storing in ServiceRequest\n    pub fn to_value_type(\u0026self) -\u003e ValueType {\n        self.data.clone()\n    }\n\n    /// Create from ValueType\n    pub fn from_value_type(\n        source: String,\n        data: ValueType,\n        node_handler: Arc\u003cdyn NodeRequestHandler + Send + Sync\u003e,\n    ) -\u003e Self {\n        RequestContext {\n            source,\n            parent_path: None,\n            data,\n            node_handler,\n        }\n    }\n}\n","traces":[{"line":45,"address":[],"length":0,"stats":{"Line":18}},{"line":46,"address":[],"length":0,"stats":{"Line":18}},{"line":47,"address":[],"length":0,"stats":{"Line":12}},{"line":48,"address":[],"length":0,"stats":{"Line":6}},{"line":55,"address":[],"length":0,"stats":{"Line":48}},{"line":56,"address":[],"length":0,"stats":{"Line":48}},{"line":57,"address":[],"length":0,"stats":{"Line":48}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":46}},{"line":161,"address":[],"length":0,"stats":{"Line":46}},{"line":165,"address":[],"length":0,"stats":{"Line":140}},{"line":166,"address":[],"length":0,"stats":{"Line":140}},{"line":167,"address":[],"length":0,"stats":{"Line":34}},{"line":168,"address":[],"length":0,"stats":{"Line":28}},{"line":169,"address":[],"length":0,"stats":{"Line":28}},{"line":170,"address":[],"length":0,"stats":{"Line":163}},{"line":171,"address":[],"length":0,"stats":{"Line":45}},{"line":173,"address":[],"length":0,"stats":{"Line":28}},{"line":175,"address":[],"length":0,"stats":{"Line":24}},{"line":176,"address":[],"length":0,"stats":{"Line":81}},{"line":177,"address":[],"length":0,"stats":{"Line":24}},{"line":179,"address":[],"length":0,"stats":{"Line":43}},{"line":180,"address":[],"length":0,"stats":{"Line":10}},{"line":181,"address":[],"length":0,"stats":{"Line":20}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":1}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":9}},{"line":222,"address":[],"length":0,"stats":{"Line":9}},{"line":223,"address":[],"length":0,"stats":{"Line":9}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":15}},{"line":230,"address":[],"length":0,"stats":{"Line":15}},{"line":231,"address":[],"length":0,"stats":{"Line":15}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":99}},{"line":238,"address":[],"length":0,"stats":{"Line":99}},{"line":239,"address":[],"length":0,"stats":{"Line":99}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":175}},{"line":278,"address":[],"length":0,"stats":{"Line":7}},{"line":279,"address":[],"length":0,"stats":{"Line":168}},{"line":280,"address":[],"length":0,"stats":{"Line":7}},{"line":282,"address":[],"length":0,"stats":{"Line":14}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":288,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":25}},{"line":362,"address":[],"length":0,"stats":{"Line":25}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":138}},{"line":444,"address":[],"length":0,"stats":{"Line":138}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":507,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":6}},{"line":532,"address":[],"length":0,"stats":{"Line":6}},{"line":533,"address":[],"length":0,"stats":{"Line":6}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":553,"address":[],"length":0,"stats":{"Line":0}},{"line":555,"address":[],"length":0,"stats":{"Line":0}},{"line":580,"address":[],"length":0,"stats":{"Line":1}},{"line":583,"address":[],"length":0,"stats":{"Line":1}},{"line":584,"address":[],"length":0,"stats":{"Line":1}},{"line":591,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":598,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":606,"address":[],"length":0,"stats":{"Line":0}},{"line":607,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":612,"address":[],"length":0,"stats":{"Line":0}},{"line":616,"address":[],"length":0,"stats":{"Line":0}},{"line":617,"address":[],"length":0,"stats":{"Line":0}},{"line":621,"address":[],"length":0,"stats":{"Line":2}},{"line":622,"address":[],"length":0,"stats":{"Line":1}},{"line":625,"address":[],"length":0,"stats":{"Line":1}},{"line":626,"address":[],"length":0,"stats":{"Line":0}},{"line":628,"address":[],"length":0,"stats":{"Line":1}},{"line":632,"address":[],"length":0,"stats":{"Line":0}},{"line":633,"address":[],"length":0,"stats":{"Line":0}},{"line":634,"address":[],"length":0,"stats":{"Line":0}},{"line":635,"address":[],"length":0,"stats":{"Line":0}},{"line":639,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":641,"address":[],"length":0,"stats":{"Line":0}},{"line":642,"address":[],"length":0,"stats":{"Line":1}},{"line":645,"address":[],"length":0,"stats":{"Line":1}},{"line":648,"address":[],"length":0,"stats":{"Line":1}},{"line":649,"address":[],"length":0,"stats":{"Line":1}},{"line":650,"address":[],"length":0,"stats":{"Line":1}},{"line":653,"address":[],"length":0,"stats":{"Line":1}},{"line":656,"address":[],"length":0,"stats":{"Line":1}},{"line":657,"address":[],"length":0,"stats":{"Line":1}},{"line":658,"address":[],"length":0,"stats":{"Line":1}},{"line":659,"address":[],"length":0,"stats":{"Line":1}},{"line":662,"address":[],"length":0,"stats":{"Line":1}},{"line":665,"address":[],"length":0,"stats":{"Line":2}},{"line":666,"address":[],"length":0,"stats":{"Line":1}},{"line":668,"address":[],"length":0,"stats":{"Line":1}},{"line":673,"address":[],"length":0,"stats":{"Line":6}},{"line":674,"address":[],"length":0,"stats":{"Line":6}},{"line":675,"address":[],"length":0,"stats":{"Line":3}},{"line":677,"address":[],"length":0,"stats":{"Line":3}},{"line":678,"address":[],"length":0,"stats":{"Line":0}},{"line":679,"address":[],"length":0,"stats":{"Line":0}},{"line":680,"address":[],"length":0,"stats":{"Line":0}},{"line":683,"address":[],"length":0,"stats":{"Line":3}},{"line":684,"address":[],"length":0,"stats":{"Line":0}},{"line":687,"address":[],"length":0,"stats":{"Line":3}},{"line":689,"address":[],"length":0,"stats":{"Line":3}},{"line":693,"address":[],"length":0,"stats":{"Line":0}},{"line":694,"address":[],"length":0,"stats":{"Line":0}},{"line":695,"address":[],"length":0,"stats":{"Line":0}},{"line":699,"address":[],"length":0,"stats":{"Line":4}},{"line":700,"address":[],"length":0,"stats":{"Line":4}},{"line":703,"address":[],"length":0,"stats":{"Line":8}},{"line":704,"address":[],"length":0,"stats":{"Line":6}},{"line":705,"address":[],"length":0,"stats":{"Line":2}},{"line":710,"address":[],"length":0,"stats":{"Line":0}},{"line":711,"address":[],"length":0,"stats":{"Line":0}},{"line":713,"address":[],"length":0,"stats":{"Line":0}},{"line":716,"address":[],"length":0,"stats":{"Line":0}},{"line":717,"address":[],"length":0,"stats":{"Line":0}},{"line":718,"address":[],"length":0,"stats":{"Line":0}},{"line":721,"address":[],"length":0,"stats":{"Line":0}},{"line":722,"address":[],"length":0,"stats":{"Line":0}},{"line":726,"address":[],"length":0,"stats":{"Line":0}},{"line":730,"address":[],"length":0,"stats":{"Line":2}},{"line":731,"address":[],"length":0,"stats":{"Line":2}},{"line":732,"address":[],"length":0,"stats":{"Line":1}},{"line":736,"address":[],"length":0,"stats":{"Line":0}},{"line":737,"address":[],"length":0,"stats":{"Line":0}},{"line":738,"address":[],"length":0,"stats":{"Line":0}},{"line":742,"address":[],"length":0,"stats":{"Line":4}},{"line":744,"address":[],"length":0,"stats":{"Line":2}},{"line":747,"address":[],"length":0,"stats":{"Line":4}},{"line":748,"address":[],"length":0,"stats":{"Line":2}},{"line":749,"address":[],"length":0,"stats":{"Line":2}},{"line":750,"address":[],"length":0,"stats":{"Line":4}},{"line":753,"address":[],"length":0,"stats":{"Line":0}},{"line":757,"address":[],"length":0,"stats":{"Line":0}},{"line":759,"address":[],"length":0,"stats":{"Line":0}},{"line":760,"address":[],"length":0,"stats":{"Line":0}},{"line":761,"address":[],"length":0,"stats":{"Line":0}},{"line":762,"address":[],"length":0,"stats":{"Line":0}},{"line":763,"address":[],"length":0,"stats":{"Line":0}},{"line":769,"address":[],"length":0,"stats":{"Line":5}},{"line":770,"address":[],"length":0,"stats":{"Line":5}},{"line":771,"address":[],"length":0,"stats":{"Line":0}},{"line":772,"address":[],"length":0,"stats":{"Line":0}},{"line":773,"address":[],"length":0,"stats":{"Line":0}},{"line":774,"address":[],"length":0,"stats":{"Line":0}},{"line":775,"address":[],"length":0,"stats":{"Line":5}},{"line":776,"address":[],"length":0,"stats":{"Line":0}},{"line":777,"address":[],"length":0,"stats":{"Line":0}},{"line":778,"address":[],"length":0,"stats":{"Line":0}},{"line":779,"address":[],"length":0,"stats":{"Line":0}},{"line":795,"address":[],"length":0,"stats":{"Line":0}},{"line":796,"address":[],"length":0,"stats":{"Line":0}},{"line":801,"address":[],"length":0,"stats":{"Line":0}},{"line":802,"address":[],"length":0,"stats":{"Line":0}},{"line":807,"address":[],"length":0,"stats":{"Line":0}},{"line":808,"address":[],"length":0,"stats":{"Line":0}},{"line":813,"address":[],"length":0,"stats":{"Line":0}},{"line":814,"address":[],"length":0,"stats":{"Line":0}},{"line":819,"address":[],"length":0,"stats":{"Line":0}},{"line":820,"address":[],"length":0,"stats":{"Line":0}},{"line":855,"address":[],"length":0,"stats":{"Line":89}},{"line":857,"address":[],"length":0,"stats":{"Line":178}},{"line":858,"address":[],"length":0,"stats":{"Line":0}},{"line":859,"address":[],"length":0,"stats":{"Line":114}},{"line":860,"address":[],"length":0,"stats":{"Line":0}},{"line":866,"address":[],"length":0,"stats":{"Line":32}},{"line":867,"address":[],"length":0,"stats":{"Line":0}},{"line":868,"address":[],"length":0,"stats":{"Line":7}},{"line":869,"address":[],"length":0,"stats":{"Line":14}},{"line":870,"address":[],"length":0,"stats":{"Line":0}},{"line":872,"address":[],"length":0,"stats":{"Line":0}},{"line":875,"address":[],"length":0,"stats":{"Line":1}},{"line":876,"address":[],"length":0,"stats":{"Line":8}},{"line":877,"address":[],"length":0,"stats":{"Line":27}},{"line":878,"address":[],"length":0,"stats":{"Line":8}},{"line":880,"address":[],"length":0,"stats":{"Line":16}},{"line":881,"address":[],"length":0,"stats":{"Line":16}},{"line":882,"address":[],"length":0,"stats":{"Line":74}},{"line":884,"address":[],"length":0,"stats":{"Line":0}},{"line":885,"address":[],"length":0,"stats":{"Line":0}},{"line":886,"address":[],"length":0,"stats":{"Line":0}},{"line":887,"address":[],"length":0,"stats":{"Line":22}},{"line":888,"address":[],"length":0,"stats":{"Line":6}},{"line":889,"address":[],"length":0,"stats":{"Line":6}},{"line":890,"address":[],"length":0,"stats":{"Line":6}},{"line":892,"address":[],"length":0,"stats":{"Line":0}},{"line":895,"address":[],"length":0,"stats":{"Line":1}},{"line":896,"address":[],"length":0,"stats":{"Line":0}},{"line":897,"address":[],"length":0,"stats":{"Line":0}},{"line":898,"address":[],"length":0,"stats":{"Line":0}},{"line":899,"address":[],"length":0,"stats":{"Line":0}},{"line":900,"address":[],"length":0,"stats":{"Line":0}},{"line":901,"address":[],"length":0,"stats":{"Line":0}},{"line":902,"address":[],"length":0,"stats":{"Line":0}},{"line":903,"address":[],"length":0,"stats":{"Line":0}},{"line":905,"address":[],"length":0,"stats":{"Line":0}},{"line":908,"address":[],"length":0,"stats":{"Line":0}},{"line":909,"address":[],"length":0,"stats":{"Line":0}},{"line":911,"address":[],"length":0,"stats":{"Line":0}},{"line":912,"address":[],"length":0,"stats":{"Line":0}},{"line":914,"address":[],"length":0,"stats":{"Line":0}},{"line":915,"address":[],"length":0,"stats":{"Line":0}},{"line":916,"address":[],"length":0,"stats":{"Line":0}},{"line":917,"address":[],"length":0,"stats":{"Line":0}},{"line":918,"address":[],"length":0,"stats":{"Line":0}},{"line":919,"address":[],"length":0,"stats":{"Line":0}},{"line":920,"address":[],"length":0,"stats":{"Line":0}},{"line":921,"address":[],"length":0,"stats":{"Line":0}},{"line":922,"address":[],"length":0,"stats":{"Line":0}},{"line":923,"address":[],"length":0,"stats":{"Line":0}},{"line":925,"address":[],"length":0,"stats":{"Line":0}},{"line":928,"address":[],"length":0,"stats":{"Line":0}},{"line":929,"address":[],"length":0,"stats":{"Line":0}},{"line":933,"address":[],"length":0,"stats":{"Line":0}},{"line":935,"address":[],"length":0,"stats":{"Line":0}},{"line":936,"address":[],"length":0,"stats":{"Line":0}},{"line":940,"address":[],"length":0,"stats":{"Line":16}},{"line":942,"address":[],"length":0,"stats":{"Line":0}},{"line":943,"address":[],"length":0,"stats":{"Line":0}},{"line":948,"address":[],"length":0,"stats":{"Line":0}},{"line":949,"address":[],"length":0,"stats":{"Line":0}},{"line":978,"address":[],"length":0,"stats":{"Line":30}},{"line":980,"address":[],"length":0,"stats":{"Line":30}},{"line":982,"address":[],"length":0,"stats":{"Line":30}},{"line":983,"address":[],"length":0,"stats":{"Line":30}},{"line":990,"address":[],"length":0,"stats":{"Line":0}},{"line":991,"address":[],"length":0,"stats":{"Line":0}},{"line":992,"address":[],"length":0,"stats":{"Line":0}},{"line":993,"address":[],"length":0,"stats":{"Line":0}},{"line":994,"address":[],"length":0,"stats":{"Line":0}},{"line":995,"address":[],"length":0,"stats":{"Line":0}},{"line":1020,"address":[],"length":0,"stats":{"Line":136}},{"line":1034,"address":[],"length":0,"stats":{"Line":0}},{"line":1037,"address":[],"length":0,"stats":{"Line":0}},{"line":1039,"address":[],"length":0,"stats":{"Line":0}},{"line":1044,"address":[],"length":0,"stats":{"Line":0}},{"line":1045,"address":[],"length":0,"stats":{"Line":0}},{"line":1049,"address":[],"length":0,"stats":{"Line":0}},{"line":1050,"address":[],"length":0,"stats":{"Line":0}},{"line":1054,"address":[],"length":0,"stats":{"Line":0}},{"line":1055,"address":[],"length":0,"stats":{"Line":0}},{"line":1056,"address":[],"length":0,"stats":{"Line":0}},{"line":1058,"address":[],"length":0,"stats":{"Line":0}},{"line":1063,"address":[],"length":0,"stats":{"Line":0}},{"line":1064,"address":[],"length":0,"stats":{"Line":0}},{"line":1065,"address":[],"length":0,"stats":{"Line":0}},{"line":1067,"address":[],"length":0,"stats":{"Line":0}},{"line":1068,"address":[],"length":0,"stats":{"Line":0}},{"line":1069,"address":[],"length":0,"stats":{"Line":0}},{"line":1074,"address":[],"length":0,"stats":{"Line":3}},{"line":1079,"address":[],"length":0,"stats":{"Line":3}},{"line":1080,"address":[],"length":0,"stats":{"Line":3}},{"line":1082,"address":[],"length":0,"stats":{"Line":3}},{"line":1083,"address":[],"length":0,"stats":{"Line":3}},{"line":1084,"address":[],"length":0,"stats":{"Line":3}},{"line":1086,"address":[],"length":0,"stats":{"Line":3}},{"line":1089,"address":[],"length":0,"stats":{"Line":6}},{"line":1091,"address":[],"length":0,"stats":{"Line":3}},{"line":1093,"address":[],"length":0,"stats":{"Line":3}},{"line":1097,"address":[],"length":0,"stats":{"Line":2}},{"line":1102,"address":[],"length":0,"stats":{"Line":2}},{"line":1103,"address":[],"length":0,"stats":{"Line":2}},{"line":1105,"address":[],"length":0,"stats":{"Line":2}},{"line":1109,"address":[],"length":0,"stats":{"Line":2}},{"line":1113,"address":[],"length":0,"stats":{"Line":2}},{"line":1114,"address":[],"length":0,"stats":{"Line":2}},{"line":1116,"address":[],"length":0,"stats":{"Line":2}},{"line":1120,"address":[],"length":0,"stats":{"Line":0}},{"line":1121,"address":[],"length":0,"stats":{"Line":0}},{"line":1125,"address":[],"length":0,"stats":{"Line":0}}],"covered":132,"coverable":393},{"path":["/","Users","rafael","dev","kagi","node","src","services","node_info.rs"],"content":"use anyhow::{anyhow, Result};\nuse async_trait::async_trait;\nuse serde_json::json;\nuse std::sync::{Arc, Mutex};\nuse std::time::{Duration, Instant};\n\nuse crate::node::NodeConfig;\nuse crate::services::abstract_service::{AbstractService, ServiceMetadata, ServiceState};\nuse crate::services::{ResponseStatus, ServiceRequest, ServiceResponse};\n\n/// Node Info Service - provides information about the node\npub struct NodeInfoService {\n    /// The path at which the service is available\n    path: String,\n\n    /// Current state of the service\n    state: Mutex\u003cServiceState\u003e,\n\n    /// Node uptime tracker\n    uptime: Instant,\n\n    /// Node configuration\n    config: Arc\u003cNodeConfig\u003e,\n}\n\nimpl NodeInfoService {\n    /// Create a new Node Info Service\n    pub fn new(network_id: \u0026str, config: Arc\u003cNodeConfig\u003e) -\u003e Self {\n        NodeInfoService {\n            path: format!(\"{}/internal/node\", network_id),\n            state: Mutex::new(ServiceState::Created),\n            uptime: Instant::now(),\n            config,\n        }\n    }\n}\n\n#[async_trait]\nimpl AbstractService for NodeInfoService {\n    fn name(\u0026self) -\u003e \u0026str {\n        \"internal/node\"\n    }\n\n    fn path(\u0026self) -\u003e \u0026str {\n        \u0026self.path\n    }\n\n    fn state(\u0026self) -\u003e ServiceState {\n        *self.state.lock().unwrap()\n    }\n\n    async fn init(\u0026mut self, context: \u0026crate::services::RequestContext) -\u003e Result\u003c()\u003e {\n        // Nothing specific to initialize for NodeInfoService\n        *self.state.lock().unwrap() = ServiceState::Initialized;\n        Ok(())\n    }\n\n    async fn start(\u0026mut self) -\u003e Result\u003c()\u003e {\n        // Nothing specific to do here for NodeInfoService\n        *self.state.lock().unwrap() = ServiceState::Running;\n        Ok(())\n    }\n\n    async fn stop(\u0026mut self) -\u003e Result\u003c()\u003e {\n        // Nothing specific to do here for NodeInfoService\n        *self.state.lock().unwrap() = ServiceState::Stopped;\n        Ok(())\n    }\n\n    async fn process_request(\u0026self, request: ServiceRequest) -\u003e Result\u003cServiceResponse\u003e {\n        // Extract the operation from the request\n        let operation = request.operation.clone();\n\n        match operation.as_str() {\n            \"info\" =\u003e {\n                // Get basic node info\n                let node_info = json!({\n                    \"name\": \"Kagi Node\",\n                    \"version\": env!(\"CARGO_PKG_VERSION\"),\n                    \"network_id\": self.config.network_id(),\n                    \"uptime\": self.uptime.elapsed().as_secs(),\n                    \"state\": format!(\"{:?}\", self.state()),\n                });\n\n                Ok(ServiceResponse {\n                    status: ResponseStatus::Success,\n                    message: \"Node info retrieved successfully\".to_string(),\n                    data: Some(crate::services::ValueType::from_json(node_info)),\n                })\n            }\n            \"stats\" =\u003e {\n                // Get node stats\n                let stats = json!({\n                    \"uptime\": self.uptime.elapsed().as_secs(),\n                    \"memory_usage\": 0, // Placeholder\n                    \"cpu_usage\": 0,    // Placeholder\n                    \"disk_usage\": 0,   // Placeholder\n                    \"network\": {\n                        \"peers\": 0,\n                        \"inbound\": 0,\n                        \"outbound\": 0,\n                    }\n                });\n\n                Ok(ServiceResponse {\n                    status: ResponseStatus::Success,\n                    message: \"Node stats retrieved successfully\".to_string(),\n                    data: Some(crate::services::ValueType::from_json(stats)),\n                })\n            }\n            \"config\" =\u003e {\n                // Get node configuration\n                let config = json!({\n                    \"network_id\": self.config.network_id(),\n                    \"node_path\": self.config.node_path(),\n                    \"db_path\": self.config.db_path(),\n                    \"version\": env!(\"CARGO_PKG_VERSION\"),\n                });\n\n                Ok(ServiceResponse {\n                    status: ResponseStatus::Success,\n                    message: \"Node configuration retrieved successfully\".to_string(),\n                    data: Some(crate::services::ValueType::from_json(config)),\n                })\n            }\n            _ =\u003e {\n                // Unknown operation\n                Err(anyhow!(\"Unknown operation: {}\", operation))\n            }\n        }\n    }\n\n    fn description(\u0026self) -\u003e String {\n        \"Node Information service providing node details, stats, and configuration\".to_string()\n    }\n\n    fn metadata(\u0026self) -\u003e ServiceMetadata {\n        ServiceMetadata {\n            name: self.name().to_string(),\n            path: self.path().to_string(),\n            state: self.state(),\n            description: self.description(),\n            operations: vec![\n                \"info\".to_string(),\n                \"stats\".to_string(),\n                \"config\".to_string(),\n            ],\n            version: \"1.0.0\".to_string(),\n        }\n    }\n}\n","traces":[{"line":28,"address":[],"length":0,"stats":{"Line":13}},{"line":30,"address":[],"length":0,"stats":{"Line":13}},{"line":31,"address":[],"length":0,"stats":{"Line":13}},{"line":32,"address":[],"length":0,"stats":{"Line":13}},{"line":40,"address":[],"length":0,"stats":{"Line":25}},{"line":41,"address":[],"length":0,"stats":{"Line":25}},{"line":44,"address":[],"length":0,"stats":{"Line":40}},{"line":45,"address":[],"length":0,"stats":{"Line":40}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":13}},{"line":54,"address":[],"length":0,"stats":{"Line":13}},{"line":55,"address":[],"length":0,"stats":{"Line":13}},{"line":58,"address":[],"length":0,"stats":{"Line":13}},{"line":60,"address":[],"length":0,"stats":{"Line":13}},{"line":61,"address":[],"length":0,"stats":{"Line":13}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}}],"covered":14,"coverable":67},{"path":["/","Users","rafael","dev","kagi","node","src","services","registry.rs"],"content":"use anyhow::{anyhow, Result};\nuse async_trait::async_trait;\nuse log::{error, info};\nuse serde_json::json;\nuse std::collections::{HashMap, HashSet};\nuse std::fmt;\nuse std::sync::Arc;\nuse tokio::sync::RwLock;\n\nuse crate::db::SqliteDatabase;\nuse crate::services::abstract_service::{ServiceMetadata, ServiceState};\nuse crate::services::{\n    AbstractService, NodeRequestHandler, RequestContext, ServiceRequest, ServiceResponse, ValueType,\n};\n\n/// A type representing a callback function for event subscribers\ntype EventCallback = Box\u003cdyn Fn(ValueType) -\u003e Result\u003c()\u003e + Send + Sync\u003e;\n\n/// ServiceRegistry is responsible for registering, discovering, and managing services\n/// It combines the functionality of the previous ServiceRegistry and ServiceManager\npub struct ServiceRegistry {\n    /// The network ID\n    network_id: String,\n\n    /// The path of the registry\n    path: String,\n\n    /// The services managed by this registry\n    services: RwLock\u003cHashMap\u003cString, Arc\u003cdyn AbstractService\u003e\u003e\u003e,\n\n    /// The database connection (optional)\n    db: Option\u003cArc\u003cSqliteDatabase\u003e\u003e,\n\n    /// The node handler for sending requests to other services\n    node_handler: Option\u003cArc\u003cdyn NodeRequestHandler + Send + Sync\u003e\u003e,\n\n    /// Event subscribers with topic as the key\n    event_subscribers: RwLock\u003cHashMap\u003cString, Vec\u003c(String, EventCallback)\u003e\u003e\u003e,\n}\n\n// Implement Clone manually for ServiceRegistry\nimpl Clone for ServiceRegistry {\n    fn clone(\u0026self) -\u003e Self {\n        ServiceRegistry {\n            network_id: self.network_id.clone(),\n            path: self.path.clone(),\n            services: RwLock::new(HashMap::new()),\n            db: self.db.clone(),\n            node_handler: self.node_handler.clone(),\n            event_subscribers: RwLock::new(HashMap::new()),\n        }\n    }\n}\n\nimpl ServiceRegistry {\n    /// Create a new registry with the given network ID\n    pub fn new(network_id: \u0026str) -\u003e Self {\n        let path = format!(\"internal/registry\");\n\n        ServiceRegistry {\n            network_id: network_id.to_string(),\n            path,\n            services: RwLock::new(HashMap::new()),\n            db: None,\n            node_handler: None,\n            event_subscribers: RwLock::new(HashMap::new()),\n        }\n    }\n\n    /// Create a new registry with a database connection\n    pub fn new_with_db(network_id: \u0026str, db: Arc\u003cSqliteDatabase\u003e) -\u003e Self {\n        let path = format!(\"internal/registry\");\n\n        ServiceRegistry {\n            network_id: network_id.to_string(),\n            path,\n            services: RwLock::new(HashMap::new()),\n            db: Some(db),\n            node_handler: None,\n            event_subscribers: RwLock::new(HashMap::new()),\n        }\n    }\n\n    /// Set the node handler\n    pub fn set_node_handler(\u0026mut self, node_handler: Arc\u003cdyn NodeRequestHandler + Send + Sync\u003e) {\n        self.node_handler = Some(node_handler);\n    }\n\n    /// Register a service with the registry\n    pub async fn register_service(\u0026self, service: Arc\u003cdyn AbstractService\u003e) -\u003e Result\u003c()\u003e {\n        let mut services = self.services.write().await;\n        let service_name = service.name().to_string();\n\n        info!(\n            \"Registering service: {} at {}\",\n            service_name,\n            service.path()\n        );\n\n        if services.contains_key(\u0026service_name) {\n            return Err(anyhow!(\"Service '{}' is already registered\", service_name));\n        }\n\n        services.insert(service_name, service);\n\n        Ok(())\n    }\n\n    /// Get a service by name\n    pub async fn get_service(\u0026self, name: \u0026str) -\u003e Option\u003cArc\u003cdyn AbstractService\u003e\u003e {\n        let services = self.services.read().await;\n        services.get(name).cloned()\n    }\n\n    /// Get a service by path\n    pub async fn get_service_by_path(\u0026self, path: \u0026str) -\u003e Option\u003cArc\u003cdyn AbstractService\u003e\u003e {\n        let services = self.services.read().await;\n\n        // Check for direct matches first\n        for service in services.values() {\n            if service.path() == path {\n                return Some(service.clone());\n            }\n        }\n\n        // Check for matches with the network ID prefix\n        let full_path = if !path.starts_with(\u0026self.network_id) {\n            format!(\"{}/{}\", self.network_id, path)\n        } else {\n            path.to_string()\n        };\n\n        for service in services.values() {\n            if service.path() == full_path {\n                return Some(service.clone());\n            }\n            // Also check if the path is just the service name\n            if service.name() == path {\n                return Some(service.clone());\n            }\n        }\n\n        None\n    }\n\n    /// List all services\n    pub async fn list_services(\u0026self) -\u003e Vec\u003cString\u003e {\n        let services = self.services.read().await;\n        services.keys().cloned().collect()\n    }\n\n    /// Get all services\n    pub async fn get_all_services(\u0026self) -\u003e Vec\u003cArc\u003cdyn AbstractService\u003e\u003e {\n        let services = self.services.read().await;\n        services.values().cloned().collect()\n    }\n\n    /// Process a service request\n    pub async fn process_request(\u0026self, request: ServiceRequest) -\u003e Result\u003cServiceResponse\u003e {\n        // Extract the path from the request\n        let path = \u0026request.path;\n\n        // Check if this is a request for the registry service itself\n        if path == \"registry\" || path == \"internal/registry\" {\n            // Handle registry-specific operations\n            let operation = \u0026request.operation;\n            let params = \u0026request.params;\n\n            match operation.as_str() {\n                \"list\" =\u003e {\n                    // List all services\n                    let services = self.list_services().await;\n                    Ok(ServiceResponse::success(\n                        \"Services listed successfully\",\n                        Some(json!({\"services\": services}).into()),\n                    ))\n                }\n                \"get\" =\u003e {\n                    // Get a service by name\n                    if let ValueType::Map(map) = params {\n                        let name = map\n                            .get(\"name\")\n                            .ok_or_else(|| anyhow!(\"Missing 'name' parameter\"))?;\n\n                        if let ValueType::String(name_str) = name {\n                            let service = self.get_service(name_str).await;\n\n                            if let Some(service) = service {\n                                Ok(ServiceResponse::success(\n                                    format!(\"Service '{}' found\", name_str),\n                                    Some(\n                                        json!({\n                                            \"name\": service.name(),\n                                            \"path\": service.path(),\n                                            \"state\": format!(\"{:?}\", service.state()),\n                                        })\n                                        .into(),\n                                    ),\n                                ))\n                            } else {\n                                Ok(ServiceResponse::error(format!(\n                                    \"Service '{}' not found\",\n                                    name_str\n                                )))\n                            }\n                        } else {\n                            Ok(ServiceResponse::error(\"'name' parameter must be a string\"))\n                        }\n                    } else {\n                        Ok(ServiceResponse::error(\"Parameters must be a map\"))\n                    }\n                }\n                \"register\" =\u003e {\n                    // This is for service metadata registration - not actual service instances\n                    // This will be implemented later\n                    Ok(ServiceResponse::error(\"Not implemented yet\"))\n                }\n                \"unregister\" =\u003e {\n                    // This is for service metadata unregistration - not actual service instances\n                    // This will be implemented later\n                    Ok(ServiceResponse::error(\"Not implemented yet\"))\n                }\n                \"subscribe\" =\u003e {\n                    // This is for subscribing to service events through the API\n                    // It's different from the subscribe method above, which is used internally\n                    if let ValueType::Map(map) = params {\n                        let topic = map\n                            .get(\"topic\")\n                            .ok_or_else(|| anyhow!(\"Missing 'topic' parameter\"))?;\n\n                        if let ValueType::String(topic_str) = topic {\n                            // Since we can't pass callbacks through API, we'd need to implement\n                            // a different mechanism (e.g., webhook or IPC callback)\n                            // For now, return not implemented\n                            Ok(ServiceResponse::error(\"Not implemented yet\"))\n                        } else {\n                            Ok(ServiceResponse::error(\"'topic' parameter must be a string\"))\n                        }\n                    } else {\n                        Ok(ServiceResponse::error(\"Parameters must be a map\"))\n                    }\n                }\n                _ =\u003e Ok(ServiceResponse::error(format!(\n                    \"Unknown operation: {}\",\n                    operation\n                ))),\n            }\n        } else {\n            // Forward the request to the appropriate service\n            let service = self\n                .get_service_by_path(path)\n                .await\n                .ok_or_else(|| anyhow!(\"No service found for path: {}\", path))?;\n\n            // Process the request with the service\n            service.process_request(request).await\n        }\n    }\n\n    /// Get the database connection\n    pub fn get_db(\u0026self) -\u003e Option\u003cArc\u003cSqliteDatabase\u003e\u003e {\n        self.db.clone()\n    }\n\n    /// Publish an event to all subscribers\n    pub async fn publish(\u0026self, topic: String, data: ValueType) -\u003e Result\u003c()\u003e {\n        // If topic doesn't have a service name, it's an error\n        if !topic.contains('/') {\n            return Err(anyhow!(\"Topic must include service name: {}\", topic));\n        }\n\n        let subscribers = self.event_subscribers.read().await;\n\n        // First, try to find direct matches\n        if let Some(callbacks) = subscribers.get(\u0026topic) {\n            for (service_name, callback) in callbacks {\n                // Execute each callback and log errors\n                match callback(data.clone()) {\n                    Ok(_) =\u003e {}\n                    Err(e) =\u003e {\n                        error!(\n                            \"Error executing callback for service '{}' on topic '{}': {}\",\n                            service_name, topic, e\n                        );\n                    }\n                }\n            }\n        }\n\n        // Check for wildcard subscribers (e.g., \"service/*\")\n        for (pattern, callbacks) in subscribers.iter() {\n            if pattern.ends_with(\"/*\") {\n                let prefix = \u0026pattern[0..pattern.len() - 1]; // Remove the '*'\n\n                if topic.starts_with(prefix) {\n                    for (service_name, callback) in callbacks {\n                        // Execute each callback and log errors\n                        match callback(data.clone()) {\n                            Ok(_) =\u003e {}\n                            Err(e) =\u003e {\n                                error!(\"Error executing callback for service '{}' on topic '{}' (matched wildcard '{}'): {}\", \n                                       service_name, topic, pattern, e);\n                            }\n                        }\n                    }\n                }\n            }\n        }\n\n        Ok(())\n    }\n\n    /// Subscribe to events\n    pub async fn subscribe(\n        \u0026self,\n        service_name: String,\n        topic: String,\n        callback: EventCallback,\n    ) -\u003e Result\u003c()\u003e {\n        let mut subscribers = self.event_subscribers.write().await;\n\n        // Create entry if it doesn't exist\n        if !subscribers.contains_key(\u0026topic) {\n            subscribers.insert(topic.clone(), Vec::new());\n        }\n\n        // Add the callback\n        if let Some(callbacks) = subscribers.get_mut(\u0026topic) {\n            callbacks.push((service_name, callback));\n        }\n\n        Ok(())\n    }\n}\n\n/// Implementation of the AbstractService trait for ServiceRegistry\n#[async_trait::async_trait]\nimpl AbstractService for ServiceRegistry {\n    fn name(\u0026self) -\u003e \u0026str {\n        \"registry\"\n    }\n\n    fn path(\u0026self) -\u003e \u0026str {\n        \u0026self.path\n    }\n\n    fn state(\u0026self) -\u003e ServiceState {\n        ServiceState::Running\n    }\n\n    async fn init(\u0026mut self, context: \u0026crate::services::RequestContext) -\u003e Result\u003c()\u003e {\n        Ok(())\n    }\n\n    async fn start(\u0026mut self) -\u003e Result\u003c()\u003e {\n        Ok(())\n    }\n\n    async fn stop(\u0026mut self) -\u003e Result\u003c()\u003e {\n        Ok(())\n    }\n\n    async fn process_request(\u0026self, request: ServiceRequest) -\u003e Result\u003cServiceResponse\u003e {\n        // Extract the path from the request\n        let path = \u0026request.path;\n\n        // Check if this is a request for the registry service itself\n        if path == \"registry\" || path == \"internal/registry\" {\n            // Handle registry-specific operations\n            let operation = \u0026request.operation;\n            let params = \u0026request.params;\n\n            match operation.as_str() {\n                \"list\" =\u003e {\n                    // List all services\n                    let services = self.list_services().await;\n                    Ok(ServiceResponse::success(\n                        \"Services listed successfully\",\n                        Some(json!({\"services\": services}).into()),\n                    ))\n                }\n                \"get\" =\u003e {\n                    // Get a service by name\n                    if let ValueType::Map(map) = params {\n                        let name = map\n                            .get(\"name\")\n                            .ok_or_else(|| anyhow!(\"Missing 'name' parameter\"))?;\n\n                        if let ValueType::String(name_str) = name {\n                            let service = self.get_service(name_str).await;\n\n                            if let Some(service) = service {\n                                Ok(ServiceResponse::success(\n                                    format!(\"Service '{}' found\", name_str),\n                                    Some(\n                                        json!({\n                                            \"name\": service.name(),\n                                            \"path\": service.path(),\n                                            \"state\": format!(\"{:?}\", service.state()),\n                                        })\n                                        .into(),\n                                    ),\n                                ))\n                            } else {\n                                Ok(ServiceResponse::error(format!(\n                                    \"Service '{}' not found\",\n                                    name_str\n                                )))\n                            }\n                        } else {\n                            Ok(ServiceResponse::error(\"'name' parameter must be a string\"))\n                        }\n                    } else {\n                        Ok(ServiceResponse::error(\"Parameters must be a map\"))\n                    }\n                }\n                \"register\" =\u003e {\n                    // This is for service metadata registration - not actual service instances\n                    // This will be implemented later\n                    Ok(ServiceResponse::error(\"Not implemented yet\"))\n                }\n                \"unregister\" =\u003e {\n                    // This is for service metadata unregistration - not actual service instances\n                    // This will be implemented later\n                    Ok(ServiceResponse::error(\"Not implemented yet\"))\n                }\n                \"subscribe\" =\u003e {\n                    // This is for subscribing to service events through the API\n                    // It's different from the subscribe method above, which is used internally\n                    if let ValueType::Map(map) = params {\n                        let topic = map\n                            .get(\"topic\")\n                            .ok_or_else(|| anyhow!(\"Missing 'topic' parameter\"))?;\n\n                        if let ValueType::String(topic_str) = topic {\n                            // Since we can't pass callbacks through API, we'd need to implement\n                            // a different mechanism (e.g., webhook or IPC callback)\n                            // For now, return not implemented\n                            Ok(ServiceResponse::error(\"Not implemented yet\"))\n                        } else {\n                            Ok(ServiceResponse::error(\"'topic' parameter must be a string\"))\n                        }\n                    } else {\n                        Ok(ServiceResponse::error(\"Parameters must be a map\"))\n                    }\n                }\n                _ =\u003e Ok(ServiceResponse::error(format!(\n                    \"Unknown operation: {}\",\n                    operation\n                ))),\n            }\n        } else {\n            // Forward the request to the appropriate service\n            let service = self\n                .get_service_by_path(path)\n                .await\n                .ok_or_else(|| anyhow!(\"No service found for path: {}\", path))?;\n\n            // Process the request with the service\n            service.process_request(request).await\n        }\n    }\n\n    fn description(\u0026self) -\u003e String {\n        \"Registry service for service discovery\".to_string()\n    }\n\n    fn metadata(\u0026self) -\u003e ServiceMetadata {\n        ServiceMetadata {\n            name: self.name().to_string(),\n            path: self.path().to_string(),\n            state: self.state(),\n            description: self.description(),\n            operations: vec![\n                \"list\".to_string(),\n                \"get\".to_string(),\n                \"register\".to_string(),\n                \"unregister\".to_string(),\n            ],\n            version: \"1.0.0\".to_string(),\n        }\n    }\n}\n\n/// Registry Service for service discovery and management\n/// This is a system service that provides information about available services\npub struct RegistryService {\n    /// Name of the service\n    name: String,\n    /// Path of the service\n    path: String,\n    /// Current state\n    state: std::sync::Mutex\u003cServiceState\u003e,\n    /// The database\n    db: Arc\u003cSqliteDatabase\u003e,\n}\n\nimpl RegistryService {\n    /// Create a new registry service\n    pub fn new(db: Arc\u003cSqliteDatabase\u003e, network_id: \u0026str) -\u003e Self {\n        RegistryService {\n            name: \"registry\".to_string(),\n            path: format!(\"{}/registry\", network_id),\n            state: std::sync::Mutex::new(ServiceState::Created),\n            db,\n        }\n    }\n\n    /// Register a service\n    pub async fn register_service(\u0026self, service: Arc\u003cdyn AbstractService\u003e) -\u003e Result\u003c()\u003e {\n        // Log the service registration\n        info!(\n            \"Service '{}' registered at {}\",\n            service.name(),\n            service.path()\n        );\n        Ok(())\n    }\n}\n\n#[async_trait]\nimpl AbstractService for RegistryService {\n    fn name(\u0026self) -\u003e \u0026str {\n        \u0026self.name\n    }\n\n    fn path(\u0026self) -\u003e \u0026str {\n        \u0026self.path\n    }\n\n    fn state(\u0026self) -\u003e ServiceState {\n        *self.state.lock().unwrap()\n    }\n\n    async fn init(\u0026mut self, context: \u0026crate::services::RequestContext) -\u003e Result\u003c()\u003e {\n        *self.state.lock().unwrap() = ServiceState::Initialized;\n        Ok(())\n    }\n\n    async fn start(\u0026mut self) -\u003e Result\u003c()\u003e {\n        *self.state.lock().unwrap() = ServiceState::Running;\n        Ok(())\n    }\n\n    async fn stop(\u0026mut self) -\u003e Result\u003c()\u003e {\n        *self.state.lock().unwrap() = ServiceState::Stopped;\n        Ok(())\n    }\n\n    async fn process_request(\u0026self, request: ServiceRequest) -\u003e Result\u003cServiceResponse\u003e {\n        // Handle registry service requests\n        let operation = request.operation.as_str();\n\n        match operation {\n            \"list\" =\u003e {\n                // List all services\n                // For now, we'll return a simple success message\n                Ok(ServiceResponse::success(\"Services listed\", None))\n            }\n            \"get\" =\u003e {\n                // Get a service by name\n                if let Some(name) = request.params.get(\"name\") {\n                    // For now, we'll return a simple success message\n                    Ok(ServiceResponse::success(\n                        \u0026format!(\"Service found: {}\", name),\n                        None,\n                    ))\n                } else {\n                    Ok(ServiceResponse::error(\"Missing service name\"))\n                }\n            }\n            \"register\" =\u003e {\n                // Register a service\n                if let Some(_) = request.params.get(\"service\") {\n                    // For now, we'll return a simple success message\n                    Ok(ServiceResponse::success(\"Service registered\", None))\n                } else {\n                    Ok(ServiceResponse::error(\"Missing service data\"))\n                }\n            }\n            \"unregister\" =\u003e {\n                // Unregister a service\n                if let Some(name) = request.params.get(\"name\") {\n                    // For now, we'll return a simple success message\n                    Ok(ServiceResponse::success(\n                        \u0026format!(\"Service unregistered: {}\", name),\n                        None,\n                    ))\n                } else {\n                    Ok(ServiceResponse::error(\"Missing service name\"))\n                }\n            }\n            _ =\u003e Ok(ServiceResponse::error(\u0026format!(\n                \"Unknown operation: {}\",\n                operation\n            ))),\n        }\n    }\n\n    fn description(\u0026self) -\u003e String {\n        \"Registry service for service discovery\".to_string()\n    }\n\n    fn metadata(\u0026self) -\u003e ServiceMetadata {\n        ServiceMetadata {\n            name: self.name.clone(),\n            path: self.path.clone(),\n            state: self.state(),\n            description: self.description(),\n            operations: vec![\n                \"list\".to_string(),\n                \"get\".to_string(),\n                \"register\".to_string(),\n                \"unregister\".to_string(),\n            ],\n            version: \"1.0.0\".to_string(),\n        }\n    }\n}\n","traces":[{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":21}},{"line":72,"address":[],"length":0,"stats":{"Line":21}},{"line":75,"address":[],"length":0,"stats":{"Line":21}},{"line":77,"address":[],"length":0,"stats":{"Line":21}},{"line":78,"address":[],"length":0,"stats":{"Line":21}},{"line":80,"address":[],"length":0,"stats":{"Line":21}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":88}},{"line":91,"address":[],"length":0,"stats":{"Line":44}},{"line":92,"address":[],"length":0,"stats":{"Line":22}},{"line":94,"address":[],"length":0,"stats":{"Line":22}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":22}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":22}},{"line":106,"address":[],"length":0,"stats":{"Line":22}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":156}},{"line":117,"address":[],"length":0,"stats":{"Line":156}},{"line":120,"address":[],"length":0,"stats":{"Line":267}},{"line":121,"address":[],"length":0,"stats":{"Line":189}},{"line":122,"address":[],"length":0,"stats":{"Line":63}},{"line":127,"address":[],"length":0,"stats":{"Line":30}},{"line":128,"address":[],"length":0,"stats":{"Line":15}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":30}},{"line":134,"address":[],"length":0,"stats":{"Line":15}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":15}},{"line":139,"address":[],"length":0,"stats":{"Line":15}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":36}},{"line":148,"address":[],"length":0,"stats":{"Line":36}},{"line":149,"address":[],"length":0,"stats":{"Line":18}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":156}},{"line":161,"address":[],"length":0,"stats":{"Line":78}},{"line":164,"address":[],"length":0,"stats":{"Line":156}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":156}},{"line":251,"address":[],"length":0,"stats":{"Line":78}},{"line":252,"address":[],"length":0,"stats":{"Line":78}},{"line":253,"address":[],"length":0,"stats":{"Line":156}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":12}},{"line":268,"address":[],"length":0,"stats":{"Line":6}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":12}},{"line":275,"address":[],"length":0,"stats":{"Line":12}},{"line":276,"address":[],"length":0,"stats":{"Line":18}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":6}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":18}},{"line":292,"address":[],"length":0,"stats":{"Line":12}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":6}},{"line":314,"address":[],"length":0,"stats":{"Line":6}},{"line":320,"address":[],"length":0,"stats":{"Line":12}},{"line":323,"address":[],"length":0,"stats":{"Line":12}},{"line":324,"address":[],"length":0,"stats":{"Line":6}},{"line":328,"address":[],"length":0,"stats":{"Line":12}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":6}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":360,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":2}},{"line":502,"address":[],"length":0,"stats":{"Line":2}},{"line":503,"address":[],"length":0,"stats":{"Line":2}},{"line":504,"address":[],"length":0,"stats":{"Line":2}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":1}},{"line":524,"address":[],"length":0,"stats":{"Line":1}},{"line":527,"address":[],"length":0,"stats":{"Line":2}},{"line":528,"address":[],"length":0,"stats":{"Line":2}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":1}},{"line":536,"address":[],"length":0,"stats":{"Line":1}},{"line":537,"address":[],"length":0,"stats":{"Line":1}},{"line":540,"address":[],"length":0,"stats":{"Line":2}},{"line":541,"address":[],"length":0,"stats":{"Line":2}},{"line":542,"address":[],"length":0,"stats":{"Line":2}},{"line":545,"address":[],"length":0,"stats":{"Line":1}},{"line":546,"address":[],"length":0,"stats":{"Line":1}},{"line":547,"address":[],"length":0,"stats":{"Line":1}},{"line":550,"address":[],"length":0,"stats":{"Line":6}},{"line":552,"address":[],"length":0,"stats":{"Line":6}},{"line":554,"address":[],"length":0,"stats":{"Line":6}},{"line":555,"address":[],"length":0,"stats":{"Line":6}},{"line":558,"address":[],"length":0,"stats":{"Line":2}},{"line":560,"address":[],"length":0,"stats":{"Line":4}},{"line":562,"address":[],"length":0,"stats":{"Line":2}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":3}},{"line":574,"address":[],"length":0,"stats":{"Line":2}},{"line":576,"address":[],"length":0,"stats":{"Line":2}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":1}},{"line":583,"address":[],"length":0,"stats":{"Line":2}},{"line":590,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[],"length":0,"stats":{"Line":0}},{"line":601,"address":[],"length":0,"stats":{"Line":0}},{"line":604,"address":[],"length":0,"stats":{"Line":0}},{"line":606,"address":[],"length":0,"stats":{"Line":0}},{"line":607,"address":[],"length":0,"stats":{"Line":0}},{"line":608,"address":[],"length":0,"stats":{"Line":0}},{"line":609,"address":[],"length":0,"stats":{"Line":0}},{"line":610,"address":[],"length":0,"stats":{"Line":0}},{"line":616,"address":[],"length":0,"stats":{"Line":0}}],"covered":78,"coverable":249},{"path":["/","Users","rafael","dev","kagi","node","src","services","sqlite.rs"],"content":"use anyhow::{anyhow, Result};\nuse async_trait::async_trait;\nuse log::{info, warn};\nuse rusqlite::{params, Connection, ToSql};\nuse serde::{Deserialize, Serialize};\nuse serde_json::{json, Map, Value};\nuse std::collections::HashMap;\nuse std::sync::Arc;\nuse uuid::Uuid;\n\nuse crate::db::SqliteDatabase;\nuse crate::ipc::IpcResponseStatus;\nuse crate::services::abstract_service::{\n    AbstractService, CrudOperationType, ServiceMetadata, ServiceState,\n};\nuse crate::services::utils;\nuse crate::services::{ServiceRequest, ServiceResponse, ValueType};\n\n/// SQLite storage type\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub enum SqliteStorageType {\n    /// In-memory storage\n    Memory,\n    /// Disk-based storage\n    Disk,\n}\n\n/// SQLite storage options\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct SqliteStorageOptions {\n    /// Storage type (memory or disk)\n    pub storage_type: SqliteStorageType,\n    /// Maximum size of the database in bytes (0 for unlimited)\n    pub max_size: Option\u003cusize\u003e,\n    /// Path to the database file (only used for disk storage)\n    pub path: Option\u003cString\u003e,\n}\n\n/// SQLite schema definition\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct SqliteSchemaField {\n    /// Field name\n    pub name: String,\n    /// Field type\n    pub field_type: String,\n    /// Whether the field is required\n    pub required: bool,\n    /// Default value for the field\n    pub default: Option\u003cValue\u003e,\n}\n\n/// SQLite schema\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct SqliteSchema {\n    /// Collection/table name\n    pub collection: String,\n    /// Fields in the schema\n    pub fields: Vec\u003cSqliteSchemaField\u003e,\n}\n\n/// CRUD operation parameters\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct CrudOperation {\n    /// Type of CRUD operation\n    pub operation: CrudOperationType,\n    /// Collection to operate on\n    pub collection: String,\n    /// Document data (for create/update)\n    pub document: Option\u003cValue\u003e,\n    /// Query filter (for read/update/delete)\n    pub filter: Option\u003cValue\u003e,\n    /// Query options (limit, skip, etc.)\n    pub options: Option\u003cValue\u003e,\n}\n\n/// SQL operation\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct SqlOperation {\n    /// SQL query to execute\n    pub query: String,\n    /// Query parameters\n    pub params: Option\u003cValue\u003e,\n    /// Whether to return results (SELECT) or just success/failure (UPDATE, etc.)\n    pub return_results: Option\u003cbool\u003e,\n}\n\n// SqliteCrud Mixin - reusable CRUD functionality for SQLite-based services\npub struct SqliteCrudMixin {\n    /// The database connection\n    db: Arc\u003cSqliteDatabase\u003e,\n    /// Storage options\n    storage_options: SqliteStorageOptions,\n    /// Schema (if structured data)\n    schema: Option\u003cVec\u003cSqliteSchema\u003e\u003e,\n}\n\nimpl SqliteCrudMixin {\n    /// Create a new SqliteCrudMixin\n    pub fn new(\n        db: Arc\u003cSqliteDatabase\u003e,\n        storage_options: SqliteStorageOptions,\n        schema: Option\u003cVec\u003cSqliteSchema\u003e\u003e,\n    ) -\u003e Self {\n        SqliteCrudMixin {\n            db,\n            storage_options,\n            schema,\n        }\n    }\n\n    /// Create a new SqliteCrudMixin with in-memory database\n    /// This handles database creation internally, simplifying service implementations\n    pub async fn new_in_memory(schema: Vec\u003cSqliteSchema\u003e) -\u003e Result\u003cSelf\u003e {\n        // Create an in-memory database\n        let db = Arc::new(SqliteDatabase::new(\":memory:\").await?);\n\n        let storage_options = SqliteStorageOptions {\n            storage_type: SqliteStorageType::Memory,\n            max_size: None,\n            path: None,\n        };\n\n        Ok(Self::new(db, storage_options, Some(schema)))\n    }\n\n    /// Create a new SqliteCrudMixin with file-based database and schema\n    pub async fn new_with_path(path: \u0026str, schema: Vec\u003cSqliteSchema\u003e) -\u003e Result\u003cSelf\u003e {\n        // Create a file-based database\n        let db = Arc::new(SqliteDatabase::new(path).await?);\n\n        let storage_options = SqliteStorageOptions {\n            storage_type: SqliteStorageType::Disk,\n            max_size: None,\n            path: Some(path.to_string()),\n        };\n\n        Ok(Self::new(db, storage_options, Some(schema)))\n    }\n\n    /// Create a new SqliteCrudMixin from storage options\n    /// This creates the appropriate database based on the storage options\n    pub async fn new_from_options(\n        storage_options: SqliteStorageOptions,\n        schema: Vec\u003cSqliteSchema\u003e,\n    ) -\u003e Result\u003cSelf\u003e {\n        let db = match storage_options.storage_type {\n            SqliteStorageType::Memory =\u003e Arc::new(SqliteDatabase::new(\":memory:\").await?),\n            SqliteStorageType::Disk =\u003e {\n                let path = storage_options\n                    .path\n                    .as_ref()\n                    .ok_or_else(|| anyhow!(\"Path is required for disk storage\"))?;\n                Arc::new(SqliteDatabase::new(path).await?)\n            }\n        };\n\n        Ok(Self::new(db, storage_options, Some(schema)))\n    }\n\n    /// Initialize the metadata table for SqliteCrudMixin\n    pub async fn init(\u0026self, context: \u0026crate::services::RequestContext) -\u003e Result\u003c()\u003e {\n        let conn = self.db.get_connection().await?;\n\n        // Create the _metadata table to track collections\n        conn.execute(\n            \"CREATE TABLE IF NOT EXISTS _metadata (\n                collection TEXT PRIMARY KEY,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n            )\",\n            [],\n        )?;\n\n        // If schema is provided, create the collections\n        if let Some(schemas) = \u0026self.schema {\n            for schema in schemas {\n                self.ensure_collection_exists(\u0026conn, \u0026schema.collection)?;\n            }\n        }\n\n        Ok(())\n    }\n\n    /// Process a CRUD request\n    pub async fn process_request(\u0026self, request: ServiceRequest) -\u003e Result\u003cServiceResponse\u003e {\n        // Determine which CRUD operation to perform based on the operation field\n        match request.operation.as_str() {\n            \"create\" =\u003e {\n                let collection = request\n                    .get_param(\"collection\")\n                    .and_then(|v| v.as_str().map(|s| s.to_string()))\n                    .ok_or_else(|| anyhow!(\"Collection is required\"))?;\n\n                let document = request\n                    .get_param(\"document\")\n                    .ok_or_else(|| anyhow!(\"Document is required for create operation\"))?;\n\n                self.create(\u0026collection, document).await\n            }\n            \"read\" =\u003e {\n                let collection = request\n                    .get_param(\"collection\")\n                    .and_then(|v| v.as_str().map(|s| s.to_string()))\n                    .ok_or_else(|| anyhow!(\"Collection is required\"))?;\n\n                let filter = request.get_param(\"filter\");\n                let options = request.get_param(\"options\");\n\n                self.read(\u0026collection, filter, options).await\n            }\n            \"update\" =\u003e {\n                let collection = request\n                    .get_param(\"collection\")\n                    .and_then(|v| v.as_str().map(|s| s.to_string()))\n                    .ok_or_else(|| anyhow!(\"Collection is required\"))?;\n\n                let filter = request\n                    .get_param(\"filter\")\n                    .ok_or_else(|| anyhow!(\"Filter is required for update operation\"))?;\n\n                let document = request\n                    .get_param(\"document\")\n                    .ok_or_else(|| anyhow!(\"Document is required for update operation\"))?;\n\n                self.update(\u0026collection, filter, document).await\n            }\n            \"delete\" =\u003e {\n                let collection = request\n                    .get_param(\"collection\")\n                    .and_then(|v| v.as_str().map(|s| s.to_string()))\n                    .ok_or_else(|| anyhow!(\"Collection is required\"))?;\n\n                let filter = request\n                    .get_param(\"filter\")\n                    .ok_or_else(|| anyhow!(\"Filter is required for delete operation\"))?;\n\n                self.delete(\u0026collection, filter).await\n            }\n            _ =\u003e Err(anyhow!(\"Unknown operation: {}\", request.operation)),\n        }\n    }\n\n    /// Create a new document\n    async fn create(\u0026self, collection: \u0026str, document: ValueType) -\u003e Result\u003cServiceResponse\u003e {\n        let conn = self.db.get_connection().await?;\n\n        // Ensure the collection exists\n        self.ensure_collection_exists(\u0026conn, collection)?;\n\n        // Get a JSON representation for storage\n        let document_json = document.to_json();\n\n        // Generate an ID if none exists\n        let mut document_with_id = document_json.clone();\n        if !document_with_id.is_object() {\n            return Err(anyhow!(\"Document must be an object\"));\n        }\n\n        // Ensure we have an _id field\n        if let Some(obj) = document_with_id.as_object_mut() {\n            if !obj.contains_key(\"_id\") {\n                // Generate a UUID\n                let id = Uuid::new_v4().to_string();\n                obj.insert(\"_id\".to_string(), Value::String(id));\n            }\n        }\n\n        // Insert the document\n        let json_str = serde_json::to_string(\u0026document_with_id)?;\n        let id = document_with_id\n            .get(\"_id\")\n            .and_then(|v| v.as_str())\n            .unwrap_or_default();\n\n        conn.execute(\n            \u0026format!(\"INSERT INTO {} (_id, data) VALUES (?, ?)\", collection),\n            params![id, json_str],\n        )?;\n\n        Ok(ServiceResponse {\n            status: IpcResponseStatus::Success.into(),\n            message: format!(\"Document created with ID: {}\", id),\n            data: Some(ValueType::from_json(document_with_id)),\n        })\n    }\n\n    /// Read documents\n    async fn read(\n        \u0026self,\n        collection: \u0026str,\n        filter: Option\u003cValueType\u003e,\n        options: Option\u003cValueType\u003e,\n    ) -\u003e Result\u003cServiceResponse\u003e {\n        let conn = self.db.get_connection().await?;\n\n        // Check if the collection exists, if not, return empty array\n        if !self.collection_exists(\u0026conn, collection)? {\n            return Ok(ServiceResponse {\n                status: IpcResponseStatus::Success.into(),\n                message: format!(\"Found 0 documents\"),\n                data: Some(ValueType::Array(vec![])),\n            });\n        }\n\n        // Print the original filter for debugging\n        println!(\"SqliteCrudMixin::read - Original filter: {:?}\", filter);\n\n        // Convert filter to JSON for the query\n        let filter_json = filter.map(|f| f.to_json());\n        println!(\"SqliteCrudMixin::read - Filter JSON: {:?}\", filter_json);\n\n        let options_json = options.map(|o| o.to_json());\n\n        // Build the query\n        let mut sql = format!(\"SELECT data FROM {}\", collection);\n        let mut params: Vec\u003cBox\u003cdyn ToSql\u003e\u003e = Vec::new();\n\n        if let Some(filter) = \u0026filter_json {\n            if let Some(filter_obj) = filter.as_object() {\n                if !filter_obj.is_empty() {\n                    sql += \" WHERE \";\n                    let mut first = true;\n\n                    for (key, value) in filter_obj {\n                        println!(\n                            \"SqliteCrudMixin::read - Filter key: {}, value: {:?}\",\n                            key, value\n                        );\n\n                        if !first {\n                            sql += \" AND \";\n                        }\n                        first = false;\n\n                        // We need to handle nested fields in JSON\n                        if key == \"_id\" {\n                            sql += \"_id = ?\";\n                            params.push(Box::new(value.as_str().unwrap_or_default().to_string()));\n                        } else {\n                            // For other fields, we use JSON_EXTRACT\n                            sql += \u0026format!(\"JSON_EXTRACT(data, '$.{}') = ?\", key.replace(\".\", \"\"));\n\n                            // Handle different value types properly\n                            let param_value = if value.is_string() {\n                                // For string values, extract the string without quotes\n                                value.as_str().unwrap_or_default().to_string()\n                            } else {\n                                // For other values, use the JSON string representation\n                                value.to_string()\n                            };\n\n                            println!(\"SqliteCrudMixin::read - SQL param value: {}\", param_value);\n                            params.push(Box::new(param_value));\n                        }\n                    }\n                }\n            }\n        }\n\n        // Handle options (limit, offset, sort)\n        if let Some(options) = \u0026options_json {\n            if let Some(options_obj) = options.as_object() {\n                // Handle sort\n                if let Some(sort) = options_obj.get(\"sort\") {\n                    if let Some(sort_obj) = sort.as_object() {\n                        if !sort_obj.is_empty() {\n                            sql += \" ORDER BY \";\n                            let mut first = true;\n\n                            for (key, value) in sort_obj {\n                                if !first {\n                                    sql += \", \";\n                                }\n                                first = false;\n\n                                // Extract the field from JSON\n                                sql += \u0026format!(\"JSON_EXTRACT(data, '$.{}')\", key);\n\n                                // Determine sort direction\n                                if let Some(sort_dir) = value.as_i64() {\n                                    if sort_dir \u003c 0 {\n                                        sql += \" DESC\";\n                                    } else {\n                                        sql += \" ASC\";\n                                    }\n                                }\n                            }\n                        }\n                    }\n                }\n\n                // Handle limit and offset\n                if let Some(limit) = options_obj.get(\"limit\").and_then(|v| v.as_i64()) {\n                    sql += \u0026format!(\" LIMIT {}\", limit);\n\n                    if let Some(offset) = options_obj.get(\"offset\").and_then(|v| v.as_i64()) {\n                        sql += \u0026format!(\" OFFSET {}\", offset);\n                    }\n                }\n            }\n        }\n\n        // Execute the query\n        let mut stmt = conn.prepare(\u0026sql)?;\n        let mut rows = stmt.query(rusqlite::params_from_iter(\n            params.iter().map(|p| p.as_ref()),\n        ))?;\n\n        // Parse the results\n        let mut results = Vec::new();\n        while let Some(row) = rows.next()? {\n            let json_str: String = row.get(0)?;\n            if let Ok(json) = serde_json::from_str::\u003cValue\u003e(\u0026json_str) {\n                results.push(ValueType::from_json(json));\n            }\n        }\n\n        Ok(ServiceResponse {\n            status: IpcResponseStatus::Success.into(),\n            message: format!(\"Found {} documents\", results.len()),\n            data: Some(ValueType::Array(results)),\n        })\n    }\n\n    /// Update documents\n    async fn update(\n        \u0026self,\n        collection: \u0026str,\n        filter: ValueType,\n        document: ValueType,\n    ) -\u003e Result\u003cServiceResponse\u003e {\n        let conn = self.db.get_connection().await?;\n\n        // Check if the collection exists\n        if !self.collection_exists(\u0026conn, collection)? {\n            return Err(anyhow!(\"Collection {} does not exist\", collection));\n        }\n\n        // Convert to JSON for storage\n        let filter_json = filter.to_json();\n        let document_json = document.to_json();\n\n        if !filter_json.is_object() {\n            return Err(anyhow!(\"Filter must be an object\"));\n        }\n\n        if !document_json.is_object() {\n            return Err(anyhow!(\"Document must be an object\"));\n        }\n\n        // Find the document to update\n        let mut sql = format!(\"SELECT _id, data FROM {}\", collection);\n        let mut params: Vec\u003cBox\u003cdyn ToSql\u003e\u003e = Vec::new();\n\n        let filter_obj = filter_json.as_object().unwrap();\n        if !filter_obj.is_empty() {\n            sql += \" WHERE \";\n            let mut first = true;\n\n            for (key, value) in filter_obj {\n                if !first {\n                    sql += \" AND \";\n                }\n                first = false;\n\n                // Handle _id separately\n                if key == \"_id\" {\n                    sql += \"_id = ?\";\n                    params.push(Box::new(value.as_str().unwrap_or_default().to_string()));\n                } else {\n                    // For other fields, use JSON_EXTRACT\n                    sql += \u0026format!(\"JSON_EXTRACT(data, '$.{}') = ?\", key);\n                    params.push(Box::new(value.to_string()));\n                }\n            }\n        }\n\n        let mut stmt = conn.prepare(\u0026sql)?;\n        let mut rows = stmt.query(rusqlite::params_from_iter(\n            params.iter().map(|p| p.as_ref()),\n        ))?;\n\n        let mut updated_documents = Vec::new();\n        while let Some(row) = rows.next()? {\n            let id: String = row.get(0)?;\n            let json_str: String = row.get(1)?;\n\n            // Parse the existing document\n            let existing_doc = serde_json::from_str::\u003cValue\u003e(\u0026json_str)?;\n\n            // Merge the existing doc with the update\n            let mut updated_doc = existing_doc.clone();\n            if let (Some(_existing_obj), Some(update_obj)) =\n                (existing_doc.as_object(), document_json.as_object())\n            {\n                if let Some(obj) = updated_doc.as_object_mut() {\n                    // Merge all fields except _id\n                    for (key, value) in update_obj {\n                        if key != \"_id\" {\n                            obj.insert(key.clone(), value.clone());\n                        }\n                    }\n                }\n            }\n\n            // Update in the database\n            let updated_json = serde_json::to_string(\u0026updated_doc)?;\n            conn.execute(\n                \u0026format!(\"UPDATE {} SET data = ? WHERE _id = ?\", collection),\n                params![updated_json, id],\n            )?;\n\n            updated_documents.push(ValueType::from_json(updated_doc));\n        }\n\n        // If nothing was updated, return an appropriate message\n        if updated_documents.is_empty() {\n            return Ok(ServiceResponse {\n                status: IpcResponseStatus::Success.into(),\n                message: \"No documents matched the filter criteria\".to_string(),\n                data: None,\n            });\n        }\n\n        let document_id = if updated_documents.len() == 1 {\n            if let ValueType::Map(map) = \u0026updated_documents[0] {\n                if let Some(ValueType::String(id)) = map.get(\"_id\").cloned() {\n                    id\n                } else {\n                    \"unknown\".to_string()\n                }\n            } else if let ValueType::Json(json) = \u0026updated_documents[0] {\n                json.get(\"_id\")\n                    .and_then(|id| id.as_str())\n                    .unwrap_or(\"unknown\")\n                    .to_string()\n            } else {\n                \"unknown\".to_string()\n            }\n        } else {\n            \"multiple\".to_string()\n        };\n\n        Ok(ServiceResponse {\n            status: IpcResponseStatus::Success.into(),\n            message: format!(\"Document with ID {} updated\", document_id),\n            data: if updated_documents.len() == 1 {\n                Some(updated_documents[0].clone())\n            } else {\n                Some(ValueType::Array(updated_documents))\n            },\n        })\n    }\n\n    /// Delete documents\n    async fn delete(\u0026self, collection: \u0026str, filter: ValueType) -\u003e Result\u003cServiceResponse\u003e {\n        let conn = self.db.get_connection().await?;\n\n        // Check if the collection exists\n        if !self.collection_exists(\u0026conn, collection)? {\n            return Err(anyhow!(\"Collection {} does not exist\", collection));\n        }\n\n        // Convert to JSON for query\n        let filter_json = filter.to_json();\n\n        if !filter_json.is_object() {\n            return Err(anyhow!(\"Filter must be an object\"));\n        }\n\n        // Build the query\n        let mut sql = format!(\"DELETE FROM {}\", collection);\n        let mut params: Vec\u003cBox\u003cdyn ToSql\u003e\u003e = Vec::new();\n\n        let filter_obj = filter_json.as_object().unwrap();\n        if !filter_obj.is_empty() {\n            sql += \" WHERE \";\n            let mut first = true;\n\n            for (key, value) in filter_obj {\n                if !first {\n                    sql += \" AND \";\n                }\n                first = false;\n\n                // Handle _id separately\n                if key == \"_id\" {\n                    sql += \"_id = ?\";\n                    params.push(Box::new(value.as_str().unwrap_or_default().to_string()));\n                } else {\n                    // For other fields, use JSON_EXTRACT\n                    sql += \u0026format!(\"JSON_EXTRACT(data, '$.{}') = ?\", key);\n                    params.push(Box::new(value.to_string()));\n                }\n            }\n        }\n\n        // Execute the query\n        let result = conn.execute(\n            \u0026sql,\n            rusqlite::params_from_iter(params.iter().map(|p| p.as_ref())),\n        )?;\n\n        let mut result_data = HashMap::new();\n        result_data.insert(\"deleted\".to_string(), ValueType::Number(result as f64));\n\n        Ok(ServiceResponse {\n            status: IpcResponseStatus::Success.into(),\n            message: format!(\"Deleted {} documents\", result),\n            data: Some(ValueType::Map(result_data)),\n        })\n    }\n\n    /// Ensure a collection exists, create it if it doesn't\n    fn ensure_collection_exists(\n        \u0026self,\n        conn: \u0026rusqlite::Connection,\n        collection: \u0026str,\n    ) -\u003e Result\u003c()\u003e {\n        // Check if collection exists\n        if self.collection_exists(conn, collection)? {\n            return Ok(());\n        }\n\n        // Create the collection table\n        conn.execute(\n            \u0026format!(\n                \"CREATE TABLE {} (\n                    _id TEXT PRIMARY KEY,\n                    data TEXT NOT NULL\n                )\",\n                collection\n            ),\n            [],\n        )?;\n\n        // Add to metadata\n        conn.execute(\n            \"INSERT INTO _metadata (collection) VALUES (?)\",\n            params![collection],\n        )?;\n\n        Ok(())\n    }\n\n    /// Check if a collection exists\n    fn collection_exists(\u0026self, conn: \u0026rusqlite::Connection, collection: \u0026str) -\u003e Result\u003cbool\u003e {\n        let count: i64 = conn.query_row(\n            \"SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name=?\",\n            params![collection],\n            |row| row.get(0),\n        )?;\n\n        Ok(count \u003e 0)\n    }\n}\n\n// SqliteQueryMixin - reusable direct SQL query functionality for SQLite-based services\npub struct SqliteQueryMixin {\n    /// The database connection\n    db: Arc\u003cSqliteDatabase\u003e,\n    /// Storage options\n    storage_options: SqliteStorageOptions,\n}\n\nimpl SqliteQueryMixin {\n    /// Create a new SqliteQueryMixin\n    pub fn new(db: Arc\u003cSqliteDatabase\u003e, storage_options: SqliteStorageOptions) -\u003e Self {\n        SqliteQueryMixin {\n            db,\n            storage_options,\n        }\n    }\n\n    /// Create a new SqliteQueryMixin with in-memory database\n    /// This handles database creation internally, simplifying service implementations\n    pub async fn new_in_memory() -\u003e Result\u003cSelf\u003e {\n        // Create an in-memory database\n        let db = Arc::new(SqliteDatabase::new(\":memory:\").await?);\n\n        let storage_options = SqliteStorageOptions {\n            storage_type: SqliteStorageType::Memory,\n            max_size: None,\n            path: None,\n        };\n\n        Ok(Self::new(db, storage_options))\n    }\n\n    /// Create a new SqliteQueryMixin with a file-based database\n    /// This handles database creation internally, simplifying service implementations\n    pub async fn new_with_path(path: \u0026str) -\u003e Result\u003cSelf\u003e {\n        // Create a file-based database\n        let db = Arc::new(SqliteDatabase::new(path).await?);\n\n        let storage_options = SqliteStorageOptions {\n            storage_type: SqliteStorageType::Disk,\n            max_size: None,\n            path: Some(path.to_string()),\n        };\n\n        Ok(Self::new(db, storage_options))\n    }\n\n    /// Create a new SqliteQueryMixin from storage options\n    /// This creates the appropriate database based on the storage options\n    pub async fn new_from_options(storage_options: SqliteStorageOptions) -\u003e Result\u003cSelf\u003e {\n        let db = match storage_options.storage_type {\n            SqliteStorageType::Memory =\u003e Arc::new(SqliteDatabase::new(\":memory:\").await?),\n            SqliteStorageType::Disk =\u003e {\n                let path = storage_options\n                    .path\n                    .as_ref()\n                    .ok_or_else(|| anyhow!(\"Path is required for disk storage\"))?;\n                Arc::new(SqliteDatabase::new(path).await?)\n            }\n        };\n\n        Ok(Self::new(db, storage_options))\n    }\n\n    /// Initialize the database for SqliteQueryMixin\n    pub async fn init(\u0026self, context: \u0026crate::services::RequestContext) -\u003e Result\u003c()\u003e {\n        // Nothing specific to initialize for query mixin\n        Ok(())\n    }\n\n    /// Process a SQL request\n    pub async fn process_request(\u0026self, request: ServiceRequest) -\u003e Result\u003cServiceResponse\u003e {\n        match request.operation.as_str() {\n            \"query\" =\u003e {\n                let sql = request\n                    .get_param(\"sql\")\n                    .and_then(|v| v.as_str().map(|s| s.to_string()))\n                    .ok_or_else(|| anyhow!(\"SQL query is required\"))?;\n\n                let params = request.get_param(\"params\").unwrap_or(ValueType::Null);\n\n                self.query(\u0026sql, params).await\n            }\n            \"execute\" =\u003e {\n                let sql = request\n                    .get_param(\"sql\")\n                    .and_then(|v| v.as_str().map(|s| s.to_string()))\n                    .ok_or_else(|| anyhow!(\"SQL query is required\"))?;\n\n                let params = request.get_param(\"params\").unwrap_or(ValueType::Null);\n\n                self.execute(\u0026sql, params).await\n            }\n            _ =\u003e Err(anyhow!(\"Unknown operation: {}\", request.operation)),\n        }\n    }\n\n    /// Execute a SQL query that returns rows\n    async fn query(\u0026self, sql: \u0026str, params: ValueType) -\u003e Result\u003cServiceResponse\u003e {\n        let conn = self.db.get_connection().await?;\n\n        // Convert parameters to SQL params if needed\n        let json_params = params.to_json();\n        let sql_params = utils::json_params_to_sql_params(\u0026json_params)?;\n        let param_refs: Vec\u003c\u0026dyn rusqlite::ToSql\u003e = sql_params.iter().map(|p| p.as_ref()).collect();\n\n        // Prepare statement\n        let mut stmt = conn.prepare(sql)?;\n        let column_names: Vec\u003cString\u003e = stmt\n            .column_names()\n            .into_iter()\n            .map(|s| s.to_string())\n            .collect();\n\n        // Execute query\n        let mut rows = stmt.query(rusqlite::params_from_iter(param_refs.iter()))?;\n\n        // Process results\n        let mut results = Vec::new();\n        while let Some(row) = rows.next()? {\n            let json_obj = utils::map_row_to_json_object(row, \u0026column_names)?;\n            results.push(ValueType::from_json(json_obj));\n        }\n\n        Ok(ServiceResponse {\n            status: IpcResponseStatus::Success.into(),\n            message: format!(\"Query returned {} rows\", results.len()),\n            data: Some(ValueType::Array(results)),\n        })\n    }\n\n    /// Execute a SQL query that doesn't return rows\n    async fn execute(\u0026self, sql: \u0026str, params: ValueType) -\u003e Result\u003cServiceResponse\u003e {\n        let conn = self.db.get_connection().await?;\n\n        // Convert parameters to SQL params if needed\n        let json_params = params.to_json();\n        let sql_params = utils::json_params_to_sql_params(\u0026json_params)?;\n        let param_refs: Vec\u003c\u0026dyn rusqlite::ToSql\u003e = sql_params.iter().map(|p| p.as_ref()).collect();\n\n        // Execute query\n        let rows_affected = conn.execute(sql, rusqlite::params_from_iter(param_refs.iter()))?;\n\n        Ok(ServiceResponse {\n            status: IpcResponseStatus::Success.into(),\n            message: format!(\n                \"Query executed successfully, {} rows affected\",\n                rows_affected\n            ),\n            data: Some(ValueType::Number(rows_affected as f64)),\n        })\n    }\n}\n\n/// SQLite Service - provides both CRUD operations and raw SQL execution\n/// This is an example of a service that uses both mixins\npub struct SqliteService {\n    /// Service name\n    name: String,\n    /// Service path\n    path: String,\n    /// Service state\n    state: ServiceState,\n    /// CRUD mixin for database operations\n    crud_mixin: SqliteCrudMixin,\n    /// Query mixin for SQL operations\n    query_mixin: SqliteQueryMixin,\n}\n\nimpl SqliteService {\n    /// Create a new SQLite service\n    pub fn new(db: Arc\u003cSqliteDatabase\u003e, network_id: \u0026str) -\u003e Self {\n        let storage_options = SqliteStorageOptions {\n            storage_type: SqliteStorageType::Disk,\n            max_size: None,\n            path: None,\n        };\n\n        SqliteService {\n            name: \"sqlite\".to_string(),\n            path: format!(\"{}/sqlite\", network_id),\n            state: ServiceState::Created,\n            crud_mixin: SqliteCrudMixin::new(db.clone(), storage_options.clone(), None),\n            query_mixin: SqliteQueryMixin::new(db.clone(), storage_options),\n        }\n    }\n}\n\n#[async_trait]\nimpl AbstractService for SqliteService {\n    fn name(\u0026self) -\u003e \u0026str {\n        \u0026self.name\n    }\n\n    fn path(\u0026self) -\u003e \u0026str {\n        \u0026self.path\n    }\n\n    fn state(\u0026self) -\u003e ServiceState {\n        self.state\n    }\n\n    async fn init(\u0026mut self, context: \u0026crate::services::RequestContext) -\u003e Result\u003c()\u003e {\n        self.crud_mixin.init(context).await?;\n        self.query_mixin.init(context).await?;\n        self.state = ServiceState::Initialized;\n        Ok(())\n    }\n\n    async fn start(\u0026mut self) -\u003e Result\u003c()\u003e {\n        self.state = ServiceState::Running;\n        Ok(())\n    }\n\n    async fn stop(\u0026mut self) -\u003e Result\u003c()\u003e {\n        self.state = ServiceState::Stopped;\n        Ok(())\n    }\n\n    async fn process_request(\u0026self, request: ServiceRequest) -\u003e Result\u003cServiceResponse\u003e {\n        match request.operation.as_str() {\n            \"create\" | \"read\" | \"update\" | \"delete\" | \"crud\" =\u003e {\n                self.crud_mixin.process_request(request).await\n            }\n            \"query\" | \"execute\" =\u003e self.query_mixin.process_request(request).await,\n            _ =\u003e Err(anyhow!(\"Unknown operation: {}\", request.operation)),\n        }\n    }\n\n    fn description(\u0026self) -\u003e String {\n        \"SQLite database service with CRUD operations and SQL query capabilities\".to_string()\n    }\n\n    fn metadata(\u0026self) -\u003e ServiceMetadata {\n        ServiceMetadata {\n            name: self.name().to_string(),\n            path: self.path().to_string(),\n            state: self.state(),\n            description: self.description(),\n            operations: vec![\n                \"create\".to_string(),\n                \"read\".to_string(),\n                \"update\".to_string(),\n                \"delete\".to_string(),\n                \"query\".to_string(),\n                \"execute\".to_string(),\n            ],\n            version: \"1.0.0\".to_string(),\n        }\n    }\n}\n","traces":[{"line":99,"address":[],"length":0,"stats":{"Line":25}},{"line":113,"address":[],"length":0,"stats":{"Line":4}},{"line":115,"address":[],"length":0,"stats":{"Line":2}},{"line":123,"address":[],"length":0,"stats":{"Line":1}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":3}},{"line":146,"address":[],"length":0,"stats":{"Line":2}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":2}},{"line":150,"address":[],"length":0,"stats":{"Line":1}},{"line":152,"address":[],"length":0,"stats":{"Line":2}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":50}},{"line":162,"address":[],"length":0,"stats":{"Line":50}},{"line":165,"address":[],"length":0,"stats":{"Line":25}},{"line":175,"address":[],"length":0,"stats":{"Line":31}},{"line":176,"address":[],"length":0,"stats":{"Line":18}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":25}},{"line":185,"address":[],"length":0,"stats":{"Line":48}},{"line":187,"address":[],"length":0,"stats":{"Line":24}},{"line":188,"address":[],"length":0,"stats":{"Line":24}},{"line":189,"address":[],"length":0,"stats":{"Line":12}},{"line":191,"address":[],"length":0,"stats":{"Line":30}},{"line":192,"address":[],"length":0,"stats":{"Line":12}},{"line":194,"address":[],"length":0,"stats":{"Line":6}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":18}},{"line":201,"address":[],"length":0,"stats":{"Line":24}},{"line":203,"address":[],"length":0,"stats":{"Line":60}},{"line":204,"address":[],"length":0,"stats":{"Line":24}},{"line":211,"address":[],"length":0,"stats":{"Line":6}},{"line":212,"address":[],"length":0,"stats":{"Line":6}},{"line":214,"address":[],"length":0,"stats":{"Line":15}},{"line":215,"address":[],"length":0,"stats":{"Line":6}},{"line":217,"address":[],"length":0,"stats":{"Line":3}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":3}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":3}},{"line":228,"address":[],"length":0,"stats":{"Line":6}},{"line":230,"address":[],"length":0,"stats":{"Line":15}},{"line":231,"address":[],"length":0,"stats":{"Line":6}},{"line":233,"address":[],"length":0,"stats":{"Line":3}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":12}},{"line":245,"address":[],"length":0,"stats":{"Line":12}},{"line":248,"address":[],"length":0,"stats":{"Line":6}},{"line":251,"address":[],"length":0,"stats":{"Line":6}},{"line":254,"address":[],"length":0,"stats":{"Line":6}},{"line":255,"address":[],"length":0,"stats":{"Line":6}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":12}},{"line":261,"address":[],"length":0,"stats":{"Line":6}},{"line":263,"address":[],"length":0,"stats":{"Line":6}},{"line":264,"address":[],"length":0,"stats":{"Line":6}},{"line":269,"address":[],"length":0,"stats":{"Line":12}},{"line":272,"address":[],"length":0,"stats":{"Line":6}},{"line":280,"address":[],"length":0,"stats":{"Line":6}},{"line":281,"address":[],"length":0,"stats":{"Line":6}},{"line":282,"address":[],"length":0,"stats":{"Line":6}},{"line":283,"address":[],"length":0,"stats":{"Line":6}},{"line":288,"address":[],"length":0,"stats":{"Line":12}},{"line":294,"address":[],"length":0,"stats":{"Line":24}},{"line":297,"address":[],"length":0,"stats":{"Line":12}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":299,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":12}},{"line":309,"address":[],"length":0,"stats":{"Line":36}},{"line":310,"address":[],"length":0,"stats":{"Line":12}},{"line":312,"address":[],"length":0,"stats":{"Line":24}},{"line":315,"address":[],"length":0,"stats":{"Line":12}},{"line":316,"address":[],"length":0,"stats":{"Line":12}},{"line":318,"address":[],"length":0,"stats":{"Line":24}},{"line":319,"address":[],"length":0,"stats":{"Line":12}},{"line":321,"address":[],"length":0,"stats":{"Line":12}},{"line":322,"address":[],"length":0,"stats":{"Line":12}},{"line":324,"address":[],"length":0,"stats":{"Line":36}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":9}},{"line":337,"address":[],"length":0,"stats":{"Line":9}},{"line":338,"address":[],"length":0,"stats":{"Line":9}},{"line":341,"address":[],"length":0,"stats":{"Line":3}},{"line":344,"address":[],"length":0,"stats":{"Line":3}},{"line":346,"address":[],"length":0,"stats":{"Line":3}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":12}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":24}},{"line":405,"address":[],"length":0,"stats":{"Line":12}},{"line":406,"address":[],"length":0,"stats":{"Line":12}},{"line":411,"address":[],"length":0,"stats":{"Line":30}},{"line":412,"address":[],"length":0,"stats":{"Line":18}},{"line":413,"address":[],"length":0,"stats":{"Line":18}},{"line":414,"address":[],"length":0,"stats":{"Line":9}},{"line":418,"address":[],"length":0,"stats":{"Line":12}},{"line":419,"address":[],"length":0,"stats":{"Line":12}},{"line":420,"address":[],"length":0,"stats":{"Line":12}},{"line":421,"address":[],"length":0,"stats":{"Line":12}},{"line":426,"address":[],"length":0,"stats":{"Line":3}},{"line":432,"address":[],"length":0,"stats":{"Line":6}},{"line":435,"address":[],"length":0,"stats":{"Line":3}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":3}},{"line":441,"address":[],"length":0,"stats":{"Line":3}},{"line":443,"address":[],"length":0,"stats":{"Line":3}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":3}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":3}},{"line":453,"address":[],"length":0,"stats":{"Line":3}},{"line":455,"address":[],"length":0,"stats":{"Line":3}},{"line":456,"address":[],"length":0,"stats":{"Line":3}},{"line":457,"address":[],"length":0,"stats":{"Line":3}},{"line":458,"address":[],"length":0,"stats":{"Line":3}},{"line":460,"address":[],"length":0,"stats":{"Line":9}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":3}},{"line":468,"address":[],"length":0,"stats":{"Line":3}},{"line":469,"address":[],"length":0,"stats":{"Line":3}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":6}},{"line":479,"address":[],"length":0,"stats":{"Line":3}},{"line":480,"address":[],"length":0,"stats":{"Line":3}},{"line":484,"address":[],"length":0,"stats":{"Line":9}},{"line":485,"address":[],"length":0,"stats":{"Line":6}},{"line":486,"address":[],"length":0,"stats":{"Line":3}},{"line":489,"address":[],"length":0,"stats":{"Line":3}},{"line":493,"address":[],"length":0,"stats":{"Line":3}},{"line":496,"address":[],"length":0,"stats":{"Line":6}},{"line":498,"address":[],"length":0,"stats":{"Line":21}},{"line":499,"address":[],"length":0,"stats":{"Line":9}},{"line":500,"address":[],"length":0,"stats":{"Line":9}},{"line":507,"address":[],"length":0,"stats":{"Line":6}},{"line":513,"address":[],"length":0,"stats":{"Line":3}},{"line":517,"address":[],"length":0,"stats":{"Line":3}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":3}},{"line":526,"address":[],"length":0,"stats":{"Line":3}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":6}},{"line":534,"address":[],"length":0,"stats":{"Line":3}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":3}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":6}},{"line":557,"address":[],"length":0,"stats":{"Line":6}},{"line":560,"address":[],"length":0,"stats":{"Line":3}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":3}},{"line":567,"address":[],"length":0,"stats":{"Line":3}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":3}},{"line":573,"address":[],"length":0,"stats":{"Line":3}},{"line":575,"address":[],"length":0,"stats":{"Line":3}},{"line":576,"address":[],"length":0,"stats":{"Line":3}},{"line":577,"address":[],"length":0,"stats":{"Line":3}},{"line":578,"address":[],"length":0,"stats":{"Line":3}},{"line":580,"address":[],"length":0,"stats":{"Line":9}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":582,"address":[],"length":0,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":3}},{"line":588,"address":[],"length":0,"stats":{"Line":3}},{"line":589,"address":[],"length":0,"stats":{"Line":3}},{"line":592,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":6}},{"line":600,"address":[],"length":0,"stats":{"Line":3}},{"line":601,"address":[],"length":0,"stats":{"Line":6}},{"line":615,"address":[],"length":0,"stats":{"Line":12}},{"line":621,"address":[],"length":0,"stats":{"Line":12}},{"line":622,"address":[],"length":0,"stats":{"Line":6}},{"line":626,"address":[],"length":0,"stats":{"Line":6}},{"line":627,"address":[],"length":0,"stats":{"Line":6}},{"line":628,"address":[],"length":0,"stats":{"Line":6}},{"line":629,"address":[],"length":0,"stats":{"Line":6}},{"line":630,"address":[],"length":0,"stats":{"Line":6}},{"line":631,"address":[],"length":0,"stats":{"Line":6}},{"line":632,"address":[],"length":0,"stats":{"Line":6}},{"line":638,"address":[],"length":0,"stats":{"Line":6}},{"line":640,"address":[],"length":0,"stats":{"Line":6}},{"line":643,"address":[],"length":0,"stats":{"Line":6}},{"line":647,"address":[],"length":0,"stats":{"Line":30}},{"line":648,"address":[],"length":0,"stats":{"Line":60}},{"line":650,"address":[],"length":0,"stats":{"Line":30}},{"line":651,"address":[],"length":0,"stats":{"Line":90}},{"line":668,"address":[],"length":0,"stats":{"Line":25}},{"line":677,"address":[],"length":0,"stats":{"Line":4}},{"line":679,"address":[],"length":0,"stats":{"Line":2}},{"line":687,"address":[],"length":0,"stats":{"Line":1}},{"line":692,"address":[],"length":0,"stats":{"Line":0}},{"line":694,"address":[],"length":0,"stats":{"Line":0}},{"line":699,"address":[],"length":0,"stats":{"Line":0}},{"line":702,"address":[],"length":0,"stats":{"Line":0}},{"line":707,"address":[],"length":0,"stats":{"Line":4}},{"line":708,"address":[],"length":0,"stats":{"Line":2}},{"line":709,"address":[],"length":0,"stats":{"Line":0}},{"line":711,"address":[],"length":0,"stats":{"Line":2}},{"line":712,"address":[],"length":0,"stats":{"Line":1}},{"line":714,"address":[],"length":0,"stats":{"Line":2}},{"line":715,"address":[],"length":0,"stats":{"Line":0}},{"line":719,"address":[],"length":0,"stats":{"Line":0}},{"line":723,"address":[],"length":0,"stats":{"Line":38}},{"line":725,"address":[],"length":0,"stats":{"Line":19}},{"line":729,"address":[],"length":0,"stats":{"Line":54}},{"line":730,"address":[],"length":0,"stats":{"Line":27}},{"line":731,"address":[],"length":0,"stats":{"Line":27}},{"line":732,"address":[],"length":0,"stats":{"Line":24}},{"line":734,"address":[],"length":0,"stats":{"Line":60}},{"line":735,"address":[],"length":0,"stats":{"Line":24}},{"line":741,"address":[],"length":0,"stats":{"Line":15}},{"line":742,"address":[],"length":0,"stats":{"Line":30}},{"line":744,"address":[],"length":0,"stats":{"Line":75}},{"line":745,"address":[],"length":0,"stats":{"Line":30}},{"line":751,"address":[],"length":0,"stats":{"Line":0}},{"line":756,"address":[],"length":0,"stats":{"Line":24}},{"line":757,"address":[],"length":0,"stats":{"Line":24}},{"line":760,"address":[],"length":0,"stats":{"Line":12}},{"line":761,"address":[],"length":0,"stats":{"Line":24}},{"line":762,"address":[],"length":0,"stats":{"Line":3}},{"line":765,"address":[],"length":0,"stats":{"Line":9}},{"line":769,"address":[],"length":0,"stats":{"Line":30}},{"line":773,"address":[],"length":0,"stats":{"Line":9}},{"line":777,"address":[],"length":0,"stats":{"Line":27}},{"line":778,"address":[],"length":0,"stats":{"Line":18}},{"line":779,"address":[],"length":0,"stats":{"Line":9}},{"line":782,"address":[],"length":0,"stats":{"Line":9}},{"line":783,"address":[],"length":0,"stats":{"Line":9}},{"line":784,"address":[],"length":0,"stats":{"Line":9}},{"line":785,"address":[],"length":0,"stats":{"Line":9}},{"line":790,"address":[],"length":0,"stats":{"Line":30}},{"line":791,"address":[],"length":0,"stats":{"Line":30}},{"line":794,"address":[],"length":0,"stats":{"Line":15}},{"line":795,"address":[],"length":0,"stats":{"Line":30}},{"line":796,"address":[],"length":0,"stats":{"Line":30}},{"line":799,"address":[],"length":0,"stats":{"Line":15}},{"line":829,"address":[],"length":0,"stats":{"Line":19}},{"line":837,"address":[],"length":0,"stats":{"Line":19}},{"line":838,"address":[],"length":0,"stats":{"Line":19}},{"line":840,"address":[],"length":0,"stats":{"Line":19}},{"line":841,"address":[],"length":0,"stats":{"Line":19}},{"line":848,"address":[],"length":0,"stats":{"Line":37}},{"line":849,"address":[],"length":0,"stats":{"Line":37}},{"line":852,"address":[],"length":0,"stats":{"Line":41}},{"line":853,"address":[],"length":0,"stats":{"Line":41}},{"line":856,"address":[],"length":0,"stats":{"Line":0}},{"line":857,"address":[],"length":0,"stats":{"Line":0}},{"line":860,"address":[],"length":0,"stats":{"Line":19}},{"line":861,"address":[],"length":0,"stats":{"Line":19}},{"line":862,"address":[],"length":0,"stats":{"Line":19}},{"line":863,"address":[],"length":0,"stats":{"Line":19}},{"line":864,"address":[],"length":0,"stats":{"Line":19}},{"line":867,"address":[],"length":0,"stats":{"Line":19}},{"line":868,"address":[],"length":0,"stats":{"Line":19}},{"line":869,"address":[],"length":0,"stats":{"Line":19}},{"line":872,"address":[],"length":0,"stats":{"Line":0}},{"line":873,"address":[],"length":0,"stats":{"Line":0}},{"line":874,"address":[],"length":0,"stats":{"Line":0}},{"line":877,"address":[],"length":0,"stats":{"Line":0}},{"line":878,"address":[],"length":0,"stats":{"Line":0}},{"line":879,"address":[],"length":0,"stats":{"Line":0}},{"line":880,"address":[],"length":0,"stats":{"Line":0}},{"line":882,"address":[],"length":0,"stats":{"Line":0}},{"line":883,"address":[],"length":0,"stats":{"Line":0}},{"line":887,"address":[],"length":0,"stats":{"Line":0}},{"line":888,"address":[],"length":0,"stats":{"Line":0}},{"line":891,"address":[],"length":0,"stats":{"Line":0}},{"line":893,"address":[],"length":0,"stats":{"Line":0}},{"line":894,"address":[],"length":0,"stats":{"Line":0}},{"line":895,"address":[],"length":0,"stats":{"Line":0}},{"line":896,"address":[],"length":0,"stats":{"Line":0}},{"line":897,"address":[],"length":0,"stats":{"Line":0}},{"line":905,"address":[],"length":0,"stats":{"Line":0}}],"covered":216,"coverable":303},{"path":["/","Users","rafael","dev","kagi","node","src","services","utils.rs"],"content":"use anyhow::{anyhow, Result};\nuse base64;\nuse rusqlite::{Connection, Row, ToSql};\nuse serde_json::Value;\nuse std::collections::HashMap;\n\n/// Convert a serde_json::Value to a rusqlite::ToSql implementor\npub fn json_value_to_sql_value(value: \u0026Value) -\u003e Result\u003cBox\u003cdyn ToSql\u003e\u003e {\n    match value {\n        Value::Null =\u003e Ok(Box::new(Option::\u003cString\u003e::None)),\n        Value::Bool(b) =\u003e Ok(Box::new(*b)),\n        Value::Number(n) =\u003e {\n            if n.is_i64() {\n                Ok(Box::new(n.as_i64().unwrap()))\n            } else if n.is_f64() {\n                Ok(Box::new(n.as_f64().unwrap()))\n            } else {\n                Ok(Box::new(n.to_string()))\n            }\n        }\n        Value::String(s) =\u003e Ok(Box::new(s.clone())),\n        _ =\u003e Ok(Box::new(value.to_string())),\n    }\n}\n\n/// Convert a JSON array of parameters to a vector of SQL parameters\npub fn json_params_to_sql_params(params: \u0026Value) -\u003e Result\u003cVec\u003cBox\u003cdyn ToSql\u003e\u003e\u003e {\n    if let Value::Array(array) = params {\n        let mut result = Vec::with_capacity(array.len());\n\n        for value in array {\n            result.push(json_value_to_sql_value(value)?);\n        }\n\n        Ok(result)\n    } else {\n        Err(anyhow!(\"Parameters must be a JSON array\"))\n    }\n}\n\n/// Execute a SQL query with JSON parameters\npub fn execute_with_json_params(conn: \u0026Connection, query: \u0026str, params: \u0026Value) -\u003e Result\u003cusize\u003e {\n    let param_values = json_params_to_sql_params(params)?;\n    let param_refs: Vec\u003c\u0026dyn ToSql\u003e = param_values.iter().map(|p| p.as_ref()).collect();\n\n    let rows_affected = conn.execute(query, rusqlite::params_from_iter(param_refs.iter()))?;\n    Ok(rows_affected)\n}\n\n/// Map a SQLite row to a JSON object\npub fn map_row_to_json_object(row: \u0026Row, column_names: \u0026[String]) -\u003e Result\u003cValue\u003e {\n    let mut obj = serde_json::Map::new();\n\n    for (i, column_name) in column_names.iter().enumerate() {\n        let value: Value = match row.get_ref(i)? {\n            rusqlite::types::ValueRef::Null =\u003e Value::Null,\n            rusqlite::types::ValueRef::Integer(i) =\u003e Value::Number(i.into()),\n            rusqlite::types::ValueRef::Real(f) =\u003e {\n                // Convert f64 to Value::Number\n                let n =\n                    serde_json::Number::from_f64(f).unwrap_or_else(|| serde_json::Number::from(0));\n                Value::Number(n)\n            }\n            rusqlite::types::ValueRef::Text(t) =\u003e {\n                let s = std::str::from_utf8(t).unwrap_or_default();\n\n                // Try to parse as JSON first, if it fails, treat as string\n                match serde_json::from_str::\u003cValue\u003e(s) {\n                    Ok(json_value) =\u003e json_value,\n                    Err(_) =\u003e Value::String(s.to_string()),\n                }\n            }\n            rusqlite::types::ValueRef::Blob(b) =\u003e {\n                // Convert blob to base64 string\n                Value::String(base64::encode(b))\n            }\n        };\n\n        obj.insert(column_name.clone(), value);\n    }\n\n    Ok(Value::Object(obj))\n}\n\n/// Convert a JSON filter object to a SQL WHERE clause and parameters\npub fn json_filter_to_sql_where(\n    filter: \u0026Value,\n    prefix: Option\u003c\u0026str\u003e,\n) -\u003e Result\u003c(String, Vec\u003cBox\u003cdyn ToSql\u003e\u003e)\u003e {\n    if !filter.is_object() || filter.as_object().unwrap().is_empty() {\n        return Ok((String::new(), Vec::new()));\n    }\n\n    let mut where_clause = String::from(\"WHERE \");\n    let mut params: Vec\u003cBox\u003cdyn ToSql\u003e\u003e = Vec::new();\n    let mut first = true;\n\n    for (key, value) in filter.as_object().unwrap() {\n        if !first {\n            where_clause.push_str(\" AND \");\n        }\n\n        // Handle special operators (like $gt, $lt, etc.)\n        if key.starts_with('$') {\n            match key.as_str() {\n                \"$or\" =\u003e {\n                    if let Value::Array(conditions) = value {\n                        if conditions.is_empty() {\n                            continue;\n                        }\n\n                        where_clause.push_str(\"(\");\n\n                        for (i, condition) in conditions.iter().enumerate() {\n                            if i \u003e 0 {\n                                where_clause.push_str(\" OR \");\n                            }\n\n                            let (sub_clause, sub_params) =\n                                json_filter_to_sql_where(condition, None)?;\n                            // Remove the \"WHERE\" prefix from the sub-clause\n                            let sub_clause = if sub_clause.starts_with(\"WHERE \") {\n                                sub_clause[6..].to_string()\n                            } else {\n                                sub_clause\n                            };\n\n                            where_clause.push_str(\u0026format!(\"({})\", sub_clause));\n                            params.extend(sub_params);\n                        }\n\n                        where_clause.push_str(\")\");\n                    }\n                }\n                \"$and\" =\u003e {\n                    if let Value::Array(conditions) = value {\n                        if conditions.is_empty() {\n                            continue;\n                        }\n\n                        where_clause.push_str(\"(\");\n\n                        for (i, condition) in conditions.iter().enumerate() {\n                            if i \u003e 0 {\n                                where_clause.push_str(\" AND \");\n                            }\n\n                            let (sub_clause, sub_params) =\n                                json_filter_to_sql_where(condition, None)?;\n                            // Remove the \"WHERE\" prefix from the sub-clause\n                            let sub_clause = if sub_clause.starts_with(\"WHERE \") {\n                                sub_clause[6..].to_string()\n                            } else {\n                                sub_clause\n                            };\n\n                            where_clause.push_str(\u0026format!(\"({})\", sub_clause));\n                            params.extend(sub_params);\n                        }\n\n                        where_clause.push_str(\")\");\n                    }\n                }\n                _ =\u003e return Err(anyhow!(\"Unsupported operator: {}\", key)),\n            }\n        } else if value.is_object() \u0026\u0026 !value.as_object().unwrap().is_empty() {\n            // This is a field with operators like {field: {$gt: 5}}\n            let mut field_clause = String::new();\n\n            // Determine the field name based on whether it's _id or a JSON field\n            let field_name = if key == \"_id\" {\n                \"_id\".to_string()\n            } else if let Some(p) = prefix {\n                format!(\"json_extract(data, '$.{}.{}')\", p, key)\n            } else {\n                format!(\"json_extract(data, '$.{}')\", key)\n            };\n\n            for (op, op_value) in value.as_object().unwrap() {\n                if !field_clause.is_empty() {\n                    field_clause.push_str(\" AND \");\n                }\n\n                match op.as_str() {\n                    \"$eq\" =\u003e {\n                        field_clause.push_str(\u0026format!(\"{} = ?\", field_name));\n                        params.push(json_value_to_sql_value(op_value)?);\n                    }\n                    \"$gt\" =\u003e {\n                        field_clause.push_str(\u0026format!(\"{} \u003e ?\", field_name));\n                        params.push(json_value_to_sql_value(op_value)?);\n                    }\n                    \"$gte\" =\u003e {\n                        field_clause.push_str(\u0026format!(\"{} \u003e= ?\", field_name));\n                        params.push(json_value_to_sql_value(op_value)?);\n                    }\n                    \"$lt\" =\u003e {\n                        field_clause.push_str(\u0026format!(\"{} \u003c ?\", field_name));\n                        params.push(json_value_to_sql_value(op_value)?);\n                    }\n                    \"$lte\" =\u003e {\n                        field_clause.push_str(\u0026format!(\"{} \u003c= ?\", field_name));\n                        params.push(json_value_to_sql_value(op_value)?);\n                    }\n                    \"$ne\" =\u003e {\n                        field_clause.push_str(\u0026format!(\"{} != ?\", field_name));\n                        params.push(json_value_to_sql_value(op_value)?);\n                    }\n                    \"$in\" =\u003e {\n                        if let Value::Array(values) = op_value {\n                            if values.is_empty() {\n                                field_clause.push_str(\"0\"); // Never true condition\n                            } else {\n                                field_clause.push_str(\u0026format!(\n                                    \"{} IN ({})\",\n                                    field_name,\n                                    values.iter().map(|_| \"?\").collect::\u003cVec\u003c_\u003e\u003e().join(\", \")\n                                ));\n\n                                for val in values {\n                                    params.push(json_value_to_sql_value(val)?);\n                                }\n                            }\n                        }\n                    }\n                    \"$nin\" =\u003e {\n                        if let Value::Array(values) = op_value {\n                            if values.is_empty() {\n                                field_clause.push_str(\"1\"); // Always true condition\n                            } else {\n                                field_clause.push_str(\u0026format!(\n                                    \"{} NOT IN ({})\",\n                                    field_name,\n                                    values.iter().map(|_| \"?\").collect::\u003cVec\u003c_\u003e\u003e().join(\", \")\n                                ));\n\n                                for val in values {\n                                    params.push(json_value_to_sql_value(val)?);\n                                }\n                            }\n                        }\n                    }\n                    \"$like\" =\u003e {\n                        field_clause.push_str(\u0026format!(\"{} LIKE ?\", field_name));\n                        params.push(json_value_to_sql_value(op_value)?);\n                    }\n                    \"$nlike\" =\u003e {\n                        field_clause.push_str(\u0026format!(\"{} NOT LIKE ?\", field_name));\n                        params.push(json_value_to_sql_value(op_value)?);\n                    }\n                    \"$regex\" =\u003e {\n                        field_clause.push_str(\u0026format!(\"{} REGEXP ?\", field_name));\n                        params.push(json_value_to_sql_value(op_value)?);\n                    }\n                    \"$exists\" =\u003e {\n                        if op_value.as_bool().unwrap_or(false) {\n                            field_clause.push_str(\u0026format!(\"{} IS NOT NULL\", field_name));\n                        } else {\n                            field_clause.push_str(\u0026format!(\"{} IS NULL\", field_name));\n                        }\n                    }\n                    _ =\u003e return Err(anyhow!(\"Unsupported operator: {}\", op)),\n                }\n            }\n\n            where_clause.push_str(\u0026format!(\"({})\", field_clause));\n        } else {\n            // Simple equality check\n            if key == \"_id\" {\n                where_clause.push_str(\u0026format!(\"_id = ?\"));\n\n                if value.is_string() {\n                    params.push(json_value_to_sql_value(value)?);\n                } else {\n                    params.push(Box::new(value.to_string()));\n                }\n            } else {\n                // For other fields, we need to use JSON extraction\n                let field_name = if let Some(p) = prefix {\n                    format!(\"json_extract(data, '$.{}.{}')\", p, key)\n                } else {\n                    format!(\"json_extract(data, '$.{}')\", key)\n                };\n\n                where_clause.push_str(\u0026format!(\"{} = ?\", field_name));\n                params.push(json_value_to_sql_value(value)?);\n            }\n        }\n\n        first = false;\n    }\n\n    Ok((where_clause, params))\n}\n","traces":[{"line":8,"address":[],"length":0,"stats":{"Line":33}},{"line":9,"address":[],"length":0,"stats":{"Line":33}},{"line":10,"address":[],"length":0,"stats":{"Line":0}},{"line":11,"address":[],"length":0,"stats":{"Line":0}},{"line":12,"address":[],"length":0,"stats":{"Line":0}},{"line":13,"address":[],"length":0,"stats":{"Line":0}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":33}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":27}},{"line":28,"address":[],"length":0,"stats":{"Line":51}},{"line":31,"address":[],"length":0,"stats":{"Line":90}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":24}},{"line":37,"address":[],"length":0,"stats":{"Line":3}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":9}},{"line":52,"address":[],"length":0,"stats":{"Line":9}},{"line":54,"address":[],"length":0,"stats":{"Line":39}},{"line":55,"address":[],"length":0,"stats":{"Line":60}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":3}},{"line":58,"address":[],"length":0,"stats":{"Line":6}},{"line":60,"address":[],"length":0,"stats":{"Line":6}},{"line":61,"address":[],"length":0,"stats":{"Line":12}},{"line":62,"address":[],"length":0,"stats":{"Line":6}},{"line":64,"address":[],"length":0,"stats":{"Line":21}},{"line":65,"address":[],"length":0,"stats":{"Line":21}},{"line":68,"address":[],"length":0,"stats":{"Line":21}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":21}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":9}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}}],"covered":22,"coverable":161},{"path":["/","Users","rafael","dev","kagi","node","src","tests","mod.rs"],"content":"// Test modules\npub mod service_tests;\npub mod value_type_tests;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","rafael","dev","kagi","node","src","tests","service_tests.rs"],"content":"use anyhow::Result;\nuse serde_json::{json, Value};\nuse std::sync::Arc;\nuse std::time::Duration;\nuse tokio::time::timeout;\n\nuse crate::db::SqliteDatabase;\nuse crate::node::NodeConfig;\nuse crate::services::ResponseStatus;\nuse crate::services::ServiceManager;\nuse crate::services::{\n    abstract_service::AbstractService, registry::RegistryService, RequestContext, ServiceRequest,\n    ServiceResponse,\n};\n\n/// Create a test database\nasync fn create_test_db() -\u003e Result\u003c(Arc\u003cSqliteDatabase\u003e, tempfile::TempDir)\u003e {\n    // Create a temporary directory for our test\n    let temp_dir = tempfile::TempDir::new()?;\n    let db_path = temp_dir\n        .path()\n        .join(\"test_db.db\")\n        .to_str()\n        .unwrap()\n        .to_string();\n\n    // Create the database\n    let db = Arc::new(SqliteDatabase::new(\u0026db_path).await?);\n\n    Ok((db, temp_dir))\n}\n\n/// Test the Registry service\n#[tokio::test]\nasync fn test_registry_service() -\u003e Result\u003c()\u003e {\n    // Add a constant for timeout duration\n    const TEST_TIMEOUT: Duration = Duration::from_secs(5);\n\n    // Run the entire test with a timeout\n    timeout(TEST_TIMEOUT, async {\n        // Create a test database\n        let (db, _temp_dir) = create_test_db().await?;\n\n        // Create the Registry service\n        let network_id = \"test_network\";\n        let mut service = RegistryService::new(db.clone(), network_id);\n\n        // Start the service\n        service.start().await?;\n\n        // Register a service\n        let register_request = ServiceRequest {\n            request_id: Some(\"register-test\".to_string()),\n            path: format!(\"{}/registry\", network_id),\n            operation: \"register\".to_string(),\n            params: json!({\n                \"service\": {\n                    \"service_id\": \"test-service\",\n                    \"name\": \"Test Service\",\n                    \"description\": \"A test service\",\n                    \"version\": \"1.0.0\",\n                    \"endpoints\": [\n                        {\n                            \"path\": \"test/endpoint\",\n                            \"method\": \"GET\",\n                            \"description\": \"A test endpoint\"\n                        }\n                    ]\n                }\n            })\n            .into(),\n            request_context: RequestContext::default().into(),\n        };\n\n        let response = service.process_request(register_request).await?;\n        assert!(response.status == ResponseStatus::Success);\n\n        // List services\n        let list_request = ServiceRequest {\n            request_id: Some(\"list-test\".to_string()),\n            path: format!(\"{}/registry\", network_id),\n            operation: \"list\".to_string(),\n            params: json!({}).into(),\n            request_context: RequestContext::default().into(),\n        };\n\n        let response = service.process_request(list_request).await?;\n        assert!(response.status == ResponseStatus::Success);\n\n        // Get service details\n        let get_request = ServiceRequest {\n            request_id: Some(\"get-test\".to_string()),\n            path: format!(\"{}/registry\", network_id),\n            operation: \"get\".to_string(),\n            params: json!({\n                \"name\": \"test-service\"\n            })\n            .into(),\n            request_context: RequestContext::default().into(),\n        };\n\n        let response = service.process_request(get_request).await?;\n        assert!(response.status == ResponseStatus::Success);\n\n        // Unregister the service\n        let unregister_request = ServiceRequest {\n            request_id: Some(\"unregister-test\".to_string()),\n            path: format!(\"{}/registry\", network_id),\n            operation: \"unregister\".to_string(),\n            params: json!({\n                \"name\": \"test-service\"\n            })\n            .into(),\n            request_context: RequestContext::default().into(),\n        };\n\n        let response = service.process_request(unregister_request).await?;\n        assert!(response.status == ResponseStatus::Success);\n\n        // Stop the service\n        service.stop().await?;\n\n        Ok(())\n    })\n    .await?\n}\n\n/// Test the ServiceManager with Registry service\n#[tokio::test]\nasync fn test_service_manager_registry() -\u003e Result\u003c()\u003e {\n    // Add a constant for timeout duration\n    const TEST_TIMEOUT: Duration = Duration::from_secs(5);\n\n    // Run the entire test with a timeout\n    timeout(TEST_TIMEOUT, async {\n        // Create a test database\n        let (db, _temp_dir) = create_test_db().await?;\n\n        // Create a service manager\n        let network_id = \"test_network\";\n        let config = Arc::new(NodeConfig::new(\n            network_id,\n            \u0026format!(\"./test_data/{}\", network_id),\n        ));\n        let mut service_manager = ServiceManager::new(db.clone(), config);\n\n        // Initialize services\n        service_manager.init_services().await?;\n\n        // Test Registry service through the manager\n        // Register a service\n        let register_request = ServiceRequest {\n            request_id: Some(\"register-test\".to_string()),\n            path: format!(\"{}/registry\", network_id),\n            operation: \"register\".to_string(),\n            params: json!({\n                \"service\": {\n                    \"service_id\": \"test-service\",\n                    \"name\": \"Test Service\",\n                    \"description\": \"A test service\",\n                    \"version\": \"1.0.0\",\n                    \"endpoints\": [\n                        {\n                            \"path\": \"test/endpoint\",\n                            \"method\": \"GET\",\n                            \"description\": \"A test endpoint\"\n                        }\n                    ]\n                }\n            })\n            .into(),\n            request_context: RequestContext::default().into(),\n        };\n\n        let response = service_manager.process_request(register_request).await?;\n        assert!(response.status == ResponseStatus::Success);\n\n        // List services to verify registration\n        let list_request = ServiceRequest {\n            request_id: Some(\"list-test\".to_string()),\n            path: format!(\"{}/registry\", network_id),\n            operation: \"list\".to_string(),\n            params: json!({}).into(),\n            request_context: RequestContext::default().into(),\n        };\n\n        let response = service_manager.process_request(list_request).await?;\n        assert!(response.status == ResponseStatus::Success);\n\n        Ok(())\n    })\n    .await?\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","rafael","dev","kagi","node","src","tests","value_type_tests.rs"],"content":"#[cfg(test)]\nmod tests {\n    use crate::services::ValueType;\n    use crate::{vjson, vmap};\n    use std::collections::HashMap;\n\n    #[test]\n    fn test_vjson_macro() {\n        // Test creating a ValueType using the vjson! macro\n        let value = vjson!({\n            \"name\": \"John\",\n            \"age\": 30,\n            \"is_active\": true,\n            \"address\": {\n                \"street\": \"123 Main St\",\n                \"city\": \"Anytown\"\n            },\n            \"skills\": [\"Rust\", \"JavaScript\", \"Python\"]\n        });\n\n        // Convert to JSON value for easier testing\n        let json = value.to_json();\n        assert_eq!(json[\"name\"], \"John\");\n        assert_eq!(json[\"age\"], 30);\n        assert_eq!(json[\"is_active\"], true);\n        assert_eq!(json[\"address\"][\"street\"], \"123 Main St\");\n        assert_eq!(json[\"address\"][\"city\"], \"Anytown\");\n        assert_eq!(json[\"skills\"][0], \"Rust\");\n        assert_eq!(json[\"skills\"][1], \"JavaScript\");\n        assert_eq!(json[\"skills\"][2], \"Python\");\n    }\n\n    #[test]\n    fn test_vmap_macro() {\n        // Test creating a ValueType using the vmap! macro\n        let value = vmap! {\n            \"name\" =\u003e \"John\",\n            \"age\" =\u003e 30,\n            \"is_active\" =\u003e true,\n            \"address\" =\u003e vmap! {\n                \"street\" =\u003e \"123 Main St\",\n                \"city\" =\u003e \"Anytown\"\n            }\n        };\n\n        // Now use the ValueType API to interact with it\n        let map = match \u0026value {\n            ValueType::Map(m) =\u003e m,\n            _ =\u003e panic!(\"Expected a Map ValueType\"),\n        };\n\n        // Check top-level fields\n        match \u0026map[\"name\"] {\n            ValueType::String(s) =\u003e assert_eq!(s, \"John\"),\n            _ =\u003e panic!(\"Expected a String ValueType for name\"),\n        }\n\n        match \u0026map[\"age\"] {\n            ValueType::Number(n) =\u003e assert_eq!(*n, 30.0),\n            _ =\u003e panic!(\"Expected a Number ValueType for age\"),\n        }\n\n        match \u0026map[\"is_active\"] {\n            ValueType::Bool(b) =\u003e assert_eq!(*b, true),\n            _ =\u003e panic!(\"Expected a Bool ValueType for is_active\"),\n        }\n\n        // Check nested map\n        match \u0026map[\"address\"] {\n            ValueType::Map(addr) =\u003e {\n                // Debug print to see what's actually in the address map\n                println!(\"Address map: {:?}\", addr);\n\n                // Debug print to see what type the street value is\n                match \u0026addr[\"street\"] {\n                    ValueType::String(_) =\u003e println!(\"street is ValueType::String\"),\n                    ValueType::Json(_) =\u003e println!(\"street is ValueType::Json\"),\n                    ValueType::Number(_) =\u003e println!(\"street is ValueType::Number\"),\n                    ValueType::Bool(_) =\u003e println!(\"street is ValueType::Bool\"),\n                    ValueType::Array(_) =\u003e println!(\"street is ValueType::Array\"),\n                    ValueType::Map(_) =\u003e println!(\"street is ValueType::Map\"),\n                    ValueType::Bytes(_) =\u003e println!(\"street is ValueType::Bytes\"),\n                    ValueType::Null =\u003e println!(\"street is ValueType::Null\"),\n                    ValueType::Struct(_) =\u003e println!(\"street is ValueType::Struct\"),\n                }\n\n                match \u0026addr[\"street\"] {\n                    ValueType::String(s) =\u003e assert_eq!(s, \"123 Main St\"),\n                    _ =\u003e panic!(\"Expected a String ValueType for street\"),\n                }\n                match \u0026addr[\"city\"] {\n                    ValueType::String(s) =\u003e assert_eq!(s, \"Anytown\"),\n                    _ =\u003e panic!(\"Expected a String ValueType for city\"),\n                }\n            }\n            _ =\u003e panic!(\"Expected a Map ValueType for address\"),\n        }\n    }\n\n    #[derive(Debug, Clone, serde::Serialize, serde::Deserialize)]\n    struct User {\n        name: String,\n        age: u32,\n        is_active: bool,\n    }\n\n    #[test]\n    fn test_struct_to_value_type() {\n        // Create a struct\n        let user = User {\n            name: \"John\".to_string(),\n            age: 30,\n            is_active: true,\n        };\n\n        // Convert to a ValueType\n        let value = crate::services::to_value_type(user);\n\n        // Get as JSON and verify\n        let json = value.to_json();\n        assert_eq!(json[\"name\"], \"John\");\n        assert_eq!(json[\"age\"], 30.0);\n        assert_eq!(json[\"is_active\"], true);\n    }\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","rafael","dev","kagi","node","src","util","logging.rs"],"content":"use log::{debug, error, info, trace, warn, LevelFilter};\n\n// Define the component identifiers for filtering\npub enum Component {\n    Node,\n    Registry,\n    Service,\n    P2P,\n    Request,\n    Context,\n    Test,\n}\n\nimpl Component {\n    pub fn as_str(\u0026self) -\u003e \u0026'static str {\n        match self {\n            Component::Node =\u003e \"NODE\",\n            Component::Registry =\u003e \"REGISTRY\",\n            Component::Service =\u003e \"SERVICE\",\n            Component::P2P =\u003e \"P2P\",\n            Component::Request =\u003e \"REQUEST\",\n            Component::Context =\u003e \"CONTEXT\",\n            Component::Test =\u003e \"TEST\",\n        }\n    }\n}\n\n// Log trace level message with component\npub fn trace_log(component: Component, message: \u0026str) {\n    trace!(\"[{}] {}\", component.as_str(), message);\n}\n\n// Log debug level message with component\npub fn debug_log(component: Component, message: \u0026str) {\n    debug!(\"[{}] {}\", component.as_str(), message);\n}\n\n// Log info level message with component\npub fn info_log(component: Component, message: \u0026str) {\n    info!(\"[{}] {}\", component.as_str(), message);\n}\n\n// Log warning level message with component\npub fn warn_log(component: Component, message: \u0026str) {\n    warn!(\"[{}] {}\", component.as_str(), message);\n}\n\n// Log error level message with component\npub fn error_log(component: Component, message: \u0026str) {\n    error!(\"[{}] {}\", component.as_str(), message);\n}\n\n// Log debug message with component and data structure\npub fn debug_log_with_data\u003cT: std::fmt::Debug\u003e(component: Component, message: \u0026str, data: \u0026T) {\n    debug!(\"[{}] {}: {:?}\", component.as_str(), message, data);\n}\n\n// Initialize logging with component filters\npub fn init_logging() {\n    // Set up env_logger with custom format\n    let env = env_logger::Env::default()\n        .filter_or(\"RUST_LOG\", \"debug\") // Default to debug level\n        .filter_or(\"KAGI_NODE_LOG\", \"debug\"); // Allow override with KAGI_NODE_LOG\n\n    env_logger::Builder::from_env(env)\n        .format(|buf, record| {\n            use std::io::Write;\n            let level_style = buf.default_level_style(record.level());\n            writeln!(\n                buf,\n                \"{} {} [{}] {}\",\n                chrono::Local::now().format(\"%Y-%m-%d %H:%M:%S%.3f\"),\n                level_style.value(record.level()),\n                record.target(),\n                record.args()\n            )\n        })\n        .init();\n}\n\n// Get test-specific filter - this is useful for enabling specific components during tests\npub fn get_test_filter() -\u003e String {\n    std::env::var(\"KAGI_TEST_LOG\").unwrap_or_else(|_| \"debug\".to_string())\n}\n\n// Configure logging for tests\npub fn configure_test_logging() {\n    let filter = get_test_filter();\n    let env = env_logger::Env::default().filter_or(\"RUST_LOG\", filter);\n\n    env_logger::Builder::from_env(env)\n        .format(|buf, record| {\n            use std::io::Write;\n            let level_style = buf.default_level_style(record.level());\n            writeln!(\n                buf,\n                \"{} {} [{}] {}\",\n                chrono::Local::now().format(\"%Y-%m-%d %H:%M:%S%.3f\"),\n                level_style.value(record.level()),\n                record.target(),\n                record.args()\n            )\n        })\n        .is_test(true)\n        .init();\n}\n","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":23,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":18}},{"line":35,"address":[],"length":0,"stats":{"Line":18}},{"line":39,"address":[],"length":0,"stats":{"Line":108}},{"line":40,"address":[],"length":0,"stats":{"Line":108}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":12}},{"line":55,"address":[],"length":0,"stats":{"Line":12}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}}],"covered":6,"coverable":48},{"path":["/","Users","rafael","dev","kagi","node","src","util","mod.rs"],"content":"pub mod logging;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","rafael","dev","kagi","node","src","web.rs"],"content":"use crate::config::NodeConfig;\nuse crate::db::{Database, SqliteDatabase};\nuse anyhow::Result;\nuse hyper::{\n    service::{make_service_fn, service_fn},\n    Body, Request, Response, StatusCode,\n};\nuse log::{error, info, warn};\nuse serde_urlencoded;\nuse std::collections::HashMap;\nuse std::convert::Infallible;\nuse std::fs;\nuse std::net::SocketAddr;\nuse std::path::PathBuf;\nuse std::sync::Arc;\nuse tokio::sync::{oneshot, Mutex};\n\n#[derive(Clone)]\npub enum WebServerMode {\n    SetupUI,\n    NodeUI,\n}\n\npub async fn start_web_server(\n    db: Arc\u003cSqliteDatabase\u003e,\n    setup_tx: Option\u003coneshot::Sender\u003c()\u003e\u003e,\n    config_dir: PathBuf,\n    mode: WebServerMode,\n) -\u003e Result\u003c()\u003e {\n    info!(\"Starting web server...\");\n\n    // Ensure config_dir is absolute\n    let config_dir = if config_dir.is_absolute() {\n        config_dir\n    } else {\n        std::env::current_dir()?.join(config_dir)\n    };\n\n    info!(\"Using config directory: {}\", config_dir.display());\n\n    // Determine the UI directories we need\n    let node_path = std::env::current_dir().unwrap_or_else(|_| config_dir.clone());\n    let web_ui_dir = match mode {\n        WebServerMode::SetupUI =\u003e node_path.join(\"setup_ui\"),\n        WebServerMode::NodeUI =\u003e node_path.join(\"node_ui\"),\n    };\n\n    info!(\"Web UI directory: {}\", web_ui_dir.display());\n\n    // Make sure the UI directory exists\n    if !web_ui_dir.exists() {\n        error!(\"UI directory does not exist: {}\", web_ui_dir.display());\n        return Err(anyhow::anyhow!(\n            \"UI directory does not exist: {}\",\n            web_ui_dir.display()\n        ));\n    }\n\n    if !web_ui_dir.is_dir() {\n        error!(\"UI path is not a directory: {}\", web_ui_dir.display());\n        return Err(anyhow::anyhow!(\n            \"UI path is not a directory: {}\",\n            web_ui_dir.display()\n        ));\n    }\n\n    // Check for index.html\n    let index_path = web_ui_dir.join(\"index.html\");\n    if !index_path.exists() {\n        error!(\n            \"index.html not found in UI directory: {}\",\n            web_ui_dir.display()\n        );\n        return Err(anyhow::anyhow!(\n            \"index.html not found in UI directory: {}\",\n            web_ui_dir.display()\n        ));\n    }\n\n    // Shared state\n    let db = db.clone();\n    let setup_tx_shared = Arc::new(Mutex::new(setup_tx));\n    let setup_tx_shared_for_server = Arc::clone(\u0026setup_tx_shared);\n\n    // Define the request handler\n    let make_svc = make_service_fn(move |_conn| {\n        let db = db.clone();\n        let setup_tx_shared = Arc::clone(\u0026setup_tx_shared);\n        let config_dir = config_dir.clone();\n        let mode = mode.clone();\n\n        async move {\n            Ok::\u003c_, Infallible\u003e(service_fn(move |req: Request\u003cBody\u003e| {\n                let db = db.clone();\n                let setup_tx_shared = Arc::clone(\u0026setup_tx_shared);\n                let config_dir = config_dir.clone();\n                let mode = mode.clone();\n                async move { handle_request(req, db, setup_tx_shared, config_dir, mode).await }\n            }))\n        }\n    });\n\n    // Try different ports if the default one is not available\n    let ports = [3000, 3001, 3002, 3003, 3004, 3005, 3006, 3007, 3008, 3009];\n    let mut server_future = None;\n    let mut bound_port = 0;\n\n    // Try to bind to each port\n    for port in ports {\n        let addr = SocketAddr::from(([127, 0, 0, 1], port));\n        info!(\"Attempting to bind web server to address: {}\", addr);\n\n        // Try to create a TCP listener explicitly to check if port is available\n        let tcp_result = std::net::TcpListener::bind(addr);\n        match tcp_result {\n            Ok(listener) =\u003e {\n                info!(\"Successfully bound TCP listener to {}\", addr);\n                // Close the listener so hyper can use it\n                drop(listener);\n\n                // Now try to bind with hyper\n                match hyper::Server::try_bind(\u0026addr) {\n                    Ok(server_builder) =\u003e {\n                        info!(\"Successfully bound hyper server to {}\", addr);\n                        server_future = Some(server_builder.serve(make_svc));\n                        bound_port = port;\n                        break;\n                    }\n                    Err(e) =\u003e {\n                        error!(\"Failed to bind hyper server to {}: {}\", addr, e);\n                        continue;\n                    }\n                }\n            }\n            Err(e) =\u003e {\n                error!(\"Failed to bind TCP listener to {}: {}\", addr, e);\n                continue;\n            }\n        }\n    }\n\n    if let Some(server) = server_future {\n        // Run the server in a separate task\n        info!(\"Starting web server on port {}\", bound_port);\n        tokio::spawn(async move {\n            info!(\"Web server task started on port {}\", bound_port);\n            match server.await {\n                Ok(_) =\u003e info!(\"Web server completed normally\"),\n                Err(e) =\u003e error!(\"Web server error: {}\", e),\n            }\n        });\n\n        // Give the server a moment to start\n        info!(\"Waiting for server to start...\");\n        tokio::time::sleep(tokio::time::Duration::from_secs(2)).await;\n\n        // Try to connect to the server to verify it's running\n        info!(\"Verifying server is running on port {}\", bound_port);\n        let client = hyper::Client::new();\n        let uri = format!(\"http://127.0.0.1:{}\", bound_port).parse::\u003chyper::Uri\u003e()?;\n\n        match client.get(uri).await {\n            Ok(_) =\u003e info!(\"Successfully connected to server on port {}\", bound_port),\n            Err(e) =\u003e warn!(\"Could not connect to server for verification: {}\", e),\n        }\n\n        // Log the port information\n        info!(\"Web server running on port {}\", bound_port);\n\n        // Check if we have a setup channel\n        let has_setup_tx = {\n            let guard = setup_tx_shared_for_server.lock().await;\n            guard.is_some()\n        };\n\n        if has_setup_tx {\n            info!(\"Setup channel is available for later use\");\n        } else {\n            warn!(\"No setup channel available\");\n        }\n\n        Ok(())\n    } else {\n        error!(\"Failed to bind web server to any port\");\n        Err(anyhow::anyhow!(\"Failed to bind web server to any port\"))\n    }\n}\n\nasync fn handle_request(\n    req: Request\u003cBody\u003e,\n    db: Arc\u003cSqliteDatabase\u003e,\n    setup_tx_shared: Arc\u003cMutex\u003cOption\u003coneshot::Sender\u003c()\u003e\u003e\u003e\u003e,\n    config_dir: PathBuf,\n    mode: WebServerMode,\n) -\u003e Result\u003cResponse\u003cBody\u003e, Infallible\u003e {\n    info!(\"Received request: {} {}\", req.method(), req.uri().path());\n\n    match mode {\n        WebServerMode::SetupUI =\u003e {\n            match (req.method(), req.uri().path()) {\n                (\u0026hyper::Method::POST, \"/setup_node\") =\u003e {\n                    info!(\"Handling setup_node POST request\");\n                    match setup_api(req, db, setup_tx_shared).await {\n                        Ok(response) =\u003e {\n                            info!(\"Setup API request successful\");\n                            Ok(response)\n                        }\n                        Err(e) =\u003e {\n                            error!(\"Setup API error: {}\", e);\n                            Ok(Response::builder()\n                                .status(StatusCode::INTERNAL_SERVER_ERROR)\n                                .body(Body::from(format!(\"Error: {}\", e)))\n                                .unwrap_or_else(|_| {\n                                    Response::new(Body::from(\"Internal Server Error\"))\n                                }))\n                        }\n                    }\n                }\n                (\u0026hyper::Method::GET, \"/\") =\u003e {\n                    info!(\"Serving setup UI index.html\");\n                    // Serve the index.html file\n                    let node_path = std::env::current_dir().unwrap_or_else(|_| config_dir.clone());\n                    let web_ui_dir = node_path.join(\"setup_ui\");\n                    match std::fs::read_to_string(web_ui_dir.join(\"index.html\")) {\n                        Ok(content) =\u003e {\n                            info!(\"Successfully read index.html\");\n                            Ok(Response::new(Body::from(content)))\n                        }\n                        Err(e) =\u003e {\n                            error!(\"Failed to read index.html: {}\", e);\n                            Ok(Response::new(Body::from(format!(\n                                \"Index file not found: {}\",\n                                e\n                            ))))\n                        }\n                    }\n                }\n                (\u0026hyper::Method::GET, path)\n                    if path.starts_with(\"/css/\")\n                        || path.starts_with(\"/js/\")\n                        || path.starts_with(\"/assets/\") =\u003e\n                {\n                    info!(\"Serving static file: {}\", path);\n                    // Serve static files from subdirectories\n                    let node_path = std::env::current_dir().unwrap_or_else(|_| config_dir.clone());\n                    let web_ui_dir = node_path.join(\"setup_ui\");\n                    let file_path = web_ui_dir.join(\u0026path[1..]); // Remove leading slash\n\n                    match std::fs::read(\u0026file_path) {\n                        Ok(content) =\u003e {\n                            info!(\"Successfully read static file: {}\", file_path.display());\n\n                            // Determine content type based on file extension\n                            let content_type = if path.ends_with(\".css\") {\n                                \"text/css\"\n                            } else if path.ends_with(\".js\") {\n                                \"application/javascript\"\n                            } else if path.ends_with(\".svg\") {\n                                \"image/svg+xml\"\n                            } else if path.ends_with(\".png\") {\n                                \"image/png\"\n                            } else if path.ends_with(\".jpg\") || path.ends_with(\".jpeg\") {\n                                \"image/jpeg\"\n                            } else {\n                                \"application/octet-stream\"\n                            };\n\n                            Ok(Response::builder()\n                                .header(\"Content-Type\", content_type)\n                                .body(Body::from(content.clone()))\n                                .unwrap_or_else(|_| Response::new(Body::from(content))))\n                        }\n                        Err(e) =\u003e {\n                            error!(\"Failed to read static file {}: {}\", file_path.display(), e);\n                            Ok(Response::builder()\n                                .status(StatusCode::NOT_FOUND)\n                                .body(Body::from(format!(\"File not found: {}\", path)))\n                                .unwrap_or_else(|_| Response::new(Body::from(\"File not found\"))))\n                        }\n                    }\n                }\n                _ =\u003e {\n                    info!(\"Not found: {} {}\", req.method(), req.uri().path());\n                    Ok(Response::builder()\n                        .status(StatusCode::NOT_FOUND)\n                        .body(Body::from(\"Not Found\"))\n                        .unwrap())\n                }\n            }\n        }\n        WebServerMode::NodeUI =\u003e node_api(req, db, config_dir).await,\n    }\n}\n\nasync fn setup_api(\n    req: Request\u003cBody\u003e,\n    db: Arc\u003cSqliteDatabase\u003e,\n    setup_tx_shared: Arc\u003cMutex\u003cOption\u003coneshot::Sender\u003c()\u003e\u003e\u003e\u003e,\n) -\u003e Result\u003cResponse\u003cBody\u003e\u003e {\n    info!(\"Received setup request\");\n\n    // Parse the request body\n    let body_bytes = hyper::body::to_bytes(req.into_body()).await?;\n    let body_str = String::from_utf8(body_bytes.to_vec())?;\n    info!(\"Request body: {}\", body_str);\n\n    let params: HashMap\u003cString, String\u003e = match serde_urlencoded::from_str(\u0026body_str) {\n        Ok(params) =\u003e {\n            info!(\"Parsed parameters: {:?}\", params);\n            params\n        }\n        Err(e) =\u003e {\n            error!(\"Failed to parse request body: {}\", e);\n            return Err(anyhow::anyhow!(\"Failed to parse request body: {}\", e));\n        }\n    };\n\n    let node_name = match params.get(\"node_name\") {\n        Some(name) =\u003e {\n            info!(\"Node name parameter: {}\", name);\n            name\n        }\n        None =\u003e {\n            error!(\"Missing node_name parameter in request\");\n            return Err(anyhow::anyhow!(\"Missing node_name parameter\"));\n        }\n    };\n\n    info!(\"Setting up node with name: {}\", node_name);\n\n    // Generate a keypair for the node\n    let keypair = match NodeConfig::generate_keypair() {\n        Ok(kp) =\u003e kp,\n        Err(e) =\u003e {\n            error!(\"Failed to generate keypair: {}\", e);\n            return Err(anyhow::anyhow!(\"Failed to generate keypair: {}\", e));\n        }\n    };\n\n    // Create the node config\n    let node_config = NodeConfig {\n        node_name: node_name.clone(),\n        private_key: keypair,\n        config_dir: PathBuf::from(\".\"), // This will be set by the database when loading\n        web_ui_port: 8383,\n    };\n\n    // Save the node config to the database\n    info!(\"Saving node config to database\");\n    match db.save_node_config(\u0026node_config).await {\n        Ok(_) =\u003e info!(\"Node config saved to database successfully\"),\n        Err(e) =\u003e {\n            error!(\"Failed to save node config to database: {:?}\", e);\n            return Err(anyhow::anyhow!(\"Failed to save node config: {}\", e));\n        }\n    }\n\n    // Signal that setup is complete - use a separate block to ensure mutex is released\n    info!(\"Attempting to send setup complete signal\");\n    {\n        let mut setup_tx_guard = setup_tx_shared.lock().await;\n        if let Some(tx) = setup_tx_guard.take() {\n            info!(\"Sending setup complete signal\");\n\n            // Create a clone of the channel for debugging\n            match tx.send(()) {\n                Ok(_) =\u003e {\n                    info!(\"Setup complete signal sent successfully\");\n                }\n                Err(_) =\u003e {\n                    error!(\"Failed to send setup complete signal - receiver dropped\");\n                    // Even if we fail to send the signal, we'll continue since the config is saved\n                }\n            }\n        } else {\n            warn!(\"No setup channel available to signal completion\");\n        }\n    }\n\n    // Return a success response\n    info!(\"Returning success response\");\n    Ok(Response::builder()\n        .status(StatusCode::OK)\n        .header(\"Content-Type\", \"application/json\")\n        .body(Body::from(r#\"{\"status\":\"success\"}\"#))?)\n}\n\nasync fn node_api(\n    req: Request\u003cBody\u003e,\n    db: Arc\u003cSqliteDatabase\u003e,\n    config_dir: PathBuf,\n) -\u003e Result\u003cResponse\u003cBody\u003e, Infallible\u003e {\n    info!(\n        \"Received node UI request: {} {}\",\n        req.method(),\n        req.uri().path()\n    );\n\n    match (req.method(), req.uri().path()) {\n        (\u0026hyper::Method::GET, \"/\") =\u003e {\n            info!(\"Serving node UI index.html\");\n            // Serve the index.html file\n            let node_path = std::env::current_dir().unwrap_or_else(|_| config_dir.clone());\n            let web_ui_dir = node_path.join(\"node_ui\");\n            match std::fs::read_to_string(web_ui_dir.join(\"index.html\")) {\n                Ok(content) =\u003e {\n                    info!(\"Successfully read index.html\");\n                    Ok(Response::new(Body::from(content)))\n                }\n                Err(e) =\u003e {\n                    error!(\"Failed to read index.html: {}\", e);\n                    Ok(Response::new(Body::from(format!(\n                        \"Index file not found: {}\",\n                        e\n                    ))))\n                }\n            }\n        }\n        (\u0026hyper::Method::GET, path) if path.starts_with(\"/assets/\") =\u003e {\n            info!(\"Serving static file: {}\", path);\n            // Serve static files from subdirectories\n            let node_path = std::env::current_dir().unwrap_or_else(|_| config_dir.clone());\n            let web_ui_dir = node_path.join(\"node_ui\");\n            let file_path = web_ui_dir.join(\u0026path[1..]); // Remove leading slash\n\n            match std::fs::read(\u0026file_path) {\n                Ok(content) =\u003e {\n                    info!(\"Successfully read static file: {}\", file_path.display());\n\n                    // Determine content type based on file extension\n                    let content_type = if path.ends_with(\".css\") {\n                        \"text/css\"\n                    } else if path.ends_with(\".js\") {\n                        \"application/javascript\"\n                    } else if path.ends_with(\".svg\") {\n                        \"image/svg+xml\"\n                    } else if path.ends_with(\".png\") {\n                        \"image/png\"\n                    } else if path.ends_with(\".jpg\") || path.ends_with(\".jpeg\") {\n                        \"image/jpeg\"\n                    } else {\n                        \"application/octet-stream\"\n                    };\n\n                    Ok(Response::builder()\n                        .header(\"Content-Type\", content_type)\n                        .body(Body::from(content.clone()))\n                        .unwrap_or_else(|_| Response::new(Body::from(content))))\n                }\n                Err(e) =\u003e {\n                    error!(\"Failed to read static file {}: {}\", file_path.display(), e);\n                    Ok(Response::builder()\n                        .status(StatusCode::NOT_FOUND)\n                        .body(Body::from(format!(\"File not found: {}\", path)))\n                        .unwrap_or_else(|_| Response::new(Body::from(\"File not found\"))))\n                }\n            }\n        }\n        (\u0026hyper::Method::GET, \"/node_details\") =\u003e {\n            info!(\"Handling node_details API request\");\n            Ok(Response::new(Body::from(\"Node details logic executed\")))\n        }\n        (\u0026hyper::Method::POST, \"/update_node\") =\u003e {\n            info!(\"Handling update_node API request\");\n            Ok(Response::new(Body::from(\"Update node logic executed\")))\n        }\n        _ =\u003e {\n            info!(\"Not found: {} {}\", req.method(), req.uri().path());\n            Ok(Response::builder()\n                .status(StatusCode::NOT_FOUND)\n                .body(Body::from(\"Not Found\"))\n                .unwrap())\n        }\n    }\n}\n\npub async fn download_web_ui(web_ui_dir: \u0026PathBuf) -\u003e Result\u003c()\u003e {\n    info!(\"Checking web UI at: {}\", web_ui_dir.display());\n\n    // Ensure web_ui_dir is absolute\n    let web_ui_dir = if web_ui_dir.is_absolute() {\n        web_ui_dir.clone()\n    } else {\n        std::env::current_dir()?.join(web_ui_dir)\n    };\n\n    info!(\"Absolute path for web UI: {}\", web_ui_dir.display());\n\n    // Create the directory if it doesn't exist\n    if !web_ui_dir.exists() {\n        info!(\"Creating web UI directory: {}\", web_ui_dir.display());\n        match fs::create_dir_all(\u0026web_ui_dir) {\n            Ok(_) =\u003e info!(\"Successfully created web UI directory\"),\n            Err(e) =\u003e {\n                error!(\"Failed to create web UI directory: {}\", e);\n                return Err(anyhow::anyhow!(\"Failed to create web UI directory: {}\", e));\n            }\n        }\n    } else if !web_ui_dir.is_dir() {\n        error!(\n            \"Web UI path exists but is not a directory: {}\",\n            web_ui_dir.display()\n        );\n        return Err(anyhow::anyhow!(\"Web UI path exists but is not a directory\"));\n    } else {\n        info!(\"Web UI directory already exists\");\n    }\n\n    // Check if index.html already exists\n    let index_path = web_ui_dir.join(\"index.html\");\n    if index_path.exists() {\n        info!(\"index.html already exists at: {}\", index_path.display());\n        return Ok(());\n    }\n\n    // Create a simple fallback index.html file for setup UI if it doesn't exist\n    info!(\"Creating fallback index.html at: {}\", index_path.display());\n\n    let index_html = r#\"\u003c!DOCTYPE html\u003e\n\u003chtml lang=\"en\"\u003e\n\u003chead\u003e\n    \u003cmeta charset=\"UTF-8\"\u003e\n    \u003cmeta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\"\u003e\n    \u003ctitle\u003eKagi Node Setup\u003c/title\u003e\n    \u003c!-- This is a fallback UI. For the full UI, build the Svelte project --\u003e\n    \u003cstyle\u003e\n        body {\n            font-family: Arial, sans-serif;\n            margin: 0;\n            padding: 20px;\n            background-color: #f5f5f5;\n        }\n        .container {\n            max-width: 600px;\n            margin: 0 auto;\n            background-color: white;\n            padding: 30px;\n            border-radius: 10px;\n            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);\n        }\n        h1 {\n            color: #333;\n            text-align: center;\n            margin-bottom: 30px;\n        }\n        .form-group {\n            margin-bottom: 20px;\n        }\n        label {\n            display: block;\n            margin-bottom: 8px;\n            font-weight: bold;\n        }\n        input[type=\"text\"] {\n            width: 100%;\n            padding: 10px;\n            border: 1px solid #ddd;\n            border-radius: 4px;\n            font-size: 16px;\n        }\n        button {\n            background-color: #4CAF50;\n            color: white;\n            border: none;\n            padding: 12px 20px;\n            font-size: 16px;\n            border-radius: 4px;\n            cursor: pointer;\n            width: 100%;\n            transition: background-color 0.3s;\n        }\n        button:hover {\n            background-color: #45a049;\n        }\n        button:disabled {\n            background-color: #cccccc;\n            cursor: not-allowed;\n        }\n        .success-message {\n            color: #4CAF50;\n            font-weight: bold;\n            margin-top: 15px;\n            display: none;\n            text-align: center;\n        }\n    \u003c/style\u003e\n\u003c/head\u003e\n\u003cbody\u003e\n    \u003cdiv class=\"container\"\u003e\n        \u003ch1\u003eKagi Node Setup\u003c/h1\u003e\n        \u003cform id=\"setupForm\"\u003e\n            \u003cdiv class=\"form-group\"\u003e\n                \u003clabel for=\"node_name\"\u003eNode Name:\u003c/label\u003e\n                \u003cinput type=\"text\" id=\"node_name\" name=\"node_name\" required\u003e\n            \u003c/div\u003e\n            \u003cbutton type=\"submit\" id=\"setupButton\"\u003eComplete Setup\u003c/button\u003e\n            \u003cdiv class=\"success-message\" id=\"successMessage\"\u003eSetup completed successfully! The page will reload in a moment...\u003c/div\u003e\n        \u003c/form\u003e\n    \u003c/div\u003e\n    \u003cscript\u003e\n        document.getElementById('setupForm').addEventListener('submit', function(e) {\n            e.preventDefault();\n            \n            const setupButton = document.getElementById('setupButton');\n            const successMessage = document.getElementById('successMessage');\n            const nodeName = document.getElementById('node_name').value;\n            \n            setupButton.disabled = true;\n            setupButton.textContent = 'Setting up...';\n            \n            fetch('/setup_node', {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/x-www-form-urlencoded',\n                },\n                body: 'node_name=' + encodeURIComponent(nodeName)\n            })\n            .then(response =\u003e response.json())\n            .then(data =\u003e {\n                if (data.status === 'success') {\n                    successMessage.style.display = 'block';\n                    setTimeout(function() {\n                        window.location.reload();\n                    }, 3000);\n                } else {\n                    alert('Error: ' + data.message);\n                    setupButton.disabled = false;\n                    setupButton.textContent = 'Complete Setup';\n                }\n            })\n            .catch(error =\u003e {\n                alert('Error: ' + error);\n                setupButton.disabled = false;\n                setupButton.textContent = 'Complete Setup';\n            });\n        });\n    \u003c/script\u003e\n\u003c/body\u003e\n\u003c/html\u003e\"#;\n\n    match fs::write(\u0026index_path, index_html) {\n        Ok(_) =\u003e info!(\"Successfully wrote fallback index.html\"),\n        Err(e) =\u003e {\n            error!(\"Failed to write index.html: {}\", e);\n            return Err(anyhow::anyhow!(\"Failed to write index.html: {}\", e));\n        }\n    }\n\n    info!(\"Created fallback UI at: {}\", web_ui_dir.display());\n    Ok(())\n}\n","traces":[{"line":24,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":94,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":312,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":318,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":354,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":405,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":496,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":543,"address":[],"length":0,"stats":{"Line":0}},{"line":544,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":551,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":554,"address":[],"length":0,"stats":{"Line":0}},{"line":555,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":563,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":567,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":0}},{"line":573,"address":[],"length":0,"stats":{"Line":0}},{"line":575,"address":[],"length":0,"stats":{"Line":0}},{"line":576,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":0}},{"line":579,"address":[],"length":0,"stats":{"Line":0}},{"line":580,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":582,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":586,"address":[],"length":0,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":0}},{"line":591,"address":[],"length":0,"stats":{"Line":0}},{"line":592,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":597,"address":[],"length":0,"stats":{"Line":0}},{"line":598,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[],"length":0,"stats":{"Line":0}},{"line":601,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":604,"address":[],"length":0,"stats":{"Line":0}},{"line":605,"address":[],"length":0,"stats":{"Line":0}},{"line":606,"address":[],"length":0,"stats":{"Line":0}},{"line":608,"address":[],"length":0,"stats":{"Line":0}},{"line":609,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":612,"address":[],"length":0,"stats":{"Line":0}},{"line":613,"address":[],"length":0,"stats":{"Line":0}},{"line":614,"address":[],"length":0,"stats":{"Line":0}},{"line":616,"address":[],"length":0,"stats":{"Line":0}},{"line":618,"address":[],"length":0,"stats":{"Line":0}},{"line":619,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":621,"address":[],"length":0,"stats":{"Line":0}},{"line":622,"address":[],"length":0,"stats":{"Line":0}},{"line":623,"address":[],"length":0,"stats":{"Line":0}},{"line":624,"address":[],"length":0,"stats":{"Line":0}},{"line":626,"address":[],"length":0,"stats":{"Line":0}},{"line":627,"address":[],"length":0,"stats":{"Line":0}},{"line":628,"address":[],"length":0,"stats":{"Line":0}},{"line":631,"address":[],"length":0,"stats":{"Line":0}},{"line":632,"address":[],"length":0,"stats":{"Line":0}},{"line":633,"address":[],"length":0,"stats":{"Line":0}},{"line":634,"address":[],"length":0,"stats":{"Line":0}},{"line":637,"address":[],"length":0,"stats":{"Line":0}},{"line":638,"address":[],"length":0,"stats":{"Line":0}},{"line":639,"address":[],"length":0,"stats":{"Line":0}},{"line":641,"address":[],"length":0,"stats":{"Line":0}},{"line":642,"address":[],"length":0,"stats":{"Line":0}},{"line":643,"address":[],"length":0,"stats":{"Line":0}},{"line":644,"address":[],"length":0,"stats":{"Line":0}},{"line":645,"address":[],"length":0,"stats":{"Line":0}},{"line":649,"address":[],"length":0,"stats":{"Line":0}},{"line":650,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":396},{"path":["/","Users","rafael","dev","kagi","node","tests","ipc_tests.rs"],"content":"use anyhow::Result;\nuse async_trait::async_trait;\nuse kagi_node::services::registry::ServiceRegistry;\nuse kagi_node::services::{\n    AbstractService, RequestContext, ResponseStatus, ServiceManager, ServiceRequest,\n    ServiceResponse,\n};\nuse serde_json::json;\nuse std::sync::Arc;\nuse tempfile::TempDir;\nuse tokio::time::{timeout, Duration};\n\nuse kagi_node::db::SqliteDatabase;\nuse kagi_node::ipc::{IpcClient, IpcResponseStatus, IpcServer};\n\nconst NETWORK_ID: \u0026str = \"test_network\";\nconst TEST_TIMEOUT: u64 = 10; // 10 second timeout for tests\n\n// Simple test service implementation\nstruct TestService {\n    name: String,\n    path: String,\n}\n\nimpl TestService {\n    fn new(name: \u0026str, network_id: \u0026str) -\u003e Self {\n        TestService {\n            name: name.to_string(),\n            path: format!(\"{}/{}\", network_id, name),\n        }\n    }\n}\n\n#[async_trait]\nimpl AbstractService for TestService {\n    fn name(\u0026self) -\u003e \u0026str {\n        \u0026self.name\n    }\n\n    fn path(\u0026self) -\u003e \u0026str {\n        \u0026self.path\n    }\n\n    fn state(\u0026self) -\u003e kagi_node::services::abstract_service::ServiceState {\n        kagi_node::services::abstract_service::ServiceState::Running\n    }\n\n    async fn init(\u0026mut self, _context: \u0026RequestContext) -\u003e Result\u003c()\u003e {\n        Ok(())\n    }\n\n    async fn start(\u0026mut self) -\u003e Result\u003c()\u003e {\n        Ok(())\n    }\n\n    async fn stop(\u0026mut self) -\u003e Result\u003c()\u003e {\n        Ok(())\n    }\n\n    async fn process_request(\u0026self, request: ServiceRequest) -\u003e Result\u003cServiceResponse\u003e {\n        match request.operation.as_str() {\n            \"ping\" =\u003e Ok(ServiceResponse {\n                status: ResponseStatus::Success,\n                message: \"Pong\".to_string(),\n                data: Some(kagi_node::services::ValueType::String(\"Pong\".to_string())),\n            }),\n            \"echo\" =\u003e {\n                let message = request\n                    .get_param(\"message\")\n                    .map(|v| v.to_string())\n                    .unwrap_or_else(|| \"No message provided\".to_string());\n\n                Ok(ServiceResponse {\n                    status: ResponseStatus::Success,\n                    message: \"Echo received\".to_string(),\n                    data: Some(kagi_node::services::ValueType::String(message)),\n                })\n            }\n            _ =\u003e Ok(ServiceResponse {\n                status: ResponseStatus::Error,\n                message: format!(\"Unknown operation: {}\", request.operation),\n                data: None,\n            }),\n        }\n    }\n\n    fn description(\u0026self) -\u003e String {\n        \"A simple test service\".to_string()\n    }\n}\n\n// Helper function to create an IPC server with services\nasync fn create_test_server() -\u003e Result\u003c(IpcServer, std::path::PathBuf, TempDir)\u003e {\n    println!(\"Creating test server...\");\n    // Create a temporary directory for our test\n    let temp_dir = TempDir::new()?;\n    println!(\"Created temp directory at: {:?}\", temp_dir.path());\n\n    let db_path = temp_dir\n        .path()\n        .join(\"test_db.db\")\n        .to_str()\n        .unwrap()\n        .to_string();\n    println!(\"Database path: {}\", db_path);\n\n    let socket_path = temp_dir.path().join(\"test_socket.sock\");\n    println!(\"Socket path: {:?}\", socket_path);\n\n    // Create the database\n    println!(\"Creating database...\");\n    let db = Arc::new(SqliteDatabase::new(\u0026db_path).await?);\n    println!(\"Database created successfully\");\n\n    // Create the service registry\n    println!(\"Creating service registry...\");\n    let service_registry = ServiceRegistry::new_with_db(NETWORK_ID, db.clone());\n\n    // Register our test service\n    println!(\"Registering test service...\");\n    let test_service = TestService::new(\"test\", NETWORK_ID);\n    service_registry\n        .register_service(Arc::new(test_service))\n        .await?;\n\n    // Create Arc\u003cServiceRegistry\u003e for sharing\n    let service_registry = Arc::new(service_registry);\n\n    // Set up IPC server\n    println!(\"Setting up IPC server...\");\n    let mut ipc_server = IpcServer::new(socket_path.clone(), db.clone(), NETWORK_ID);\n\n    // Attach the service registry to the IPC server\n    ipc_server.set_service_registry(service_registry.clone());\n\n    // Start the IPC server\n    println!(\"Starting IPC server...\");\n    ipc_server.start().await?;\n    println!(\"IPC server started successfully\");\n\n    // Give the server time to start\n    println!(\"Waiting for server to stabilize...\");\n    tokio::time::sleep(Duration::from_millis(500)).await;\n    println!(\"Ready to proceed with tests\");\n\n    Ok((ipc_server, socket_path, temp_dir))\n}\n\n#[tokio::test]\nasync fn test_ipc_communication() -\u003e Result\u003c()\u003e {\n    println!(\"Starting test_ipc_communication...\");\n\n    // Apply timeout to the entire test\n    timeout(Duration::from_secs(TEST_TIMEOUT), async {\n        println!(\"Creating test server...\");\n        let (mut server, socket_path, temp_dir) = create_test_server().await?;\n        println!(\"Test server created successfully\");\n\n        // Create a client that will automatically reconnect when needed\n        println!(\"Creating IPC client...\");\n        let mut client = IpcClient::new(socket_path.clone());\n        println!(\"Connecting to server at: {:?}...\", socket_path);\n\n        match client.connect().await {\n            Ok(_) =\u003e println!(\"Connected to IPC server successfully\"),\n            Err(e) =\u003e {\n                println!(\"Failed to connect to IPC server: {}\", e);\n                return Err(e);\n            }\n        }\n\n        // Test ping\n        println!(\"Testing ping operation...\");\n        let ping_request = json!({\n            \"operation\": \"ping\"\n        });\n\n        let ping_response = client\n            .request(\n                format!(\"{}/test\", NETWORK_ID).as_str(),\n                \"ping\",\n                Some(ping_request),\n            )\n            .await?;\n\n        assert_eq!(\n            ping_response.status,\n            ResponseStatus::Success.into(),\n            \"Ping operation failed: {}\",\n            ping_response.message.unwrap_or_default()\n        );\n\n        assert_eq!(\n            ping_response.data.unwrap().as_str().unwrap(),\n            \"Pong\",\n            \"Expected 'Pong' response from ping\"\n        );\n\n        println!(\"Ping test passed successfully\");\n\n        // Test echo\n        println!(\"Testing echo operation...\");\n        let test_message = \"Hello, world!\";\n        let echo_request = json!({\n            \"operation\": \"echo\",\n            \"message\": test_message\n        });\n\n        let echo_response = client\n            .request(\n                format!(\"{}/test\", NETWORK_ID).as_str(),\n                \"echo\",\n                Some(echo_request),\n            )\n            .await?;\n\n        assert_eq!(\n            echo_response.status,\n            ResponseStatus::Success.into(),\n            \"Echo operation failed: {}\",\n            echo_response.message.unwrap_or_default()\n        );\n\n        // The echo response is quoted, so we need to compare with the quoted string\n        assert_eq!(\n            echo_response.data.unwrap().as_str().unwrap(),\n            \u0026format!(\"\\\"{}\\\"\", test_message),\n            \"Echo response did not match sent message\"\n        );\n\n        println!(\"Echo test passed successfully\");\n\n        // Test unknown operation\n        println!(\"Testing unknown operation...\");\n        let unknown_request = json!({\n            \"operation\": \"unknown_operation\"\n        });\n\n        let unknown_response = client\n            .request(\n                format!(\"{}/test\", NETWORK_ID).as_str(),\n                \"unknown_operation\",\n                Some(unknown_request),\n            )\n            .await?;\n\n        assert_eq!(\n            unknown_response.status,\n            ResponseStatus::Error.into(),\n            \"Expected error for unknown operation but got success\"\n        );\n\n        println!(\"Unknown operation test passed successfully\");\n\n        // Clean up\n        println!(\"Cleaning up...\");\n        println!(\"Disconnecting client...\");\n        client.disconnect().await?;\n        println!(\"Stopping server...\");\n        server.stop().await?;\n        println!(\"Server stopped successfully\");\n\n        // Make sure the temp_dir is not dropped until after the test\n        drop(temp_dir);\n\n        Ok(())\n    })\n    .await\n    .expect(\"Test timed out\")?;\n\n    println!(\"Test completed successfully\");\n    Ok(())\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","rafael","dev","kagi","node","tests","node_api_tests.rs"],"content":"use anyhow::Result;\nuse async_trait::async_trait;\nuse kagi_node::node::{Node, NodeConfig};\nuse kagi_node::services::abstract_service::{AbstractService, ServiceMetadata, ServiceState};\nuse kagi_node::services::ResponseStatus;\nuse kagi_node::services::{RequestContext, ServiceRequest, ServiceResponse, ValueType};\nuse kagi_node::vmap;\n\nuse std::sync::Mutex;\nuse tempfile::tempdir;\nuse tokio::time::timeout;\n\nmod test_utils;\nuse test_utils::{create_test_node, MockDocumentStore, SimpleTestService};\n\n/// Authentication service that demonstrates service-to-service communication\nstruct AuthService {\n    name: String,\n    path: String,\n    state: Mutex\u003cServiceState\u003e,\n}\n\nimpl AuthService {\n    /// Create a new AuthService\n    pub fn new(name: \u0026str) -\u003e Self {\n        AuthService {\n            name: name.to_string(),\n            path: name.to_string(),\n            state: Mutex::new(ServiceState::Created),\n        }\n    }\n\n    /// Find a user by credentials\n    async fn find_user(\n        \u0026self,\n        context: \u0026RequestContext,\n        username: \u0026str,\n    ) -\u003e Result\u003cOption\u003cValueType\u003e\u003e {\n        // Create a filter for the user lookup\n        let filter = vmap! {\n            \"name\" =\u003e username.to_string()\n        };\n\n        // Create the request parameters\n        let params = vmap! {\n            \"collection\" =\u003e \"users\",\n            \"filter\" =\u003e filter\n        };\n\n        // Make a request to the document store using the context\n        let response = context.request(\"documentStore/read\", params).await?;\n\n        // Check if we found a user\n        if let Some(data) = response.data {\n            if let Some(users) = data.as_array() {\n                if !users.is_empty() {\n                    // User found\n                    return Ok(Some(users[0].clone()));\n                }\n            }\n        }\n\n        Ok(None)\n    }\n\n    /// Login a user with username and password\n    async fn login(\n        \u0026self,\n        context: \u0026RequestContext,\n        username: \u0026str,\n        password: \u0026str,\n    ) -\u003e Result\u003cServiceResponse\u003e {\n        // Find the user\n        let user_option = self.find_user(context, username).await?;\n\n        // Check if we found a user\n        if let Some(user) = user_option {\n            // Verify password (in a real app, we would hash and compare)\n            let stored_password = match \u0026user {\n                ValueType::Map(map) =\u003e map.get(\"password\").and_then(|p| p.as_str()),\n                ValueType::Json(json) =\u003e json.get(\"password\").and_then(|p| p.as_str()),\n                _ =\u003e None,\n            };\n\n            if let Some(stored_pwd) = stored_password {\n                if stored_pwd == password {\n                    // Success - create a session token (just a UUID in this example)\n                    let token = uuid::Uuid::new_v4().to_string();\n\n                    // Create the response\n                    let response_data = vmap! {\n                        \"user\" =\u003e user,\n                        \"token\" =\u003e token\n                    };\n\n                    return Ok(ServiceResponse {\n                        status: ResponseStatus::Success,\n                        message: \"Login successful\".to_string(),\n                        data: Some(response_data),\n                    });\n                }\n            }\n        }\n\n        // Authentication failed\n        Ok(ServiceResponse {\n            status: ResponseStatus::Error,\n            message: \"Invalid username or password\".to_string(),\n            data: None,\n        })\n    }\n\n    /// Logout a user by invalidating their token\n    async fn logout(\u0026self, _context: \u0026RequestContext, token: \u0026str) -\u003e Result\u003cServiceResponse\u003e {\n        // Just simulate token invalidation - in a real service,\n        // we would delete the token from a database\n        if !token.is_empty() {\n            Ok(ServiceResponse {\n                status: ResponseStatus::Success,\n                message: \"Logout successful\".to_string(),\n                data: None,\n            })\n        } else {\n            Ok(ServiceResponse {\n                status: ResponseStatus::Error,\n                message: \"Invalid token\".to_string(),\n                data: None,\n            })\n        }\n    }\n}\n\n#[async_trait]\nimpl AbstractService for AuthService {\n    fn name(\u0026self) -\u003e \u0026str {\n        \u0026self.name\n    }\n\n    fn path(\u0026self) -\u003e \u0026str {\n        \u0026self.path\n    }\n\n    fn state(\u0026self) -\u003e ServiceState {\n        *self.state.lock().unwrap()\n    }\n\n    async fn init(\u0026mut self, _context: \u0026RequestContext) -\u003e Result\u003c()\u003e {\n        *self.state.lock().unwrap() = ServiceState::Initialized;\n        Ok(())\n    }\n\n    async fn start(\u0026mut self) -\u003e Result\u003c()\u003e {\n        *self.state.lock().unwrap() = ServiceState::Running;\n        Ok(())\n    }\n\n    async fn stop(\u0026mut self) -\u003e Result\u003c()\u003e {\n        *self.state.lock().unwrap() = ServiceState::Stopped;\n        Ok(())\n    }\n\n    async fn process_request(\u0026self, request: ServiceRequest) -\u003e Result\u003cServiceResponse\u003e {\n        // Get the request context\n        let request_context = \u0026request.request_context;\n\n        // Handle auth service requests\n        let operation = request.operation.as_str();\n\n        match operation {\n            \"login\" =\u003e {\n                // Extract username and password from request\n                let username = request\n                    .params\n                    .get(\"username\")\n                    .and_then(|v| v.as_str().map(|s| s.to_string()))\n                    .unwrap_or_default();\n                let password = request\n                    .params\n                    .get(\"password\")\n                    .and_then(|v| v.as_str().map(|s| s.to_string()))\n                    .unwrap_or_default();\n\n                // Call the login method with context\n                self.login(request_context, \u0026username, \u0026password).await\n            }\n            \"logout\" =\u003e {\n                // Extract token from request\n                let token = request\n                    .params\n                    .get(\"token\")\n                    .and_then(|v| v.as_str().map(|s| s.to_string()))\n                    .unwrap_or_default();\n\n                // Call the logout method with context\n                self.logout(request_context, \u0026token).await\n            }\n            _ =\u003e Ok(ServiceResponse {\n                status: ResponseStatus::Error,\n                message: format!(\"Unknown operation: {}\", operation),\n                data: None,\n            }),\n        }\n    }\n\n    fn description(\u0026self) -\u003e String {\n        \"Authentication Service\".to_string()\n    }\n\n    fn metadata(\u0026self) -\u003e ServiceMetadata {\n        ServiceMetadata {\n            name: self.name.clone(),\n            path: self.path.clone(),\n            state: self.state(),\n            description: self.description(),\n            operations: vec![\"login\".to_string(), \"logout\".to_string()],\n            version: \"1.0.0\".to_string(),\n        }\n    }\n}\n\n/// Test the Node API with a simple service\n#[tokio::test]\nasync fn test_node_api_with_simple_service() -\u003e Result\u003c()\u003e {\n    // Set a timeout for the test\n    let timeout_duration = std::time::Duration::from_secs(10);\n\n    let _result = timeout(timeout_duration, async {\n        // Create a test node\n        let (mut node, _temp_dir, _node_config) = create_test_node().await?;\n\n        // Create and add the simple test service\n        let test_service = SimpleTestService::new(\"testService\");\n        node.add_service(test_service).await?;\n\n        // Test basic service request\n        let echo_params = vmap! {\n            \"message\" =\u003e \"Hello from test!\",\n            \"value\" =\u003e 42\n        };\n\n        let echo_result = node.request(\"testService/echo\", echo_params).await?;\n\n        // Print the response for debugging\n        println!(\"Echo result: {:?}\", echo_result);\n        if let Some(data) = \u0026echo_result.data {\n            println!(\"Response data: {:?}\", data);\n            if let Some(received_params) = data.get(\"received_params\") {\n                println!(\"Received params: {:?}\", received_params);\n                if let Some(params_map) = received_params.as_map() {\n                    println!(\"Params map: {:?}\", params_map);\n                    for (k, v) in params_map {\n                        println!(\"Key: {}, Value: {:?}\", k, v);\n                    }\n                }\n            }\n        }\n\n        // Verify request was successful\n        assert_eq!(\n            echo_result.status,\n            ResponseStatus::Success,\n            \"Echo request should succeed\"\n        );\n\n        // Verify response has data\n        assert!(echo_result.data.is_some(), \"Response should have data\");\n\n        // Verify message in response\n        if let Some(data) = echo_result.data {\n            if let Some(message) = data.get(\"message\") {\n                assert!(\n                    message.as_str().unwrap_or_default().contains(\"echo\"),\n                    \"Message should contain operation name\"\n                );\n            } else {\n                panic!(\"Response data should contain a message field\");\n            }\n\n            // Verify parameters were echoed back\n            if let Some(received_params) = data.get(\"received_params\") {\n                if let Some(params_map) = received_params.as_map() {\n                    // Get the message parameter, handling both plain and JSON values\n                    let message_value = params_map.get(\"message\");\n                    let message_str = match message_value {\n                        Some(ValueType::String(s)) =\u003e Some(s.as_str()),\n                        Some(ValueType::Json(json)) =\u003e json.as_str(),\n                        _ =\u003e None,\n                    };\n\n                    assert_eq!(\n                        message_str,\n                        Some(\"Hello from test!\"),\n                        \"Original message parameter should be echoed\"\n                    );\n\n                    // Get the value parameter, handling both plain and JSON values\n                    let value_num = match params_map.get(\"value\") {\n                        Some(ValueType::Number(n)) =\u003e Some(*n),\n                        Some(ValueType::Json(json)) =\u003e json.as_f64(),\n                        _ =\u003e None,\n                    };\n\n                    assert_eq!(\n                        value_num,\n                        Some(42.0),\n                        \"Original value parameter should be echoed\"\n                    );\n                } else {\n                    panic!(\"Response data should contain received_params as a map\");\n                }\n            } else {\n                panic!(\"Response data should contain received_params field\");\n            }\n        }\n\n        Ok::\u003c(), anyhow::Error\u003e(())\n    })\n    .await??;\n\n    Ok(())\n}\n\n/// Test the service to service communication\n#[tokio::test]\nasync fn test_service_to_service_communication() -\u003e Result\u003c()\u003e {\n    // Set a timeout for the test\n    let timeout_duration = std::time::Duration::from_secs(10);\n\n    let _result = timeout(timeout_duration, async {\n        // Create a test node\n        let (mut node, _temp_dir, _node_config) = create_test_node().await?;\n\n        // Create the MockDocumentStore (which will simulate a user store)\n        let document_store = MockDocumentStore::new(\"documentStore\");\n        node.add_service(document_store).await?;\n\n        // Create the AuthService\n        let auth_service = AuthService::new(\"auth\");\n        node.add_service(auth_service).await?;\n\n        // Login the user - the AuthService will call MockDocumentStore internally\n        let login_params = vmap! {\n            \"username\" =\u003e \"testuser\",\n            \"password\" =\u003e \"password123\"\n        };\n\n        let login_result = node.request(\"auth/login\", login_params).await?;\n\n        // Verify login was successful\n        assert_eq!(\n            login_result.status,\n            ResponseStatus::Success,\n            \"Login should succeed\"\n        );\n\n        // Extract the session token\n        let session_token = login_result\n            .data\n            .as_ref()\n            .and_then(|data| data.get(\"token\"))\n            .and_then(|token| token.as_str().map(|s| s.to_string()))\n            .expect(\"No token in login response\");\n\n        // Logout the user\n        let logout_params = vmap! {\n            \"token\" =\u003e session_token\n        };\n\n        let logout_result = node.request(\"auth/logout\", logout_params).await?;\n\n        // Verify logout was successful\n        assert_eq!(\n            logout_result.status,\n            ResponseStatus::Success,\n            \"Logout should succeed\"\n        );\n\n        Ok::\u003c(), anyhow::Error\u003e(())\n    })\n    .await??;\n\n    Ok(())\n}\n\n/// Test failed authentication\n#[tokio::test]\nasync fn test_failed_authentication() -\u003e Result\u003c()\u003e {\n    // Set a timeout for the test\n    let timeout_duration = std::time::Duration::from_secs(10);\n\n    let _result = timeout(timeout_duration, async {\n        // Create a test node\n        let (mut node, _temp_dir, _node_config) = create_test_node().await?;\n\n        // Create the MockDocumentStore (which will simulate a user store)\n        let document_store = MockDocumentStore::new(\"documentStore\");\n        node.add_service(document_store).await?;\n\n        // Create the AuthService\n        let auth_service = AuthService::new(\"auth\");\n        node.add_service(auth_service).await?;\n\n        // Try to login with invalid credentials\n        let login_params = vmap! {\n            \"username\" =\u003e \"testuser\",\n            \"password\" =\u003e \"wrong_password\"\n        };\n\n        let login_result = node.request(\"auth/login\", login_params).await?;\n\n        // Verify login failed\n        assert_eq!(\n            login_result.status,\n            ResponseStatus::Error,\n            \"Login should fail with wrong password\"\n        );\n\n        // Try to login with non-existent user\n        let login_params = vmap! {\n            \"username\" =\u003e \"nonexistent\",\n            \"password\" =\u003e \"password123\"\n        };\n\n        let login_result = node.request(\"auth/login\", login_params).await?;\n\n        // Verify login failed\n        assert_eq!(\n            login_result.status,\n            ResponseStatus::Error,\n            \"Login should fail with non-existent user\"\n        );\n\n        Ok::\u003c(), anyhow::Error\u003e(())\n    })\n    .await??;\n\n    Ok(())\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","rafael","dev","kagi","node","tests","pub_sub_tests.rs"],"content":"use anyhow::Result;\nuse chrono;\nuse kagi_node::node::{Node, NodeConfig};\nuse kagi_node::services::{\n    AbstractService, RequestContext, ResponseStatus, ServiceRequest, ServiceResponse, ValueType,\n};\nuse serde_json::json;\nuse std::sync::Arc;\nuse tempfile::tempdir;\nuse tokio::sync::Mutex;\nuse tokio::test;\n\n/// A service that publishes events\nstruct PublisherService {\n    name: String,\n    path: String,\n}\n\nimpl PublisherService {\n    fn new(name: \u0026str) -\u003e Self {\n        PublisherService {\n            name: name.to_string(),\n            path: name.to_string(),\n        }\n    }\n\n    async fn validate_event(\u0026self, event_data: \u0026str) -\u003e Result\u003cServiceResponse\u003e {\n        // Just a simple validation\n        if event_data.contains(\"valid\") {\n            Ok(ServiceResponse {\n                status: ResponseStatus::Success,\n                message: \"Event is valid\".to_string(),\n                data: Some(ValueType::String(\"valid\".to_string())),\n            })\n        } else {\n            Ok(ServiceResponse {\n                status: ResponseStatus::Error,\n                message: \"Event is invalid\".to_string(),\n                data: Some(ValueType::String(\"invalid\".to_string())),\n            })\n        }\n    }\n\n    // Method to publish an event\n    async fn publish_event(\u0026self, context: \u0026RequestContext, topic: \u0026str, data: \u0026str) -\u003e Result\u003c()\u003e {\n        // Ensure topic includes service name\n        let full_topic = if topic.starts_with(\u0026format!(\"{}/\", self.name)) {\n            topic.to_string()\n        } else {\n            format!(\"{}/{}\", self.name, topic)\n        };\n\n        let event_data = json!({\n            \"topic\": full_topic,\n            \"data\": data,\n            \"timestamp\": chrono::Utc::now().to_rfc3339(),\n        });\n\n        println!(\"Publishing to topic: {} with data: {}\", full_topic, data);\n        context.publish(\u0026full_topic, event_data).await?;\n        println!(\"Published event on topic: {}\", full_topic);\n\n        Ok(())\n    }\n}\n\n#[async_trait::async_trait]\nimpl AbstractService for PublisherService {\n    fn name(\u0026self) -\u003e \u0026str {\n        \u0026self.name\n    }\n\n    fn path(\u0026self) -\u003e \u0026str {\n        \u0026self.path\n    }\n\n    fn state(\u0026self) -\u003e kagi_node::services::abstract_service::ServiceState {\n        kagi_node::services::abstract_service::ServiceState::Running\n    }\n\n    async fn init(\u0026mut self, context: \u0026RequestContext) -\u003e Result\u003c()\u003e {\n        println!(\"Initializing PublisherService\");\n        // Publisher doesn't need to set up subscriptions\n        Ok(())\n    }\n\n    async fn start(\u0026mut self) -\u003e Result\u003c()\u003e {\n        println!(\"Starting PublisherService\");\n        Ok(())\n    }\n\n    async fn stop(\u0026mut self) -\u003e Result\u003c()\u003e {\n        println!(\"Stopping PublisherService\");\n        Ok(())\n    }\n\n    async fn process_request(\u0026self, request: ServiceRequest) -\u003e Result\u003cServiceResponse\u003e {\n        match request.operation.as_str() {\n            \"validate\" =\u003e {\n                let event_data = request\n                    .get_param(\"data\")\n                    .and_then(|v| v.as_str().map(|s| s.to_string()))\n                    .unwrap_or_else(|| \"empty\".to_string());\n\n                self.validate_event(\u0026event_data).await\n            }\n            \"publish\" =\u003e {\n                // Extract topic and data from the request parameters\n                println!(\"Publish request params: {:?}\", request.params);\n\n                // Extract directly from the JSON value\n                let params = match \u0026request.params {\n                    ValueType::Json(json_value) =\u003e {\n                        if let Some(obj) = json_value.as_object() {\n                            obj\n                        } else {\n                            println!(\"Params is not an object\");\n                            return Ok(ServiceResponse {\n                                status: ResponseStatus::Error,\n                                message: \"Params is not an object\".to_string(),\n                                data: None,\n                            });\n                        }\n                    }\n                    _ =\u003e {\n                        println!(\"Params is not a JSON value\");\n                        return Ok(ServiceResponse {\n                            status: ResponseStatus::Error,\n                            message: \"Params is not a JSON value\".to_string(),\n                            data: None,\n                        });\n                    }\n                };\n\n                let topic = params\n                    .get(\"topic\")\n                    .and_then(|v| v.as_str())\n                    .unwrap_or(\"default\");\n\n                let data = params\n                    .get(\"data\")\n                    .and_then(|v| v.as_str())\n                    .unwrap_or(\"empty\");\n\n                println!(\n                    \"Received publish request with topic: {} and data: {}\",\n                    topic, data\n                );\n\n                // Pass the context directly from the request\n                self.publish_event(\u0026request.request_context, topic, data)\n                    .await?;\n\n                Ok(ServiceResponse {\n                    status: ResponseStatus::Success,\n                    message: format!(\"Published to topic {}\", topic),\n                    data: None,\n                })\n            }\n            _ =\u003e Ok(ServiceResponse {\n                status: ResponseStatus::Error,\n                message: format!(\"Unknown operation: {}\", request.operation),\n                data: None,\n            }),\n        }\n    }\n\n    fn description(\u0026self) -\u003e String {\n        \"A service that publishes events\".to_string()\n    }\n}\n\n// Shared storage for events\n#[derive(Clone)]\nstruct EventStorage {\n    valid_events: Arc\u003cMutex\u003cVec\u003cString\u003e\u003e\u003e,\n    invalid_events: Arc\u003cMutex\u003cVec\u003cString\u003e\u003e\u003e,\n}\n\nimpl EventStorage {\n    fn new() -\u003e Self {\n        Self {\n            valid_events: Arc::new(Mutex::new(vec![])),\n            invalid_events: Arc::new(Mutex::new(vec![])),\n        }\n    }\n}\n\n/// A service that listens for events\nstruct ListenerService {\n    name: String,\n    path: String,\n    storage: EventStorage,\n    // Flag to track if subscriptions are set up\n    subscriptions_setup: Arc\u003cMutex\u003cbool\u003e\u003e,\n}\n\nimpl ListenerService {\n    fn new(name: \u0026str) -\u003e Self {\n        ListenerService {\n            name: name.to_string(),\n            path: name.to_string(),\n            storage: EventStorage::new(),\n            subscriptions_setup: Arc::new(Mutex::new(false)),\n        }\n    }\n\n    // Handler for valid events\n    async fn handle_valid_event(\u0026self, payload: serde_json::Value) {\n        let data = payload[\"data\"].as_str().unwrap_or(\"unknown\");\n        println!(\"Received valid event: {}\", data);\n        let mut events = self.storage.valid_events.lock().await;\n        events.push(data.to_string());\n        println!(\"Valid events count after adding: {}\", events.len());\n    }\n\n    // Handler for invalid events\n    async fn handle_invalid_event(\u0026self, payload: serde_json::Value) {\n        let data = payload[\"data\"].as_str().unwrap_or(\"unknown\");\n        println!(\"Received invalid event: {}\", data);\n        let mut events = self.storage.invalid_events.lock().await;\n        events.push(data.to_string());\n        println!(\"Invalid events count after adding: {}\", events.len());\n    }\n\n    // Get all valid events that have been received\n    async fn get_valid_events(\u0026self) -\u003e Vec\u003cString\u003e {\n        let events = self.storage.valid_events.lock().await;\n        println!(\"Getting valid events, count: {}\", events.len());\n        events.clone()\n    }\n\n    // Get all invalid events that have been received\n    async fn get_invalid_events(\u0026self) -\u003e Vec\u003cString\u003e {\n        let events = self.storage.invalid_events.lock().await;\n        println!(\"Getting invalid events, count: {}\", events.len());\n        events.clone()\n    }\n\n    // Set up subscriptions with a provided context\n    async fn setup_subscriptions(\u0026self, context: \u0026RequestContext) -\u003e Result\u003c()\u003e {\n        // Create clones for the closures\n        let self_clone = Arc::new(self.clone());\n\n        // Subscribe to valid events\n        let self_valid = self_clone.clone();\n        println!(\"Setting up subscription for topic: publisher/valid\");\n        context\n            .subscribe(\"publisher/valid\", move |payload| {\n                let self_valid = self_valid.clone();\n                println!(\"Received payload on publisher/valid: {:?}\", payload);\n                if let ValueType::Json(json_value) = payload {\n                    // Spawn a task to handle the event asynchronously\n                    tokio::spawn(async move {\n                        self_valid.handle_valid_event(json_value).await;\n                    });\n                }\n                Ok(())\n            })\n            .await?;\n\n        // Subscribe to invalid events\n        let self_invalid = self_clone.clone();\n        println!(\"Setting up subscription for topic: publisher/invalid\");\n        context\n            .subscribe(\"publisher/invalid\", move |payload| {\n                let self_invalid = self_invalid.clone();\n                println!(\"Received payload on publisher/invalid: {:?}\", payload);\n                if let ValueType::Json(json_value) = payload {\n                    // Spawn a task to handle the event asynchronously\n                    tokio::spawn(async move {\n                        self_invalid.handle_invalid_event(json_value).await;\n                    });\n                }\n                Ok(())\n            })\n            .await?;\n\n        println!(\"Subscriptions set up successfully\");\n\n        Ok(())\n    }\n\n    // Ensure subscriptions are set up\n    async fn ensure_subscriptions(\u0026self, context: \u0026RequestContext) -\u003e Result\u003c()\u003e {\n        let mut setup = self.subscriptions_setup.lock().await;\n        if !*setup {\n            self.setup_subscriptions(context).await?;\n            *setup = true;\n        }\n        Ok(())\n    }\n}\n\n#[async_trait::async_trait]\nimpl AbstractService for ListenerService {\n    fn name(\u0026self) -\u003e \u0026str {\n        \u0026self.name\n    }\n\n    fn path(\u0026self) -\u003e \u0026str {\n        \u0026self.path\n    }\n\n    fn state(\u0026self) -\u003e kagi_node::services::abstract_service::ServiceState {\n        kagi_node::services::abstract_service::ServiceState::Running\n    }\n\n    async fn init(\u0026mut self, context: \u0026RequestContext) -\u003e Result\u003c()\u003e {\n        println!(\"Initializing ListenerService\");\n\n        // Set up subscriptions during initialization\n        let self_clone = self.clone();\n        let self_valid = Arc::new(self_clone.clone());\n\n        println!(\"Setting up subscription for topic: publisher/valid\");\n        context\n            .subscribe(\"publisher/valid\", move |payload| {\n                let self_valid = self_valid.clone();\n                println!(\"Received payload on publisher/valid: {:?}\", payload);\n                if let ValueType::Json(json_value) = payload {\n                    // Spawn a task to handle the event asynchronously\n                    tokio::spawn(async move {\n                        self_valid.handle_valid_event(json_value).await;\n                    });\n                }\n                Ok(())\n            })\n            .await?;\n\n        // Subscribe to invalid events\n        let self_invalid = Arc::new(self_clone);\n        println!(\"Setting up subscription for topic: publisher/invalid\");\n        context\n            .subscribe(\"publisher/invalid\", move |payload| {\n                let self_invalid = self_invalid.clone();\n                println!(\"Received payload on publisher/invalid: {:?}\", payload);\n                if let ValueType::Json(json_value) = payload {\n                    // Spawn a task to handle the event asynchronously\n                    tokio::spawn(async move {\n                        self_invalid.handle_invalid_event(json_value).await;\n                    });\n                }\n                Ok(())\n            })\n            .await?;\n\n        println!(\"Subscriptions set up successfully during initialization\");\n\n        // Mark subscriptions as set up\n        let mut setup = self.subscriptions_setup.lock().await;\n        *setup = true;\n\n        Ok(())\n    }\n\n    async fn start(\u0026mut self) -\u003e Result\u003c()\u003e {\n        println!(\"Starting ListenerService\");\n        Ok(())\n    }\n\n    async fn stop(\u0026mut self) -\u003e Result\u003c()\u003e {\n        println!(\"Stopping ListenerService\");\n        Ok(())\n    }\n\n    async fn process_request(\u0026self, request: ServiceRequest) -\u003e Result\u003cServiceResponse\u003e {\n        // Subscriptions are now set up in init() method, no need to check here\n        match request.operation.as_str() {\n            \"get_valid_events\" =\u003e {\n                let events = self.get_valid_events().await;\n                Ok(ServiceResponse {\n                    status: ResponseStatus::Success,\n                    message: format!(\"Found {} valid events\", events.len()),\n                    data: Some(ValueType::Array(\n                        events.into_iter().map(|s| ValueType::String(s)).collect(),\n                    )),\n                })\n            }\n            \"get_invalid_events\" =\u003e {\n                let events = self.get_invalid_events().await;\n                Ok(ServiceResponse {\n                    status: ResponseStatus::Success,\n                    message: format!(\"Found {} invalid events\", events.len()),\n                    data: Some(ValueType::Array(\n                        events.into_iter().map(|s| ValueType::String(s)).collect(),\n                    )),\n                })\n            }\n            _ =\u003e Ok(ServiceResponse {\n                status: ResponseStatus::Error,\n                message: format!(\"Unknown operation: {}\", request.operation),\n                data: None,\n            }),\n        }\n    }\n\n    fn description(\u0026self) -\u003e String {\n        \"A service that listens for events\".to_string()\n    }\n}\n\n// Need to implement Clone for ListenerService to support the subscription pattern\nimpl Clone for ListenerService {\n    fn clone(\u0026self) -\u003e Self {\n        Self {\n            name: self.name.clone(),\n            path: self.path.clone(),\n            storage: self.storage.clone(), // Use the shared storage\n            subscriptions_setup: self.subscriptions_setup.clone(),\n        }\n    }\n}\n\n#[test]\nasync fn test_publish_subscribe() -\u003e Result\u003c()\u003e {\n    // Create a temporary directory for the test\n    let temp_dir = tempdir()?;\n    let _db_path = temp_dir.path().join(\"test.db\");\n\n    // Configure and create node\n    let config = NodeConfig::new(\"test\", temp_dir.path().to_str().unwrap());\n    let mut node = Node::new(\u0026config).await?;\n\n    // Initialize the node\n    node.init().await?;\n\n    // Create our services\n    let publisher_service = PublisherService::new(\"publisher\");\n    let listener_service = ListenerService::new(\"listener\");\n\n    // Add the services to the node\n    node.add_service(publisher_service).await?;\n    node.add_service(listener_service).await?;\n\n    // Wait a bit for the services to initialize\n    tokio::time::sleep(std::time::Duration::from_millis(500)).await;\n\n    // No need to make an initial request to set up subscriptions anymore\n    // Subscriptions are now set up during initialization\n\n    // Publish a valid event\n    let valid_payload = json!({\n        \"topic\": \"publisher/valid\",\n        \"data\": \"this is a valid event\"\n    });\n    println!(\"Sending valid event request\");\n    node.request(\"publisher/publish\", valid_payload).await?;\n\n    // Publish an invalid event\n    let invalid_payload = json!({\n        \"topic\": \"publisher/invalid\",\n        \"data\": \"this is an invalid event\"\n    });\n    println!(\"Sending invalid event request\");\n    node.request(\"publisher/publish\", invalid_payload).await?;\n\n    // Wait for events to be processed\n    tokio::time::sleep(std::time::Duration::from_millis(500)).await;\n\n    // Check that the listener received the events\n    println!(\"Checking valid events\");\n    let valid_events_response = node.request(\"listener/get_valid_events\", json!({})).await?;\n    println!(\"Valid events response: {:?}\", valid_events_response);\n\n    println!(\"Checking invalid events\");\n    let invalid_events_response = node\n        .request(\"listener/get_invalid_events\", json!({}))\n        .await?;\n    println!(\"Invalid events response: {:?}\", invalid_events_response);\n\n    // Extract the events - fix the temporary value dropped while borrowed errors\n    let valid_data = valid_events_response.data.unwrap();\n    let valid_events = valid_data.as_array().unwrap();\n\n    let invalid_data = invalid_events_response.data.unwrap();\n    let invalid_events = invalid_data.as_array().unwrap();\n\n    // Assert that we received the correct events\n    assert_eq!(valid_events.len(), 1);\n    assert_eq!(invalid_events.len(), 1);\n\n    let valid_event = valid_events[0].as_str().unwrap();\n    let invalid_event = invalid_events[0].as_str().unwrap();\n\n    assert!(valid_event.contains(\"valid\"));\n    assert!(invalid_event.contains(\"invalid\"));\n\n    Ok(())\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","rafael","dev","kagi","node","tests","sqlite_mixin_tests.rs"],"content":"use anyhow::{anyhow, Result};\nuse async_trait::async_trait;\nuse kagi_node::services::ResponseStatus;\nuse kagi_node::node::NodeConfig;\nuse kagi_node::services::abstract_service::{AbstractService, ServiceMetadata, ServiceState};\nuse kagi_node::services::sqlite::{SqliteCrudMixin, SqliteQueryMixin, SqliteSchema, SqliteSchemaField, SqliteStorageOptions, SqliteStorageType};\nuse kagi_node::services::{RequestContext, ServiceRequest, ServiceResponse, ValueType};\nuse kagi_node::node::DummyNodeRequestHandler;\n\nuse std::path::Path;\nuse std::sync::{Arc, Mutex};\nuse tokio::time::timeout;\n\nuse kagi_node::vmap;\n\nmod test_utils;\nuse test_utils::create_test_node;\n\n/// A custom UserStore service that uses SqliteCrudMixin\n/// This version follows clean separation of concerns - the service focuses\n/// on its domain logic while the mixin handles all storage concerns\nstruct UserStoreService {\n    name: String,\n    path: String,\n    state: Mutex\u003cServiceState\u003e,\n    crud_mixin: SqliteCrudMixin,\n}\n\nimpl UserStoreService {\n    /// Define the schema for the UserStore service\n    fn schema() -\u003e Vec\u003cSqliteSchema\u003e {\n        vec![SqliteSchema {\n            collection: \"users\".to_string(),\n            fields: vec![\n                SqliteSchemaField {\n                    name: \"name\".to_string(),\n                    field_type: \"TEXT\".to_string(),\n                    required: true,\n                    default: None,\n                },\n                SqliteSchemaField {\n                    name: \"email\".to_string(),\n                    field_type: \"TEXT\".to_string(),\n                    required: true,\n                    default: None,\n                },\n                SqliteSchemaField {\n                    name: \"age\".to_string(),\n                    field_type: \"INTEGER\".to_string(),\n                    required: false,\n                    default: None,\n                },\n            ],\n        }]\n    }\n\n    /// Create a new UserStoreService\n    pub async fn new(name: \u0026str, config: \u0026NodeConfig) -\u003e Result\u003cSelf\u003e {\n        // Service path should be just the name, as the node will prepend the network_id when needed\n        let service_path = name.to_string();\n\n        // Create the full directory path for the service\n        let service_dir_path = format!(\"{}/{}\", config.node_path(), name);\n\n        // Create service directory if it doesn't exist\n        let service_dir = Path::new(\u0026service_dir_path);\n        if !service_dir.exists() {\n            std::fs::create_dir_all(service_dir)?;\n        }\n\n        // Create the database path\n        let db_path = format!(\"{}/userstore.db\", service_dir_path);\n        \n        // Create storage options\n        let storage_options = SqliteStorageOptions {\n            storage_type: SqliteStorageType::Disk,\n            max_size: None,\n            path: Some(db_path),\n        };\n\n        // Use the new method that handles database creation internally\n        let crud_mixin = SqliteCrudMixin::new_from_options(storage_options, Self::schema()).await?;\n\n        Ok(UserStoreService {\n            name: name.to_string(),\n            path: service_path,\n            state: Mutex::new(ServiceState::Created),\n            crud_mixin,\n        })\n    }\n}\n\n#[async_trait]\nimpl AbstractService for UserStoreService {\n    fn name(\u0026self) -\u003e \u0026str {\n        \u0026self.name\n    }\n\n    fn path(\u0026self) -\u003e \u0026str {\n        \u0026self.path\n    }\n\n    fn state(\u0026self) -\u003e ServiceState {\n        *self.state.lock().unwrap()\n    }\n\n    async fn init(\u0026mut self, context: \u0026RequestContext) -\u003e Result\u003c()\u003e {\n        *self.state.lock().unwrap() = ServiceState::Initialized;\n        self.crud_mixin.init(context).await\n    }\n\n    async fn start(\u0026mut self) -\u003e Result\u003c()\u003e {\n        *self.state.lock().unwrap() = ServiceState::Running;\n        Ok(())\n    }\n\n    async fn stop(\u0026mut self) -\u003e Result\u003c()\u003e {\n        *self.state.lock().unwrap() = ServiceState::Stopped;\n        Ok(())\n    }\n\n    async fn process_request(\u0026self, request: ServiceRequest) -\u003e Result\u003cServiceResponse\u003e {\n        // Simply delegate to the mixin\n        self.crud_mixin.process_request(request).await\n    }\n\n    fn description(\u0026self) -\u003e String {\n        \"User Store Service with SQLite CRUD operations\".to_string()\n    }\n\n    fn metadata(\u0026self) -\u003e ServiceMetadata {\n        ServiceMetadata {\n            name: self.name.clone(),\n            path: self.path.clone(),\n            state: self.state(),\n            description: self.description(),\n            operations: vec![\n                \"create\".to_string(),\n                \"read\".to_string(),\n                \"update\".to_string(),\n                \"delete\".to_string(),\n            ],\n            version: \"1.0.0\".to_string(),\n        }\n    }\n}\n\n/// A test service that uses SqliteQueryMixin for direct SQL access\nstruct QueryableStoreService {\n    name: String,\n    path: String,\n    state: Mutex\u003cServiceState\u003e,\n    query_mixin: SqliteQueryMixin,\n}\n\nimpl QueryableStoreService {\n    /// Create a new QueryableStoreService\n    pub async fn new(name: \u0026str, config: \u0026NodeConfig) -\u003e Result\u003cSelf\u003e {\n        // Construct the service path\n        let svc_path = format!(\"queryable-{}\", name);\n\n        // Create the directory path for the service\n        let dir_path = format!(\"{}/{}\", config.node_path(), \u0026svc_path);\n\n        // Check if the service directory exists, if not create it\n        if !std::path::Path::new(\u0026dir_path).exists() {\n            std::fs::create_dir_all(\u0026dir_path)?;\n        }\n\n        // Initialize the database path\n        let db_path = format!(\"{}/queryables.db\", dir_path);\n\n        // Create the storage options\n        let storage_options = SqliteStorageOptions {\n            storage_type: SqliteStorageType::Disk,\n            max_size: None,\n            path: Some(db_path.clone()),\n        };\n\n        // Create the query mixin using the new method that handles database creation internally\n        let query_mixin = SqliteQueryMixin::new_from_options(storage_options).await?;\n        \n        Ok(Self {\n            name: name.to_string(),\n            path: svc_path,\n            state: Mutex::new(ServiceState::Created),\n            query_mixin,\n        })\n    }\n}\n\n#[async_trait]\nimpl AbstractService for QueryableStoreService {\n    fn name(\u0026self) -\u003e \u0026str {\n        \u0026self.name\n    }\n\n    fn path(\u0026self) -\u003e \u0026str {\n        \u0026self.path\n    }\n\n    fn state(\u0026self) -\u003e ServiceState {\n        *self.state.lock().unwrap()\n    }\n\n    async fn init(\u0026mut self, context: \u0026RequestContext) -\u003e Result\u003c()\u003e {\n        *self.state.lock().unwrap() = ServiceState::Initialized;\n        \n        // Create a table in the database\n        let create_table_sql = \"\n            CREATE TABLE IF NOT EXISTS items (\n                id TEXT PRIMARY KEY,\n                name TEXT NOT NULL,\n                price REAL NOT NULL,\n                category TEXT,\n                created_at TEXT\n            )\n        \";\n        \n        // Execute SQL through process_request instead of direct call\n        let create_table_request = ServiceRequest {\n            path: self.path.clone(),\n            operation: \"execute\".to_string(),\n            params: vmap! {\n                \"sql\" =\u003e create_table_sql,\n                \"params\" =\u003e Vec::\u003cString\u003e::new()\n            },\n            request_id: None,\n            request_context: Arc::new(context.clone()),\n        };\n        \n        self.query_mixin.process_request(create_table_request).await?;\n        \n        Ok(())\n    }\n\n    async fn start(\u0026mut self) -\u003e Result\u003c()\u003e {\n        *self.state.lock().unwrap() = ServiceState::Running;\n        Ok(())\n    }\n\n    async fn stop(\u0026mut self) -\u003e Result\u003c()\u003e {\n        *self.state.lock().unwrap() = ServiceState::Stopped;\n        Ok(())\n    }\n\n    async fn process_request(\u0026self, request: ServiceRequest) -\u003e Result\u003cServiceResponse\u003e {\n        // Delegate to the query mixin\n        self.query_mixin.process_request(request).await\n    }\n\n    fn description(\u0026self) -\u003e String {\n        \"Queryable Store Service with direct SQL access\".to_string()\n    }\n\n    fn metadata(\u0026self) -\u003e ServiceMetadata {\n        ServiceMetadata {\n            name: self.name.clone(),\n            path: self.path.clone(),\n            state: self.state(),\n            description: self.description(),\n            operations: vec![\n                \"execute\".to_string(),\n                \"query\".to_string(),\n            ],\n            version: \"1.0.0\".to_string(),\n        }\n    }\n}\n\n/// Test the CRUD operations of SqliteCrudMixin\n#[tokio::test]\nasync fn test_sqlite_crud_mixin() -\u003e Result\u003c()\u003e {\n    // Set a timeout for the test\n    let timeout_duration = std::time::Duration::from_secs(10);\n\n    let _result = timeout(timeout_duration, async {\n        // Create a test node\n        let (mut node, _temp_dir, node_config) = create_test_node().await?;\n        \n        // Create the UserStore service\n        let user_store = UserStoreService::new(\"userStore\", \u0026node_config).await?;\n\n        // Add the service to the node\n        node.add_service(user_store).await?;\n\n        // 1. Test creating a document\n        let create_params = vmap! {\n            \"collection\" =\u003e \"users\",\n            \"document\" =\u003e vmap! {\n                \"name\" =\u003e \"John Doe\",\n                \"email\" =\u003e \"john@example.com\",\n                \"age\" =\u003e 30\n            }\n        };\n\n        let create_result = node.request(\"userStore/create\", create_params).await?;\n        assert_eq!(create_result.status, ResponseStatus::Success, \"Create should succeed\");\n\n        // Extract the document ID\n        let doc_id = create_result.data\n            .as_ref()\n            .and_then(|data| {\n                match data {\n                    ValueType::Json(json_data) =\u003e json_data\n                        .get(\"_id\")\n                        .and_then(|id| id.as_str())\n                        .map(|s| s.to_string()),\n                    ValueType::Map(map) =\u003e map\n                        .get(\"_id\")\n                        .and_then(|id| id.as_str())\n                        .map(|s| s.to_string()),\n                    _ =\u003e None\n                }\n            })\n            .unwrap_or_default();\n\n        assert!(!doc_id.is_empty(), \"Document ID should not be empty\");\n\n        // 2. Test reading the document\n        let read_params = vmap! {\n            \"collection\" =\u003e \"users\",\n            \"filter\" =\u003e vmap! {\n                \"_id\" =\u003e doc_id.clone()\n            }\n        };\n\n        let read_result = node.request(\"userStore/read\", read_params).await?;\n        assert_eq!(read_result.status, ResponseStatus::Success, \"Read should succeed\");\n\n        // Verify the document data\n        let user_data = read_result.data\n            .as_ref()\n            .ok_or_else(|| anyhow!(\"No data returned from read\"))?;\n\n        // Extract the user document\n        let user_doc = match user_data {\n            ValueType::Array(docs) =\u003e {\n                assert_eq!(docs.len(), 1, \"Should have one user document\");\n                docs.first().unwrap()\n            },\n            _ =\u003e panic!(\"Expected an array of documents\")\n        };\n\n        // Verify user fields based on actual ValueType variant\n        match user_doc {\n            ValueType::Map(map) =\u003e {\n                assert_eq!(map.get(\"name\").and_then(|v| v.as_str()), Some(\"John Doe\"));\n                assert_eq!(map.get(\"email\").and_then(|v| v.as_str()), Some(\"john@example.com\"));\n                assert_eq!(map.get(\"age\").and_then(|v| v.as_i64()), Some(30));\n            },\n            ValueType::Json(json_obj) =\u003e {\n                assert_eq!(json_obj.get(\"name\").and_then(|v| v.as_str()), Some(\"John Doe\"));\n                assert_eq!(json_obj.get(\"email\").and_then(|v| v.as_str()), Some(\"john@example.com\"));\n                assert_eq!(json_obj.get(\"age\").and_then(|v| v.as_f64()).map(|n| n as i64), Some(30));\n            },\n            _ =\u003e panic!(\"Expected user to be a map or json object\")\n        }\n\n        // 3. Test updating the document\n        let update_params = vmap! {\n            \"collection\" =\u003e \"users\",\n            \"filter\" =\u003e vmap! {\n                \"_id\" =\u003e doc_id.clone()\n            },\n            \"document\" =\u003e vmap! {\n                \"name\" =\u003e \"Jane Doe\",\n                \"email\" =\u003e \"jane@example.com\",\n                \"age\" =\u003e 32\n            }\n        };\n\n        let update_result = node.request(\"userStore/update\", update_params).await?;\n        assert_eq!(update_result.status, ResponseStatus::Success, \"Update should succeed\");\n\n        // 4. Verify the update\n        let read_updated_params = vmap! {\n            \"collection\" =\u003e \"users\",\n            \"filter\" =\u003e vmap! {\n                \"_id\" =\u003e doc_id.clone()\n            }\n        };\n\n        let read_updated_result = node.request(\"userStore/read\", read_updated_params).await?;\n        assert_eq!(read_updated_result.status, ResponseStatus::Success, \"Read after update should succeed\");\n\n        // Verify the updated document\n        let updated_user_data = read_updated_result.data\n            .as_ref()\n            .ok_or_else(|| anyhow!(\"No data returned from read after update\"))?;\n\n        let updated_user_doc = match updated_user_data {\n            ValueType::Array(docs) =\u003e {\n                assert_eq!(docs.len(), 1, \"Should have one document after update\");\n                docs.first().unwrap()\n            },\n            _ =\u003e panic!(\"Expected an array of documents\")\n        };\n\n        // Verify updated fields\n        match updated_user_doc {\n            ValueType::Map(map) =\u003e {\n                assert_eq!(map.get(\"name\").and_then(|v| v.as_str()), Some(\"Jane Doe\"));\n                assert_eq!(map.get(\"age\").and_then(|v| v.as_i64()), Some(32));\n            },\n            ValueType::Json(json_obj) =\u003e {\n                assert_eq!(json_obj.get(\"name\").and_then(|v| v.as_str()), Some(\"Jane Doe\"));\n                assert_eq!(json_obj.get(\"age\").and_then(|v| v.as_f64()).map(|n| n as i64), Some(32));\n            },\n            _ =\u003e panic!(\"Expected updated user to be a map or json object\")\n        }\n\n        // 5. Test deleting the document\n        let delete_params = vmap! {\n            \"collection\" =\u003e \"users\",\n            \"filter\" =\u003e vmap! {\n                \"_id\" =\u003e doc_id.clone()\n            }\n        };\n\n        let delete_result = node.request(\"userStore/delete\", delete_params).await?;\n        assert_eq!(delete_result.status, ResponseStatus::Success, \"Delete should succeed\");\n\n        // 6. Verify document was deleted\n        let verify_delete_params = vmap! {\n            \"collection\" =\u003e \"users\",\n            \"filter\" =\u003e vmap! {\n                \"_id\" =\u003e doc_id.clone()\n            }\n        };\n\n        let read_after_delete = node.request(\"userStore/read\", verify_delete_params).await?;\n        \n        // Verify the document is gone (empty array)\n        if let Some(ValueType::Array(docs)) = \u0026read_after_delete.data {\n            assert!(docs.is_empty(), \"Document should be deleted\");\n        } else {\n            panic!(\"Expected an array response from read operation\");\n        }\n\n        Ok::\u003c(), anyhow::Error\u003e(())\n    }).await??;\n\n    Ok(())\n}\n\n/// Test the SQL querying capabilities of SqliteQueryMixin\n#[tokio::test]\nasync fn test_sqlite_query_mixin() -\u003e Result\u003c()\u003e {\n    // Set a timeout for the test\n    let timeout_duration = std::time::Duration::from_secs(10);\n\n    let _result = timeout(timeout_duration, async {\n        // Create a test node\n        let (mut node, _temp_dir, node_config) = create_test_node().await?;\n        \n        // Create the QueryableStore service\n        let query_store = QueryableStoreService::new(\"queryStore\", \u0026node_config).await?;\n\n        // Add the service to the node\n        node.add_service(query_store).await?;\n\n        // 1. Test SQL insertion\n        let insert_params = vmap! {\n            \"sql\" =\u003e \"INSERT INTO items (id, name, price, category, created_at) VALUES (?, ?, ?, ?, datetime('now'))\",\n            \"params\" =\u003e vec![\n                \"item1\".to_string(),\n                \"Laptop\".to_string(),\n                \"1299.99\".to_string(),\n                \"Electronics\".to_string()\n            ]\n        };\n\n        let insert_result = node.request(\"queryStore/execute\", insert_params).await?;\n        assert_eq!(insert_result.status, ResponseStatus::Success, \"Insert should succeed\");\n\n        // 2. Test SQL query with parameters\n        let query_params = vmap! {\n            \"sql\" =\u003e \"SELECT * FROM items WHERE category = ?\",\n            \"params\" =\u003e vec![\"Electronics\".to_string()]\n        };\n\n        let query_result = node.request(\"queryStore/query\", query_params).await?;\n        assert_eq!(query_result.status, ResponseStatus::Success, \"Query should succeed\");\n\n        // 3. Verify result data\n        let result_data = query_result.data\n            .as_ref()\n            .ok_or_else(|| anyhow!(\"No data returned from query\"))?;\n\n        // Handle different ValueType variants\n        match result_data {\n            ValueType::Array(rows) =\u003e {\n                assert_eq!(rows.len(), 1, \"Should have one result row\");\n                \n                if let Some(row) = rows.first() {\n                    match row {\n                        ValueType::Map(fields) =\u003e {\n                            assert_eq!(fields.get(\"id\").and_then(|v| v.as_str()), Some(\"item1\"));\n                            assert_eq!(fields.get(\"name\").and_then(|v| v.as_str()), Some(\"Laptop\"));\n                            assert_eq!(fields.get(\"category\").and_then(|v| v.as_str()), Some(\"Electronics\"));\n                        },\n                        ValueType::Json(json_obj) =\u003e {\n                            assert_eq!(json_obj.get(\"id\").and_then(|v| v.as_str()), Some(\"item1\"));\n                            assert_eq!(json_obj.get(\"name\").and_then(|v| v.as_str()), Some(\"Laptop\"));\n                            assert_eq!(json_obj.get(\"category\").and_then(|v| v.as_str()), Some(\"Electronics\"));\n                        },\n                        _ =\u003e panic!(\"Expected row to be a map or json object\")\n                    }\n                }\n            },\n            ValueType::Json(json_value) =\u003e {\n                if let Some(array) = json_value.as_array() {\n                    assert_eq!(array.len(), 1, \"Should have one result row\");\n                    \n                    if let Some(row) = array.first() {\n                        assert_eq!(row.get(\"id\").and_then(|v| v.as_str()), Some(\"item1\"));\n                        assert_eq!(row.get(\"name\").and_then(|v| v.as_str()), Some(\"Laptop\"));\n                        assert_eq!(row.get(\"category\").and_then(|v| v.as_str()), Some(\"Electronics\"));\n                    }\n                }\n            },\n            _ =\u003e panic!(\"Expected result data to be an array or JSON array\")\n        }\n\n        // 4. Test multiple row insertion and complex query\n        let insert_more_params = vmap! {\n            \"sql\" =\u003e \"INSERT INTO items (id, name, price, category, created_at) VALUES (?, ?, ?, ?, datetime('now'))\",\n            \"params\" =\u003e vec![\n                \"item2\".to_string(), \n                \"Smartphone\".to_string(), \n                \"999.99\".to_string(), \n                \"Electronics\".to_string()\n            ]\n        };\n        \n        node.request(\"queryStore/execute\", insert_more_params).await?;\n        \n        // Query with aggregation\n        let aggregate_params = vmap! {\n            \"sql\" =\u003e \"SELECT category, COUNT(*) as count, AVG(price) as avg_price FROM items GROUP BY category\",\n            \"params\" =\u003e Vec::\u003cString\u003e::new()\n        };\n        \n        let aggregate_result = node.request(\"queryStore/query\", aggregate_params).await?;\n        assert_eq!(aggregate_result.status, ResponseStatus::Success, \"Aggregate query should succeed\");\n        \n        // Verify aggregation results\n        if let Some(ValueType::Array(rows)) = \u0026aggregate_result.data {\n            assert_eq!(rows.len(), 1, \"Should have one row for Electronics category\");\n            \n            let row = \u0026rows[0];\n            match row {\n                ValueType::Map(fields) =\u003e {\n                    assert_eq!(fields.get(\"category\").and_then(|v| v.as_str()), Some(\"Electronics\"));\n                    assert_eq!(fields.get(\"count\").and_then(|v| v.as_i64()), Some(2));\n                },\n                ValueType::Json(json_obj) =\u003e {\n                    assert_eq!(json_obj.get(\"category\").and_then(|v| v.as_str()), Some(\"Electronics\"));\n                    assert_eq!(json_obj.get(\"count\").and_then(|v| v.as_f64()).map(|n| n as i64), Some(2));\n                },\n                _ =\u003e panic!(\"Expected row to be a map or json object\")\n            }\n        }\n\n        // 5. Test error handling with invalid SQL\n        let invalid_sql_params = vmap! {\n            \"sql\" =\u003e \"SELECT * FROM items WHERE\",\n            \"params\" =\u003e \"not_an_array\" // This should cause an error\n        };\n\n        let error_result = node.request(\"queryStore/query\", invalid_sql_params).await;\n        \n        // Verify that we get an error response\n        match error_result {\n            Ok(response) =\u003e {\n                assert_eq!(response.status, ResponseStatus::Error, \"Invalid SQL should return error\");\n                assert!(response.message.contains(\"Parameters must be a JSON array\"), \n                       \"Error message should indicate parameter type issue\");\n            },\n            Err(_) =\u003e {\n                // If we get an error directly, that's also acceptable\n            }\n        }\n\n        Ok::\u003c(), anyhow::Error\u003e(())\n    }).await??;\n\n    Ok(())\n}\n\n/// Test in-memory database functionality\n#[tokio::test]\nasync fn test_sqlite_in_memory() -\u003e Result\u003c()\u003e {\n    // Set a timeout for the test\n    let timeout_duration = std::time::Duration::from_secs(10);\n\n    let _result = timeout(timeout_duration, async {\n        // Create an in-memory database for SqliteQueryMixin\n        let query_mixin = SqliteQueryMixin::new_in_memory().await?;\n        \n        // Create a temporary table using process_request\n        let create_table_request = ServiceRequest {\n            path: \"test/execute\".to_string(),\n            operation: \"execute\".to_string(),\n            params: vmap! {\n                \"sql\" =\u003e \"CREATE TABLE test (id TEXT PRIMARY KEY, value TEXT)\",\n                \"params\" =\u003e Vec::\u003cString\u003e::new()\n            },\n            request_id: None,\n            request_context: Arc::new(RequestContext::default()),\n        };\n        \n        let create_result = query_mixin.process_request(create_table_request).await?;\n        assert_eq!(create_result.status, ResponseStatus::Success, \"Create table should succeed\");\n        \n        // Insert data\n        let insert_params_value = ValueType::from_json(serde_json::json!([\"test1\", \"value1\"]));\n        let insert_request = ServiceRequest {\n            path: \"test/execute\".to_string(),\n            operation: \"execute\".to_string(),\n            params: vmap! {\n                \"sql\" =\u003e \"INSERT INTO test (id, value) VALUES (?, ?)\",\n                \"params\" =\u003e insert_params_value\n            },\n            request_id: None,\n            request_context: Arc::new(RequestContext::default()),\n        };\n        \n        let insert_result = query_mixin.process_request(insert_request).await?;\n        assert_eq!(insert_result.status, ResponseStatus::Success, \"Insert should succeed\");\n        \n        // Query data\n        let query_request = ServiceRequest {\n            path: \"test/query\".to_string(),\n            operation: \"query\".to_string(),\n            params: vmap! {\n                \"sql\" =\u003e \"SELECT * FROM test\",\n                \"params\" =\u003e Vec::\u003cString\u003e::new()\n            },\n            request_id: None,\n            request_context: Arc::new(RequestContext::default()),\n        };\n        \n        let query_result = query_mixin.process_request(query_request).await?;\n        assert_eq!(query_result.status, ResponseStatus::Success, \"Query should succeed\");\n        \n        // Verify data\n        if let Some(ValueType::Array(rows)) = query_result.data {\n            assert_eq!(rows.len(), 1, \"Should have one row\");\n            \n            let row = \u0026rows[0];\n            match row {\n                ValueType::Map(fields) =\u003e {\n                    assert_eq!(fields.get(\"id\").and_then(|v| v.as_str()), Some(\"test1\"));\n                    assert_eq!(fields.get(\"value\").and_then(|v| v.as_str()), Some(\"value1\"));\n                },\n                ValueType::Json(json_obj) =\u003e {\n                    assert_eq!(json_obj.get(\"id\").and_then(|v| v.as_str()), Some(\"test1\"));\n                    assert_eq!(json_obj.get(\"value\").and_then(|v| v.as_str()), Some(\"value1\"));\n                },\n                _ =\u003e panic!(\"Expected row to be a map or json object\")\n            }\n        } else {\n            panic!(\"Expected array of rows\");\n        }\n        \n        // Create an in-memory database for SqliteCrudMixin\n        let schema = vec![SqliteSchema {\n            collection: \"items\".to_string(),\n            fields: vec![\n                SqliteSchemaField {\n                    name: \"name\".to_string(),\n                    field_type: \"TEXT\".to_string(),\n                    required: true,\n                    default: None,\n                },\n                SqliteSchemaField {\n                    name: \"value\".to_string(),\n                    field_type: \"INTEGER\".to_string(),\n                    required: false,\n                    default: None,\n                },\n            ],\n        }];\n        \n        let crud_mixin = SqliteCrudMixin::new_in_memory(schema).await?;\n        let node_handler = Arc::new(DummyNodeRequestHandler {});\n        let context = RequestContext::new(\"test\".to_string(), ValueType::Null, node_handler);\n        crud_mixin.init(\u0026context).await?;\n        \n        // Create a document\n        let document = vmap! {\n            \"name\" =\u003e \"test_item\",\n            \"value\" =\u003e 42\n        };\n        \n        let create_params = ServiceRequest {\n            path: \"test/create\".to_string(),\n            operation: \"create\".to_string(),\n            params: vmap! {\n                \"collection\" =\u003e \"items\",\n                \"document\" =\u003e document\n            },\n            request_id: None,\n            request_context: Arc::new(RequestContext::default()),\n        };\n        \n        let create_result = crud_mixin.process_request(create_params).await?;\n        assert_eq!(create_result.status, ResponseStatus::Success, \"Create should succeed\");\n        \n        // Read the document\n        let read_params = ServiceRequest {\n            path: \"test/read\".to_string(),\n            operation: \"read\".to_string(),\n            params: vmap! {\n                \"collection\" =\u003e \"items\",\n                \"filter\" =\u003e vmap! { \"name\" =\u003e \"test_item\" }\n            },\n            request_id: None,\n            request_context: Arc::new(RequestContext::default()),\n        };\n        \n        let read_result = crud_mixin.process_request(read_params).await?;\n        assert_eq!(read_result.status, ResponseStatus::Success, \"Read should succeed\");\n        \n        // Verify data\n        if let Some(ValueType::Array(docs)) = read_result.data {\n            assert_eq!(docs.len(), 1, \"Should have one document\");\n            \n            let doc = \u0026docs[0];\n            match doc {\n                ValueType::Map(fields) =\u003e {\n                    assert_eq!(fields.get(\"name\").and_then(|v| v.as_str()), Some(\"test_item\"));\n                    assert_eq!(fields.get(\"value\").and_then(|v| v.as_i64()), Some(42));\n                },\n                ValueType::Json(json_obj) =\u003e {\n                    assert_eq!(json_obj.get(\"name\").and_then(|v| v.as_str()), Some(\"test_item\"));\n                    assert_eq!(json_obj.get(\"value\").and_then(|v| v.as_f64()).map(|n| n as i64), Some(42));\n                },\n                _ =\u003e panic!(\"Expected document to be a map or json object\")\n            }\n        } else {\n            panic!(\"Expected array of documents\");\n        }\n\n        Ok::\u003c(), anyhow::Error\u003e(())\n    }).await??;\n\n    Ok(())\n} ","traces":[],"covered":0,"coverable":0},{"path":["/","Users","rafael","dev","kagi","node","tests","test_utils","mod.rs"],"content":"use anyhow::Result;\nuse async_trait::async_trait;\nuse kagi_node::services::abstract_service::{AbstractService, ServiceMetadata, ServiceState};\nuse kagi_node::services::ResponseStatus;\nuse kagi_node::services::{RequestContext, ServiceRequest, ServiceResponse, ValueType};\nuse std::sync::Mutex;\n\nuse kagi_node::vmap;\n\n/// A minimal test service that just responds with a simple message\n/// This is useful for basic service registration/discovery tests\npub struct SimpleTestService {\n    name: String,\n    path: String,\n    state: Mutex\u003cServiceState\u003e,\n}\n\nimpl SimpleTestService {\n    /// Create a new SimpleTestService\n    pub fn new(name: \u0026str) -\u003e Self {\n        SimpleTestService {\n            name: name.to_string(),\n            path: name.to_string(),\n            state: Mutex::new(ServiceState::Created),\n        }\n    }\n}\n\n#[async_trait]\nimpl AbstractService for SimpleTestService {\n    fn name(\u0026self) -\u003e \u0026str {\n        \u0026self.name\n    }\n\n    fn path(\u0026self) -\u003e \u0026str {\n        \u0026self.path\n    }\n\n    fn state(\u0026self) -\u003e ServiceState {\n        *self.state.lock().unwrap()\n    }\n\n    async fn init(\u0026mut self, _context: \u0026RequestContext) -\u003e Result\u003c()\u003e {\n        *self.state.lock().unwrap() = ServiceState::Initialized;\n        Ok(())\n    }\n\n    async fn start(\u0026mut self) -\u003e Result\u003c()\u003e {\n        *self.state.lock().unwrap() = ServiceState::Running;\n        Ok(())\n    }\n\n    async fn stop(\u0026mut self) -\u003e Result\u003c()\u003e {\n        *self.state.lock().unwrap() = ServiceState::Stopped;\n        Ok(())\n    }\n\n    async fn process_request(\u0026self, request: ServiceRequest) -\u003e Result\u003cServiceResponse\u003e {\n        // Simple echo behavior - returns the operation and parameters\n        let operation = request.operation.clone();\n\n        // Convert params to a map with plain values (not JSON)\n        let mut plain_params = std::collections::HashMap::new();\n        if let Some(params_map) = request.params.as_map() {\n            for (key, value) in params_map {\n                // Convert JSON values to plain values\n                let plain_value = match value {\n                    ValueType::Json(json) =\u003e {\n                        if let Some(s) = json.as_str() {\n                            ValueType::String(s.to_string())\n                        } else if let Some(n) = json.as_f64() {\n                            ValueType::Number(n)\n                        } else if let Some(b) = json.as_bool() {\n                            ValueType::Bool(b)\n                        } else {\n                            value.clone()\n                        }\n                    }\n                    _ =\u003e value.clone(),\n                };\n                plain_params.insert(key.clone(), plain_value);\n            }\n        }\n\n        let response_data = vmap! {\n            \"message\" =\u003e format!(\"SimpleTestService received operation: {}\", operation),\n            \"received_params\" =\u003e ValueType::Map(plain_params),\n            \"timestamp\" =\u003e std::time::SystemTime::now().duration_since(std::time::UNIX_EPOCH).unwrap().as_secs().to_string()\n        };\n\n        Ok(ServiceResponse {\n            status: ResponseStatus::Success,\n            message: \"Request processed successfully\".to_string(),\n            data: Some(response_data),\n        })\n    }\n\n    fn description(\u0026self) -\u003e String {\n        \"Simple Test Service for testing\".to_string()\n    }\n\n    fn metadata(\u0026self) -\u003e ServiceMetadata {\n        ServiceMetadata {\n            name: self.name.clone(),\n            path: self.path.clone(),\n            state: self.state(),\n            description: self.description(),\n            operations: vec![\"echo\".to_string(), \"ping\".to_string()],\n            version: \"1.0.0\".to_string(),\n        }\n    }\n}\n\n/// A mock database service for testing\n/// This simulates a document store with key operations (create, read, update, delete)\npub struct MockDocumentStore {\n    name: String,\n    path: String,\n    state: Mutex\u003cServiceState\u003e,\n}\n\nimpl MockDocumentStore {\n    /// Create a new MockDocumentStore\n    pub fn new(name: \u0026str) -\u003e Self {\n        MockDocumentStore {\n            name: name.to_string(),\n            path: name.to_string(),\n            state: Mutex::new(ServiceState::Created),\n        }\n    }\n}\n\n#[async_trait]\nimpl AbstractService for MockDocumentStore {\n    fn name(\u0026self) -\u003e \u0026str {\n        \u0026self.name\n    }\n\n    fn path(\u0026self) -\u003e \u0026str {\n        \u0026self.path\n    }\n\n    fn state(\u0026self) -\u003e ServiceState {\n        *self.state.lock().unwrap()\n    }\n\n    async fn init(\u0026mut self, _context: \u0026RequestContext) -\u003e Result\u003c()\u003e {\n        *self.state.lock().unwrap() = ServiceState::Initialized;\n        Ok(())\n    }\n\n    async fn start(\u0026mut self) -\u003e Result\u003c()\u003e {\n        *self.state.lock().unwrap() = ServiceState::Running;\n        Ok(())\n    }\n\n    async fn stop(\u0026mut self) -\u003e Result\u003c()\u003e {\n        *self.state.lock().unwrap() = ServiceState::Stopped;\n        Ok(())\n    }\n\n    async fn process_request(\u0026self, request: ServiceRequest) -\u003e Result\u003cServiceResponse\u003e {\n        // Handle CRUD operations with simulated responses\n        match request.operation.as_str() {\n            \"create\" =\u003e {\n                let collection = request\n                    .get_param(\"collection\")\n                    .and_then(|v| v.as_str().map(|s| s.to_string()))\n                    .unwrap_or_default();\n\n                let document = request.get_param(\"document\").unwrap_or(ValueType::Null);\n\n                // Generate a UUID for the document\n                let id = uuid::Uuid::new_v4().to_string();\n\n                // Add ID to document\n                let mut document_map = document.clone();\n                if let ValueType::Map(ref mut map) = document_map {\n                    map.insert(\"_id\".to_string(), ValueType::String(id.clone()));\n                }\n\n                Ok(ServiceResponse {\n                    status: ResponseStatus::Success,\n                    message: format!(\n                        \"Document created in collection {} with ID: {}\",\n                        collection, id\n                    ),\n                    data: Some(document_map),\n                })\n            }\n            \"read\" =\u003e {\n                let collection = request\n                    .get_param(\"collection\")\n                    .and_then(|v| v.as_str().map(|s| s.to_string()))\n                    .unwrap_or_default();\n\n                let filter = request.get_param(\"filter\").unwrap_or(ValueType::Null);\n\n                // Check if we're looking for a user with a specific name\n                let mut has_match = false;\n                if let ValueType::Map(filter_map) = \u0026filter {\n                    if let Some(name_value) = filter_map.get(\"name\") {\n                        let name_str = match name_value {\n                            ValueType::String(s) =\u003e Some(s.as_str()),\n                            ValueType::Json(json) =\u003e {\n                                if let Some(s) = json.as_str() {\n                                    Some(s)\n                                } else {\n                                    None\n                                }\n                            }\n                            _ =\u003e None,\n                        };\n\n                        if let Some(name) = name_str {\n                            if name == \"testuser\" {\n                                has_match = true;\n                            }\n                        }\n                    }\n                }\n\n                if has_match {\n                    // Return a mock user\n                    let user = vmap! {\n                        \"_id\" =\u003e uuid::Uuid::new_v4().to_string(),\n                        \"name\" =\u003e \"testuser\",\n                        \"email\" =\u003e \"test@example.com\",\n                        \"age\" =\u003e 30,\n                        \"password\" =\u003e \"password123\"\n                    };\n\n                    Ok(ServiceResponse {\n                        status: ResponseStatus::Success,\n                        message: format!(\"Found 1 document in collection {}\", collection),\n                        data: Some(ValueType::Array(vec![user])),\n                    })\n                } else {\n                    // Return empty array\n                    Ok(ServiceResponse {\n                        status: ResponseStatus::Success,\n                        message: format!(\"Found 0 documents in collection {}\", collection),\n                        data: Some(ValueType::Array(vec![])),\n                    })\n                }\n            }\n            \"update\" =\u003e {\n                let collection = request\n                    .get_param(\"collection\")\n                    .and_then(|v| v.as_str().map(|s| s.to_string()))\n                    .unwrap_or_default();\n\n                let filter = request.get_param(\"filter\").unwrap_or(ValueType::Null);\n                let document = request.get_param(\"document\").unwrap_or(ValueType::Null);\n\n                // Extract ID from filter or generate a new one\n                let id = if let ValueType::Map(filter_map) = \u0026filter {\n                    if let Some(id_value) = filter_map.get(\"_id\") {\n                        if let Some(id_str) = id_value.as_str() {\n                            id_str.to_string()\n                        } else {\n                            uuid::Uuid::new_v4().to_string()\n                        }\n                    } else {\n                        uuid::Uuid::new_v4().to_string()\n                    }\n                } else {\n                    uuid::Uuid::new_v4().to_string()\n                };\n\n                Ok(ServiceResponse {\n                    status: ResponseStatus::Success,\n                    message: format!(\n                        \"Document updated in collection {} with ID: {}\",\n                        collection, id\n                    ),\n                    data: Some(document),\n                })\n            }\n            \"delete\" =\u003e {\n                let collection = request\n                    .get_param(\"collection\")\n                    .and_then(|v| v.as_str().map(|s| s.to_string()))\n                    .unwrap_or_default();\n\n                let filter = request.get_param(\"filter\").unwrap_or(ValueType::Null);\n\n                // Extract ID from filter or generate a new one\n                let id = if let ValueType::Map(filter_map) = \u0026filter {\n                    if let Some(id_value) = filter_map.get(\"_id\") {\n                        if let Some(id_str) = id_value.as_str() {\n                            id_str.to_string()\n                        } else {\n                            uuid::Uuid::new_v4().to_string()\n                        }\n                    } else {\n                        uuid::Uuid::new_v4().to_string()\n                    }\n                } else {\n                    uuid::Uuid::new_v4().to_string()\n                };\n\n                Ok(ServiceResponse {\n                    status: ResponseStatus::Success,\n                    message: format!(\n                        \"Document deleted from collection {} with ID: {}\",\n                        collection, id\n                    ),\n                    data: None,\n                })\n            }\n            _ =\u003e Ok(ServiceResponse {\n                status: ResponseStatus::Error,\n                message: format!(\"Unknown operation: {}\", request.operation),\n                data: None,\n            }),\n        }\n    }\n\n    fn description(\u0026self) -\u003e String {\n        \"Mock Document Store Service for testing\".to_string()\n    }\n\n    fn metadata(\u0026self) -\u003e ServiceMetadata {\n        ServiceMetadata {\n            name: self.name.clone(),\n            path: self.path.clone(),\n            state: self.state(),\n            description: self.description(),\n            operations: vec![\n                \"create\".to_string(),\n                \"read\".to_string(),\n                \"update\".to_string(),\n                \"delete\".to_string(),\n            ],\n            version: \"1.0.0\".to_string(),\n        }\n    }\n}\n\n/// Test helper function to create a temporary node for testing\npub async fn create_test_node() -\u003e Result\u003c(\n    kagi_node::node::Node,\n    tempfile::TempDir,\n    kagi_node::node::NodeConfig,\n)\u003e {\n    // Create a temporary directory for node storage\n    let temp_dir = tempfile::tempdir()?;\n    let node_path = temp_dir.path().to_str().unwrap();\n    let network_id = \"test-network\";\n\n    // Create a NodeConfig for the node\n    let node_config = kagi_node::node::NodeConfig::new(network_id, node_path);\n\n    // Create and initialize the node\n    let mut node = kagi_node::node::Node::new(\u0026node_config).await?;\n    node.init().await?;\n\n    Ok((node, temp_dir, node_config))\n}\n","traces":[],"covered":0,"coverable":0}]};
        var previousData = null;
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      }
    };
  });

  return [
    ...folders,
    ...files.filter(file => file.path.length === 1),
  ];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener("hashchange", () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.substr(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(({current}) => {
      return {current: [...current, file.path[0]]};
    }, () => this.updateHash());
  }

  back(file) {
    this.setState(({current}) => {
      return {current: current.slice(0, current.length - 1)};
    }, () => this.updateHash());
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e('div', {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e('table', {className: 'files-list'},
      e('thead', {className: 'files-list__head'},
        e('tr', null,
          e('th', null, "Path"),
          e('th', null, "Coverage")
        )
      ),
      e('tbody', {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile}))
      )
    )
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? file.covered / file.coverable * 100 : -1;
  const coverageDelta = file.prevRun &&
    (file.covered / file.coverable * 100 - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('tr', {
      className: 'files-list__file'
        + (coverage >= 0 && coverage < 50 ? ' files-list__file_low': '')
        + (coverage >= 50 && coverage < 80 ? ' files-list__file_medium': '')
        + (coverage >= 80 ? ' files-list__file_high': '')
        + (file.is_folder ? ' files-list__file_folder': ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e('td', null,
      file.covered + ' / ' + file.coverable +
      (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'},
    e(FileHeader, {file, onBack}),
    e(FileContent, {file})
  );
}

function FileHeader({file, onBack}) {
  const coverage = file.covered / file.coverable * 100;
  const coverageDelta = file.prevRun && (coverage - file.prevRun.covered / file.prevRun.coverable * 100);

  return e('div', {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e('div', {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable +
      (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e('span', {title: 'Change from the previous run'},
        (coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : ''))
    )
  );
}

function FileContent({file}) {
  return e('pre', {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      return e('code', {
          className: 'code-line'
            + (covered ? ' code-line_covered' : '')
            + (uncovered ? ' code-line_uncovered' : ''),
          title: trace ? JSON.stringify(trace.stats, null, 2) : null,
        }, line);
    })
  );
}

(function(){
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData && previousData.files.forEach((file) => {
    const path = file.path.slice(commonPath.length).join('/');
    prevFilesMap.set(path, file);
  });

  const files = data.files.map((file) => {
    const path = file.path.slice(commonPath.length);
    const { covered = 0, coverable = 0 } = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: { covered, coverable },
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    }
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));
}());
</script>
</body>
</html>